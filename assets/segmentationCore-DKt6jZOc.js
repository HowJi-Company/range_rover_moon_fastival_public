const o={FACE_DETECTION:{MODEL:"short",MIN_DETECTION_CONFIDENCE:.5,MAX_FACES:10},SEGMENTATION:{ENABLED:!0,MODEL_SELECTION:1,SELFIE_MODE:!0,SEGMENTATION_THRESHOLD:.1},FACE_DETECTION_SETTINGS:{REQUIRED_FACES:1},CAMERA:{DEFAULT_WIDTH:640,DEFAULT_HEIGHT:480,DEFAULT_FACING_MODE:"user",FRAME_RATE:30},UI:{STATUS_UPDATE_INTERVAL:100,SHOW_DEBUG_INFO:!0,SHOW_FPS:!1,LANGUAGE:"zh-TW"},EFFECTS:{MOON_EFFECT_DURATION:3e3,FADE_DURATION:800,ENABLE_SOUND:!1,MOON_SIZE_SCALE:1,STAR_COUNT:5,SPARKLE_COUNT:3},BACKGROUND_EFFECTS:{DEFAULT_BACKGROUND:"moon_video",WAVE_EFFECT:{AMPLITUDE:10,FREQUENCY:.02,SPEED:.05},FREQUENCY_EFFECT:{BANDS:32,HEIGHT_SCALE:.8,COLOR_SHIFT:.01},EFFECT_INTENSITY:.5,BLEND_MODE:"source-over"},PERFORMANCE:{ENABLE_MONITORING:!1,MAX_LATENCY:100,LOW_PERFORMANCE_MODE:!1,AUTO_ADJUST_PERFORMANCE:!0},DEBUG:{VERBOSE_LOGGING:!1,SHOW_FACE_LANDMARKS:!1,SAVE_DETECTION_RESULTS:!1},ADVANCED:{MEDIAPIPE_BASE_URL:"https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/",MEDIAPIPE_SEGMENTATION_URL:"https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/",USE_WEB_WORKERS:!1,MEMORY_LIMIT:512,ENABLE_ERROR_REPORTING:!0}};o.BACKGROUND=o.BACKGROUND||{TYPE:o.BACKGROUND_EFFECTS&&o.BACKGROUND_EFFECTS.DEFAULT_BACKGROUND||"original",INTENSITY:(o.BACKGROUND_EFFECTS&&o.BACKGROUND_EFFECTS.EFFECT_INTENSITY)??.5,GIF_BLEND_MODE:"overlay"};let k=null,ue=null,K=null;function pe(){try{K&&(URL.revokeObjectURL(K),K=null)}catch(e){console.warn("revoke failed",e)}}function we(e,t){if(!e)return null;pe(),k=e,ue=t||`moonAR_${Date.now()}.webm`;try{K=URL.createObjectURL(e)}catch(n){console.warn("createObjectURL failed",n),K=null}return K}function Ve(){return!!k}function Ye(){return K||null}function $e(){pe(),k=null,ue=null}function je(){return ue}async function De(e,t){const n=new FormData;n.append("file",e,t);const a=await fetch("/api/upload",{method:"POST",body:n});if(!a.ok)throw new Error("upload failed");const s=await a.json();if(!(s!=null&&s.url))throw new Error("upload response missing url");return s.url}async function Xe(){if(!k)throw new Error("no recording available");const e=ue||`moonAR_${Date.now()}.mp4`,t=new File([k],e,{type:k.type||"video/mp4"});try{if(navigator.canShare&&navigator.canShare({files:[t]}))return await navigator.share({files:[t],title:"月亮節 AR 影片",text:"分享給你"}),{ok:!0,method:"webshare"}}catch(n){console.warn("Web Share file error:",n)}try{const n=await De(k,e);if(navigator.share)try{return await navigator.share({title:"月亮節 AR 影片",text:"看這個影片：",url:n}),{ok:!0,method:"url-share",url:n}}catch(a){console.warn("Web Share URL error:",a)}return{ok:!0,method:"uploaded",url:n}}catch(n){throw console.warn("upload failed:",n),n}}let z=null,ee=null,j=null,V=!1,Q=null,Ee=o.CAMERA.DEFAULT_FACING_MODE||"user",Ae=!1,C,q,Y,T,H,c,w,he,W,D,A=null,te=!1,G=e=>{},oe=e=>{},me=0,P=null,se={w:0,h:0},X=null;const x=document.createElement("canvas"),Te=x.getContext("2d");x.style.display="none";const ge=document.createElement("canvas"),B=ge.getContext("2d");ge.style.display="none";const ce=document.createElement("canvas"),Fe=ce.getContext("2d"),le=document.createElement("canvas"),ae=le.getContext("2d"),de=document.createElement("canvas"),ie=de.getContext("2d");let re=0,Se=-1;function ve(){const e=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),t=(navigator.hardwareConcurrency||4)<=2;e&&(o.CAMERA.DEFAULT_WIDTH=480,o.CAMERA.DEFAULT_HEIGHT=360,o.FACE_DETECTION.MODEL="short",o.EFFECTS.STAR_COUNT=3,o.EFFECTS.SPARKLE_COUNT=2),t&&(o.PERFORMANCE.LOW_PERFORMANCE_MODE=!0,o.FACE_DETECTION.MIN_DETECTION_CONFIDENCE=.6,o.CAMERA.FRAME_RATE=20,o.EFFECTS.MOON_SIZE_SCALE=.8)}function ye(){var t;const e=[];return(o.FACE_DETECTION.MIN_DETECTION_CONFIDENCE<0||o.FACE_DETECTION.MIN_DETECTION_CONFIDENCE>1)&&e.push("MIN_DETECTION_CONFIDENCE 必須在 0~1 之間"),(t=navigator.mediaDevices)!=null&&t.getUserMedia||e.push("瀏覽器不支援相機功能"),e}function ze(){try{localStorage.setItem("moonFestivalAR_config",JSON.stringify(o))}catch{}}function Qe(){try{localStorage.removeItem("moonFestivalAR_config")}catch{}location.reload()}function Ge(){try{const e=localStorage.getItem("moonFestivalAR_config");e&&Object.assign(o,JSON.parse(e))}catch{}}function Ue(){var t;Ge(),ve(),o.CAMERA.WIDTH=o.CAMERA.DEFAULT_WIDTH||o.CAMERA.WIDTH||1280,o.CAMERA.HEIGHT=o.CAMERA.DEFAULT_HEIGHT||o.CAMERA.HEIGHT||720,o.CAMERA.FACING=o.CAMERA.DEFAULT_FACING_MODE||o.CAMERA.FACING||"user",o.SEGMENTER=o.SEGMENTER||{},o.SEGMENTER.USE_LANDSCAPE_MODEL=o.SEGMENTATION&&o.SEGMENTATION.MODEL_SELECTION===1?!0:o.SEGMENTER.USE_LANDSCAPE_MODEL??!0,o.SEGMENTER.USE_GPU=o.SEGMENTER.USE_GPU??!0,o.SMOOTHING=o.SMOOTHING||{},o.SMOOTHING.THRESHOLD=o.SMOOTHING.THRESHOLD??((t=o.SEGMENTATION)==null?void 0:t.SEGMENTATION_THRESHOLD)??.38,o.SMOOTHING.TEMPORAL_ALPHA=o.SMOOTHING.TEMPORAL_ALPHA??.6,o.SMOOTHING.EDGE_FEATHER_PX=o.SMOOTHING.EDGE_FEATHER_PX??3,o.SMOOTHING.HYS_ON=o.SMOOTHING.HYS_ON??o.SMOOTHING.THRESHOLD-.15,o.SMOOTHING.HYS_OFF=o.SMOOTHING.HYS_OFF??o.SMOOTHING.THRESHOLD+.15,o.SMOOTHING.MASK_GROW_PX=o.SMOOTHING.MASK_GROW_PX??1.5,o.MODELS||(o.MODELS={SELFIE_SEGMENTER_LANDSCAPE:"https://storage.googleapis.com/mediapipe-models/image_segmenter/selfie_segmenter_landscape/float16/latest/selfie_segmenter_landscape.tflite",SELFIE_SEGMENTER_SQUARE:"https://storage.googleapis.com/mediapipe-models/image_segmenter/selfie_segmenter/float16/latest/selfie_segmenter.tflite",FACE_DETECTOR:"https://storage.googleapis.com/mediapipe-models/face_detector/blaze_face_short_range/float16/latest/blaze_face_short_range.tflite"}),o.WASM_BASE=o.WASM_BASE||"https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.7/wasm";const e=ye();return e.length?(console.error("配置驗證失敗：",e),!1):!0}function qe(e,t={}){C=e.videoEl,q=e.bgCanvas,Y=e.maskCanvas,T=e.outCanvas,H=e.bgVideoEl||null,e.bgGifEl,c=e.bgMoonVideoEl||null,w=e.iosMoonVideoEl||null,te=e.isIOSDevice||!1,console.log("📱 SegmentationCore 設備資訊:",{isIOSDevice:te,hasIOSMoonVideo:!!w,hasNormalMoonVideo:!!c}),he=q.getContext("2d"),W=Y.getContext("2d"),D=T.getContext("2d"),typeof t.onStatus=="function"&&(G=t.onStatus),typeof t.onStats=="function"&&(oe=t.onStats),Ee=o.CAMERA.FACING||"user",Le()}function Le(){const e=new Image;e.onload=()=>{A=e,console.log("✅ 自定義背景圖片載入完成")},e.onerror=n=>{console.warn("⚠️ 自定義背景圖片載入失敗:",n)};const t="/range_rover_moon_fastival_public/";e.src=t+"pexels-photo-623218.jpeg"}async function He(){if(window.FilesetResolver&&window.ImageSegmenter)return!0;const e=["https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.7/vision_bundle.mjs","https://unpkg.com/@mediapipe/tasks-vision@0.10.7/vision_bundle.mjs"];for(const t of e)try{const n=await import(t);return n.FilesetResolver&&(window.FilesetResolver=n.FilesetResolver),n.ImageSegmenter&&(window.ImageSegmenter=n.ImageSegmenter),n.FaceDetector&&(window.FaceDetector=n.FaceDetector),!0}catch(n){console.warn("[WARN] failed to import tasks-vision from",t,n)}throw new Error("無法載入 @mediapipe/tasks-vision 模組")}async function be(){j||(j=await FilesetResolver.forVisionTasks(o.WASM_BASE));try{const t=T.getBoundingClientRect();o.SEGMENTER.USE_LANDSCAPE_MODEL=(t.width||1)>=(t.height||1)}catch{}const e={modelAssetPath:o.SEGMENTER.USE_LANDSCAPE_MODEL?o.MODELS.SELFIE_SEGMENTER_LANDSCAPE:o.MODELS.SELFIE_SEGMENTER_SQUARE,delegate:o.SEGMENTER.USE_GPU?"GPU":"CPU"};try{z=await ImageSegmenter.createFromOptions(j,{baseOptions:e,runningMode:"VIDEO",outputCategoryMask:!1,outputConfidenceMasks:!0})}catch(t){console.warn("[Segmenter] GPU 失敗，改用 CPU:",t),z=await ImageSegmenter.createFromOptions(j,{baseOptions:{...e,delegate:"CPU"},runningMode:"VIDEO",outputCategoryMask:!1,outputConfidenceMasks:!0})}try{ee=await FaceDetector.createFromOptions(j,{baseOptions:{modelAssetPath:o.MODELS.FACE_DETECTOR,delegate:"GPU"},runningMode:"VIDEO",minDetectionConfidence:.6,minSuppressionThreshold:.3})}catch(t){console.warn("[FaceDetector] GPU 失敗，改用 CPU:",t),ee=await FaceDetector.createFromOptions(j,{baseOptions:{modelAssetPath:o.MODELS.FACE_DETECTOR,delegate:"CPU"},runningMode:"VIDEO",minDetectionConfidence:.6,minSuppressionThreshold:.3})}}async function Oe(){if(Q)try{Q.getTracks().forEach(t=>t.stop())}catch{}const e={audio:!1,video:{facingMode:Ee,width:{ideal:o.CAMERA.WIDTH},height:{ideal:o.CAMERA.HEIGHT},frameRate:{ideal:o.CAMERA.FRAME_RATE}}};Q=await navigator.mediaDevices.getUserMedia(e),C.srcObject=Q,C.setAttribute("playsinline",""),C.muted=!0,C.autoplay=!0,await new Promise(t=>{if(C.readyState>=1&&C.videoWidth&&C.videoHeight)return t();C.onloadedmetadata=()=>t(),setTimeout(t,1500)});try{await C.play()}catch{}Ce()}async function Je(){Ee=Ee==="user"?"environment":"user",await Oe()}function Ce(){const t=(T.closest(".stage")||T.parentElement).getBoundingClientRect(),n=Math.max(1,Math.round(t.width)),a=Math.max(1,Math.round(t.height));[q,Y,T,x,ge].forEach(s=>{(s.width!==n||s.height!==a)&&(s.width=n,s.height=a),s.style.width=`${n}px`,s.style.height=`${a}px`}),se={w:T.width,h:T.height}}function Pe(e,t,n){const a=o.BACKGROUND&&o.BACKGROUND.TYPE||o.BACKGROUND_EFFECTS&&o.BACKGROUND_EFFECTS.DEFAULT_BACKGROUND||"original",s=o.BACKGROUND&&typeof o.BACKGROUND.INTENSITY=="number"?o.BACKGROUND.INTENSITY:(o.BACKGROUND_EFFECTS&&o.BACKGROUND_EFFECTS.EFFECT_INTENSITY)??.5;if(e.clearRect(0,0,t,n),re+=.016,a!=="original"){if(a==="waves"){const i=e.createLinearGradient(0,0,t,n);i.addColorStop(0,"#1a2332"),i.addColorStop(.5,"#2d3a50"),i.addColorStop(1,"#0f1419"),e.fillStyle=i,e.fillRect(0,0,t,n),e.strokeStyle=`rgba(100,200,255,${s*.6})`,e.lineWidth=2;for(let l=0;l<8;l++){e.beginPath();for(let r=0;r<t;r+=5){const h=l*50,E=n/2+Math.sin((r+h)*.012+re*1.2)*20*s;r===0?e.moveTo(r,E):e.lineTo(r,E)}e.stroke()}return}if(a==="frequency"){e.fillStyle="#0a0a0a",e.fillRect(0,0,t,n);const i=48,l=t/i;for(let r=0;r<i;r++){const h=r*l,E=(Math.sin(re*2+r*.2)*.5+.5)*n*.5*s,d=(re*30+r*10)%360;e.fillStyle=`hsla(${d},70%,60%,0.8)`,e.fillRect(h,n-E,l-1,E)}return}if(a==="video"&&H){const i=H.videoWidth||1,l=H.videoHeight||1;if(H.readyState>=2){const r=Math.max(t/i,n/l),h=Math.round(i*r),E=Math.round(l*r),d=Math.round((t-h)/2),g=Math.round((n-E)/2);try{H.paused&&H.play().catch(()=>{})}catch{}e.globalAlpha=Math.min(1,.3+s*.7),e.drawImage(H,0,0,i,l,d,g,h,E),e.globalAlpha=1}return}if(a==="moon_video"&&c){try{if(c.readyState>=2&&!c.paused){const i=c.videoWidth||c.width||1,l=c.videoHeight||c.height||1;if(i>1&&l>1){const r=Math.max(t/i,n/l),h=Math.round(i*r),E=Math.round(l*r),d=Math.round((t-h)/2),g=Math.round((n-E)/2);e.globalAlpha=Math.min(1,.3+s*.7),e.drawImage(c,0,0,i,l,d,g,h,E),e.globalAlpha=1}else console.warn("🌙 Moon video dimensions too small:",{vw:i,vh:l})}else c.paused?c.play().catch(i=>console.warn("月相影片播放失敗:",i)):console.warn("🌙 Moon video not ready:",{readyState:c.readyState,paused:c.paused})}catch(i){console.warn("月相影片渲染錯誤:",i)}return}if(a==="custom_moon_bg"&&A){try{if(te){if(A){const i=A.naturalWidth||A.width,l=A.naturalHeight||A.height;if(i>0&&l>0){const r=Math.max(t/i,n/l),h=Math.round(i*r),E=Math.round(l*r),d=Math.round((t-h)/2),g=Math.round((n-E)/2);e.drawImage(A,0,0,i,l,d,g,h,E)}}return}if(A){const i=A.naturalWidth||A.width,l=A.naturalHeight||A.height;if(i>0&&l>0){const r=Math.max(t/i,n/l),h=Math.round(i*r),E=Math.round(l*r),d=Math.round((t-h)/2),g=Math.round((n-E)/2);e.drawImage(A,0,0,i,l,d,g,h,E)}}if(c&&c.readyState>=2&&!c.paused){const i=c.videoWidth||c.width||1,l=c.videoHeight||c.height||1;if(i>1&&l>1){e.save();const r=t/n;let h,E,d;r>.6?(h=t*.5,E=n*.35,d=Math.min(t,n)*.25):r>.5?(h=t*.51,E=n*.29,d=Math.min(t,n)*.29):(h=t*.51,E=n*.26,d=Math.min(t,n)*.3),e.beginPath(),e.arc(h,E,d,0,2*Math.PI),e.clip();const g=Math.max(t/i,n/l),v=Math.round(i*g),u=Math.round(l*g),S=Math.round((t-v)/2),R=Math.round((n-u)/2);e.globalAlpha=Math.min(1,.8+s*.2),e.drawImage(c,0,0,i,l,S,R,v,u),e.globalAlpha=1,e.restore()}}else c&&c.paused&&c.play().catch(i=>console.warn("月相影片播放失敗:",i))}catch(i){console.warn("自定義背景 + 圓形月亮渲染錯誤:",i)}return}}}function Be(e,t){Pe(he,e,t)}function ke(e,t,n){const a=t*n;if(!P||se.w!==t||se.h!==n)return P=new Float32Array(a),P.set(e),se={w:t,h:n},P;const s=o.SMOOTHING.TEMPORAL_ALPHA;for(let i=0;i<a;i++)P[i]=s*P[i]+(1-s)*e[i];return P}function We(e,t,n){const a=o.SMOOTHING.THRESHOLD,s=t*n,i=new ImageData(t,n);for(let E=0,d=0;E<s;E++,d+=4){const g=e[E],v=g>=a?Math.min(255,Math.round(g*255)):0;i.data[d]=0,i.data[d+1]=0,i.data[d+2]=0,i.data[d+3]=v}ce.width=t,ce.height=n,Fe.putImageData(i,0,0);const l=T.width,r=T.height;le.width=l,le.height=r,ae.clearRect(0,0,l,r),ae.imageSmoothingEnabled=!0,ae.imageSmoothingQuality="high",ae.drawImage(ce,0,0,l,r);const h=o.SMOOTHING.EDGE_FEATHER_PX;return de.width=l,de.height=r,ie.clearRect(0,0,l,r),ie.filter=h>0?`blur(${h}px)`:"none",ie.drawImage(le,0,0),ie.filter="none",de}function xe(e){const t=T.width;T.height,D.save(),D.translate(t,0),D.scale(-1,1);const n=e;D.restore();const a=n.length>=o.FACE_DETECTION_SETTINGS.REQUIRED_FACES;a!==Ae&&(a?typeof G=="function"&&G("TRIGGER_TEST_EFFECT"):typeof G=="function"&&G("STOP_TEST_EFFECT"),Ae=a),oe({faceCount:e.length,facesInArea:n.length,moonActive:n.length>=o.FACE_DETECTION_SETTINGS.REQUIRED_FACES})}async function _e(){var d,g,v;if(!V)return;const e=performance.now(),t=T.width,n=T.height;D.clearRect(0,0,t,n),Be(t,n),Te.clearRect(0,0,t,n);const a=C.videoWidth||1,s=C.videoHeight||1,i=Math.max(t/a,n/s),l=Math.round(a*i),r=Math.round(s*i),h=Math.round((t-l)/2),E=Math.round((n-r)/2);try{Te.drawImage(C,0,0,a,s,h,E,l,r)}catch{}if(z&&o.SEGMENTATION.ENABLED){if(C.currentTime!==Se){Se=C.currentTime;try{const u=z.segmentForVideo?z.segmentForVideo(x,e):await z.segment(x);if(u){let S=null,R=0,L=0;if(u.confidenceMasks&&u.confidenceMasks.length){const _=me<u.confidenceMasks.length?me:0,I=u.confidenceMasks[_];if(I!=null&&I.getAsFloat32Array){const f=I.getAsFloat32Array();S=new Float32Array(f.length),S.set(f),R=I.width,L=I.height}for(const f of u.confidenceMasks)try{(d=f==null?void 0:f.close)==null||d.call(f)}catch{}}else if((g=u.categoryMask)!=null&&g.getAsUint8Array){const _=u.categoryMask,I=_.getAsUint8Array();S=new Float32Array(I.length),R=_.width,L=_.height;const f=me;for(let y=0;y<I.length;y++)S[y]=I[y]===f?1:0;try{(v=_.close)==null||v.call(_)}catch{}}if(S&&R&&L){const _=ke(S,R,L);X=We(_,R,L)}}}catch(u){console.warn("segmentForVideo error:",u)}}}else X=null;if(B.clearRect(0,0,t,n),B.save(),B.drawImage(x,0,0,t,n),X&&(B.globalCompositeOperation="destination-in",B.drawImage(X,0,0,t,n),B.globalCompositeOperation="source-over"),B.restore(),D.save(),D.translate(t,0),D.scale(-1,1),D.drawImage(ge,0,0,t,n),D.restore(),W.clearRect(0,0,t,n),X&&Ne?(W.globalAlpha=.9,W.drawImage(X,0,0,t,n),W.globalAlpha=1,Y.style.display="block"):Y.style.display="none",ee)try{const u=ee.detectForVideo?ee.detectForVideo(x,e):null;u&&xe(u.detections||[])}catch(u){console.warn("faceDetector error:",u)}requestAnimationFrame(_e)}async function Ze(){if(V)return;if(!Ue()){G("配置錯誤，請檢查控制台");return}G("初始化..."),await He(),await be(),await Oe(),V=!0,G("檢測中"),requestAnimationFrame(_e)}function et(){V=!1;try{Q&&Q.getTracks().forEach(e=>e.stop())}catch{}D&&W&&he&&(D.clearRect(0,0,T.width,T.height),W.clearRect(0,0,Y.width,Y.height),he.clearRect(0,0,q.width,q.height)),oe({faceCount:0,facesInArea:0,moonActive:!1}),G("已停止")}function tt(){V&&Ce()}let Ne=!1;function ot(e){Ne=!!e}function nt(e){o.SEGMENTATION.ENABLED=!!e}function at(e){o.BACKGROUND.TYPE=e}function it(e){o.BACKGROUND.INTENSITY=Math.max(0,Math.min(1,e))}function rt(e){o.SMOOTHING.EDGE_FEATHER_PX=Math.max(0,Number(e)||0)}function st(e){o.SMOOTHING.TEMPORAL_ALPHA=Math.max(0,Math.min(.95,Number(e)||0))}function ct(e){o.SMOOTHING.THRESHOLD=Math.max(0,Math.min(1,Number(e)||0))}function lt(e){o.BACKGROUND.GIF_BLEND_MODE=e}function dt(e){}function Et(){return V}async function ht(){if(!T||!V)return console.warn("無法拍照：相機未啟動或畫布不存在"),null;try{const e=document.createElement("canvas"),t=e.getContext("2d"),n=T.width,a=T.height;e.width=n,e.height=a;const s=o.BACKGROUND&&o.BACKGROUND.TYPE;if(console.log("📸 拍照檢查背景類型:",{bgType:s,hasMoonVideo:!!c}),(s==="moon_video"||s==="custom_moon_bg")&&c){console.log("🌙 月相影片模式：生成 8 秒動態影片..."),t.drawImage(T,0,0,n,a);const E=e.toDataURL("image/png",1);try{const d=await Ke(E,n,a);return console.log("✅ 影片生成完成:",d),d}catch(d){console.error("❌ 影片生成失敗:",d);const g=e.toDataURL("image/png",1),v=new Date().toISOString().replace(/[:]/g,"-").split(".")[0],u=document.createElement("a"),S=`月亮節AR拍照_${v}.png`;return u.download=S,u.href=g,document.body.appendChild(u),u.click(),document.body.removeChild(u),{png:g,error:"影片生成失敗，已保存為圖片"}}}else t.drawImage(q,0,0,n,a),t.drawImage(T,0,0,n,a);const i=e.toDataURL("image/png",1),l=new Date().toISOString().replace(/[:]/g,"-").split(".")[0],r=document.createElement("a"),h=`月亮節AR拍照_${l}.png`;return r.download=h,r.href=i,document.body.appendChild(r),r.click(),document.body.removeChild(r),console.log("📸 PNG 拍照成功！"),{png:i}}catch(e){return console.error("拍照失敗：",e),null}}let b=null,Z="mp4";function ut(e){b=e}function gt(e){Z=e}async function Ke(e,t,n){console.log("🎬 開始錄製靜止人物 + 動態背景影片...");try{if(!window.MediaRecorder)return console.warn("瀏覽器不支援 MediaRecorder"),{png:e,error:"瀏覽器不支援影片錄製"};const a=document.createElement("canvas"),s=a.getContext("2d"),i=640,l=t/n;t>n?(a.width=Math.min(i,t),a.height=Math.round(a.width/l)):(a.height=Math.min(i,n),a.width=Math.round(a.height*l)),console.log(`錄製 Canvas 尺寸: ${a.width}x${a.height} (原始: ${t}x${n}, 比例: ${l.toFixed(2)})`);const r=new Image;return new Promise((h,E)=>{r.onload=async()=>{console.log("靜止人物圖片載入完成，開始錄製...");const d=8,g=20,v=d*g;c&&c.paused&&await c.play().catch(f=>console.warn("影片播放失敗:",f));const u=a.captureStream(g);let S;Z==="mp4"?MediaRecorder.isTypeSupported("video/mp4; codecs=h264")?S={mimeType:"video/mp4; codecs=h264",videoBitsPerSecond:3e6}:MediaRecorder.isTypeSupported("video/mp4")?S={mimeType:"video/mp4",videoBitsPerSecond:3e6}:(console.warn("瀏覽器不支援 MP4，降級到 WebM"),S={mimeType:"video/webm; codecs=vp8",videoBitsPerSecond:3e6},Z="webm"):S={mimeType:"video/webm; codecs=vp8",videoBitsPerSecond:3e6};const R=new MediaRecorder(u,S);console.log(`📹 使用格式: ${S.mimeType}`);const L=[];R.ondataavailable=f=>{f.data.size>0&&L.push(f.data)},R.onstop=()=>{const f=Z==="mp4"?"video/mp4":"video/webm",y=Z==="mp4"?"mp4":"webm",$=new Blob(L,{type:f}),ne=`月亮節AR_月相影片_${new Date().toISOString().replace(/[:]/g,"-").split(".")[0]}.${y}`,m=we($,ne);typeof G=="function"&&G("影片已生成，可按 分享 或 下載"),typeof oe=="function"&&oe({lastVideoUrl:m,lastVideoFilename:ne}),h({png:e,video:m,duration:d,format:y,saved:!0})},R.onerror=f=>{console.error("錄製錯誤:",f.error),E(f.error)},R.start(),console.log(`開始錄製 ${d} 秒影片...`),b&&(b.setStatus("開始錄製..."),b.updateProgress(0,d));let _=0;function I(){s.clearRect(0,0,a.width,a.height);const f=o.BACKGROUND&&o.BACKGROUND.TYPE,y=o.BACKGROUND.INTENSITY||.5;if(f==="custom_moon_bg"&&A){if(A){const m=A.naturalWidth||A.width,M=A.naturalHeight||A.height;if(m>0&&M>0){const N=Math.max(a.width/m,a.height/M),p=Math.round(m*N),O=Math.round(M*N),F=Math.round((a.width-p)/2),U=Math.round((a.height-O)/2);s.drawImage(A,0,0,m,M,F,U,p,O)}}if(console.log("🎬 錄影月亮檢查:",{isIOSDevice:te,hasIosMoonVideo:!!w,iosMoonVideoReady:(w==null?void 0:w.readyState)>=2,hasBgMoonVideo:!!c,bgMoonVideoReady:(c==null?void 0:c.readyState)>=2}),te&&w&&w.readyState>=2){console.log("🍎 錄影使用 iOS 透明 MOV 模式");const m=w.videoWidth||w.width||1,M=w.videoHeight||w.height||1;if(m>1&&M>1){const N=Math.max(a.width/m,a.height/M),p=Math.round(m*N),O=Math.round(M*N),F=Math.round((a.width-p)/2),U=Math.round((a.height-O)/2);s.globalAlpha=Math.min(1,.8+y*.2),s.drawImage(w,0,0,m,M,F,U,p,O),s.globalAlpha=1}}else if(c&&c.readyState>=2){console.log("💿 錄影使用傳統 MP4 + 圓形遮罩模式");const m=c.videoWidth||c.width||1,M=c.videoHeight||c.height||1;if(m>1&&M>1){s.save();const N=a.width/a.height;let p,O,F;N>.6?(p=a.width*.5,O=a.height*.35,F=Math.min(a.width,a.height)*.25):N>.5?(p=a.width*.51,O=a.height*.29,F=Math.min(a.width,a.height)*.29):(p=a.width*.51,O=a.height*.26,F=Math.min(a.width,a.height)*.3),s.beginPath(),s.arc(p,O,F,0,2*Math.PI),s.clip();const U=Math.max(a.width/m,a.height/M),fe=Math.round(m*U),Me=Math.round(M*U),Re=Math.round((a.width-fe)/2),Ie=Math.round((a.height-Me)/2);s.globalAlpha=Math.min(1,.8+y*.2),s.drawImage(c,0,0,m,M,Re,Ie,fe,Me),s.globalAlpha=1,s.restore()}}}else if(c&&c.readyState>=2){const m=c.videoWidth||c.width||1,M=c.videoHeight||c.height||1;if(m>1&&M>1){const N=Math.max(a.width/m,a.height/M),p=Math.round(m*N),O=Math.round(M*N),F=Math.round((a.width-p)/2),U=Math.round((a.height-O)/2);s.globalAlpha=Math.min(1,.3+y*.7),s.drawImage(c,0,0,m,M,F,U,p,O),s.globalAlpha=1}}const $=r.naturalWidth||r.width,J=r.naturalHeight||r.height;if($>0&&J>0){const m=a.width/$,M=a.height/J,N=Math.max(m,M),p=Math.round($*N),O=Math.round(J*N),F=Math.round((a.width-p)/2),U=Math.round((a.height-O)/2);s.drawImage(r,0,0,$,J,F,U,p,O)}else s.drawImage(r,0,0,a.width,a.height);_++;const ne=_/g;b&&b.updateProgress(ne,d),_<v?setTimeout(I,1e3/g):(b&&b.setStatus("錄製完成，正在生成檔案..."),R.stop(),console.log("所有幀錄製完成"))}I()},r.onerror=()=>{E(new Error("靜止人物圖片載入失敗"))},r.src=e})}catch(a){return console.error("影片生成錯誤:",a),{png:e,error:a.message}}}export{o as CONFIG,ht as capturePhoto,$e as clearLastRecording,je as getLastRecordingFilename,Ye as getLastRecordingUrl,Ve as hasRecordingAvailable,qe as initCore,Ue as initializeConfig,Et as isRunning,tt as onResize,Qe as resetConfig,ze as saveConfig,it as setBackgroundIntensity,at as setBackgroundType,rt as setEdgeFeather,nt as setEnableSegmentation,lt as setGifBlendMode,ut as setRecordingProgressCallback,dt as setShouldGenerateGif,ot as setShowMaskPreview,st as setTemporalAlpha,ct as setThreshold,gt as setVideoOutputFormat,Xe as shareLastRecording,Ze as start,et as stop,we as storeRecordingBlob,Je as switchCamera,Ce as syncCanvasSize,De as uploadBlobToServerAndGetUrl};
//# sourceMappingURL=segmentationCore-DKt6jZOc.js.map
