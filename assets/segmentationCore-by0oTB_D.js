const o={FACE_DETECTION:{MODEL:"short",MIN_DETECTION_CONFIDENCE:.5,MAX_FACES:10},SEGMENTATION:{ENABLED:!0,MODEL_SELECTION:1,SELFIE_MODE:!0,SEGMENTATION_THRESHOLD:.1},FACE_DETECTION_SETTINGS:{REQUIRED_FACES:1},CAMERA:{DEFAULT_WIDTH:640,DEFAULT_HEIGHT:480,DEFAULT_FACING_MODE:"user",FRAME_RATE:30},UI:{STATUS_UPDATE_INTERVAL:100,SHOW_DEBUG_INFO:!0,SHOW_FPS:!1,LANGUAGE:"zh-TW"},EFFECTS:{MOON_EFFECT_DURATION:3e3,FADE_DURATION:800,ENABLE_SOUND:!1,MOON_SIZE_SCALE:1,STAR_COUNT:5,SPARKLE_COUNT:3},BACKGROUND_EFFECTS:{DEFAULT_BACKGROUND:"moon_video",WAVE_EFFECT:{AMPLITUDE:10,FREQUENCY:.02,SPEED:.05},FREQUENCY_EFFECT:{BANDS:32,HEIGHT_SCALE:.8,COLOR_SHIFT:.01},EFFECT_INTENSITY:.5,BLEND_MODE:"source-over"},PERFORMANCE:{ENABLE_MONITORING:!1,MAX_LATENCY:100,LOW_PERFORMANCE_MODE:!1,AUTO_ADJUST_PERFORMANCE:!0},DEBUG:{VERBOSE_LOGGING:!1,SHOW_FACE_LANDMARKS:!1,SAVE_DETECTION_RESULTS:!1},ADVANCED:{MEDIAPIPE_BASE_URL:"https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/",MEDIAPIPE_SEGMENTATION_URL:"https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/",USE_WEB_WORKERS:!1,MEMORY_LIMIT:512,ENABLE_ERROR_REPORTING:!0}};o.BACKGROUND=o.BACKGROUND||{TYPE:o.BACKGROUND_EFFECTS&&o.BACKGROUND_EFFECTS.DEFAULT_BACKGROUND||"original",INTENSITY:(o.BACKGROUND_EFFECTS&&o.BACKGROUND_EFFECTS.EFFECT_INTENSITY)??.5,GIF_BLEND_MODE:"overlay"};let W=null,me=null,V=null;function _e(){try{V&&(URL.revokeObjectURL(V),V=null)}catch(e){console.warn("revoke failed",e)}}function De(e,n){if(!e)return null;_e(),W=e,me=n||`moonAR_${Date.now()}.webm`;try{V=URL.createObjectURL(e)}catch(a){console.warn("createObjectURL failed",a),V=null}return V}function Ye(){return!!W}function $e(){return V||null}function je(){_e(),W=null,me=null}function Xe(){return me}async function Fe(e,n){const a=new FormData;a.append("file",e,n);const t=await fetch("/api/upload",{method:"POST",body:a});if(!t.ok)throw new Error("upload failed");const i=await t.json();if(!(i!=null&&i.url))throw new Error("upload response missing url");return i.url}async function ze(){if(!W)throw new Error("no recording available");const e=me||`moonAR_${Date.now()}.mp4`,n=new File([W],e,{type:W.type||"video/mp4"});try{if(navigator.canShare&&navigator.canShare({files:[n]}))return await navigator.share({files:[n],title:"æœˆäº®ç¯€ AR å½±ç‰‡",text:"åˆ†äº«çµ¦ä½ "}),{ok:!0,method:"webshare"}}catch(a){console.warn("Web Share file error:",a)}try{const a=await Fe(W,e);if(navigator.share)try{return await navigator.share({title:"æœˆäº®ç¯€ AR å½±ç‰‡",text:"çœ‹é€™å€‹å½±ç‰‡ï¼š",url:a}),{ok:!0,method:"url-share",url:a}}catch(t){console.warn("Web Share URL error:",t)}return{ok:!0,method:"uploaded",url:a}}catch(a){throw console.warn("upload failed:",a),a}}let z=null,ne=null,j=null,Y=!1,Q=null,ge=o.CAMERA.DEFAULT_FACING_MODE||"user",pe=!1,I,J,$,C,y,s,D,ue,x,G,u=null,q=!1,L=e=>{},ae=e=>{},Te=0,B=null,le={w:0,h:0},X=null;const K=document.createElement("canvas"),Oe=K.getContext("2d");K.style.display="none";const fe=document.createElement("canvas"),k=fe.getContext("2d");fe.style.display="none";const de=document.createElement("canvas"),ve=de.getContext("2d"),he=document.createElement("canvas"),se=he.getContext("2d"),Ee=document.createElement("canvas"),re=Ee.getContext("2d");let ce=0,Ce=-1;function ye(){const e=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),n=(navigator.hardwareConcurrency||4)<=2;e&&(o.CAMERA.DEFAULT_WIDTH=480,o.CAMERA.DEFAULT_HEIGHT=360,o.FACE_DETECTION.MODEL="short",o.EFFECTS.STAR_COUNT=3,o.EFFECTS.SPARKLE_COUNT=2),n&&(o.PERFORMANCE.LOW_PERFORMANCE_MODE=!0,o.FACE_DETECTION.MIN_DETECTION_CONFIDENCE=.6,o.CAMERA.FRAME_RATE=20,o.EFFECTS.MOON_SIZE_SCALE=.8)}function Ge(){var n;const e=[];return(o.FACE_DETECTION.MIN_DETECTION_CONFIDENCE<0||o.FACE_DETECTION.MIN_DETECTION_CONFIDENCE>1)&&e.push("MIN_DETECTION_CONFIDENCE å¿…é ˆåœ¨ 0~1 ä¹‹é–“"),(n=navigator.mediaDevices)!=null&&n.getUserMedia||e.push("ç€è¦½å™¨ä¸æ”¯æ´ç›¸æ©ŸåŠŸèƒ½"),e}function Qe(){try{localStorage.setItem("moonFestivalAR_config",JSON.stringify(o))}catch{}}function qe(){try{localStorage.removeItem("moonFestivalAR_config")}catch{}location.reload()}function Ue(){try{const e=localStorage.getItem("moonFestivalAR_config");e&&Object.assign(o,JSON.parse(e))}catch{}}function Le(){var n;Ue(),ye(),o.CAMERA.WIDTH=o.CAMERA.DEFAULT_WIDTH||o.CAMERA.WIDTH||1280,o.CAMERA.HEIGHT=o.CAMERA.DEFAULT_HEIGHT||o.CAMERA.HEIGHT||720,o.CAMERA.FACING=o.CAMERA.DEFAULT_FACING_MODE||o.CAMERA.FACING||"user",o.SEGMENTER=o.SEGMENTER||{},o.SEGMENTER.USE_LANDSCAPE_MODEL=o.SEGMENTATION&&o.SEGMENTATION.MODEL_SELECTION===1?!0:o.SEGMENTER.USE_LANDSCAPE_MODEL??!0,o.SEGMENTER.USE_GPU=o.SEGMENTER.USE_GPU??!0,o.SMOOTHING=o.SMOOTHING||{},o.SMOOTHING.THRESHOLD=o.SMOOTHING.THRESHOLD??((n=o.SEGMENTATION)==null?void 0:n.SEGMENTATION_THRESHOLD)??.38,o.SMOOTHING.TEMPORAL_ALPHA=o.SMOOTHING.TEMPORAL_ALPHA??.6,o.SMOOTHING.EDGE_FEATHER_PX=o.SMOOTHING.EDGE_FEATHER_PX??3,o.SMOOTHING.HYS_ON=o.SMOOTHING.HYS_ON??o.SMOOTHING.THRESHOLD-.15,o.SMOOTHING.HYS_OFF=o.SMOOTHING.HYS_OFF??o.SMOOTHING.THRESHOLD+.15,o.SMOOTHING.MASK_GROW_PX=o.SMOOTHING.MASK_GROW_PX??1.5,o.MODELS||(o.MODELS={SELFIE_SEGMENTER_LANDSCAPE:"https://storage.googleapis.com/mediapipe-models/image_segmenter/selfie_segmenter_landscape/float16/latest/selfie_segmenter_landscape.tflite",SELFIE_SEGMENTER_SQUARE:"https://storage.googleapis.com/mediapipe-models/image_segmenter/selfie_segmenter/float16/latest/selfie_segmenter.tflite",FACE_DETECTOR:"https://storage.googleapis.com/mediapipe-models/face_detector/blaze_face_short_range/float16/latest/blaze_face_short_range.tflite"}),o.WASM_BASE=o.WASM_BASE||"https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.7/wasm";const e=Ge();return e.length?(console.error("é…ç½®é©—è­‰å¤±æ•—ï¼š",e),!1):!0}function Je(e,n={}){I=e.videoEl,J=e.bgCanvas,$=e.maskCanvas,C=e.outCanvas,y=e.bgVideoEl||null,e.bgGifEl,s=e.bgMoonVideoEl||null,D=e.iosMoonVideoEl||null,q=e.isIOSDevice||!1,console.log("ğŸ“± SegmentationCore è¨­å‚™è³‡è¨Š:",{isIOSDevice:q,hasIOSMoonVideo:!!D,hasNormalMoonVideo:!!s}),ue=J.getContext("2d"),x=$.getContext("2d"),G=C.getContext("2d"),typeof n.onStatus=="function"&&(L=n.onStatus),typeof n.onStats=="function"&&(ae=n.onStats),ge=o.CAMERA.FACING||"user",be()}function be(){const e=new Image;e.onload=()=>{u=e,console.log("âœ… è‡ªå®šç¾©èƒŒæ™¯åœ–ç‰‡è¼‰å…¥å®Œæˆ")},e.onerror=a=>{console.warn("âš ï¸ è‡ªå®šç¾©èƒŒæ™¯åœ–ç‰‡è¼‰å…¥å¤±æ•—:",a)};const n="/range_rover_moon_fastival_public/";e.src=n+"pexels-photo-623218.jpeg"}async function He(){if(window.FilesetResolver&&window.ImageSegmenter)return!0;const e=["https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.7/vision_bundle.mjs","https://unpkg.com/@mediapipe/tasks-vision@0.10.7/vision_bundle.mjs"];for(const n of e)try{const a=await import(n);return a.FilesetResolver&&(window.FilesetResolver=a.FilesetResolver),a.ImageSegmenter&&(window.ImageSegmenter=a.ImageSegmenter),a.FaceDetector&&(window.FaceDetector=a.FaceDetector),!0}catch(a){console.warn("[WARN] failed to import tasks-vision from",n,a)}throw new Error("ç„¡æ³•è¼‰å…¥ @mediapipe/tasks-vision æ¨¡çµ„")}async function Pe(){j||(j=await FilesetResolver.forVisionTasks(o.WASM_BASE));try{const n=C.getBoundingClientRect();o.SEGMENTER.USE_LANDSCAPE_MODEL=(n.width||1)>=(n.height||1)}catch{}const e={modelAssetPath:o.SEGMENTER.USE_LANDSCAPE_MODEL?o.MODELS.SELFIE_SEGMENTER_LANDSCAPE:o.MODELS.SELFIE_SEGMENTER_SQUARE,delegate:o.SEGMENTER.USE_GPU?"GPU":"CPU"};try{z=await ImageSegmenter.createFromOptions(j,{baseOptions:e,runningMode:"VIDEO",outputCategoryMask:!1,outputConfidenceMasks:!0})}catch(n){console.warn("[Segmenter] GPU å¤±æ•—ï¼Œæ”¹ç”¨ CPU:",n),z=await ImageSegmenter.createFromOptions(j,{baseOptions:{...e,delegate:"CPU"},runningMode:"VIDEO",outputCategoryMask:!1,outputConfidenceMasks:!0})}try{ne=await FaceDetector.createFromOptions(j,{baseOptions:{modelAssetPath:o.MODELS.FACE_DETECTOR,delegate:"GPU"},runningMode:"VIDEO",minDetectionConfidence:.6,minSuppressionThreshold:.3})}catch(n){console.warn("[FaceDetector] GPU å¤±æ•—ï¼Œæ”¹ç”¨ CPU:",n),ne=await FaceDetector.createFromOptions(j,{baseOptions:{modelAssetPath:o.MODELS.FACE_DETECTOR,delegate:"CPU"},runningMode:"VIDEO",minDetectionConfidence:.6,minSuppressionThreshold:.3})}}async function Ne(){if(Q)try{Q.getTracks().forEach(n=>n.stop())}catch{}const e={audio:!1,video:{facingMode:ge,width:{ideal:o.CAMERA.WIDTH},height:{ideal:o.CAMERA.HEIGHT},frameRate:{ideal:o.CAMERA.FRAME_RATE}}};Q=await navigator.mediaDevices.getUserMedia(e),I.srcObject=Q,I.setAttribute("playsinline",""),I.muted=!0,I.autoplay=!0,await new Promise(n=>{if(I.readyState>=1&&I.videoWidth&&I.videoHeight)return n();I.onloadedmetadata=()=>n(),setTimeout(n,1500)});try{await I.play()}catch{}we()}async function Ze(){ge=ge==="user"?"environment":"user",await Ne()}function we(){const n=(C.closest(".stage")||C.parentElement).getBoundingClientRect(),a=Math.max(1,Math.round(n.width)),t=Math.max(1,Math.round(n.height));[J,$,C,K,fe].forEach(i=>{(i.width!==a||i.height!==t)&&(i.width=a,i.height=t),i.style.width=`${a}px`,i.style.height=`${t}px`}),le={w:C.width,h:C.height}}function Be(e,n,a){const t=o.BACKGROUND&&o.BACKGROUND.TYPE||o.BACKGROUND_EFFECTS&&o.BACKGROUND_EFFECTS.DEFAULT_BACKGROUND||"original",i=o.BACKGROUND&&typeof o.BACKGROUND.INTENSITY=="number"?o.BACKGROUND.INTENSITY:(o.BACKGROUND_EFFECTS&&o.BACKGROUND_EFFECTS.EFFECT_INTENSITY)??.5;if(e.clearRect(0,0,n,a),ce+=.016,t!=="original"){if(t==="waves"){const r=e.createLinearGradient(0,0,n,a);r.addColorStop(0,"#1a2332"),r.addColorStop(.5,"#2d3a50"),r.addColorStop(1,"#0f1419"),e.fillStyle=r,e.fillRect(0,0,n,a),e.strokeStyle=`rgba(100,200,255,${i*.6})`,e.lineWidth=2;for(let l=0;l<8;l++){e.beginPath();for(let c=0;c<n;c+=5){const M=l*50,g=a/2+Math.sin((c+M)*.012+ce*1.2)*20*i;c===0?e.moveTo(c,g):e.lineTo(c,g)}e.stroke()}return}if(t==="frequency"){e.fillStyle="#0a0a0a",e.fillRect(0,0,n,a);const r=48,l=n/r;for(let c=0;c<r;c++){const M=c*l,g=(Math.sin(ce*2+c*.2)*.5+.5)*a*.5*i,E=(ce*30+c*10)%360;e.fillStyle=`hsla(${E},70%,60%,0.8)`,e.fillRect(M,a-g,l-1,g)}return}if(t==="video"&&y){const r=y.videoWidth||1,l=y.videoHeight||1;if(y.readyState>=2){const c=Math.max(n/r,a/l),M=Math.round(r*c),g=Math.round(l*c),E=Math.round((n-M)/2),p=Math.round((a-g)/2);try{y.paused&&y.play().catch(()=>{})}catch{}e.globalAlpha=Math.min(1,.3+i*.7),e.drawImage(y,0,0,r,l,E,p,M,g),e.globalAlpha=1}return}if(t==="moon_video"&&s){try{if(s.readyState>=2&&!s.paused){const r=s.videoWidth||s.width||1,l=s.videoHeight||s.height||1;if(r>1&&l>1){const c=Math.max(n/r,a/l),M=Math.round(r*c),g=Math.round(l*c),E=Math.round((n-M)/2),p=Math.round((a-g)/2);e.globalAlpha=Math.min(1,.3+i*.7),e.drawImage(s,0,0,r,l,E,p,M,g),e.globalAlpha=1}else console.warn("ğŸŒ™ Moon video dimensions too small:",{vw:r,vh:l})}else s.paused?s.play().catch(r=>console.warn("æœˆç›¸å½±ç‰‡æ’­æ”¾å¤±æ•—:",r)):console.warn("ğŸŒ™ Moon video not ready:",{readyState:s.readyState,paused:s.paused})}catch(r){console.warn("æœˆç›¸å½±ç‰‡æ¸²æŸ“éŒ¯èª¤:",r)}return}if(t==="custom_moon_bg"&&u){try{if(q){if(u){const r=u.naturalWidth||u.width,l=u.naturalHeight||u.height;if(r>0&&l>0){const c=Math.max(n/r,a/l),M=Math.round(r*c),g=Math.round(l*c),E=Math.round((n-M)/2),p=Math.round((a-g)/2);e.drawImage(u,0,0,r,l,E,p,M,g)}}return}if(u){const r=u.naturalWidth||u.width,l=u.naturalHeight||u.height;if(r>0&&l>0){const c=Math.max(n/r,a/l),M=Math.round(r*c),g=Math.round(l*c),E=Math.round((n-M)/2),p=Math.round((a-g)/2);e.drawImage(u,0,0,r,l,E,p,M,g)}}if(s&&s.readyState>=2&&!s.paused){const r=s.videoWidth||s.width||1,l=s.videoHeight||s.height||1;if(r>1&&l>1){e.save();const c=n/a;let M,g,E;c>.6?(M=n*.5,g=a*.35,E=Math.min(n,a)*.25):c>.5?(M=n*.51,g=a*.29,E=Math.min(n,a)*.29):(M=n*.51,g=a*.26,E=Math.min(n,a)*.3),e.beginPath(),e.arc(M,g,E,0,2*Math.PI),e.clip();const p=Math.max(n/r,a/l),U=Math.round(r*p),T=Math.round(l*p),N=Math.round((n-U)/2),F=Math.round((a-T)/2);e.globalAlpha=Math.min(1,.8+i*.2),e.drawImage(s,0,0,r,l,N,F,U,T),e.globalAlpha=1,e.restore()}}else s&&s.paused&&s.play().catch(r=>console.warn("æœˆç›¸å½±ç‰‡æ’­æ”¾å¤±æ•—:",r))}catch(r){console.warn("è‡ªå®šç¾©èƒŒæ™¯ + åœ“å½¢æœˆäº®æ¸²æŸ“éŒ¯èª¤:",r)}return}}}function ke(e,n){Be(ue,e,n)}function We(e,n,a){const t=n*a;if(!B||le.w!==n||le.h!==a)return B=new Float32Array(t),B.set(e),le={w:n,h:a},B;const i=o.SMOOTHING.TEMPORAL_ALPHA;for(let r=0;r<t;r++)B[r]=i*B[r]+(1-i)*e[r];return B}function xe(e,n,a){const t=o.SMOOTHING.THRESHOLD,i=n*a,r=new ImageData(n,a);for(let g=0,E=0;g<i;g++,E+=4){const p=e[g],U=p>=t?Math.min(255,Math.round(p*255)):0;r.data[E]=0,r.data[E+1]=0,r.data[E+2]=0,r.data[E+3]=U}de.width=n,de.height=a,ve.putImageData(r,0,0);const l=C.width,c=C.height;he.width=l,he.height=c,se.clearRect(0,0,l,c),se.imageSmoothingEnabled=!0,se.imageSmoothingQuality="high",se.drawImage(de,0,0,l,c);const M=o.SMOOTHING.EDGE_FEATHER_PX;return Ee.width=l,Ee.height=c,re.clearRect(0,0,l,c),re.filter=M>0?`blur(${M}px)`:"none",re.drawImage(he,0,0),re.filter="none",Ee}function Ke(e){const n=C.width;C.height,G.save(),G.translate(n,0),G.scale(-1,1);const a=e;G.restore();const t=a.length>=o.FACE_DETECTION_SETTINGS.REQUIRED_FACES;t!==pe&&(t?typeof L=="function"&&L("TRIGGER_TEST_EFFECT"):typeof L=="function"&&L("STOP_TEST_EFFECT"),pe=t),ae({faceCount:e.length,facesInArea:a.length,moonActive:a.length>=o.FACE_DETECTION_SETTINGS.REQUIRED_FACES})}async function Re(){var E,p,U;if(!Y)return;const e=performance.now(),n=C.width,a=C.height;G.clearRect(0,0,n,a),ke(n,a),Oe.clearRect(0,0,n,a);const t=I.videoWidth||1,i=I.videoHeight||1,r=Math.max(n/t,a/i),l=Math.round(t*r),c=Math.round(i*r),M=Math.round((n-l)/2),g=Math.round((a-c)/2);try{Oe.drawImage(I,0,0,t,i,M,g,l,c)}catch{}if(z&&o.SEGMENTATION.ENABLED){if(I.currentTime!==Ce){Ce=I.currentTime;try{const T=z.segmentForVideo?z.segmentForVideo(K,e):await z.segment(K);if(T){let N=null,F=0,b=0;if(T.confidenceMasks&&T.confidenceMasks.length){const w=Te<T.confidenceMasks.length?Te:0,v=T.confidenceMasks[w];if(v!=null&&v.getAsFloat32Array){const A=v.getAsFloat32Array();N=new Float32Array(A.length),N.set(A),F=v.width,b=v.height}for(const A of T.confidenceMasks)try{(E=A==null?void 0:A.close)==null||E.call(A)}catch{}}else if((p=T.categoryMask)!=null&&p.getAsUint8Array){const w=T.categoryMask,v=w.getAsUint8Array();N=new Float32Array(v.length),F=w.width,b=w.height;const A=Te;for(let R=0;R<v.length;R++)N[R]=v[R]===A?1:0;try{(U=w.close)==null||U.call(w)}catch{}}if(N&&F&&b){const w=We(N,F,b);X=xe(w,F,b)}}}catch(T){console.warn("segmentForVideo error:",T)}}}else X=null;if(k.clearRect(0,0,n,a),k.save(),k.drawImage(K,0,0,n,a),X&&(k.globalCompositeOperation="destination-in",k.drawImage(X,0,0,n,a),k.globalCompositeOperation="source-over"),k.restore(),G.save(),G.translate(n,0),G.scale(-1,1),G.drawImage(fe,0,0,n,a),G.restore(),x.clearRect(0,0,n,a),X&&Ie?(x.globalAlpha=.9,x.drawImage(X,0,0,n,a),x.globalAlpha=1,$.style.display="block"):$.style.display="none",ne)try{const T=ne.detectForVideo?ne.detectForVideo(K,e):null;T&&Ke(T.detections||[])}catch(T){console.warn("faceDetector error:",T)}requestAnimationFrame(Re)}async function et(){if(Y)return;if(!Le()){L("é…ç½®éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°");return}L("åˆå§‹åŒ–..."),await He(),await Pe(),await Ne(),Y=!0,L("æª¢æ¸¬ä¸­"),requestAnimationFrame(Re)}function tt(){Y=!1;try{Q&&Q.getTracks().forEach(e=>e.stop())}catch{}G&&x&&ue&&(G.clearRect(0,0,C.width,C.height),x.clearRect(0,0,$.width,$.height),ue.clearRect(0,0,J.width,J.height)),ae({faceCount:0,facesInArea:0,moonActive:!1}),L("å·²åœæ­¢")}function ot(){Y&&we()}let Ie=!1;function nt(e){Ie=!!e}function at(e){o.SEGMENTATION.ENABLED=!!e}function it(e){o.BACKGROUND.TYPE=e}function st(e){o.BACKGROUND.INTENSITY=Math.max(0,Math.min(1,e))}function rt(e){o.SMOOTHING.EDGE_FEATHER_PX=Math.max(0,Number(e)||0)}function ct(e){o.SMOOTHING.TEMPORAL_ALPHA=Math.max(0,Math.min(.95,Number(e)||0))}function lt(e){o.SMOOTHING.THRESHOLD=Math.max(0,Math.min(1,Number(e)||0))}function dt(e){o.BACKGROUND.GIF_BLEND_MODE=e}function ht(e){}function Et(){return Y}async function gt(){if(!C||!Y)return console.warn("ç„¡æ³•æ‹ç…§ï¼šç›¸æ©Ÿæœªå•Ÿå‹•æˆ–ç•«å¸ƒä¸å­˜åœ¨"),null;try{const e=document.createElement("canvas"),n=e.getContext("2d"),a=C.width,t=C.height;e.width=a,e.height=t;const i=o.BACKGROUND&&o.BACKGROUND.TYPE;if(console.log("ğŸ“¸ æ‹ç…§æª¢æŸ¥èƒŒæ™¯é¡å‹:",{bgType:i,hasMoonVideo:!!s}),(i==="moon_video"||i==="custom_moon_bg")&&s){console.log("ğŸŒ™ æœˆç›¸å½±ç‰‡æ¨¡å¼ï¼šç”Ÿæˆ 8 ç§’å‹•æ…‹å½±ç‰‡..."),n.drawImage(C,0,0,a,t);const g=e.toDataURL("image/png",1);try{const E=await Ve(g,a,t);return console.log("âœ… å½±ç‰‡ç”Ÿæˆå®Œæˆ:",E),E}catch(E){console.error("âŒ å½±ç‰‡ç”Ÿæˆå¤±æ•—:",E);const p=e.toDataURL("image/png",1),U=new Date().toISOString().replace(/[:]/g,"-").split(".")[0],T=document.createElement("a"),N=`æœˆäº®ç¯€ARæ‹ç…§_${U}.png`;return T.download=N,T.href=p,document.body.appendChild(T),T.click(),document.body.removeChild(T),{png:p,error:"å½±ç‰‡ç”Ÿæˆå¤±æ•—ï¼Œå·²ä¿å­˜ç‚ºåœ–ç‰‡"}}}else n.drawImage(J,0,0,a,t),n.drawImage(C,0,0,a,t);const r=e.toDataURL("image/png",1),l=new Date().toISOString().replace(/[:]/g,"-").split(".")[0],c=document.createElement("a"),M=`æœˆäº®ç¯€ARæ‹ç…§_${l}.png`;return c.download=M,c.href=r,document.body.appendChild(c),c.click(),document.body.removeChild(c),console.log("ğŸ“¸ PNG æ‹ç…§æˆåŠŸï¼"),{png:r}}catch(e){return console.error("æ‹ç…§å¤±æ•—ï¼š",e),null}}let H=null,oe="mp4";function ut(e){H=e}function mt(e){oe=e}async function Ve(e,n,a){console.log("ğŸ¬ é–‹å§‹éŒ„è£½éœæ­¢äººç‰© + å‹•æ…‹èƒŒæ™¯å½±ç‰‡...");try{if(!window.MediaRecorder)return console.warn("ç€è¦½å™¨ä¸æ”¯æ´ MediaRecorder"),{png:e,error:"ç€è¦½å™¨ä¸æ”¯æ´å½±ç‰‡éŒ„è£½"};const t=document.createElement("canvas"),i=t.getContext("2d"),r=640,l=n/a;n>a?(t.width=Math.min(r,n),t.height=Math.round(t.width/l)):(t.height=Math.min(r,a),t.width=Math.round(t.height*l)),console.log(`éŒ„è£½ Canvas å°ºå¯¸: ${t.width}x${t.height} (åŸå§‹: ${n}x${a}, æ¯”ä¾‹: ${l.toFixed(2)})`);const c=new Image;return new Promise((M,g)=>{c.onload=async()=>{console.log("éœæ­¢äººç‰©åœ–ç‰‡è¼‰å…¥å®Œæˆï¼Œé–‹å§‹éŒ„è£½...");const E=8,p=20,U=E*p;console.log("ğŸ”§ éŒ„è£½å‰é…ç½®æª¢æŸ¥:",{"CONFIG.BACKGROUND.TYPE":o.BACKGROUND.TYPE,"CONFIG.BACKGROUND.INTENSITY":o.BACKGROUND.INTENSITY,customBackgroundImage:!!u,bgMoonVideoEl:!!s,iosMoonVideoEl:!!D,isIOSDevice:q}),(!o.BACKGROUND.TYPE||o.BACKGROUND.TYPE==="original")&&(console.warn("âš ï¸ èƒŒæ™¯é¡å‹æœªæ­£ç¢ºè¨­å®šï¼Œå˜—è©¦è‡ªå‹•ä¿®æ­£..."),s||D?u?(o.BACKGROUND.TYPE="custom_moon_bg",console.log("âœ… è‡ªå‹•è¨­å®šèƒŒæ™¯é¡å‹ç‚º: custom_moon_bg")):(o.BACKGROUND.TYPE="moon_video",console.log("âœ… è‡ªå‹•è¨­å®šèƒŒæ™¯é¡å‹ç‚º: moon_video")):u&&(o.BACKGROUND.TYPE="custom_moon_bg",console.log("âœ… è‡ªå‹•è¨­å®šèƒŒæ™¯é¡å‹ç‚º: custom_moon_bg (åƒ…èƒŒæ™¯åœ–ç‰‡)"))),s&&s.paused&&await s.play().catch(A=>console.warn("å½±ç‰‡æ’­æ”¾å¤±æ•—:",A)),D&&D.paused&&await D.play().catch(A=>console.warn("iOS å½±ç‰‡æ’­æ”¾å¤±æ•—:",A));const T=t.captureStream(p);let N;oe==="mp4"?MediaRecorder.isTypeSupported("video/mp4; codecs=h264")?N={mimeType:"video/mp4; codecs=h264",videoBitsPerSecond:3e6}:MediaRecorder.isTypeSupported("video/mp4")?N={mimeType:"video/mp4",videoBitsPerSecond:3e6}:(console.warn("ç€è¦½å™¨ä¸æ”¯æ´ MP4ï¼Œé™ç´šåˆ° WebM"),N={mimeType:"video/webm; codecs=vp8",videoBitsPerSecond:3e6},oe="webm"):N={mimeType:"video/webm; codecs=vp8",videoBitsPerSecond:3e6};const F=new MediaRecorder(T,N);console.log(`ğŸ“¹ ä½¿ç”¨æ ¼å¼: ${N.mimeType}`);const b=[];F.ondataavailable=A=>{A.data.size>0&&b.push(A.data)},F.onstop=()=>{const A=oe==="mp4"?"video/mp4":"video/webm",R=oe==="mp4"?"mp4":"webm",Se=new Blob(b,{type:A}),P=`æœˆäº®ç¯€AR_æœˆç›¸å½±ç‰‡_${new Date().toISOString().replace(/[:]/g,"-").split(".")[0]}.${R}`,ie=De(Se,P);typeof L=="function"&&L("å½±ç‰‡å·²ç”Ÿæˆï¼Œå¯æŒ‰ åˆ†äº« æˆ– ä¸‹è¼‰"),typeof ae=="function"&&ae({lastVideoUrl:ie,lastVideoFilename:P}),M({png:e,video:ie,duration:E,format:R,saved:!0})},F.onerror=A=>{console.error("éŒ„è£½éŒ¯èª¤:",A.error),g(A.error)},F.start(),console.log(`é–‹å§‹éŒ„è£½ ${E} ç§’å½±ç‰‡...`),H&&(H.setStatus("é–‹å§‹éŒ„è£½..."),H.updateProgress(0,E));let w=0;function v(){i.clearRect(0,0,t.width,t.height);const A=o.BACKGROUND&&o.BACKGROUND.TYPE,R=o.BACKGROUND.INTENSITY||.5;if(console.log(`ğŸ¬ éŒ„è£½å¹€ ${w}/${U}:`,{bgType:A,intensity:R,hasCustomBg:!!u,hasMoonVideo:!!s,hasIOSMoonVideo:!!D,isIOSDevice:q}),A==="custom_moon_bg"&&u){const d=u.naturalWidth||u.width,h=u.naturalHeight||u.height;if(d>0&&h>0){const S=Math.max(t.width/d,t.height/h),m=Math.round(d*S),f=Math.round(h*S),O=Math.round((t.width-m)/2),_=Math.round((t.height-f)/2);i.drawImage(u,0,0,d,h,O,_,m,f)}}else if(A==="video"&&y&&y.readyState>=2){const d=y.videoWidth||1,h=y.videoHeight||1,S=Math.max(t.width/d,t.height/h),m=Math.round(d*S),f=Math.round(h*S),O=Math.round((t.width-m)/2),_=Math.round((t.height-f)/2);i.globalAlpha=Math.min(1,.3+R*.7),i.drawImage(y,0,0,d,h,O,_,m,f),i.globalAlpha=1}if(A==="custom_moon_bg"||A==="moon_video"){if(q){if(D&&D.readyState>=2&&D.videoWidth>0){const d=D.videoWidth,h=D.videoHeight,S=Math.max(t.width/d,t.height/h),m=Math.round(d*S),f=Math.round(h*S),O=Math.round((t.width-m)/2),_=Math.round((t.height-f)/2);i.globalAlpha=Math.min(1,.8+R*.2),i.drawImage(D,0,0,d,h,O,_,m,f),i.globalAlpha=1}else if(s&&s.readyState>=2){const d=s.videoWidth||s.width||1,h=s.videoHeight||s.height||1,S=Math.max(t.width/d,t.height/h),m=Math.round(d*S),f=Math.round(h*S),O=Math.round((t.width-m)/2),_=Math.round((t.height-f)/2);i.globalAlpha=Math.min(1,.8+R*.2),i.drawImage(s,0,0,d,h,O,_,m,f),i.globalAlpha=1}}else if(s&&s.readyState>=2){const d=s.videoWidth||s.width||1,h=s.videoHeight||s.height||1;if(d>1&&h>1){i.save();const S=t.width/t.height;let m,f,O;S>.6?(m=t.width*.5,f=t.height*.35,O=Math.min(t.width,t.height)*.25):S>.5?(m=t.width*.51,f=t.height*.29,O=Math.min(t.width,t.height)*.29):(m=t.width*.51,f=t.height*.26,O=Math.min(t.width,t.height)*.3),i.beginPath(),i.arc(m,f,O,0,2*Math.PI),i.clip();const _=Math.max(t.width/d,t.height/h),ee=Math.round(d*_),te=Math.round(h*_),Me=Math.round((t.width-ee)/2),Ae=Math.round((t.height-te)/2);i.globalAlpha=Math.min(1,.8+R*.2),i.drawImage(s,0,0,d,h,Me,Ae,ee,te),i.globalAlpha=1,i.restore()}}}else if(s&&s.readyState>=2){const d=s.videoWidth||s.width||1,h=s.videoHeight||s.height||1;if(d>1&&h>1){const S=Math.max(t.width/d,t.height/h),m=Math.round(d*S),f=Math.round(h*S),O=Math.round((t.width-m)/2),_=Math.round((t.height-f)/2);i.globalAlpha=Math.min(1,.3+R*.7),i.drawImage(s,0,0,d,h,O,_,m,f),i.globalAlpha=1}}else{if(console.warn("âš ï¸ èƒŒæ™¯é¡å‹æœªåŒ¹é…ï¼Œå˜—è©¦ fallback é‚è¼¯:",{bgType:A,hasCustomBg:!!u,hasMoonVideo:!!s}),u&&u.complete){const d=u.naturalWidth||u.width,h=u.naturalHeight||u.height;if(d>0&&h>0){const S=Math.max(t.width/d,t.height/h),m=Math.round(d*S),f=Math.round(h*S),O=Math.round((t.width-m)/2),_=Math.round((t.height-f)/2);i.drawImage(u,0,0,d,h,O,_,m,f),console.log("âœ… ä½¿ç”¨è‡ªå®šç¾©èƒŒæ™¯ä½œç‚º fallback")}}if(s&&s.readyState>=2&&!s.paused){const d=s.videoWidth||s.width||1,h=s.videoHeight||s.height||1;if(d>1&&h>1){i.save();const S=t.width/t.height;let m,f,O;S>.6?(m=t.width*.5,f=t.height*.35,O=Math.min(t.width,t.height)*.25):S>.5?(m=t.width*.51,f=t.height*.29,O=Math.min(t.width,t.height)*.29):(m=t.width*.51,f=t.height*.26,O=Math.min(t.width,t.height)*.3),i.beginPath(),i.arc(m,f,O,0,2*Math.PI),i.clip();const _=Math.max(t.width/d,t.height/h),ee=Math.round(d*_),te=Math.round(h*_),Me=Math.round((t.width-ee)/2),Ae=Math.round((t.height-te)/2);i.globalAlpha=Math.min(1,.8+R*.2),i.drawImage(s,0,0,d,h,Me,Ae,ee,te),i.globalAlpha=1,i.restore(),console.log("âœ… ä½¿ç”¨æœˆç›¸å½±ç‰‡ä½œç‚º fallback")}}}const Z=c.naturalWidth||c.width,P=c.naturalHeight||c.height;if(Z>0&&P>0){const d=t.width/Z,h=t.height/P,S=Math.max(d,h),m=Math.round(Z*S),f=Math.round(P*S),O=Math.round((t.width-m)/2),_=Math.round((t.height-f)/2);i.drawImage(c,0,0,Z,P,O,_,m,f)}else i.drawImage(c,0,0,t.width,t.height);w++;const ie=w/p;H&&H.updateProgress(ie,E),w<U?setTimeout(v,1e3/p):(H&&H.setStatus("éŒ„è£½å®Œæˆï¼Œæ­£åœ¨ç”Ÿæˆæª”æ¡ˆ..."),F.stop(),console.log("æ‰€æœ‰å¹€éŒ„è£½å®Œæˆ"))}v()},c.onerror=()=>{g(new Error("éœæ­¢äººç‰©åœ–ç‰‡è¼‰å…¥å¤±æ•—"))},c.src=e})}catch(t){return console.error("å½±ç‰‡ç”ŸæˆéŒ¯èª¤:",t),{png:e,error:t.message}}}export{o as CONFIG,gt as capturePhoto,je as clearLastRecording,Xe as getLastRecordingFilename,$e as getLastRecordingUrl,Ye as hasRecordingAvailable,Je as initCore,Le as initializeConfig,Et as isRunning,ot as onResize,qe as resetConfig,Qe as saveConfig,st as setBackgroundIntensity,it as setBackgroundType,rt as setEdgeFeather,at as setEnableSegmentation,dt as setGifBlendMode,ut as setRecordingProgressCallback,ht as setShouldGenerateGif,nt as setShowMaskPreview,ct as setTemporalAlpha,lt as setThreshold,mt as setVideoOutputFormat,ze as shareLastRecording,et as start,tt as stop,De as storeRecordingBlob,Ze as switchCamera,we as syncCanvasSize,Fe as uploadBlobToServerAndGetUrl};
//# sourceMappingURL=segmentationCore-by0oTB_D.js.map
