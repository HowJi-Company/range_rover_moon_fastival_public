{"version":3,"file":"segmentationCore-tzuSt-AR.js","sources":["../../src/core/config.js","../../src/core/mediaPipeManager.js","../../src/core/cameraManager.js","../../src/core/backgroundRenderer.js","../../src/core/recordingManager.js","../../src/segmentationCore.js"],"sourcesContent":["// config.js - 配置管理模組\n// 負責：配置項定義、驗證、持久化、自動調整\n\nexport const CONFIG = {\n  FACE_DETECTION: {\n    MODEL: \"short\",\n    MIN_DETECTION_CONFIDENCE: 0.5,\n    MAX_FACES: 10,\n  },\n  SEGMENTATION: {\n    ENABLED: true,\n    MODEL_SELECTION: 1, // 1 => landscape\n    SELFIE_MODE: true,\n    SEGMENTATION_THRESHOLD: 0.1,\n  },\n  FACE_DETECTION_SETTINGS: {\n    REQUIRED_FACES: 1,\n  },\n  CAMERA: {\n    WIDTH: 1280,\n    HEIGHT: 720,\n    DEFAULT_WIDTH: 1280,\n    DEFAULT_HEIGHT: 720,\n    DEFAULT_FACING_MODE: \"user\",\n    FRAME_RATE: 30,\n  },\n  UI: {\n    STATUS_UPDATE_INTERVAL: 100,\n    SHOW_DEBUG_INFO: true,\n    SHOW_FPS: false,\n    LANGUAGE: \"zh-TW\",\n  },\n  EFFECTS: {\n    MOON_EFFECT_DURATION: 3000,\n    FADE_DURATION: 800,\n    ENABLE_SOUND: false,\n    MOON_SIZE_SCALE: 1.0,\n    STAR_COUNT: 5,\n    SPARKLE_COUNT: 3,\n  },\n  BACKGROUND_EFFECTS: {\n    DEFAULT_BACKGROUND: \"moon_video\",\n    WAVE_EFFECT: { AMPLITUDE: 10, FREQUENCY: 0.02, SPEED: 0.05 },\n    FREQUENCY_EFFECT: { BANDS: 32, HEIGHT_SCALE: 0.8, COLOR_SHIFT: 0.01 },\n    EFFECT_INTENSITY: 0.5,\n    BLEND_MODE: \"source-over\",\n  },\n  PERFORMANCE: {\n    ENABLE_MONITORING: false,\n    MAX_LATENCY: 100,\n    LOW_PERFORMANCE_MODE: false,\n    AUTO_ADJUST_PERFORMANCE: true,\n  },\n  DEBUG: {\n    VERBOSE_LOGGING: false,\n    SHOW_FACE_LANDMARKS: false,\n    SAVE_DETECTION_RESULTS: false,\n  },\n  ADVANCED: {\n    MEDIAPIPE_BASE_URL:\n      \"https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/\",\n    MEDIAPIPE_SEGMENTATION_URL:\n      \"https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/\",\n    USE_WEB_WORKERS: false,\n    MEMORY_LIMIT: 512,\n    ENABLE_ERROR_REPORTING: true,\n  },\n};\n\n// 讓背景設定存在（避免 undefined）\nCONFIG.BACKGROUND = CONFIG.BACKGROUND || {\n  TYPE:\n    (CONFIG.BACKGROUND_EFFECTS &&\n      CONFIG.BACKGROUND_EFFECTS.DEFAULT_BACKGROUND) ||\n    \"original\",\n  INTENSITY:\n    (CONFIG.BACKGROUND_EFFECTS && CONFIG.BACKGROUND_EFFECTS.EFFECT_INTENSITY) ??\n    0.5,\n  GIF_BLEND_MODE: \"overlay\", // 仍保留欄位以向後相容（但會無效）\n};\n\n// 裝置自動調整\nfunction autoAdjustConfig() {\n  const isMobile =\n    /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(\n      navigator.userAgent\n    );\n  const isLowEnd = (navigator.hardwareConcurrency || 4) <= 2;\n\n  if (isMobile) {\n    CONFIG.CAMERA.DEFAULT_WIDTH = 480;\n    CONFIG.CAMERA.DEFAULT_HEIGHT = 360;\n    CONFIG.FACE_DETECTION.MODEL = \"short\";\n    CONFIG.EFFECTS.STAR_COUNT = 3;\n    CONFIG.EFFECTS.SPARKLE_COUNT = 2;\n  }\n  if (isLowEnd) {\n    CONFIG.PERFORMANCE.LOW_PERFORMANCE_MODE = true;\n    CONFIG.FACE_DETECTION.MIN_DETECTION_CONFIDENCE = 0.6;\n    CONFIG.CAMERA.FRAME_RATE = 20;\n    CONFIG.EFFECTS.MOON_SIZE_SCALE = 0.8;\n  }\n}\n\n// 配置驗證\nfunction validateConfig() {\n  const errors = [];\n  if (\n    CONFIG.FACE_DETECTION.MIN_DETECTION_CONFIDENCE < 0 ||\n    CONFIG.FACE_DETECTION.MIN_DETECTION_CONFIDENCE > 1\n  )\n    errors.push(\"MIN_DETECTION_CONFIDENCE 必須在 0~1 之間\");\n\n  if (!navigator.mediaDevices?.getUserMedia) {\n    errors.push(\"瀏覽器不支援相機功能\");\n  }\n  return errors;\n}\n\n// 配置持久化\nexport function saveConfig() {\n  try {\n    localStorage.setItem(\"moonFestivalAR_config\", JSON.stringify(CONFIG));\n  } catch {}\n}\n\nexport function resetConfig() {\n  try {\n    localStorage.removeItem(\"moonFestivalAR_config\");\n  } catch {}\n  location.reload();\n}\n\nfunction loadCustomConfig() {\n  try {\n    const c = localStorage.getItem(\"moonFestivalAR_config\");\n    if (c) Object.assign(CONFIG, JSON.parse(c));\n  } catch {}\n}\n\n// 初始化配置\nexport function initializeConfig() {\n  loadCustomConfig();\n  autoAdjustConfig();\n\n  // 對應舊欄位\n  CONFIG.CAMERA.WIDTH =\n    CONFIG.CAMERA.DEFAULT_WIDTH || CONFIG.CAMERA.WIDTH || 1280;\n  CONFIG.CAMERA.HEIGHT =\n    CONFIG.CAMERA.DEFAULT_HEIGHT || CONFIG.CAMERA.HEIGHT || 720;\n  CONFIG.CAMERA.FACING =\n    CONFIG.CAMERA.DEFAULT_FACING_MODE || CONFIG.CAMERA.FACING || \"user\";\n\n  CONFIG.SEGMENTER = CONFIG.SEGMENTER || {};\n  CONFIG.SEGMENTER.USE_LANDSCAPE_MODEL =\n    CONFIG.SEGMENTATION && CONFIG.SEGMENTATION.MODEL_SELECTION === 1\n      ? true\n      : CONFIG.SEGMENTER.USE_LANDSCAPE_MODEL ?? true;\n  CONFIG.SEGMENTER.USE_GPU = CONFIG.SEGMENTER.USE_GPU ?? true;\n\n  CONFIG.SMOOTHING = CONFIG.SMOOTHING || {};\n  CONFIG.SMOOTHING.THRESHOLD =\n    CONFIG.SMOOTHING.THRESHOLD ??\n    CONFIG.SEGMENTATION?.SEGMENTATION_THRESHOLD ??\n    0.38;\n  CONFIG.SMOOTHING.TEMPORAL_ALPHA = CONFIG.SMOOTHING.TEMPORAL_ALPHA ?? 0.6;\n  CONFIG.SMOOTHING.EDGE_FEATHER_PX = CONFIG.SMOOTHING.EDGE_FEATHER_PX ?? 3;\n  CONFIG.SMOOTHING.HYS_ON =\n    CONFIG.SMOOTHING.HYS_ON ?? CONFIG.SMOOTHING.THRESHOLD - 0.15;\n  CONFIG.SMOOTHING.HYS_OFF =\n    CONFIG.SMOOTHING.HYS_OFF ?? CONFIG.SMOOTHING.THRESHOLD + 0.15;\n  CONFIG.SMOOTHING.MASK_GROW_PX = CONFIG.SMOOTHING.MASK_GROW_PX ?? 1.5;\n\n  // 模型路徑與 WASM base\n  if (!CONFIG.MODELS) {\n    CONFIG.MODELS = {\n      SELFIE_SEGMENTER_LANDSCAPE:\n        \"https://storage.googleapis.com/mediapipe-models/image_segmenter/selfie_segmenter_landscape/float16/latest/selfie_segmenter_landscape.tflite\",\n      SELFIE_SEGMENTER_SQUARE:\n        \"https://storage.googleapis.com/mediapipe-models/image_segmenter/selfie_segmenter/float16/latest/selfie_segmenter.tflite\",\n      FACE_DETECTOR:\n        \"https://storage.googleapis.com/mediapipe-models/face_detector/blaze_face_short_range/float16/latest/blaze_face_short_range.tflite\",\n    };\n  }\n  CONFIG.WASM_BASE =\n    CONFIG.WASM_BASE ||\n    \"https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.7/wasm\";\n\n  const errs = validateConfig();\n  if (errs.length) {\n    console.error(\"配置驗證失敗：\", errs);\n    return false;\n  }\n  return true;\n}","// mediaPipeManager.js - MediaPipe 初始化和模組載入管理\n// 負責：MediaPipe 模組載入、ImageSegmenter、FaceDetector 初始化\n\nimport { CONFIG } from './config.js';\n\nlet imageSegmenter = null;\nlet faceDetector = null;\nlet wasmFileset = null;\n\n// MediaPipe 模組載入\nasync function ensureTasksVisionLoaded() {\n  if (window.FilesetResolver && window.ImageSegmenter) return true;\n  const urls = [\n    \"https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.7/vision_bundle.mjs\",\n    \"https://unpkg.com/@mediapipe/tasks-vision@0.10.7/vision_bundle.mjs\",\n  ];\n  for (const url of urls) {\n    try {\n      const mod = await import(url);\n      if (mod.FilesetResolver) window.FilesetResolver = mod.FilesetResolver;\n      if (mod.ImageSegmenter) window.ImageSegmenter = mod.ImageSegmenter;\n      if (mod.FaceDetector) window.FaceDetector = mod.FaceDetector;\n      return true;\n    } catch (e) {\n      console.warn(\"[WARN] failed to import tasks-vision from\", url, e);\n    }\n  }\n  throw new Error(\"無法載入 @mediapipe/tasks-vision 模組\");\n}\n\n// 初始化 MediaPipe Tasks\nasync function initTasks(outCanvas) {\n  if (!wasmFileset) {\n    wasmFileset = await FilesetResolver.forVisionTasks(CONFIG.WASM_BASE);\n  }\n  \n  // 依 outCanvas 比例選擇使用 landscape/square\n  try {\n    const rect = outCanvas.getBoundingClientRect();\n    CONFIG.SEGMENTER.USE_LANDSCAPE_MODEL =\n      (rect.width || 1) >= (rect.height || 1);\n  } catch {}\n\n  // ImageSegmenter\n  const baseOptions = {\n    modelAssetPath: CONFIG.SEGMENTER.USE_LANDSCAPE_MODEL\n      ? CONFIG.MODELS.SELFIE_SEGMENTER_LANDSCAPE\n      : CONFIG.MODELS.SELFIE_SEGMENTER_SQUARE,\n    delegate: CONFIG.SEGMENTER.USE_GPU ? \"GPU\" : \"CPU\",\n  };\n  \n  try {\n    imageSegmenter = await ImageSegmenter.createFromOptions(wasmFileset, {\n      baseOptions,\n      runningMode: \"VIDEO\",\n      outputCategoryMask: false,\n      outputConfidenceMasks: true,\n    });\n  } catch (e) {\n    console.warn(\"[Segmenter] GPU 失敗，改用 CPU:\", e);\n    imageSegmenter = await ImageSegmenter.createFromOptions(wasmFileset, {\n      baseOptions: { ...baseOptions, delegate: \"CPU\" },\n      runningMode: \"VIDEO\",\n      outputCategoryMask: false,\n      outputConfidenceMasks: true,\n    });\n  }\n\n  // FaceDetector（可選）\n  try {\n    faceDetector = await FaceDetector.createFromOptions(wasmFileset, {\n      baseOptions: {\n        modelAssetPath: CONFIG.MODELS.FACE_DETECTOR,\n        delegate: \"GPU\",\n      },\n      runningMode: \"VIDEO\",\n      minDetectionConfidence: 0.6,\n      minSuppressionThreshold: 0.3,\n    });\n  } catch (e) {\n    console.warn(\"[FaceDetector] GPU 失敗，改用 CPU:\", e);\n    faceDetector = await FaceDetector.createFromOptions(wasmFileset, {\n      baseOptions: {\n        modelAssetPath: CONFIG.MODELS.FACE_DETECTOR,\n        delegate: \"CPU\",\n      },\n      runningMode: \"VIDEO\",\n      minDetectionConfidence: 0.6,\n      minSuppressionThreshold: 0.3,\n    });\n  }\n}\n\n// MediaPipe 管理器類別\nexport class MediaPipeManager {\n  constructor() {\n    this.imageSegmenter = null;\n    this.faceDetector = null;\n    this.wasmFileset = null;\n  }\n\n  // 初始化 MediaPipe\n  async init(outCanvas) {\n    await ensureTasksVisionLoaded();\n    await initTasks(outCanvas);\n    this.imageSegmenter = imageSegmenter;\n    this.faceDetector = faceDetector;\n    this.wasmFileset = wasmFileset;\n  }\n\n  // 取得 ImageSegmenter\n  getImageSegmenter() {\n    return this.imageSegmenter;\n  }\n\n  // 取得 FaceDetector\n  getFaceDetector() {\n    return this.faceDetector;\n  }\n\n  // 檢查是否已初始化\n  isInitialized() {\n    return this.imageSegmenter !== null && this.faceDetector !== null;\n  }\n\n  // 執行影像分割\n  async segmentImage(canvas, timestamp) {\n    if (!this.imageSegmenter) return null;\n    \n    try {\n      const result = this.imageSegmenter.segmentForVideo\n        ? this.imageSegmenter.segmentForVideo(canvas, timestamp)\n        : await this.imageSegmenter.segment(canvas);\n      return result;\n    } catch (e) {\n      console.warn(\"segmentForVideo error:\", e);\n      return null;\n    }\n  }\n\n  // 執行臉部檢測\n  detectFaces(canvas, timestamp) {\n    if (!this.faceDetector) {\n      // Debug: 檢查 faceDetector 是否存在\n      console.warn('⚠️ faceDetector not initialized');\n      return null;\n    }\n    \n    try {\n      const det = this.faceDetector.detectForVideo\n        ? this.faceDetector.detectForVideo(canvas, timestamp)\n        : this.faceDetector.detect(canvas);\n      return det;\n    } catch (e) {\n      console.warn(\"faceDetector error:\", e);\n      return null;\n    }\n  }\n}","// cameraManager.js - 相機控制管理\n// 負責：相機初始化、切換、串流控制\n\nimport { CONFIG } from './config.js';\n\nexport class CameraManager {\n  constructor() {\n    this.stream = null;\n    this.currentFacingMode = CONFIG.CAMERA.DEFAULT_FACING_MODE || \"user\";\n    this.videoEl = null;\n  }\n\n  // 設定影片元素\n  setVideoElement(videoEl) {\n    this.videoEl = videoEl;\n  }\n\n  // 啟動相機\n  async startCamera() {\n    // 關閉舊串流\n    if (this.stream) {\n      try { this.stream.getTracks().forEach((t) => t.stop()); } catch {}\n    }\n  \n    // 依舞台（.stage）或視窗大小 + DPR 推估理想解析度\n    const stage = this.videoEl?.closest('.stage');\n    const targetCssW = stage?.clientWidth  || window.innerWidth;\n    const targetCssH = stage?.clientHeight || window.innerHeight;\n    const dpr = Math.min(window.devicePixelRatio || 1, 3);\n  \n    // 上限保守，避免某些手機直接拒絕\n    const idealW = Math.min(Math.round(targetCssW * dpr), 1920);\n    const idealH = Math.min(Math.round(targetCssH * dpr), 1080);\n    const aspect = idealW / Math.max(1, idealH);\n  \n    const constraints = {\n      audio: false,\n      video: {\n        facingMode: this.currentFacingMode,            // \"user\" 或 \"environment\"\n        width:        { ideal: idealW,  min: 640,  max: 2560 },\n        height:       { ideal: idealH,  min: 480,  max: 1440 },\n        aspectRatio:  { ideal: aspect },\n        frameRate:    { ideal: CONFIG.CAMERA.FRAME_RATE || 30, max: 60 },\n        // 某些 iOS 機型支援：resizeMode: \"none\"\n        // resizeMode: \"none\",\n      },\n    };\n  \n    this.stream = await navigator.mediaDevices.getUserMedia(constraints);\n    this.videoEl.srcObject = this.stream;\n    this.videoEl.setAttribute(\"playsinline\", \"\");\n    this.videoEl.muted = true;\n    this.videoEl.autoplay = true;\n  \n    // 等待 metadata 準備好\n    await new Promise((resolve) => {\n      if (this.videoEl.readyState >= 1 && this.videoEl.videoWidth && this.videoEl.videoHeight) return resolve();\n      this.videoEl.onloadedmetadata = () => resolve();\n      setTimeout(resolve, 1500);\n    });\n  \n    // 二次嘗試：依能力上限 applyConstraints（許多瀏覽器第一次會只給 640x480）\n    try {\n      const track = this.stream.getVideoTracks()[0];\n      const caps = track.getCapabilities?.();\n      const pick = (val, min, max) => {\n        if (min == null && max == null) return val;\n        const lo = (typeof min === 'number') ? min : val;\n        const hi = (typeof max === 'number') ? max : val;\n        return Math.min(Math.max(val, lo), hi);\n      };\n  \n      if (caps) {\n        const wantW  = pick(idealW,  caps.width?.min,  caps.width?.max);\n        const wantH  = pick(idealH,  caps.height?.min, caps.height?.max);\n        const wantAR = idealW / Math.max(1, idealH);\n  \n        await track.applyConstraints({\n          width:       { ideal: wantW },\n          height:      { ideal: wantH },\n          aspectRatio: { ideal: wantAR },\n          frameRate:   { ideal: CONFIG.CAMERA.FRAME_RATE || 30, max: 60 },\n          // resizeMode: caps.resizeMode?.includes?.(\"none\") ? \"none\" : undefined,\n        });\n      }\n    } catch (e) {\n      console.warn(\"applyConstraints failed:\", e);\n    }\n  \n    try { await this.videoEl.play(); } catch {}\n  }\n\n  // 停止相機\n  stopCamera() {\n    try {\n      if (this.stream) this.stream.getTracks().forEach((t) => t.stop());\n    } catch {}\n    this.stream = null;\n  }\n\n  // 切換前後鏡頭\n  async switchCamera() {\n    this.currentFacingMode = this.currentFacingMode === \"user\" ? \"environment\" : \"user\";\n    await this.startCamera();\n  }\n\n  // 取得當前鏡頭模式\n  getCurrentFacingMode() {\n    return this.currentFacingMode;\n  }\n\n  // 取得串流\n  getStream() {\n    return this.stream;\n  }\n}","// backgroundRenderer.js - 背景渲染管理\n// 負責：各種背景效果渲染、動畫控制\n\nimport { CONFIG } from './config.js';\n\nexport class BackgroundRenderer {\n  constructor() {\n    this.animT = 0;\n    this.customBackgroundImage = null;\n    this.isIOSDevice = false;\n    this.loadCustomBackground();\n  }\n\n  // 設定 iOS 設備標識\n  setIOSDevice(isIOS) {\n    this.isIOSDevice = isIOS;\n  }\n\n  // 載入自定義背景圖片\n  loadCustomBackground() {\n    const img = new Image();\n    img.onload = () => {\n      this.customBackgroundImage = img;\n      console.log('✅ 自定義背景圖片載入完成');\n    };\n    img.onerror = (e) => {\n      console.warn('⚠️ 自定義背景圖片載入失敗:', e);\n    };\n    \n    const base = import.meta.env.BASE_URL || '/';\n    img.src = base + 'pexels-photo-623218.jpeg';\n  }\n\n  // 設定自定義背景圖片\n  setCustomBackground(imageSrc) {\n    const img = new Image();\n    img.onload = () => {\n      this.customBackgroundImage = img;\n      console.log('✅ 背景圖片已更新:', imageSrc);\n    };\n    img.onerror = (e) => {\n      console.warn('⚠️ 背景圖片載入失敗:', e);\n    };\n    img.src = imageSrc;\n  }\n\n  // 更新動畫時間\n  updateAnimation() {\n    this.animT += 0.016;\n  }\n\n  // 渲染背景到指定 Canvas Context\n  renderBackgroundTo(ctx, w, h, bgVideoEl, bgMoonVideoEl, iosMoonVideoEl) {\n    const bgType =\n      (CONFIG.BACKGROUND && CONFIG.BACKGROUND.TYPE) ||\n      (CONFIG.BACKGROUND_EFFECTS &&\n        CONFIG.BACKGROUND_EFFECTS.DEFAULT_BACKGROUND) ||\n      \"original\";\n    const intensity =\n      CONFIG.BACKGROUND && typeof CONFIG.BACKGROUND.INTENSITY === \"number\"\n        ? CONFIG.BACKGROUND.INTENSITY\n        : (CONFIG.BACKGROUND_EFFECTS &&\n            CONFIG.BACKGROUND_EFFECTS.EFFECT_INTENSITY) ??\n          0.5;\n\n    ctx.clearRect(0, 0, w, h);\n    this.updateAnimation();\n\n    // 原始透明背景\n    if (bgType === \"original\") {\n      return;\n    }\n\n    // 波浪效果\n    if (bgType === \"waves\") {\n      this.renderWaveBackground(ctx, w, h, intensity);\n      return;\n    }\n\n    // 頻譜效果\n    if (bgType === \"frequency\") {\n      this.renderFrequencyBackground(ctx, w, h, intensity);\n      return;\n    }\n\n    // 背景影片\n    if (bgType === \"video\" && bgVideoEl) {\n      this.renderVideoBackground(ctx, w, h, bgVideoEl, intensity);\n      return;\n    }\n\n    // 月相影片背景\n    if (bgType === \"moon_video\" && bgMoonVideoEl) {\n      this.renderMoonVideoBackground(ctx, w, h, bgMoonVideoEl, intensity);\n      return;\n    }\n    \n    // 自定義背景 + 圓形月亮合成\n    if (bgType === \"custom_moon_bg\" && this.customBackgroundImage) {\n      this.renderCustomMoonBackground(ctx, w, h, bgMoonVideoEl, iosMoonVideoEl, intensity);\n      return;\n    }\n  }\n\n  // 波浪背景效果\n  renderWaveBackground(ctx, w, h, intensity) {\n    const grad = ctx.createLinearGradient(0, 0, w, h);\n    grad.addColorStop(0, \"#1a2332\");\n    grad.addColorStop(0.5, \"#2d3a50\");\n    grad.addColorStop(1, \"#0f1419\");\n    ctx.fillStyle = grad;\n    ctx.fillRect(0, 0, w, h);\n    ctx.strokeStyle = `rgba(100,200,255,${intensity * 0.6})`;\n    ctx.lineWidth = 2;\n    \n    for (let i = 0; i < 8; i++) {\n      ctx.beginPath();\n      for (let x = 0; x < w; x += 5) {\n        const off = i * 50;\n        const y =\n          h / 2 + Math.sin((x + off) * 0.012 + this.animT * 1.2) * 20 * intensity;\n        if (x === 0) ctx.moveTo(x, y);\n        else ctx.lineTo(x, y);\n      }\n      ctx.stroke();\n    }\n  }\n\n  // 頻譜背景效果\n  renderFrequencyBackground(ctx, w, h, intensity) {\n    ctx.fillStyle = \"#0a0a0a\";\n    ctx.fillRect(0, 0, w, h);\n    const bands = 48;\n    const bw = w / bands;\n    \n    for (let i = 0; i < bands; i++) {\n      const x = i * bw;\n      const bh =\n        (Math.sin(this.animT * 2 + i * 0.2) * 0.5 + 0.5) * h * 0.5 * intensity;\n      const hue = (this.animT * 30 + i * 10) % 360;\n      ctx.fillStyle = `hsla(${hue},70%,60%,0.8)`;\n      ctx.fillRect(x, h - bh, bw - 1, bh);\n    }\n  }\n\n  // 背景影片渲染\n  renderVideoBackground(ctx, w, h, bgVideoEl, intensity) {\n    const vw = bgVideoEl.videoWidth || 1;\n    const vh = bgVideoEl.videoHeight || 1;\n    \n    if (bgVideoEl.readyState >= 2) {\n      const scale = Math.max(w / vw, h / vh);\n      const dw = Math.round(vw * scale);\n      const dh = Math.round(vh * scale);\n      const ox = Math.round((w - dw) / 2);\n      const oy = Math.round((h - dh) / 2);\n      \n      try {\n        if (bgVideoEl.paused) bgVideoEl.play().catch(() => {});\n      } catch {}\n      \n      ctx.globalAlpha = Math.min(1, 0.3 + intensity * 0.7);\n      ctx.drawImage(bgVideoEl, 0, 0, vw, vh, ox, oy, dw, dh);\n      ctx.globalAlpha = 1;\n    }\n  }\n\n  // 月相影片背景渲染\n  renderMoonVideoBackground(ctx, w, h, bgMoonVideoEl, intensity) {\n    try {\n      if (bgMoonVideoEl.readyState >= 2 && !bgMoonVideoEl.paused) {\n        const vw = bgMoonVideoEl.videoWidth || bgMoonVideoEl.width || 1;\n        const vh = bgMoonVideoEl.videoHeight || bgMoonVideoEl.height || 1;\n        \n        if (vw > 1 && vh > 1) {\n          const scale = Math.max(w / vw, h / vh);\n          const dw = Math.round(vw * scale);\n          const dh = Math.round(vh * scale);\n          const ox = Math.round((w - dw) / 2);\n          const oy = Math.round((h - dh) / 2);\n\n          ctx.globalAlpha = Math.min(1, 0.3 + intensity * 0.7);\n          ctx.drawImage(bgMoonVideoEl, 0, 0, vw, vh, ox, oy, dw, dh);\n          ctx.globalAlpha = 1;\n        }\n      } else if (bgMoonVideoEl.paused) {\n        bgMoonVideoEl.play().catch((e) => console.warn(\"月相影片播放失敗:\", e));\n      }\n    } catch (e) {\n      console.warn(\"月相影片渲染錯誤:\", e);\n    }\n  }\n\n  // 自定義背景 + 圓形月亮合成渲染\n  renderCustomMoonBackground(ctx, w, h, bgMoonVideoEl, iosMoonVideoEl, intensity) {\n    try {\n      // iOS 設備特殊處理：使用背景圖片 + App.vue 中的全螢幕透明 MOV\n      if (this.isIOSDevice) {\n        if (this.customBackgroundImage) {\n          const imgW = this.customBackgroundImage.naturalWidth || this.customBackgroundImage.width;\n          const imgH = this.customBackgroundImage.naturalHeight || this.customBackgroundImage.height;\n          \n          if (imgW > 0 && imgH > 0) {\n            const scale = Math.max(w / imgW, h / imgH);\n            const dw = Math.round(imgW * scale);\n            const dh = Math.round(imgH * scale);\n            const ox = Math.round((w - dw) / 2);\n            const oy = Math.round((h - dh) / 2);\n            ctx.drawImage(this.customBackgroundImage, 0, 0, imgW, imgH, ox, oy, dw, dh);\n          }\n        }\n        return;\n      }\n      \n      // 非 iOS 設備：傳統三層合成模式\n      // 第一層：自定義背景圖片\n      if (this.customBackgroundImage) {\n        const imgW = this.customBackgroundImage.naturalWidth || this.customBackgroundImage.width;\n        const imgH = this.customBackgroundImage.naturalHeight || this.customBackgroundImage.height;\n        \n        if (imgW > 0 && imgH > 0) {\n          const scale = Math.max(w / imgW, h / imgH);\n          const dw = Math.round(imgW * scale);\n          const dh = Math.round(imgH * scale);\n          const ox = Math.round((w - dw) / 2);\n          const oy = Math.round((h - dh) / 2);\n          ctx.drawImage(this.customBackgroundImage, 0, 0, imgW, imgH, ox, oy, dw, dh);\n        }\n      }\n      \n      // 第二層：圓形月亮 MP4 (非 iOS 設備用)\n      if (bgMoonVideoEl && bgMoonVideoEl.readyState >= 2 && !bgMoonVideoEl.paused) {\n        this.renderCircularMoon(ctx, w, h, bgMoonVideoEl, intensity);\n      } else if (bgMoonVideoEl && bgMoonVideoEl.paused) {\n        bgMoonVideoEl.play().catch((e) => console.warn(\"月相影片播放失敗:\", e));\n      }\n      \n    } catch (e) {\n      console.warn(\"自定義背景 + 圓形月亮渲染錯誤:\", e);\n    }\n  }\n\n  // 圓形月亮渲染\n  renderCircularMoon(ctx, w, h, bgMoonVideoEl, intensity) {\n    const vw = bgMoonVideoEl.videoWidth || bgMoonVideoEl.width || 1;\n    const vh = bgMoonVideoEl.videoHeight || bgMoonVideoEl.height || 1;\n    \n    if (vw > 1 && vh > 1) {\n      ctx.save();\n      \n      // 響應式圓形裁剪路徑計算\n      const aspectRatio = w / h;\n      let centerX, centerY, radius;\n      \n      if (aspectRatio > 0.6) {\n        centerX = w * 0.5;\n        centerY = h * 0.35;\n        radius = Math.min(w, h) * 0.25;\n      } else if (aspectRatio > 0.5) {\n        centerX = w * 0.51;\n        centerY = h * 0.29;\n        radius = Math.min(w, h) * 0.29;\n      } else {\n        centerX = w * 0.51;\n        centerY = h * 0.26;\n        radius = Math.min(w, h) * 0.30;\n      }\n      \n      ctx.beginPath();\n      ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);\n      ctx.clip();\n      \n      const scale = Math.max(w / vw, h / vh);\n      const dw = Math.round(vw * scale);\n      const dh = Math.round(vh * scale);\n      const ox = Math.round((w - dw) / 2);\n      const oy = Math.round((h - dh) / 2);\n      \n      ctx.globalAlpha = Math.min(1, 0.8 + intensity * 0.2);\n      ctx.drawImage(bgMoonVideoEl, 0, 0, vw, vh, ox, oy, dw, dh);\n      ctx.globalAlpha = 1;\n      \n      ctx.restore();\n    }\n  }\n}","// recordingManager.js - 錄影和拍照管理\n// 負責：錄影存儲、分享、拍照功能、檔案管理\n\n// 儲存最後一次錄製的 Blob / filename / objectURL\nlet lastRecordedBlob = null;\nlet lastRecordedFilename = null;\nlet lastRecordedObjectUrl = null;\nlet recordingProgressCallback = null;\nlet videoOutputFormat = \"mp4\";\n\nfunction _revokeLastObjectUrl() {\n  try {\n    if (lastRecordedObjectUrl) {\n      URL.revokeObjectURL(lastRecordedObjectUrl);\n      lastRecordedObjectUrl = null;\n    }\n  } catch (e) {\n    console.warn(\"revoke failed\", e);\n  }\n}\n\nexport class RecordingManager {\n  constructor() {\n    this.progressCallback = null;\n    this.outputFormat = \"mp4\";\n  }\n\n  // 設定錄製進度回調\n  setProgressCallback(callback) {\n    recordingProgressCallback = callback;\n    this.progressCallback = callback;\n  }\n\n  // 設定影片輸出格式\n  setOutputFormat(format) {\n    videoOutputFormat = format;\n    this.outputFormat = format;\n  }\n\n  // 儲存錄影 Blob 並建立 objectURL\n  storeRecordingBlob(blob, filename) {\n    if (!blob) return null;\n    \n    _revokeLastObjectUrl();\n    lastRecordedBlob = blob;\n    lastRecordedFilename = filename || `moonAR_${Date.now()}.webm`;\n    \n    try {\n      lastRecordedObjectUrl = URL.createObjectURL(blob);\n    } catch (e) {\n      console.warn(\"createObjectURL failed\", e);\n      lastRecordedObjectUrl = null;\n    }\n    return lastRecordedObjectUrl;\n  }\n\n  // 檢查是否有錄影檔可用\n  hasRecordingAvailable() {\n    return !!lastRecordedBlob;\n  }\n\n  // 取得最後錄影的 URL\n  getLastRecordingUrl() {\n    return lastRecordedObjectUrl || null;\n  }\n\n  // 清除最後一次錄影的暫存\n  clearLastRecording() {\n    _revokeLastObjectUrl();\n    lastRecordedBlob = null;\n    lastRecordedFilename = null;\n  }\n\n  // 取得最後錄影檔名\n  getLastRecordingFilename() {\n    return lastRecordedFilename;\n  }\n\n  // 上傳到伺服器並取得 URL\n  async uploadBlobToServerAndGetUrl(blob, filename) {\n    const fd = new FormData();\n    fd.append(\"file\", blob, filename);\n    const res = await fetch(\"/api/upload\", { method: \"POST\", body: fd });\n    if (!res.ok) throw new Error(\"upload failed\");\n    const j = await res.json();\n    if (!j?.url) throw new Error(\"upload response missing url\");\n    return j.url;\n  }\n\n  // 分享最後錄影\n  async shareLastRecording() {\n    if (!lastRecordedBlob) throw new Error(\"no recording available\");\n    const filename = lastRecordedFilename || `moonAR_${Date.now()}.mp4`;\n    const file = new File([lastRecordedBlob], filename, {\n      type: lastRecordedBlob.type || \"video/mp4\",\n    });\n\n    // 優先嘗試檔案分享\n    try {\n      if (navigator.canShare && navigator.canShare({ files: [file] })) {\n        await navigator.share({\n          files: [file],\n          title: \"月亮節 AR 影片\",\n          text: \"分享給你\",\n        });\n        return { ok: true, method: \"webshare\" };\n      }\n    } catch (err) {\n      console.warn(\"Web Share file error:\", err);\n    }\n\n    // 嘗試上傳並分享 URL\n    try {\n      const url = await this.uploadBlobToServerAndGetUrl(lastRecordedBlob, filename);\n      if (navigator.share) {\n        try {\n          await navigator.share({\n            title: \"月亮節 AR 影片\",\n            text: \"看這個影片：\",\n            url,\n          });\n          return { ok: true, method: \"url-share\", url };\n        } catch (err) {\n          console.warn(\"Web Share URL error:\", err);\n        }\n      }\n      return { ok: true, method: \"uploaded\", url };\n    } catch (err) {\n      console.warn(\"upload failed:\", err);\n      throw err;\n    }\n  }\n\n  // 拍照功能\n  async capturePhoto(outCanvas, bgCanvas, CONFIG, backgroundRenderer, bgMoonVideoEl) {\n    if (!outCanvas || !backgroundRenderer) {\n      console.warn(\"無法拍照：相機未啟動或畫布不存在\");\n      return null;\n    }\n\n    try {\n      const captureCanvas = document.createElement(\"canvas\");\n      const captureCtx = captureCanvas.getContext(\"2d\");\n      const W = outCanvas.width;\n      const H = outCanvas.height;\n      captureCanvas.width = W;\n      captureCanvas.height = H;\n\n      const bgType = CONFIG.BACKGROUND && CONFIG.BACKGROUND.TYPE;\n      console.log(\"📸 拍照檢查背景類型:\", { bgType, hasMoonVideo: !!bgMoonVideoEl });\n\n      if ((bgType === \"moon_video\" || bgType === \"custom_moon_bg\") && bgMoonVideoEl) {\n        // 月相影片模式：生成動態影片\n        console.log(\"🌙 月相影片模式：生成 8 秒動態影片...\");\n        captureCtx.drawImage(outCanvas, 0, 0, W, H);\n        const staticPersonDataURL = captureCanvas.toDataURL(\"image/png\", 1.0);\n\n        try {\n          const result = await this.generateVideoWithStaticPerson(\n            staticPersonDataURL, \n            W, \n            H, \n            CONFIG, \n            backgroundRenderer, \n            bgMoonVideoEl\n          );\n          console.log(\"✅ 影片生成完成:\", result);\n          return result;\n        } catch (error) {\n          console.error(\"❌ 影片生成失敗:\", error);\n          // 回退到 PNG\n          return this.savePNG(captureCanvas);\n        }\n      } else {\n        // 一般模式\n        captureCtx.drawImage(bgCanvas, 0, 0, W, H);\n        captureCtx.drawImage(outCanvas, 0, 0, W, H);\n      }\n\n      return this.savePNG(captureCanvas);\n    } catch (error) {\n      console.error(\"拍照失敗：\", error);\n      return null;\n    }\n  }\n\n  // 儲存 PNG 圖片\n  savePNG(canvas) {\n    const dataURL = canvas.toDataURL(\"image/png\", 1.0);\n    const timestamp = new Date()\n      .toISOString()\n      .replace(/[:]/g, \"-\")\n      .split(\".\")[0];\n\n    const pngLink = document.createElement(\"a\");\n    const pngFilename = `月亮節AR拍照_${timestamp}.png`;\n    pngLink.download = pngFilename;\n    pngLink.href = dataURL;\n    document.body.appendChild(pngLink);\n    pngLink.click();\n    document.body.removeChild(pngLink);\n\n    console.log(`📸 PNG 拍照成功！`);\n    return { png: dataURL };\n  }\n\n  // 生成靜止人物 + 動態影片背景\n  async generateVideoWithStaticPerson(staticPersonDataURL, width, height, CONFIG, backgroundRenderer, bgMoonVideoEl) {\n    console.log(\"🎬 開始錄製靜止人物 + 動態背景影片...\");\n\n    if (!window.MediaRecorder) {\n      console.warn(\"瀏覽器不支援 MediaRecorder\");\n      return { png: staticPersonDataURL, error: \"瀏覽器不支援影片錄製\" };\n    }\n\n    const recordCanvas = document.createElement(\"canvas\");\n    const recordCtx = recordCanvas.getContext(\"2d\");\n    const maxSize = 640;\n    const aspectRatio = width / height;\n\n    if (width > height) {\n      recordCanvas.width = Math.min(maxSize, width);\n      recordCanvas.height = Math.round(recordCanvas.width / aspectRatio);\n    } else {\n      recordCanvas.height = Math.min(maxSize, height);\n      recordCanvas.width = Math.round(recordCanvas.height * aspectRatio);\n    }\n\n    const personImg = new Image();\n\n    return new Promise((resolve, reject) => {\n      personImg.onload = async () => {\n        const DURATION_SECONDS = 8;\n        const FPS = 20;\n        const totalFrames = DURATION_SECONDS * FPS;\n\n        // 確保月相影片開始播放\n        if (bgMoonVideoEl && bgMoonVideoEl.paused) {\n          await bgMoonVideoEl.play().catch((e) => console.warn(\"影片播放失敗:\", e));\n        }\n\n        const stream = recordCanvas.captureStream(FPS);\n        const recorderOptions = this.getRecorderOptions();\n        const recorder = new MediaRecorder(stream, recorderOptions);\n        \n        const chunks = [];\n        recorder.ondataavailable = (event) => {\n          if (event.data.size > 0) chunks.push(event.data);\n        };\n\n        recorder.onstop = () => {\n          const mimeType = this.outputFormat === \"mp4\" ? \"video/mp4\" : \"video/webm\";\n          const extension = this.outputFormat === \"mp4\" ? \"mp4\" : \"webm\";\n          const blob = new Blob(chunks, { type: mimeType });\n\n          const timestamp = new Date()\n            .toISOString()\n            .replace(/[:]/g, \"-\")\n            .split(\".\")[0];\n          const filename = `月亮節AR_月相影片_${timestamp}.${extension}`;\n\n          const storedUrl = this.storeRecordingBlob(blob, filename);\n          resolve({\n            png: staticPersonDataURL,\n            video: storedUrl,\n            duration: DURATION_SECONDS,\n            format: extension,\n            saved: true,\n          });\n        };\n\n        recorder.onerror = (event) => {\n          console.error(\"錄製錯誤:\", event.error);\n          reject(event.error);\n        };\n\n        recorder.start();\n        this.recordFrames(recordCtx, recordCanvas, personImg, totalFrames, FPS, CONFIG, backgroundRenderer, bgMoonVideoEl);\n      };\n\n      personImg.onerror = () => reject(new Error(\"靜止人物圖片載入失敗\"));\n      personImg.src = staticPersonDataURL;\n    });\n  }\n\n  // 取得錄製器選項\n  getRecorderOptions() {\n    if (this.outputFormat === \"mp4\") {\n      if (MediaRecorder.isTypeSupported(\"video/mp4; codecs=h264\")) {\n        return { mimeType: \"video/mp4; codecs=h264\", videoBitsPerSecond: 3000000 };\n      } else if (MediaRecorder.isTypeSupported(\"video/mp4\")) {\n        return { mimeType: \"video/mp4\", videoBitsPerSecond: 3000000 };\n      } else {\n        console.warn(\"瀏覽器不支援 MP4，降級到 WebM\");\n        this.outputFormat = \"webm\";\n        return { mimeType: \"video/webm; codecs=vp8\", videoBitsPerSecond: 3000000 };\n      }\n    } else {\n      return { mimeType: \"video/webm; codecs=vp8\", videoBitsPerSecond: 3000000 };\n    }\n  }\n\n  // 錄製幀\n  recordFrames(recordCtx, recordCanvas, personImg, totalFrames, FPS, CONFIG, backgroundRenderer, bgMoonVideoEl) {\n    let frame = 0;\n\n    const drawFrame = () => {\n      recordCtx.clearRect(0, 0, recordCanvas.width, recordCanvas.height);\n\n      // 渲染背景\n      backgroundRenderer.renderBackgroundTo(\n        recordCtx,\n        recordCanvas.width,\n        recordCanvas.height,\n        null, // bgVideoEl\n        bgMoonVideoEl,\n        null  // iosMoonVideoEl\n      );\n\n      // 渲染靜止人物\n      const personWidth = personImg.naturalWidth || personImg.width;\n      const personHeight = personImg.naturalHeight || personImg.height;\n\n      if (personWidth > 0 && personHeight > 0) {\n        const personScale = Math.max(\n          recordCanvas.width / personWidth,\n          recordCanvas.height / personHeight\n        );\n        const personDrawWidth = Math.round(personWidth * personScale);\n        const personDrawHeight = Math.round(personHeight * personScale);\n        const personOffsetX = Math.round((recordCanvas.width - personDrawWidth) / 2);\n        const personOffsetY = Math.round((recordCanvas.height - personDrawHeight) / 2);\n\n        recordCtx.drawImage(\n          personImg,\n          0, 0, personWidth, personHeight,\n          personOffsetX, personOffsetY, personDrawWidth, personDrawHeight\n        );\n      }\n\n      frame++;\n      \n      // 更新進度\n      if (this.progressCallback) {\n        const currentTime = frame / FPS;\n        this.progressCallback.updateProgress(currentTime, 8);\n      }\n\n      // 繼續或結束\n      if (frame < totalFrames) {\n        setTimeout(drawFrame, 1000 / FPS);\n      } else {\n        if (this.progressCallback) {\n          this.progressCallback.setStatus(\"錄製完成，正在生成檔案...\");\n        }\n        console.log(\"所有幀錄製完成\");\n      }\n    };\n\n    drawFrame();\n  }\n}\n\n// 向後相容的全域函數導出\nexport function storeRecordingBlob(blob, filename) {\n  const manager = new RecordingManager();\n  return manager.storeRecordingBlob(blob, filename);\n}\n\nexport function hasRecordingAvailable() {\n  return !!lastRecordedBlob;\n}\n\nexport function getLastRecordingUrl() {\n  return lastRecordedObjectUrl || null;\n}\n\nexport function clearLastRecording() {\n  _revokeLastObjectUrl();\n  lastRecordedBlob = null;\n  lastRecordedFilename = null;\n}\n\nexport function getLastRecordingFilename() {\n  return lastRecordedFilename;\n}\n\nexport async function uploadBlobToServerAndGetUrl(blob, filename) {\n  const manager = new RecordingManager();\n  return manager.uploadBlobToServerAndGetUrl(blob, filename);\n}\n\nexport async function shareLastRecording() {\n  const manager = new RecordingManager();\n  return manager.shareLastRecording();\n}\n\nexport function setRecordingProgressCallback(callback) {\n  recordingProgressCallback = callback;\n}\n\nexport function setVideoOutputFormat(format) {\n  videoOutputFormat = format;\n}","// segmentationCore.js - 重構版本使用模組化架構\n// 現在使用獨立模組來管理各種功能，提高代碼可維護性\n\n// 導入新的模組化核心\nimport { CONFIG, saveConfig, resetConfig, initializeConfig } from './core/config.js';\nimport { MediaPipeManager } from './core/mediaPipeManager.js';\nimport { CameraManager } from './core/cameraManager.js';\nimport { BackgroundRenderer } from './core/backgroundRenderer.js';\nimport { RecordingManager } from './core/recordingManager.js';\n\n// 重新導出配置相關函數以保持向後相容\nexport { CONFIG, saveConfig, resetConfig, initializeConfig };\n\n// 錄影管理器 - 使用新的模組化架構\nconst recordingManager = new RecordingManager();\n\n// 導出錄影相關函數以保持向後相容\nexport function storeRecordingBlob(blob, filename) {\n  return recordingManager.storeRecordingBlob(blob, filename);\n}\n\nexport function hasRecordingAvailable() {\n  return recordingManager.hasRecordingAvailable();\n}\n\nexport function getLastRecordingUrl() {\n  return recordingManager.getLastRecordingUrl();\n}\n\nexport function clearLastRecording() {\n  return recordingManager.clearLastRecording();\n}\n\nexport function getLastRecordingFilename() {\n  return recordingManager.getLastRecordingFilename();\n}\n\nexport async function uploadBlobToServerAndGetUrl(blob, filename) {\n  return recordingManager.uploadBlobToServerAndGetUrl(blob, filename);\n}\n\nexport async function shareLastRecording() {\n  return recordingManager.shareLastRecording();\n}\n\n// -----------------------------------------------------------------------------\n// 核心管理器實例和狀態\n// -----------------------------------------------------------------------------\nconst mediaPipeManager = new MediaPipeManager();\nconst cameraManager = new CameraManager();\nconst backgroundRenderer = new BackgroundRenderer();\n\nlet running = false;\nlet lastFaceDetectionState = false;\n\n// DOM 元素\nlet videoEl, bgCanvas, maskCanvas, outCanvas, bgVideoEl, bgMoonVideoEl, iosMoonVideoEl;\nlet bgCtx, maskCtx, outCtx;\n\n// iOS 設備檢測\nlet isIOSDevice = false;\n\n// Callbacks（由 UI 模組註冊）\nlet onStatus = (t) => {};\nlet onStats = (stats) => {}; // { faceCount, facesInArea, moonActive }\n\n// -----------------------------------------------------------------------------\n// 內部暫存\n// -----------------------------------------------------------------------------\nlet personLabelIndex = 0;\nlet lastMaskF32 = null;\nlet lastMaskSize = { w: 0, h: 0 };\nlet gMaskCanvasProcessed = null;\n\n// offscreen\nconst videoDrawCanvas = document.createElement(\"canvas\");\nconst videoDrawCtx = videoDrawCanvas.getContext(\"2d\");\nvideoDrawCanvas.style.display = \"none\";\n\nconst compositeCanvas = document.createElement(\"canvas\");\nconst compositeCtx = compositeCanvas.getContext(\"2d\");\ncompositeCanvas.style.display = \"none\";\n\n// 蒙版中繼\nconst maskBaseCanvas = document.createElement(\"canvas\");\nconst maskBaseCtx = maskBaseCanvas.getContext(\"2d\");\nconst maskUpscaleCanvas = document.createElement(\"canvas\");\nconst maskUpscaleCtx = maskUpscaleCanvas.getContext(\"2d\");\nconst maskSoftCanvas = document.createElement(\"canvas\");\nconst maskSoftCtx = maskSoftCanvas.getContext(\"2d\");\n\n// 其他\nlet animT = 0;\nlet lastVideoTime = -1;\n\n// -----------------------------------------------------------------------------\n// 工具：裝置自動調整 / 驗證 / 設定持久化\n// -----------------------------------------------------------------------------\n// 配置相關函數已移至 src/core/config.js 模組\n\n// 初始化 / 向後相容補位\n// initializeConfig 已從 config.js 模組導入並重新導出\n\n// -----------------------------------------------------------------------------\n// 初始化核心（由 UI 模組呼叫，把必要 DOM 傳進來 + 註冊回呼）\n// -----------------------------------------------------------------------------\nexport function initCore(els, callbacks = {}) {\n  videoEl = els.videoEl;\n  bgCanvas = els.bgCanvas;\n  maskCanvas = els.maskCanvas;\n  outCanvas = els.outCanvas;\n  bgVideoEl = els.bgVideoEl || null;\n  bgMoonVideoEl = els.bgMoonVideoEl || null;\n  iosMoonVideoEl = els.iosMoonVideoEl || null;\n  isIOSDevice = els.isIOSDevice || false;\n  \n  console.log('📱 SegmentationCore 設備資訊:', {\n    isIOSDevice,\n    hasIOSMoonVideo: !!iosMoonVideoEl,\n    hasNormalMoonVideo: !!bgMoonVideoEl\n  });\n\n  bgCtx = bgCanvas.getContext(\"2d\");\n  maskCtx = maskCanvas.getContext(\"2d\");\n  outCtx = outCanvas.getContext(\"2d\");\n\n  if (typeof callbacks.onStatus === \"function\") onStatus = callbacks.onStatus;\n  if (typeof callbacks.onStats === \"function\") onStats = callbacks.onStats;\n\n  // 初始化管理器\n  cameraManager.setVideoElement(videoEl);\n  backgroundRenderer.setIOSDevice(isIOSDevice);\n  recordingManager.setProgressCallback(callbacks.onProgress);\n\n  // ✅ 啟動就同步一次 Canvas 尺寸（包含 DPR 對齊）\n  syncCanvasSize();\n\n  // ✅ 視窗大小變更時同步（避免旋轉或視窗改變導致糊掉）\n  window.addEventListener('resize', onResize);\n}\n\n// MediaPipe 初始化現在由 mediaPipeManager 負責\n// 舊的初始化代碼已移至 src/core/mediaPipeManager.js\n\n// -----------------------------------------------------------------------------\n// 相機控制 - 現在由 cameraManager 負責\n// -----------------------------------------------------------------------------\nexport async function switchCamera() {\n  await cameraManager.switchCamera();\n  syncCanvasSize();\n}\n\n// -----------------------------------------------------------------------------\n// 畫布尺寸同步\n// -----------------------------------------------------------------------------\nexport function syncCanvasSize() {\n  const stageEl = outCanvas.closest(\".stage\") || outCanvas.parentElement;\n\n  // 1) 取可視區尺寸（行動裝置地址列收合更準）\n  const getViewportSize = () => {\n    const vv = window.visualViewport;\n    return {\n      w: Math.round(vv?.width  || window.innerWidth  || document.documentElement.clientWidth  || 360),\n      h: Math.round(vv?.height || window.innerHeight || document.documentElement.clientHeight || 640),\n    };\n  };\n\n  // 2) CSS 尺寸（邏輯像素）：滿版就直接吃 viewport；否則吃容器 rect\n  let cssW, cssH;\n  if (CONFIG.DISPLAY?.FULLBLEED) {\n    const { w, h } = getViewportSize();\n    cssW = w;\n    cssH = h;\n\n    // 讓容器撐滿（若你已用 fixed inset-0，可保留這段或移除都行）\n    if (stageEl && stageEl.style) {\n      stageEl.style.position = \"fixed\";\n      stageEl.style.top = \"0\";\n      stageEl.style.left = \"0\";\n      stageEl.style.right = \"0\";\n      stageEl.style.bottom = \"0\";\n      stageEl.style.width = \"100dvw\";\n      stageEl.style.height = \"100dvh\";\n      stageEl.style.margin = \"0\";\n      stageEl.style.padding = \"0\";\n      stageEl.style.overflow = \"hidden\";\n    }\n  } else {\n    const rect = stageEl.getBoundingClientRect();\n    cssW = Math.max(320, Math.round(rect.width));\n    cssH = Math.max(240, Math.round(rect.height));\n  }\n\n  // ❗ 不要再限制 CSS 高度到 720，讓畫面真的滿版\n  // （保效能改在像素層做，而不是 CSS 尺寸）\n\n  // 3) 像素層級的軟上限：限制「有效 DPR」而非 CSS 尺寸\n  const dpr = Math.max(1, Math.min(window.devicePixelRatio || 1, 3));\n  const maxWpx = (window.innerWidth > 768) ? 1920 : 1280;  // 你可依機型微調\n  const maxHpx = (window.innerHeight > 1024) ? 1080 : 1280;\n\n  // 讓 canvas 真正像素不超過上限，但畫面仍維持滿版\n  const dprEff = Math.min(dpr, maxWpx / cssW, maxHpx / cssH);\n\n  const pixelW = Math.round(cssW * dprEff);\n  const pixelH = Math.round(cssH * dprEff);\n\n  const setSize = (c) => {\n    if (c.width !== pixelW || c.height !== pixelH) {\n      c.width  = pixelW;   // 實際像素（決定清晰度）\n      c.height = pixelH;\n    }\n    c.style.width  = `${cssW}px`; // CSS 尺寸（決定畫面是否滿版）\n    c.style.height = `${cssH}px`;\n  };\n\n  [bgCanvas, maskCanvas, outCanvas, videoDrawCanvas, compositeCanvas].forEach(setSize);\n\n  lastMaskSize = { w: outCanvas.width, h: outCanvas.height };\n}\n\n// -----------------------------------------------------------------------------\n// 背景繪製（含「影片」背景選項）\n// -----------------------------------------------------------------------------\nfunction renderBackgroundTo(ctx, w, h) {\n  const bgType =\n    (CONFIG.BACKGROUND && CONFIG.BACKGROUND.TYPE) ||\n    (CONFIG.BACKGROUND_EFFECTS &&\n      CONFIG.BACKGROUND_EFFECTS.DEFAULT_BACKGROUND) ||\n    \"original\";\n  const intensity =\n    CONFIG.BACKGROUND && typeof CONFIG.BACKGROUND.INTENSITY === \"number\"\n      ? CONFIG.BACKGROUND.INTENSITY\n      : (CONFIG.BACKGROUND_EFFECTS &&\n          CONFIG.BACKGROUND_EFFECTS.EFFECT_INTENSITY) ??\n        0.5;\n\n  ctx.clearRect(0, 0, w, h);\n  animT += 0.016;\n\n  if (bgType === \"original\") {\n    // 透明\n    return;\n  }\n  if (bgType === \"waves\") {\n    const grad = ctx.createLinearGradient(0, 0, w, h);\n    grad.addColorStop(0, \"#1a2332\");\n    grad.addColorStop(0.5, \"#2d3a50\");\n    grad.addColorStop(1, \"#0f1419\");\n    ctx.fillStyle = grad;\n    ctx.fillRect(0, 0, w, h);\n    ctx.strokeStyle = `rgba(100,200,255,${intensity * 0.6})`;\n    ctx.lineWidth = 2;\n    for (let i = 0; i < 8; i++) {\n      ctx.beginPath();\n      for (let x = 0; x < w; x += 5) {\n        const off = i * 50;\n        const y =\n          h / 2 + Math.sin((x + off) * 0.012 + animT * 1.2) * 20 * intensity;\n        if (x === 0) ctx.moveTo(x, y);\n        else ctx.lineTo(x, y);\n      }\n      ctx.stroke();\n    }\n    return;\n  }\n  if (bgType === \"frequency\") {\n    ctx.fillStyle = \"#0a0a0a\";\n    ctx.fillRect(0, 0, w, h);\n    const bands = 48;\n    const bw = w / bands;\n    for (let i = 0; i < bands; i++) {\n      const x = i * bw;\n      const bh =\n        (Math.sin(animT * 2 + i * 0.2) * 0.5 + 0.5) * h * 0.5 * intensity;\n      const hue = (animT * 30 + i * 10) % 360;\n      ctx.fillStyle = `hsla(${hue},70%,60%,0.8)`;\n      ctx.fillRect(x, h - bh, bw - 1, bh);\n    }\n    return;\n  }\n  if (bgType === \"video\" && bgVideoEl) {\n    // 以 cover 方式鋪滿\n    const vw = bgVideoEl.videoWidth || 1;\n    const vh = bgVideoEl.videoHeight || 1;\n    if (bgVideoEl.readyState >= 2) {\n      const scale = Math.max(w / vw, h / vh);\n      const dw = Math.round(vw * scale);\n      const dh = Math.round(vh * scale);\n      const ox = Math.round((w - dw) / 2);\n      const oy = Math.round((h - dh) / 2);\n      try {\n        if (bgVideoEl.paused) bgVideoEl.play().catch(() => {});\n      } catch {}\n      ctx.globalAlpha = Math.min(1, 0.3 + intensity * 0.7);\n      ctx.drawImage(bgVideoEl, 0, 0, vw, vh, ox, oy, dw, dh);\n      ctx.globalAlpha = 1;\n    }\n    return;\n  }\n  // 月相影片背景\n  if (bgType === \"moon_video\" && bgMoonVideoEl) {\n    try {\n      // Debug removed - moon video working properly\n      \n      if (bgMoonVideoEl.readyState >= 2 && !bgMoonVideoEl.paused) {\n        const vw = bgMoonVideoEl.videoWidth || bgMoonVideoEl.width || 1;\n        const vh = bgMoonVideoEl.videoHeight || bgMoonVideoEl.height || 1;\n        if (vw > 1 && vh > 1) {\n          const scale = Math.max(w / vw, h / vh);\n          const dw = Math.round(vw * scale);\n          const dh = Math.round(vh * scale);\n          const ox = Math.round((w - dw) / 2);\n          const oy = Math.round((h - dh) / 2);\n\n          ctx.globalAlpha = Math.min(1, 0.3 + intensity * 0.7);\n          ctx.drawImage(bgMoonVideoEl, 0, 0, vw, vh, ox, oy, dw, dh);\n          ctx.globalAlpha = 1;\n          // Moon video rendered successfully\n        } else {\n          console.warn(\"🌙 Moon video dimensions too small:\", { vw, vh });\n        }\n      } else if (bgMoonVideoEl.paused) {\n        // Moon video is paused, attempting to play\n        bgMoonVideoEl.play().catch((e) => console.warn(\"月相影片播放失敗:\", e));\n      } else {\n        console.warn(\"🌙 Moon video not ready:\", { \n          readyState: bgMoonVideoEl.readyState, \n          paused: bgMoonVideoEl.paused \n        });\n      }\n    } catch (e) {\n      console.warn(\"月相影片渲染錯誤:\", e);\n    }\n    return;\n  }\n  \n  // 自定義背景 + 圓形月亮合成\n  if (bgType === \"custom_moon_bg\" && customBackgroundImage) {\n    try {\n      // iOS 設備特殊處理：使用背景圖片 + App.vue 中的全螢幕透明 MOV\n      if (isIOSDevice) {\n        // iOS 設備只繪製背景圖片，月亮由 App.vue 的全螢幕 MOV 處理\n        if (customBackgroundImage) {\n          const imgW = customBackgroundImage.naturalWidth || customBackgroundImage.width;\n          const imgH = customBackgroundImage.naturalHeight || customBackgroundImage.height;\n          if (imgW > 0 && imgH > 0) {\n            const scale = Math.max(w / imgW, h / imgH);\n            const dw = Math.round(imgW * scale);\n            const dh = Math.round(imgH * scale);\n            const ox = Math.round((w - dw) / 2);\n            const oy = Math.round((h - dh) / 2);\n            ctx.drawImage(customBackgroundImage, 0, 0, imgW, imgH, ox, oy, dw, dh);\n          }\n        }\n        return; // iOS 設備不繪製圓形月亮，由 MOV 處理\n      }\n      \n      // 非 iOS 設備：傳統三層合成模式\n      // 第一層：自定義背景圖片\n      if (customBackgroundImage) {\n        const imgW = customBackgroundImage.naturalWidth || customBackgroundImage.width;\n        const imgH = customBackgroundImage.naturalHeight || customBackgroundImage.height;\n        if (imgW > 0 && imgH > 0) {\n          const scale = Math.max(w / imgW, h / imgH);\n          const dw = Math.round(imgW * scale);\n          const dh = Math.round(imgH * scale);\n          const ox = Math.round((w - dw) / 2);\n          const oy = Math.round((h - dh) / 2);\n          ctx.drawImage(customBackgroundImage, 0, 0, imgW, imgH, ox, oy, dw, dh);\n        }\n      }\n      \n      // 第二層：圓形月亮 MP4 (非 iOS 設備用)\n      if (bgMoonVideoEl && bgMoonVideoEl.readyState >= 2 && !bgMoonVideoEl.paused) {\n        const vw = bgMoonVideoEl.videoWidth || bgMoonVideoEl.width || 1;\n        const vh = bgMoonVideoEl.videoHeight || bgMoonVideoEl.height || 1;\n        \n        if (vw > 1 && vh > 1) {\n          ctx.save();\n          \n          // 響應式圓形裁剪路徑計算\n          // 根據螢幕比例調整月亮位置，確保在各種手機尺寸下都能正確顯示\n          const aspectRatio = w / h;\n          let centerX, centerY, radius;\n          \n          if (aspectRatio > 0.6) {\n            // 較寬的螢幕 (如平板橫向)\n            centerX = w * 0.5;\n            centerY = h * 0.35;\n            radius = Math.min(w, h) * 0.25;\n          } else if (aspectRatio > 0.5) {\n            // 標準手機螢幕 (9:16 到 9:18)\n            centerX = w * 0.51;\n            centerY = h * 0.29;\n            radius = Math.min(w, h) * 0.29;\n          } else {\n            // 超長螢幕 (如 9:19.5, 9:20)\n            centerX = w * 0.51;\n            centerY = h * 0.26;\n            radius = Math.min(w, h) * 0.30;\n          }\n          \n          ctx.beginPath();\n          ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);\n          ctx.clip();\n          \n          // 繪製月亮影片 (以 cover 方式)\n          const scale = Math.max(w / vw, h / vh);\n          const dw = Math.round(vw * scale);\n          const dh = Math.round(vh * scale);\n          const ox = Math.round((w - dw) / 2);\n          const oy = Math.round((h - dh) / 2);\n          \n          ctx.globalAlpha = Math.min(1, 0.8 + intensity * 0.2);\n          ctx.drawImage(bgMoonVideoEl, 0, 0, vw, vh, ox, oy, dw, dh);\n          ctx.globalAlpha = 1;\n          \n          ctx.restore();\n        }\n      } else if (bgMoonVideoEl && bgMoonVideoEl.paused) {\n        // 自動播放月相影片\n        bgMoonVideoEl.play().catch((e) => console.warn(\"月相影片播放失敗:\", e));\n      }\n      \n    } catch (e) {\n      console.warn(\"自定義背景 + 圓形月亮渲染錯誤:\", e);\n    }\n    return;\n  }\n}\n\nfunction renderBackground(w, h) {\n  backgroundRenderer.setIOSDevice(isIOSDevice);\n  backgroundRenderer.renderBackgroundTo(bgCtx, w, h, bgVideoEl, bgMoonVideoEl, iosMoonVideoEl);\n}\n\n// -----------------------------------------------------------------------------\n// 蒙版處理（EMA 平滑 + 邊緣羽化）\n// -----------------------------------------------------------------------------\nfunction emaUpdate(srcF32, w, h) {\n  const N = w * h;\n  if (!lastMaskF32 || lastMaskSize.w !== w || lastMaskSize.h !== h) {\n    lastMaskF32 = new Float32Array(N);\n    lastMaskF32.set(srcF32);\n    lastMaskSize = { w, h };\n    return lastMaskF32;\n  }\n  const a = CONFIG.SMOOTHING.TEMPORAL_ALPHA;\n  for (let i = 0; i < N; i++) {\n    lastMaskF32[i] = a * lastMaskF32[i] + (1 - a) * srcF32[i];\n  }\n  return lastMaskF32;\n}\n\nfunction buildAlphaImage(maskF32, w, h) {\n  const T = CONFIG.SMOOTHING.THRESHOLD;\n  const N = w * h;\n  const img = new ImageData(w, h);\n  for (let i = 0, j = 0; i < N; i++, j += 4) {\n    const v = maskF32[i];\n    const a = v >= T ? Math.min(255, Math.round(v * 255)) : 0;\n    img.data[j] = 0;\n    img.data[j + 1] = 0;\n    img.data[j + 2] = 0;\n    img.data[j + 3] = a;\n  }\n  maskBaseCanvas.width = w;\n  maskBaseCanvas.height = h;\n  maskBaseCtx.putImageData(img, 0, 0);\n\n  const VW = outCanvas.width,\n    VH = outCanvas.height;\n  maskUpscaleCanvas.width = VW;\n  maskUpscaleCanvas.height = VH;\n  maskUpscaleCtx.clearRect(0, 0, VW, VH);\n  maskUpscaleCtx.imageSmoothingEnabled = true;\n  maskUpscaleCtx.imageSmoothingQuality = \"high\";\n  maskUpscaleCtx.drawImage(maskBaseCanvas, 0, 0, VW, VH);\n\n  const blurPx = CONFIG.SMOOTHING.EDGE_FEATHER_PX;\n  maskSoftCanvas.width = VW;\n  maskSoftCanvas.height = VH;\n  maskSoftCtx.clearRect(0, 0, VW, VH);\n  maskSoftCtx.filter = blurPx > 0 ? `blur(${blurPx}px)` : \"none\";\n  maskSoftCtx.drawImage(maskUpscaleCanvas, 0, 0);\n  maskSoftCtx.filter = \"none\";\n  return maskSoftCanvas;\n}\n\n// -----------------------------------------------------------------------------\n// 臉部檢測 / 區域與疊圖\n// -----------------------------------------------------------------------------\nfunction checkFacesInArea(detections) {\n  // 現在整個畫面都是偵測範圍，直接返回所有偵測到的人臉\n  return detections;\n}\n\nfunction renderOverlay(detections) {\n  const W = outCanvas.width,\n    H = outCanvas.height;\n  outCtx.save();\n  outCtx.translate(W, 0);\n  outCtx.scale(-1, 1);\n\n\n\n  const facesIn = checkFacesInArea(detections);\n  outCtx.restore();\n\n  // Debug: 檢查檢測結果\n  if (detections.length > 0) {\n    console.log('🔍 偵測到', detections.length, '個人臉，符合條件的:', facesIn.length);\n  }\n\n  // 根據人像偵測狀態動態切換去背功能和背景類型\n  const currentFaceDetectionState = facesIn.length >= CONFIG.FACE_DETECTION_SETTINGS.REQUIRED_FACES;\n  \n  if (currentFaceDetectionState !== lastFaceDetectionState) {\n    if (currentFaceDetectionState) {\n      // 偵測到人像：觸發測試按鈕的效果\n      if (typeof onStatus === 'function') {\n        onStatus('TRIGGER_TEST_EFFECT');\n      }\n    } else {\n      // 沒有偵測到人像：恢復正常狀態\n      if (typeof onStatus === 'function') {\n        onStatus('STOP_TEST_EFFECT');\n      }\n    }\n    lastFaceDetectionState = currentFaceDetectionState;\n  }\n\n  // 更新回呼\n  onStats({\n    faceCount: detections.length,\n    facesInArea: facesIn.length,\n    moonActive: facesIn.length >= CONFIG.FACE_DETECTION_SETTINGS.REQUIRED_FACES,\n  });\n}\n\n// -----------------------------------------------------------------------------\n// 主渲染迴圈\n// -----------------------------------------------------------------------------\nasync function renderLoop() {\n  if (!running) return;\n  const now = performance.now();\n  const W = outCanvas.width,\n    H = outCanvas.height;\n\n  // 背景\n  outCtx.clearRect(0, 0, W, H);\n  renderBackground(W, H);\n\n  // 將 video 以 cover 方式畫到暫存（滿版顯示）\n  videoDrawCtx.clearRect(0, 0, W, H);\n  const vw = videoEl.videoWidth || 1,\n    vh = videoEl.videoHeight || 1;\n  const scale = Math.max(W / vw, H / vh);\n  const dw = Math.round(vw * scale),\n    dh = Math.round(vh * scale);\n  const ox = Math.round((W - dw) / 2),\n    oy = Math.round((H - dh) / 2);\n  try {\n    videoDrawCtx.drawImage(videoEl, 0, 0, vw, vh, ox, oy, dw, dh);\n  } catch {}\n\n  // Segmentation（使用新的 mediaPipeManager）\n  if (CONFIG.SEGMENTATION.ENABLED) {\n    if (videoEl.currentTime !== lastVideoTime) {\n      lastVideoTime = videoEl.currentTime;\n      const result = await mediaPipeManager.segmentImage(videoDrawCanvas, now);\n      if (result) {\n        let maskF32 = null,\n          mw = 0,\n          mh = 0;\n        if (result.confidenceMasks && result.confidenceMasks.length) {\n          const idx =\n            personLabelIndex < result.confidenceMasks.length\n              ? personLabelIndex\n              : 0;\n          const cm = result.confidenceMasks[idx];\n          if (cm?.getAsFloat32Array) {\n            const src = cm.getAsFloat32Array();\n            maskF32 = new Float32Array(src.length);\n            maskF32.set(src);\n            mw = cm.width;\n            mh = cm.height;\n          }\n          for (const m of result.confidenceMasks) {\n            try {\n              m?.close?.();\n            } catch {}\n          }\n        } else if (result.categoryMask?.getAsUint8Array) {\n          const cat = result.categoryMask;\n          const u8 = cat.getAsUint8Array();\n          maskF32 = new Float32Array(u8.length);\n          mw = cat.width;\n          mh = cat.height;\n          const personIdx = personLabelIndex;\n          for (let i = 0; i < u8.length; i++)\n            maskF32[i] = u8[i] === personIdx ? 1 : 0;\n          try {\n            cat.close?.();\n          } catch {}\n        }\n        if (maskF32 && mw && mh) {\n          const sm = emaUpdate(maskF32, mw, mh);\n          gMaskCanvasProcessed = buildAlphaImage(sm, mw, mh);\n        }\n      }\n    }\n  } else {\n    gMaskCanvasProcessed = null;\n  }\n\n  // composite：先把人物合成到離屏，再畫回 outCanvas（避免破壞背景）\n  compositeCtx.clearRect(0, 0, W, H);\n  compositeCtx.save();\n  compositeCtx.drawImage(videoDrawCanvas, 0, 0, W, H);\n  if (gMaskCanvasProcessed) {\n    compositeCtx.globalCompositeOperation = \"destination-in\";\n    compositeCtx.drawImage(gMaskCanvasProcessed, 0, 0, W, H);\n    compositeCtx.globalCompositeOperation = \"source-over\";\n  }\n  compositeCtx.restore();\n\n  // 以鏡像方式繪回（與原本一致）\n  outCtx.save();\n  outCtx.translate(W, 0);\n  outCtx.scale(-1, 1);\n  outCtx.drawImage(compositeCanvas, 0, 0, W, H);\n  outCtx.restore();\n\n  // Mask 預覽\n  maskCtx.clearRect(0, 0, W, H);\n  if (gMaskCanvasProcessed && _showMaskPreview) {\n    maskCtx.globalAlpha = 0.9;\n    maskCtx.drawImage(gMaskCanvasProcessed, 0, 0, W, H);\n    maskCtx.globalAlpha = 1.0;\n    maskCanvas.style.display = \"block\";\n  } else {\n    maskCanvas.style.display = \"none\";\n  }\n\n  // 臉部檢測（使用新的 mediaPipeManager）\n  const det = mediaPipeManager.detectFaces(videoDrawCanvas, now);\n  if (det) {\n    renderOverlay(det.detections || []);\n  } else {\n    // 沒有檢測結果時，仍然調用 renderOverlay 以便重置狀態\n    renderOverlay([]);\n  }\n\n  requestAnimationFrame(renderLoop);\n}\n\n// -----------------------------------------------------------------------------\n// 公開 API：start/stop/onResize & 參數 setters\n// -----------------------------------------------------------------------------\nexport async function start() {\n  if (running) return;\n  const ok = initializeConfig();\n  if (!ok) {\n    onStatus(\"配置錯誤，請檢查控制台\");\n    return;\n  }\n  onStatus(\"初始化...\");\n\n  // ✅ 在初始化 MediaPipe 與開啟相機前，再同步一次尺寸（確保舞台最新）\n  syncCanvasSize();\n\n  await mediaPipeManager.init(outCanvas);\n  await cameraManager.startCamera();\n\n  running = true;\n  onStatus(\"檢測中\");\n  requestAnimationFrame(renderLoop);\n}\n\nexport function stop() {\n  running = false;\n  cameraManager.stopCamera();\n  if (outCtx && maskCtx && bgCtx) {\n    outCtx.clearRect(0, 0, outCanvas.width, outCanvas.height);\n    maskCtx.clearRect(0, 0, maskCanvas.width, maskCanvas.height);\n    bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height);\n  }\n  onStats({ faceCount: 0, facesInArea: 0, moonActive: false });\n  onStatus(\"已停止\");\n}\n\nexport function onResize() {\n  if (running) syncCanvasSize();\n}\n\n// setters\nlet _showMaskPreview = false;\nexport function setShowMaskPreview(v) {\n  _showMaskPreview = !!v;\n}\nexport function setEnableSegmentation(v) {\n  CONFIG.SEGMENTATION.ENABLED = !!v;\n}\nexport function setBackgroundType(t) {\n  CONFIG.BACKGROUND.TYPE = t;\n}\nexport function setBackgroundIntensity(p01) {\n  CONFIG.BACKGROUND.INTENSITY = Math.max(0, Math.min(1, p01));\n}\nexport function setEdgeFeather(px) {\n  CONFIG.SMOOTHING.EDGE_FEATHER_PX = Math.max(0, Number(px) || 0);\n}\nexport function setTemporalAlpha(v01) {\n  CONFIG.SMOOTHING.TEMPORAL_ALPHA = Math.max(\n    0,\n    Math.min(0.95, Number(v01) || 0)\n  );\n}\nexport function setThreshold(v01) {\n  CONFIG.SMOOTHING.THRESHOLD = Math.max(0, Math.min(1, Number(v01) || 0));\n}\n\n// 為了向後相容，保留 GIF 相關 setter（no-op），你之後可以完全移除\nexport function setGifBlendMode(mode) {\n  // no-op: GIF 功能已移除於 core\n  CONFIG.BACKGROUND.GIF_BLEND_MODE = mode;\n}\nexport function setShouldGenerateGif(value) {\n  // no-op\n  return;\n}\n\n// 便利：提供目前是否在跑\nexport function isRunning() {\n  return running;\n}\n\n// 錄影相關函數導出\nexport function setRecordingProgressCallback(callback) {\n  recordingManager.setProgressCallback(callback);\n}\n\nexport function setVideoOutputFormat(format) {\n  recordingManager.setOutputFormat(format);\n}\n\n// -----------------------------------------------------------------------------\n// 拍照功能 - 現在使用 recordingManager\n// -----------------------------------------------------------------------------\nexport async function capturePhoto() {\n  return recordingManager.capturePhoto(outCanvas, bgCanvas, CONFIG, backgroundRenderer, bgMoonVideoEl);\n}\n\n// 捕獲原始相機畫面（無背景替換）\nexport async function captureOriginalFrame() {\n  if (!videoEl || !videoEl.videoWidth || !videoEl.videoHeight) {\n    console.error('Video element not ready for capture');\n    return null;\n  }\n  \n  // 創建臨時canvas來捕獲原始畫面\n  const tempCanvas = document.createElement('canvas');\n  tempCanvas.width = videoEl.videoWidth;\n  tempCanvas.height = videoEl.videoHeight;\n  const tempCtx = tempCanvas.getContext('2d');\n  \n  // 繪製原始相機畫面\n  tempCtx.drawImage(videoEl, 0, 0);\n  \n  // 返回 data URL\n  return tempCanvas.toDataURL('image/png');\n}\n\n// 生成帶背景的預覽圖片\nexport async function generatePreviewWithBackground(previewCanvas, originalImageData, backgroundImageSrc) {\n  if (!previewCanvas || !originalImageData) {\n    console.error('Missing canvas or image data for preview');\n    return;\n  }\n  \n  try {\n    // 載入原始圖片\n    const originalImg = new Image();\n    originalImg.src = originalImageData;\n    await new Promise((resolve, reject) => {\n      originalImg.onload = resolve;\n      originalImg.onerror = reject;\n    });\n    \n    // 載入背景圖片\n    const backgroundImg = new Image();\n    backgroundImg.src = backgroundImageSrc;\n    await new Promise((resolve, reject) => {\n      backgroundImg.onload = resolve;\n      backgroundImg.onerror = reject;\n    });\n    \n    // 設定canvas尺寸\n    previewCanvas.width = originalImg.width;\n    previewCanvas.height = originalImg.height;\n    const ctx = previewCanvas.getContext('2d');\n    \n    // 如果沒有可用的人像分割蒙版，暫時只顯示原圖\n    if (!lastMaskF32 || !mediaPipeManager.isInitialized()) {\n      // 先繪製背景（縮放至填滿）\n      ctx.drawImage(backgroundImg, 0, 0, previewCanvas.width, previewCanvas.height);\n      \n      // 然後繪製原圖（透明度50%以展示效果）\n      ctx.globalAlpha = 0.8;\n      ctx.drawImage(originalImg, 0, 0);\n      ctx.globalAlpha = 1.0;\n      return;\n    }\n    \n    // 使用 MediaPipe 進行實際的背景替換\n    // 先繪製背景\n    ctx.drawImage(backgroundImg, 0, 0, previewCanvas.width, previewCanvas.height);\n    \n    // 創建蒙版canvas\n    const maskCanvas = document.createElement('canvas');\n    maskCanvas.width = previewCanvas.width;\n    maskCanvas.height = previewCanvas.height;\n    const maskCtx = maskCanvas.getContext('2d');\n    \n    // 應用分割蒙版（這裡需要將 lastMaskF32 轉換為canvas蒙版）\n    if (lastMaskF32 && lastMaskSize.w > 0 && lastMaskSize.h > 0) {\n      // 將Float32Array蒙版轉換為ImageData\n      const imageData = maskCtx.createImageData(lastMaskSize.w, lastMaskSize.h);\n      for (let i = 0; i < lastMaskF32.length; i++) {\n        const maskValue = Math.floor(lastMaskF32[i] * 255);\n        const pixelIndex = i * 4;\n        imageData.data[pixelIndex] = maskValue;     // R\n        imageData.data[pixelIndex + 1] = maskValue; // G  \n        imageData.data[pixelIndex + 2] = maskValue; // B\n        imageData.data[pixelIndex + 3] = 255;       // A\n      }\n      \n      // 將蒙版繪製到臨時canvas並縮放到目標尺寸\n      maskCtx.putImageData(imageData, 0, 0);\n      \n      // 使用蒙版合成最終圖像\n      ctx.globalCompositeOperation = 'destination-in';\n      ctx.drawImage(maskCanvas, 0, 0, previewCanvas.width, previewCanvas.height);\n      \n      // 繪製前景（人像）\n      ctx.globalCompositeOperation = 'source-over';\n      ctx.drawImage(originalImg, 0, 0);\n      \n      // 重置合成模式\n      ctx.globalCompositeOperation = 'source-over';\n    }\n    \n  } catch (error) {\n    console.error('Preview generation failed:', error);\n    // 錯誤時顯示原圖\n    const ctx = previewCanvas.getContext('2d');\n    const img = new Image();\n    img.src = originalImageData;\n    img.onload = () => {\n      previewCanvas.width = img.width;\n      previewCanvas.height = img.height;\n      ctx.drawImage(img, 0, 0);\n    };\n  }\n}\n\n// 為預覽頁面生成人像蒙版\nexport async function generatePersonMask(canvas, originalImg) {\n  if (!canvas || !originalImg) {\n    console.error('Missing canvas or original image for person mask generation');\n    return;\n  }\n  \n  try {\n    const ctx = canvas.getContext('2d');\n    \n    // 如果 MediaPipe 沒有初始化或沒有可用的蒙版數據，顯示原圖\n    if (!mediaPipeManager.isInitialized() || !lastMaskF32 || !lastMaskSize.w || !lastMaskSize.h) {\n      console.warn('MediaPipe not initialized or no mask available, showing original image');\n      \n      // 以鏡像方式繪製原圖（與相機預覽一致）\n      ctx.save();\n      ctx.scale(-1, 1);\n      ctx.translate(-canvas.width, 0);\n      ctx.drawImage(originalImg, 0, 0, canvas.width, canvas.height);\n      ctx.restore();\n      return;\n    }\n    \n    // 創建臨時 canvas 來處理蒙版\n    const tempCanvas = document.createElement('canvas');\n    tempCanvas.width = canvas.width;\n    tempCanvas.height = canvas.height;\n    const tempCtx = tempCanvas.getContext('2d');\n    \n    // 以鏡像方式繪製原圖到臨時 canvas\n    tempCtx.save();\n    tempCtx.scale(-1, 1);\n    tempCtx.translate(-tempCanvas.width, 0);\n    tempCtx.drawImage(originalImg, 0, 0, tempCanvas.width, tempCanvas.height);\n    tempCtx.restore();\n    \n    // 創建蒙版 canvas\n    const maskCanvas = document.createElement('canvas');\n    maskCanvas.width = lastMaskSize.w;\n    maskCanvas.height = lastMaskSize.h;\n    const maskCtx = maskCanvas.getContext('2d');\n    \n    // 將 Float32Array 蒙版轉換為 ImageData\n    const maskImageData = maskCtx.createImageData(lastMaskSize.w, lastMaskSize.h);\n    const threshold = CONFIG.SMOOTHING.THRESHOLD || 0.5;\n    \n    for (let i = 0; i < lastMaskF32.length; i++) {\n      const maskValue = lastMaskF32[i];\n      const alpha = maskValue >= threshold ? Math.min(255, Math.round(maskValue * 255)) : 0;\n      const pixelIndex = i * 4;\n      \n      maskImageData.data[pixelIndex] = 255;     // R\n      maskImageData.data[pixelIndex + 1] = 255; // G\n      maskImageData.data[pixelIndex + 2] = 255; // B\n      maskImageData.data[pixelIndex + 3] = alpha; // A\n    }\n    \n    // 將蒙版繪製到蒙版 canvas\n    maskCtx.putImageData(maskImageData, 0, 0);\n    \n    // 將蒙版縮放到輸出尺寸\n    const scaledMaskCanvas = document.createElement('canvas');\n    scaledMaskCanvas.width = canvas.width;\n    scaledMaskCanvas.height = canvas.height;\n    const scaledMaskCtx = scaledMaskCanvas.getContext('2d');\n    scaledMaskCtx.drawImage(maskCanvas, 0, 0, canvas.width, canvas.height);\n    \n    // 使用蒙版合成最終圖像\n    ctx.clearRect(0, 0, canvas.width, canvas.height);\n    ctx.drawImage(tempCanvas, 0, 0);\n    \n    // 應用蒙版\n    ctx.globalCompositeOperation = 'destination-in';\n    ctx.drawImage(scaledMaskCanvas, 0, 0);\n    \n    // 重置合成模式\n    ctx.globalCompositeOperation = 'source-over';\n    \n  } catch (error) {\n    console.error('Person mask generation failed:', error);\n    \n    // 錯誤時顯示原圖\n    const ctx = canvas.getContext('2d');\n    ctx.clearRect(0, 0, canvas.width, canvas.height);\n    ctx.save();\n    ctx.scale(-1, 1);\n    ctx.translate(-canvas.width, 0);\n    ctx.drawImage(originalImg, 0, 0, canvas.width, canvas.height);\n    ctx.restore();\n  }\n}\n\n// 預覽模式變數\nlet previewMode = false;\nlet previewImageData = null;\nlet previewBackgroundSrc = null;\n\n// 進入預覽模式\nexport function enterPreviewMode(imageDataUrl, backgroundSrc) {\n  previewMode = true;\n  previewImageData = imageDataUrl;\n  previewBackgroundSrc = backgroundSrc;\n  \n  // 啟用分割\n  setEnableSegmentation(true);\n  \n  // 設置自定義背景\n  setBackgroundType('custom_bg');\n  if (backgroundSrc) {\n    backgroundRenderer.setCustomBackground(backgroundSrc);\n  }\n}\n\n// 離開預覽模式\nexport function exitPreviewMode() {\n  previewMode = false;\n  previewImageData = null;\n  previewBackgroundSrc = null;\n  \n  // 恢復相機模式\n  setEnableSegmentation(false);\n  setBackgroundType('custom_moon_bg');\n}\n\n// 切換預覽背景\nexport function switchPreviewBackground(backgroundSrc) {\n  if (!previewMode) return;\n  \n  previewBackgroundSrc = backgroundSrc;\n  backgroundRenderer.setCustomBackground(backgroundSrc);\n}\n\n// 舊的錄影函數已移除，現在使用 recordingManager"],"names":["CONFIG","autoAdjustConfig","isMobile","isLowEnd","validateConfig","_a","errors","saveConfig","resetConfig","loadCustomConfig","c","initializeConfig","errs","imageSegmenter","faceDetector","wasmFileset","ensureTasksVisionLoaded","urls","url","mod","e","initTasks","outCanvas","rect","baseOptions","MediaPipeManager","canvas","timestamp","CameraManager","videoEl","_b","_c","_d","_e","_f","t","stage","targetCssW","targetCssH","dpr","idealW","idealH","aspect","constraints","resolve","track","caps","pick","val","min","max","lo","hi","wantW","wantH","wantAR","BackgroundRenderer","isIOS","img","base","imageSrc","ctx","w","h","bgVideoEl","bgMoonVideoEl","iosMoonVideoEl","bgType","intensity","grad","i","x","off","y","bands","bw","bh","hue","vw","vh","scale","dw","dh","ox","oy","imgW","imgH","aspectRatio","centerX","centerY","radius","lastRecordedBlob","lastRecordedFilename","lastRecordedObjectUrl","_revokeLastObjectUrl","RecordingManager","callback","format","blob","filename","fd","res","j","file","err","bgCanvas","backgroundRenderer","captureCanvas","captureCtx","W","H","staticPersonDataURL","result","error","dataURL","pngLink","pngFilename","width","height","recordCanvas","recordCtx","maxSize","personImg","reject","stream","recorderOptions","recorder","chunks","event","mimeType","extension","storedUrl","totalFrames","FPS","frame","drawFrame","personWidth","personHeight","personScale","personDrawWidth","personDrawHeight","personOffsetX","personOffsetY","currentTime","recordingManager","storeRecordingBlob","hasRecordingAvailable","getLastRecordingUrl","clearLastRecording","getLastRecordingFilename","uploadBlobToServerAndGetUrl","shareLastRecording","mediaPipeManager","cameraManager","running","lastFaceDetectionState","maskCanvas","bgCtx","maskCtx","outCtx","isIOSDevice","onStatus","onStats","stats","personLabelIndex","lastMaskF32","lastMaskSize","gMaskCanvasProcessed","videoDrawCanvas","videoDrawCtx","compositeCanvas","compositeCtx","maskBaseCanvas","maskBaseCtx","maskUpscaleCanvas","maskUpscaleCtx","maskSoftCanvas","maskSoftCtx","lastVideoTime","initCore","els","callbacks","syncCanvasSize","onResize","switchCamera","stageEl","getViewportSize","vv","cssW","cssH","maxWpx","maxHpx","dprEff","pixelW","pixelH","setSize","renderBackground","emaUpdate","srcF32","N","a","buildAlphaImage","maskF32","T","v","VW","VH","blurPx","renderOverlay","detections","facesIn","currentFaceDetectionState","renderLoop","now","mw","mh","idx","cm","src","m","cat","u8","personIdx","sm","_showMaskPreview","det","start","stop","setShowMaskPreview","setEnableSegmentation","setBackgroundType","setBackgroundIntensity","p01","setEdgeFeather","px","setTemporalAlpha","v01","setThreshold","setGifBlendMode","mode","setShouldGenerateGif","value","isRunning","setRecordingProgressCallback","setVideoOutputFormat","capturePhoto","captureOriginalFrame","tempCanvas","generatePreviewWithBackground","previewCanvas","originalImageData","backgroundImageSrc","originalImg","backgroundImg","imageData","maskValue","pixelIndex","generatePersonMask","tempCtx","maskImageData","threshold","alpha","scaledMaskCanvas","previewMode","enterPreviewMode","imageDataUrl","backgroundSrc","exitPreviewMode","switchPreviewBackground"],"mappings":"AAGY,MAACA,EAAS,CACpB,eAAgB,CACd,MAAO,QACP,yBAA0B,GAC1B,UAAW,EACf,EACE,aAAc,CACZ,QAAS,GACT,gBAAiB,EACjB,YAAa,GACb,uBAAwB,EAC5B,EACE,wBAAyB,CACvB,eAAgB,CACpB,EACE,OAAQ,CACN,MAAO,KACP,OAAQ,IACR,cAAe,KACf,eAAgB,IAChB,oBAAqB,OACrB,WAAY,EAChB,EACE,GAAI,CACF,uBAAwB,IACxB,gBAAiB,GACjB,SAAU,GACV,SAAU,OACd,EACE,QAAS,CACP,qBAAsB,IACtB,cAAe,IACf,aAAc,GACd,gBAAiB,EACjB,WAAY,EACZ,cAAe,CACnB,EACE,mBAAoB,CAClB,mBAAoB,aACpB,YAAa,CAAE,UAAW,GAAI,UAAW,IAAM,MAAO,GAAI,EAC1D,iBAAkB,CAAE,MAAO,GAAI,aAAc,GAAK,YAAa,GAAI,EACnE,iBAAkB,GAClB,WAAY,aAChB,EACE,YAAa,CACX,kBAAmB,GACnB,YAAa,IACb,qBAAsB,GACtB,wBAAyB,EAC7B,EACE,MAAO,CACL,gBAAiB,GACjB,oBAAqB,GACrB,uBAAwB,EAC5B,EACE,SAAU,CACR,mBACE,0DACF,2BACE,+DACF,gBAAiB,GACjB,aAAc,IACd,uBAAwB,EAC5B,CACA,EAGAA,EAAO,WAAaA,EAAO,YAAc,CACvC,KACGA,EAAO,oBACNA,EAAO,mBAAmB,oBAC5B,WACF,WACGA,EAAO,oBAAsBA,EAAO,mBAAmB,mBACxD,GACF,eAAgB,SAClB,EAGA,SAASC,IAAmB,CAC1B,MAAMC,EACJ,iEAAiE,KAC/D,UAAU,SAChB,EACQC,GAAY,UAAU,qBAAuB,IAAM,EAErDD,IACFF,EAAO,OAAO,cAAgB,IAC9BA,EAAO,OAAO,eAAiB,IAC/BA,EAAO,eAAe,MAAQ,QAC9BA,EAAO,QAAQ,WAAa,EAC5BA,EAAO,QAAQ,cAAgB,GAE7BG,IACFH,EAAO,YAAY,qBAAuB,GAC1CA,EAAO,eAAe,yBAA2B,GACjDA,EAAO,OAAO,WAAa,GAC3BA,EAAO,QAAQ,gBAAkB,GAErC,CAGA,SAASI,IAAiB,CAzG1B,IAAAC,EA0GE,MAAMC,EAAS,CAAA,EACf,OACEN,EAAO,eAAe,yBAA2B,GACjDA,EAAO,eAAe,yBAA2B,IAEjDM,EAAO,KAAK,qCAAqC,GAE9CD,EAAA,UAAU,eAAV,MAAAA,EAAwB,cAC3BC,EAAO,KAAK,YAAY,EAEnBA,CACT,CAGO,SAASC,IAAa,CAC3B,GAAI,CACF,aAAa,QAAQ,wBAAyB,KAAK,UAAUP,CAAM,CAAC,CACtE,MAAQ,CAAC,CACX,CAEO,SAASQ,IAAc,CAC5B,GAAI,CACF,aAAa,WAAW,uBAAuB,CACjD,MAAQ,CAAC,CACT,SAAS,OAAM,CACjB,CAEA,SAASC,IAAmB,CAC1B,GAAI,CACF,MAAMC,EAAI,aAAa,QAAQ,uBAAuB,EAClDA,GAAG,OAAO,OAAOV,EAAQ,KAAK,MAAMU,CAAC,CAAC,CAC5C,MAAQ,CAAC,CACX,CAGO,SAASC,IAAmB,CA7InC,IAAAN,EA8IEI,GAAgB,EAChBR,GAAgB,EAGhBD,EAAO,OAAO,MACZA,EAAO,OAAO,eAAiBA,EAAO,OAAO,OAAS,KACxDA,EAAO,OAAO,OACZA,EAAO,OAAO,gBAAkBA,EAAO,OAAO,QAAU,IAC1DA,EAAO,OAAO,OACZA,EAAO,OAAO,qBAAuBA,EAAO,OAAO,QAAU,OAE/DA,EAAO,UAAYA,EAAO,WAAa,CAAA,EACvCA,EAAO,UAAU,oBACfA,EAAO,cAAgBA,EAAO,aAAa,kBAAoB,EAC3D,GACAA,EAAO,UAAU,qBAAuB,GAC9CA,EAAO,UAAU,QAAUA,EAAO,UAAU,SAAW,GAEvDA,EAAO,UAAYA,EAAO,WAAa,CAAA,EACvCA,EAAO,UAAU,UACfA,EAAO,UAAU,aACjBK,EAAAL,EAAO,eAAP,YAAAK,EAAqB,yBACrB,IACFL,EAAO,UAAU,eAAiBA,EAAO,UAAU,gBAAkB,GACrEA,EAAO,UAAU,gBAAkBA,EAAO,UAAU,iBAAmB,EACvEA,EAAO,UAAU,OACfA,EAAO,UAAU,QAAUA,EAAO,UAAU,UAAY,IAC1DA,EAAO,UAAU,QACfA,EAAO,UAAU,SAAWA,EAAO,UAAU,UAAY,IAC3DA,EAAO,UAAU,aAAeA,EAAO,UAAU,cAAgB,IAG5DA,EAAO,SACVA,EAAO,OAAS,CACd,2BACE,8IACF,wBACE,0HACF,cACE,mIACR,GAEEA,EAAO,UACLA,EAAO,WACP,mEAEF,MAAMY,EAAOR,GAAc,EAC3B,OAAIQ,EAAK,QACP,QAAQ,MAAM,UAAWA,CAAI,EACtB,IAEF,EACT,CC7LA,IAAIC,GAAiB,KACjBC,GAAe,KACfC,EAAc,KAGlB,eAAeC,IAA0B,CACvC,GAAI,OAAO,iBAAmB,OAAO,eAAgB,MAAO,GAC5D,MAAMC,EAAO,CACX,gFACA,oEACJ,EACE,UAAWC,KAAOD,EAChB,GAAI,CACF,MAAME,EAAM,MAAM,OAAOD,GACzB,OAAIC,EAAI,kBAAiB,OAAO,gBAAkBA,EAAI,iBAClDA,EAAI,iBAAgB,OAAO,eAAiBA,EAAI,gBAChDA,EAAI,eAAc,OAAO,aAAeA,EAAI,cACzC,EACT,OAASC,EAAG,CACV,QAAQ,KAAK,4CAA6CF,EAAKE,CAAC,CAClE,CAEF,MAAM,IAAI,MAAM,iCAAiC,CACnD,CAGA,eAAeC,GAAUC,EAAW,CAC7BP,IACHA,EAAc,MAAM,gBAAgB,eAAef,EAAO,SAAS,GAIrE,GAAI,CACF,MAAMuB,EAAOD,EAAU,sBAAqB,EAC5CtB,EAAO,UAAU,qBACduB,EAAK,OAAS,KAAOA,EAAK,QAAU,EACzC,MAAQ,CAAC,CAGT,MAAMC,EAAc,CAClB,eAAgBxB,EAAO,UAAU,oBAC7BA,EAAO,OAAO,2BACdA,EAAO,OAAO,wBAClB,SAAUA,EAAO,UAAU,QAAU,MAAQ,KACjD,EAEE,GAAI,CACFa,GAAiB,MAAM,eAAe,kBAAkBE,EAAa,CACnE,YAAAS,EACA,YAAa,QACb,mBAAoB,GACpB,sBAAuB,EAC7B,CAAK,CACH,OAASJ,EAAG,CACV,QAAQ,KAAK,6BAA8BA,CAAC,EAC5CP,GAAiB,MAAM,eAAe,kBAAkBE,EAAa,CACnE,YAAa,CAAE,GAAGS,EAAa,SAAU,KAAK,EAC9C,YAAa,QACb,mBAAoB,GACpB,sBAAuB,EAC7B,CAAK,CACH,CAGA,GAAI,CACFV,GAAe,MAAM,aAAa,kBAAkBC,EAAa,CAC/D,YAAa,CACX,eAAgBf,EAAO,OAAO,cAC9B,SAAU,KAClB,EACM,YAAa,QACb,uBAAwB,GACxB,wBAAyB,EAC/B,CAAK,CACH,OAASoB,EAAG,CACV,QAAQ,KAAK,gCAAiCA,CAAC,EAC/CN,GAAe,MAAM,aAAa,kBAAkBC,EAAa,CAC/D,YAAa,CACX,eAAgBf,EAAO,OAAO,cAC9B,SAAU,KAClB,EACM,YAAa,QACb,uBAAwB,GACxB,wBAAyB,EAC/B,CAAK,CACH,CACF,CAGO,MAAMyB,EAAiB,CAC5B,aAAc,CACZ,KAAK,eAAiB,KACtB,KAAK,aAAe,KACpB,KAAK,YAAc,IACrB,CAGA,MAAM,KAAKH,EAAW,CACpB,MAAMN,GAAuB,EAC7B,MAAMK,GAAUC,CAAS,EACzB,KAAK,eAAiBT,GACtB,KAAK,aAAeC,GACpB,KAAK,YAAcC,CACrB,CAGA,mBAAoB,CAClB,OAAO,KAAK,cACd,CAGA,iBAAkB,CAChB,OAAO,KAAK,YACd,CAGA,eAAgB,CACd,OAAO,KAAK,iBAAmB,MAAQ,KAAK,eAAiB,IAC/D,CAGA,MAAM,aAAaW,EAAQC,EAAW,CACpC,GAAI,CAAC,KAAK,eAAgB,OAAO,KAEjC,GAAI,CAIF,OAHe,KAAK,eAAe,gBAC/B,KAAK,eAAe,gBAAgBD,EAAQC,CAAS,EACrD,MAAM,KAAK,eAAe,QAAQD,CAAM,CAE9C,OAASN,EAAG,CACV,eAAQ,KAAK,yBAA0BA,CAAC,EACjC,IACT,CACF,CAGA,YAAYM,EAAQC,EAAW,CAC7B,GAAI,CAAC,KAAK,aAER,eAAQ,KAAK,iCAAiC,EACvC,KAGT,GAAI,CAIF,OAHY,KAAK,aAAa,eAC1B,KAAK,aAAa,eAAeD,EAAQC,CAAS,EAClD,KAAK,aAAa,OAAOD,CAAM,CAErC,OAASN,EAAG,CACV,eAAQ,KAAK,sBAAuBA,CAAC,EAC9B,IACT,CACF,CACF,CCzJO,MAAMQ,EAAc,CACzB,aAAc,CACZ,KAAK,OAAS,KACd,KAAK,kBAAoB5B,EAAO,OAAO,qBAAuB,OAC9D,KAAK,QAAU,IACjB,CAGA,gBAAgB6B,EAAS,CACvB,KAAK,QAAUA,CACjB,CAGA,MAAM,aAAc,CFlBtB,IAAAxB,EAAAyB,EAAAC,EAAAC,EAAAC,EAAAC,EEoBI,GAAI,KAAK,OACP,GAAI,CAAE,KAAK,OAAO,UAAS,EAAG,QAASC,GAAMA,EAAE,KAAI,CAAE,CAAG,MAAQ,CAAC,CAInE,MAAMC,GAAQ/B,EAAA,KAAK,UAAL,YAAAA,EAAc,QAAQ,UAC9BgC,GAAaD,GAAA,YAAAA,EAAO,cAAgB,OAAO,WAC3CE,GAAaF,GAAA,YAAAA,EAAO,eAAgB,OAAO,YAC3CG,EAAM,KAAK,IAAI,OAAO,kBAAoB,EAAG,CAAC,EAG9CC,EAAS,KAAK,IAAI,KAAK,MAAMH,EAAaE,CAAG,EAAG,IAAI,EACpDE,EAAS,KAAK,IAAI,KAAK,MAAMH,EAAaC,CAAG,EAAG,IAAI,EACpDG,EAASF,EAAS,KAAK,IAAI,EAAGC,CAAM,EAEpCE,EAAc,CAClB,MAAO,GACP,MAAO,CACL,WAAY,KAAK,kBACjB,MAAc,CAAE,MAAOH,EAAS,IAAK,IAAM,IAAK,IAAI,EACpD,OAAc,CAAE,MAAOC,EAAS,IAAK,IAAM,IAAK,IAAI,EACpD,YAAc,CAAE,MAAOC,CAAM,EAC7B,UAAc,CAAE,MAAO1C,EAAO,OAAO,YAAc,GAAI,IAAK,EAAE,CAGtE,CACA,EAEI,KAAK,OAAS,MAAM,UAAU,aAAa,aAAa2C,CAAW,EACnE,KAAK,QAAQ,UAAY,KAAK,OAC9B,KAAK,QAAQ,aAAa,cAAe,EAAE,EAC3C,KAAK,QAAQ,MAAQ,GACrB,KAAK,QAAQ,SAAW,GAGxB,MAAM,IAAI,QAASC,GAAY,CAC7B,GAAI,KAAK,QAAQ,YAAc,GAAK,KAAK,QAAQ,YAAc,KAAK,QAAQ,YAAa,OAAOA,EAAO,EACvG,KAAK,QAAQ,iBAAmB,IAAMA,EAAO,EAC7C,WAAWA,EAAS,IAAI,CAC1B,CAAC,EAGD,GAAI,CACF,MAAMC,EAAQ,KAAK,OAAO,eAAc,EAAG,CAAC,EACtCC,GAAOhB,EAAAe,EAAM,kBAAN,YAAAf,EAAA,KAAAe,GACPE,EAAO,CAACC,EAAKC,EAAKC,IAAQ,CAC9B,GAAID,GAAO,MAAQC,GAAO,KAAM,OAAOF,EACvC,MAAMG,EAAM,OAAOF,GAAQ,SAAYA,EAAMD,EACvCI,EAAM,OAAOF,GAAQ,SAAYA,EAAMF,EAC7C,OAAO,KAAK,IAAI,KAAK,IAAIA,EAAKG,CAAE,EAAGC,CAAE,CACvC,EAEA,GAAIN,EAAM,CACR,MAAMO,EAASN,EAAKP,GAAST,EAAAe,EAAK,QAAL,YAAAf,EAAY,KAAMC,EAAAc,EAAK,QAAL,YAAAd,EAAY,GAAG,EACxDsB,EAASP,EAAKN,GAASR,EAAAa,EAAK,SAAL,YAAAb,EAAa,KAAKC,EAAAY,EAAK,SAAL,YAAAZ,EAAa,GAAG,EACzDqB,EAASf,EAAS,KAAK,IAAI,EAAGC,CAAM,EAE1C,MAAMI,EAAM,iBAAiB,CAC3B,MAAa,CAAE,MAAOQ,CAAK,EAC3B,OAAa,CAAE,MAAOC,CAAK,EAC3B,YAAa,CAAE,MAAOC,CAAM,EAC5B,UAAa,CAAE,MAAOvD,EAAO,OAAO,YAAc,GAAI,IAAK,EAAE,CAEvE,CAAS,CACH,CACF,OAASoB,EAAG,CACV,QAAQ,KAAK,2BAA4BA,CAAC,CAC5C,CAEA,GAAI,CAAE,MAAM,KAAK,QAAQ,KAAI,CAAI,MAAQ,CAAC,CAC5C,CAGA,YAAa,CACX,GAAI,CACE,KAAK,QAAQ,KAAK,OAAO,YAAY,QAASe,GAAMA,EAAE,KAAI,CAAE,CAClE,MAAQ,CAAC,CACT,KAAK,OAAS,IAChB,CAGA,MAAM,cAAe,CACnB,KAAK,kBAAoB,KAAK,oBAAsB,OAAS,cAAgB,OAC7E,MAAM,KAAK,YAAW,CACxB,CAGA,sBAAuB,CACrB,OAAO,KAAK,iBACd,CAGA,WAAY,CACV,OAAO,KAAK,MACd,CACF,CC9GO,MAAMqB,EAAmB,CAC9B,aAAc,CACZ,KAAK,MAAQ,EACb,KAAK,sBAAwB,KAC7B,KAAK,YAAc,GACnB,KAAK,qBAAA,CACP,CAGA,aAAaC,EAAO,CAClB,KAAK,YAAcA,CACrB,CAGA,sBAAuB,CACrB,MAAMC,EAAM,IAAI,MAChBA,EAAI,OAAS,IAAM,CACjB,KAAK,sBAAwBA,EAC7B,QAAQ,IAAI,eAAe,CAC7B,EACAA,EAAI,QAAWtC,GAAM,CACnB,QAAQ,KAAK,kBAAmBA,CAAC,CACnC,EAEA,MAAMuC,EAAO,qCACbD,EAAI,IAAMC,EAAO,0BACnB,CAGA,oBAAoBC,EAAU,CAC5B,MAAMF,EAAM,IAAI,MAChBA,EAAI,OAAS,IAAM,CACjB,KAAK,sBAAwBA,EAC7B,QAAQ,IAAI,aAAcE,CAAQ,CACpC,EACAF,EAAI,QAAWtC,GAAM,CACnB,QAAQ,KAAK,eAAgBA,CAAC,CAChC,EACAsC,EAAI,IAAME,CACZ,CAGA,iBAAkB,CAChB,KAAK,OAAS,IAChB,CAGA,mBAAmBC,EAAKC,EAAGC,EAAGC,EAAWC,EAAeC,EAAgB,CACtE,MAAMC,EACHnE,EAAO,YAAcA,EAAO,WAAW,MACvCA,EAAO,oBACNA,EAAO,mBAAmB,oBAC5B,WACIoE,EACJpE,EAAO,YAAc,OAAOA,EAAO,WAAW,WAAc,SACxDA,EAAO,WAAW,WACjBA,EAAO,oBACNA,EAAO,mBAAmB,mBAC5B,GAMN,GAJA6D,EAAI,UAAU,EAAG,EAAGC,EAAGC,CAAC,EACxB,KAAK,gBAAA,EAGDI,IAAW,WAKf,IAAIA,IAAW,QAAS,CACtB,KAAK,qBAAqBN,EAAKC,EAAGC,EAAGK,CAAS,EAC9C,MACF,CAGA,GAAID,IAAW,YAAa,CAC1B,KAAK,0BAA0BN,EAAKC,EAAGC,EAAGK,CAAS,EACnD,MACF,CAGA,GAAID,IAAW,SAAWH,EAAW,CACnC,KAAK,sBAAsBH,EAAKC,EAAGC,EAAGC,EAAWI,CAAS,EAC1D,MACF,CAGA,GAAID,IAAW,cAAgBF,EAAe,CAC5C,KAAK,0BAA0BJ,EAAKC,EAAGC,EAAGE,EAAeG,CAAS,EAClE,MACF,CAGA,GAAID,IAAW,kBAAoB,KAAK,sBAAuB,CAC7D,KAAK,2BAA2BN,EAAKC,EAAGC,EAAGE,EAAeC,EAAgBE,CAAS,EACnF,MACF,EACF,CAGA,qBAAqBP,EAAKC,EAAGC,EAAGK,EAAW,CACzC,MAAMC,EAAOR,EAAI,qBAAqB,EAAG,EAAGC,EAAGC,CAAC,EAChDM,EAAK,aAAa,EAAG,SAAS,EAC9BA,EAAK,aAAa,GAAK,SAAS,EAChCA,EAAK,aAAa,EAAG,SAAS,EAC9BR,EAAI,UAAYQ,EAChBR,EAAI,SAAS,EAAG,EAAGC,EAAGC,CAAC,EACvBF,EAAI,YAAc,oBAAoBO,EAAY,EAAG,IACrDP,EAAI,UAAY,EAEhB,QAASS,EAAI,EAAGA,EAAI,EAAGA,IAAK,CAC1BT,EAAI,UAAA,EACJ,QAASU,EAAI,EAAGA,EAAIT,EAAGS,GAAK,EAAG,CAC7B,MAAMC,EAAMF,EAAI,GACVG,EACJV,EAAI,EAAI,KAAK,KAAKQ,EAAIC,GAAO,KAAQ,KAAK,MAAQ,GAAG,EAAI,GAAKJ,EAC5DG,IAAM,EAAGV,EAAI,OAAOU,EAAGE,CAAC,EACvBZ,EAAI,OAAOU,EAAGE,CAAC,CACtB,CACAZ,EAAI,OAAA,CACN,CACF,CAGA,0BAA0BA,EAAKC,EAAGC,EAAGK,EAAW,CAC9CP,EAAI,UAAY,UAChBA,EAAI,SAAS,EAAG,EAAGC,EAAGC,CAAC,EACvB,MAAMW,EAAQ,GACRC,EAAKb,EAAIY,EAEf,QAASJ,EAAI,EAAGA,EAAII,EAAOJ,IAAK,CAC9B,MAAMC,EAAID,EAAIK,EACRC,GACH,KAAK,IAAI,KAAK,MAAQ,EAAIN,EAAI,EAAG,EAAI,GAAM,IAAOP,EAAI,GAAMK,EACzDS,GAAO,KAAK,MAAQ,GAAKP,EAAI,IAAM,IACzCT,EAAI,UAAY,QAAQgB,CAAG,gBAC3BhB,EAAI,SAASU,EAAGR,EAAIa,EAAID,EAAK,EAAGC,CAAE,CACpC,CACF,CAGA,sBAAsBf,EAAKC,EAAGC,EAAGC,EAAWI,EAAW,CACrD,MAAMU,EAAKd,EAAU,YAAc,EAC7Be,EAAKf,EAAU,aAAe,EAEpC,GAAIA,EAAU,YAAc,EAAG,CAC7B,MAAMgB,EAAQ,KAAK,IAAIlB,EAAIgB,EAAIf,EAAIgB,CAAE,EAC/BE,EAAK,KAAK,MAAMH,EAAKE,CAAK,EAC1BE,EAAK,KAAK,MAAMH,EAAKC,CAAK,EAC1BG,EAAK,KAAK,OAAOrB,EAAImB,GAAM,CAAC,EAC5BG,EAAK,KAAK,OAAOrB,EAAImB,GAAM,CAAC,EAElC,GAAI,CACElB,EAAU,QAAQA,EAAU,KAAA,EAAO,MAAM,IAAM,CAAC,CAAC,CACvD,MAAQ,CAAC,CAETH,EAAI,YAAc,KAAK,IAAI,EAAG,GAAMO,EAAY,EAAG,EACnDP,EAAI,UAAUG,EAAW,EAAG,EAAGc,EAAIC,EAAII,EAAIC,EAAIH,EAAIC,CAAE,EACrDrB,EAAI,YAAc,CACpB,CACF,CAGA,0BAA0BA,EAAKC,EAAGC,EAAGE,EAAeG,EAAW,CAC7D,GAAI,CACF,GAAIH,EAAc,YAAc,GAAK,CAACA,EAAc,OAAQ,CAC1D,MAAMa,EAAKb,EAAc,YAAcA,EAAc,OAAS,EACxDc,EAAKd,EAAc,aAAeA,EAAc,QAAU,EAEhE,GAAIa,EAAK,GAAKC,EAAK,EAAG,CACpB,MAAMC,EAAQ,KAAK,IAAIlB,EAAIgB,EAAIf,EAAIgB,CAAE,EAC/BE,EAAK,KAAK,MAAMH,EAAKE,CAAK,EAC1BE,EAAK,KAAK,MAAMH,EAAKC,CAAK,EAC1BG,EAAK,KAAK,OAAOrB,EAAImB,GAAM,CAAC,EAC5BG,EAAK,KAAK,OAAOrB,EAAImB,GAAM,CAAC,EAElCrB,EAAI,YAAc,KAAK,IAAI,EAAG,GAAMO,EAAY,EAAG,EACnDP,EAAI,UAAUI,EAAe,EAAG,EAAGa,EAAIC,EAAII,EAAIC,EAAIH,EAAIC,CAAE,EACzDrB,EAAI,YAAc,CACpB,CACF,MAAWI,EAAc,QACvBA,EAAc,OAAO,MAAO7C,GAAM,QAAQ,KAAK,YAAaA,CAAC,CAAC,CAElE,OAASA,EAAG,CACV,QAAQ,KAAK,YAAaA,CAAC,CAC7B,CACF,CAGA,2BAA2ByC,EAAKC,EAAGC,EAAGE,EAAeC,EAAgBE,EAAW,CAC9E,GAAI,CAEF,GAAI,KAAK,YAAa,CACpB,GAAI,KAAK,sBAAuB,CAC9B,MAAMiB,EAAO,KAAK,sBAAsB,cAAgB,KAAK,sBAAsB,MAC7EC,EAAO,KAAK,sBAAsB,eAAiB,KAAK,sBAAsB,OAEpF,GAAID,EAAO,GAAKC,EAAO,EAAG,CACxB,MAAMN,EAAQ,KAAK,IAAIlB,EAAIuB,EAAMtB,EAAIuB,CAAI,EACnCL,EAAK,KAAK,MAAMI,EAAOL,CAAK,EAC5BE,EAAK,KAAK,MAAMI,EAAON,CAAK,EAC5BG,EAAK,KAAK,OAAOrB,EAAImB,GAAM,CAAC,EAC5BG,EAAK,KAAK,OAAOrB,EAAImB,GAAM,CAAC,EAClCrB,EAAI,UAAU,KAAK,sBAAuB,EAAG,EAAGwB,EAAMC,EAAMH,EAAIC,EAAIH,EAAIC,CAAE,CAC5E,CACF,CACA,MACF,CAIA,GAAI,KAAK,sBAAuB,CAC9B,MAAMG,EAAO,KAAK,sBAAsB,cAAgB,KAAK,sBAAsB,MAC7EC,EAAO,KAAK,sBAAsB,eAAiB,KAAK,sBAAsB,OAEpF,GAAID,EAAO,GAAKC,EAAO,EAAG,CACxB,MAAMN,EAAQ,KAAK,IAAIlB,EAAIuB,EAAMtB,EAAIuB,CAAI,EACnCL,EAAK,KAAK,MAAMI,EAAOL,CAAK,EAC5BE,EAAK,KAAK,MAAMI,EAAON,CAAK,EAC5BG,EAAK,KAAK,OAAOrB,EAAImB,GAAM,CAAC,EAC5BG,EAAK,KAAK,OAAOrB,EAAImB,GAAM,CAAC,EAClCrB,EAAI,UAAU,KAAK,sBAAuB,EAAG,EAAGwB,EAAMC,EAAMH,EAAIC,EAAIH,EAAIC,CAAE,CAC5E,CACF,CAGIjB,GAAiBA,EAAc,YAAc,GAAK,CAACA,EAAc,OACnE,KAAK,mBAAmBJ,EAAKC,EAAGC,EAAGE,EAAeG,CAAS,EAClDH,GAAiBA,EAAc,QACxCA,EAAc,OAAO,MAAO7C,GAAM,QAAQ,KAAK,YAAaA,CAAC,CAAC,CAGlE,OAASA,EAAG,CACV,QAAQ,KAAK,oBAAqBA,CAAC,CACrC,CACF,CAGA,mBAAmByC,EAAKC,EAAGC,EAAGE,EAAeG,EAAW,CACtD,MAAMU,EAAKb,EAAc,YAAcA,EAAc,OAAS,EACxDc,EAAKd,EAAc,aAAeA,EAAc,QAAU,EAEhE,GAAIa,EAAK,GAAKC,EAAK,EAAG,CACpBlB,EAAI,KAAA,EAGJ,MAAM0B,EAAczB,EAAIC,EACxB,IAAIyB,EAASC,EAASC,EAElBH,EAAc,IAChBC,EAAU1B,EAAI,GACd2B,EAAU1B,EAAI,IACd2B,EAAS,KAAK,IAAI5B,EAAGC,CAAC,EAAI,KACjBwB,EAAc,IACvBC,EAAU1B,EAAI,IACd2B,EAAU1B,EAAI,IACd2B,EAAS,KAAK,IAAI5B,EAAGC,CAAC,EAAI,MAE1ByB,EAAU1B,EAAI,IACd2B,EAAU1B,EAAI,IACd2B,EAAS,KAAK,IAAI5B,EAAGC,CAAC,EAAI,IAG5BF,EAAI,UAAA,EACJA,EAAI,IAAI2B,EAASC,EAASC,EAAQ,EAAG,EAAI,KAAK,EAAE,EAChD7B,EAAI,KAAA,EAEJ,MAAMmB,EAAQ,KAAK,IAAIlB,EAAIgB,EAAIf,EAAIgB,CAAE,EAC/BE,EAAK,KAAK,MAAMH,EAAKE,CAAK,EAC1BE,EAAK,KAAK,MAAMH,EAAKC,CAAK,EAC1BG,EAAK,KAAK,OAAOrB,EAAImB,GAAM,CAAC,EAC5BG,EAAK,KAAK,OAAOrB,EAAImB,GAAM,CAAC,EAElCrB,EAAI,YAAc,KAAK,IAAI,EAAG,GAAMO,EAAY,EAAG,EACnDP,EAAI,UAAUI,EAAe,EAAG,EAAGa,EAAIC,EAAII,EAAIC,EAAIH,EAAIC,CAAE,EACzDrB,EAAI,YAAc,EAElBA,EAAI,QAAA,CACN,CACF,CACF,CCzRA,IAAI8B,EAAmB,KACnBC,EAAuB,KACvBC,EAAwB,KAI5B,SAASC,IAAuB,CAC9B,GAAI,CACED,IACF,IAAI,gBAAgBA,CAAqB,EACzCA,EAAwB,KAE5B,OAASzE,EAAG,CACV,QAAQ,KAAK,gBAAiBA,CAAC,CACjC,CACF,CAEO,MAAM2E,EAAiB,CAC5B,aAAc,CACZ,KAAK,iBAAmB,KACxB,KAAK,aAAe,KACtB,CAGA,oBAAoBC,EAAU,CAE5B,KAAK,iBAAmBA,CAC1B,CAGA,gBAAgBC,EAAQ,CAEtB,KAAK,aAAeA,CACtB,CAGA,mBAAmBC,EAAMC,EAAU,CACjC,GAAI,CAACD,EAAM,OAAO,KAElBJ,GAAoB,EACpBH,EAAmBO,EACnBN,EAAuBO,GAAY,UAAU,KAAK,IAAG,CAAE,QAEvD,GAAI,CACFN,EAAwB,IAAI,gBAAgBK,CAAI,CAClD,OAAS9E,EAAG,CACV,QAAQ,KAAK,yBAA0BA,CAAC,EACxCyE,EAAwB,IAC1B,CACA,OAAOA,CACT,CAGA,uBAAwB,CACtB,MAAO,CAAC,CAACF,CACX,CAGA,qBAAsB,CACpB,OAAOE,GAAyB,IAClC,CAGA,oBAAqB,CACnBC,GAAoB,EACpBH,EAAmB,KACnBC,EAAuB,IACzB,CAGA,0BAA2B,CACzB,OAAOA,CACT,CAGA,MAAM,4BAA4BM,EAAMC,EAAU,CAChD,MAAMC,EAAK,IAAI,SACfA,EAAG,OAAO,OAAQF,EAAMC,CAAQ,EAChC,MAAME,EAAM,MAAM,MAAM,cAAe,CAAE,OAAQ,OAAQ,KAAMD,EAAI,EACnE,GAAI,CAACC,EAAI,GAAI,MAAM,IAAI,MAAM,eAAe,EAC5C,MAAMC,EAAI,MAAMD,EAAI,KAAI,EACxB,GAAI,EAACC,GAAA,MAAAA,EAAG,KAAK,MAAM,IAAI,MAAM,6BAA6B,EAC1D,OAAOA,EAAE,GACX,CAGA,MAAM,oBAAqB,CACzB,GAAI,CAACX,EAAkB,MAAM,IAAI,MAAM,wBAAwB,EAC/D,MAAMQ,EAAWP,GAAwB,UAAU,KAAK,IAAG,CAAE,OACvDW,EAAO,IAAI,KAAK,CAACZ,CAAgB,EAAGQ,EAAU,CAClD,KAAMR,EAAiB,MAAQ,WACrC,CAAK,EAGD,GAAI,CACF,GAAI,UAAU,UAAY,UAAU,SAAS,CAAE,MAAO,CAACY,CAAI,CAAC,CAAE,EAC5D,aAAM,UAAU,MAAM,CACpB,MAAO,CAACA,CAAI,EACZ,MAAO,YACP,KAAM,MAChB,CAAS,EACM,CAAE,GAAI,GAAM,OAAQ,UAAU,CAEzC,OAASC,EAAK,CACZ,QAAQ,KAAK,wBAAyBA,CAAG,CAC3C,CAGA,GAAI,CACF,MAAMtF,EAAM,MAAM,KAAK,4BAA4ByE,EAAkBQ,CAAQ,EAC7E,GAAI,UAAU,MACZ,GAAI,CACF,aAAM,UAAU,MAAM,CACpB,MAAO,YACP,KAAM,SACN,IAAAjF,CACZ,CAAW,EACM,CAAE,GAAI,GAAM,OAAQ,YAAa,IAAAA,CAAG,CAC7C,OAASsF,EAAK,CACZ,QAAQ,KAAK,uBAAwBA,CAAG,CAC1C,CAEF,MAAO,CAAE,GAAI,GAAM,OAAQ,WAAY,IAAAtF,CAAG,CAC5C,OAASsF,EAAK,CACZ,cAAQ,KAAK,iBAAkBA,CAAG,EAC5BA,CACR,CACF,CAGA,MAAM,aAAalF,EAAWmF,EAAUzG,EAAQ0G,EAAoBzC,EAAe,CACjF,GAAI,CAAC3C,GAAa,CAACoF,EACjB,eAAQ,KAAK,kBAAkB,EACxB,KAGT,GAAI,CACF,MAAMC,EAAgB,SAAS,cAAc,QAAQ,EAC/CC,EAAaD,EAAc,WAAW,IAAI,EAC1CE,EAAIvF,EAAU,MACdwF,EAAIxF,EAAU,OACpBqF,EAAc,MAAQE,EACtBF,EAAc,OAASG,EAEvB,MAAM3C,EAASnE,EAAO,YAAcA,EAAO,WAAW,KAGtD,GAFA,QAAQ,IAAI,eAAgB,CAAE,OAAAmE,EAAQ,aAAc,CAAC,CAACF,EAAe,GAEhEE,IAAW,cAAgBA,IAAW,mBAAqBF,EAAe,CAE7E,QAAQ,IAAI,yBAAyB,EACrC2C,EAAW,UAAUtF,EAAW,EAAG,EAAGuF,EAAGC,CAAC,EAC1C,MAAMC,EAAsBJ,EAAc,UAAU,YAAa,CAAG,EAEpE,GAAI,CACF,MAAMK,EAAS,MAAM,KAAK,8BACxBD,EACAF,EACAC,EACA9G,EACA0G,EACAzC,CACZ,EACU,eAAQ,IAAI,YAAa+C,CAAM,EACxBA,CACT,OAASC,EAAO,CACd,eAAQ,MAAM,YAAaA,CAAK,EAEzB,KAAK,QAAQN,CAAa,CACnC,CACF,MAEEC,EAAW,UAAUH,EAAU,EAAG,EAAGI,EAAGC,CAAC,EACzCF,EAAW,UAAUtF,EAAW,EAAG,EAAGuF,EAAGC,CAAC,EAG5C,OAAO,KAAK,QAAQH,CAAa,CACnC,OAASM,EAAO,CACd,eAAQ,MAAM,QAASA,CAAK,EACrB,IACT,CACF,CAGA,QAAQvF,EAAQ,CACd,MAAMwF,EAAUxF,EAAO,UAAU,YAAa,CAAG,EAC3CC,EAAY,IAAI,KAAI,EACvB,YAAW,EACX,QAAQ,OAAQ,GAAG,EACnB,MAAM,GAAG,EAAE,CAAC,EAETwF,EAAU,SAAS,cAAc,GAAG,EACpCC,EAAc,WAAWzF,CAAS,OACxC,OAAAwF,EAAQ,SAAWC,EACnBD,EAAQ,KAAOD,EACf,SAAS,KAAK,YAAYC,CAAO,EACjCA,EAAQ,MAAK,EACb,SAAS,KAAK,YAAYA,CAAO,EAEjC,QAAQ,IAAI,cAAc,EACnB,CAAE,IAAKD,CAAO,CACvB,CAGA,MAAM,8BAA8BH,EAAqBM,EAAOC,EAAQtH,EAAQ0G,EAAoBzC,EAAe,CAGjH,GAFA,QAAQ,IAAI,yBAAyB,EAEjC,CAAC,OAAO,cACV,eAAQ,KAAK,sBAAsB,EAC5B,CAAE,IAAK8C,EAAqB,MAAO,YAAY,EAGxD,MAAMQ,EAAe,SAAS,cAAc,QAAQ,EAC9CC,EAAYD,EAAa,WAAW,IAAI,EACxCE,EAAU,IACVlC,EAAc8B,EAAQC,EAExBD,EAAQC,GACVC,EAAa,MAAQ,KAAK,IAAIE,EAASJ,CAAK,EAC5CE,EAAa,OAAS,KAAK,MAAMA,EAAa,MAAQhC,CAAW,IAEjEgC,EAAa,OAAS,KAAK,IAAIE,EAASH,CAAM,EAC9CC,EAAa,MAAQ,KAAK,MAAMA,EAAa,OAAShC,CAAW,GAGnE,MAAMmC,EAAY,IAAI,MAEtB,OAAO,IAAI,QAAQ,CAAC9E,EAAS+E,IAAW,CACtCD,EAAU,OAAS,SAAY,CAMzBzD,GAAiBA,EAAc,QACjC,MAAMA,EAAc,KAAI,EAAG,MAAO7C,GAAM,QAAQ,KAAK,UAAWA,CAAC,CAAC,EAGpE,MAAMwG,EAASL,EAAa,cAAc,EAAG,EACvCM,EAAkB,KAAK,mBAAkB,EACzCC,EAAW,IAAI,cAAcF,EAAQC,CAAe,EAEpDE,EAAS,CAAA,EACfD,EAAS,gBAAmBE,GAAU,CAChCA,EAAM,KAAK,KAAO,GAAGD,EAAO,KAAKC,EAAM,IAAI,CACjD,EAEAF,EAAS,OAAS,IAAM,CACtB,MAAMG,EAAW,KAAK,eAAiB,MAAQ,YAAc,aACvDC,EAAY,KAAK,eAAiB,MAAQ,MAAQ,OAClDhC,GAAO,IAAI,KAAK6B,EAAQ,CAAE,KAAME,EAAU,EAM1C9B,GAAW,cAJC,IAAI,KAAI,EACvB,YAAW,EACX,QAAQ,OAAQ,GAAG,EACnB,MAAM,GAAG,EAAE,CAAC,CACyB,IAAI+B,CAAS,GAE/CC,GAAY,KAAK,mBAAmBjC,GAAMC,EAAQ,EACxDvD,EAAQ,CACN,IAAKmE,EACL,MAAOoB,GACP,SAAU,EACV,OAAQD,EACR,MAAO,EACnB,CAAW,CACH,EAEAJ,EAAS,QAAWE,GAAU,CAC5B,QAAQ,MAAM,QAASA,EAAM,KAAK,EAClCL,EAAOK,EAAM,KAAK,CACpB,EAEAF,EAAS,MAAK,EACd,KAAK,aAAaN,EAAWD,EAAcG,EAAW,IAAa,GAAK1H,EAAQ0G,EAAoBzC,CAAa,CACnH,EAEAyD,EAAU,QAAU,IAAMC,EAAO,IAAI,MAAM,YAAY,CAAC,EACxDD,EAAU,IAAMX,CAClB,CAAC,CACH,CAGA,oBAAqB,CACnB,OAAI,KAAK,eAAiB,MACpB,cAAc,gBAAgB,wBAAwB,EACjD,CAAE,SAAU,yBAA0B,mBAAoB,GAAO,EAC/D,cAAc,gBAAgB,WAAW,EAC3C,CAAE,SAAU,YAAa,mBAAoB,GAAO,GAE3D,QAAQ,KAAK,qBAAqB,EAClC,KAAK,aAAe,OACb,CAAE,SAAU,yBAA0B,mBAAoB,GAAO,GAGnE,CAAE,SAAU,yBAA0B,mBAAoB,GAAO,CAE5E,CAGA,aAAaS,EAAWD,EAAcG,EAAWU,EAAaC,EAAKrI,EAAQ0G,EAAoBzC,EAAe,CAC5G,IAAIqE,EAAQ,EAEZ,MAAMC,EAAY,IAAM,CACtBf,EAAU,UAAU,EAAG,EAAGD,EAAa,MAAOA,EAAa,MAAM,EAGjEb,EAAmB,mBACjBc,EACAD,EAAa,MACbA,EAAa,OACb,KACAtD,EACA,IACR,EAGM,MAAMuE,EAAcd,EAAU,cAAgBA,EAAU,MAClDe,EAAef,EAAU,eAAiBA,EAAU,OAE1D,GAAIc,EAAc,GAAKC,EAAe,EAAG,CACvC,MAAMC,EAAc,KAAK,IACvBnB,EAAa,MAAQiB,EACrBjB,EAAa,OAASkB,CAChC,EACcE,EAAkB,KAAK,MAAMH,EAAcE,CAAW,EACtDE,EAAmB,KAAK,MAAMH,EAAeC,CAAW,EACxDG,EAAgB,KAAK,OAAOtB,EAAa,MAAQoB,GAAmB,CAAC,EACrEG,EAAgB,KAAK,OAAOvB,EAAa,OAASqB,GAAoB,CAAC,EAE7EpB,EAAU,UACRE,EACA,EAAG,EAAGc,EAAaC,EACnBI,EAAeC,EAAeH,EAAiBC,CACzD,CACM,CAKA,GAHAN,IAGI,KAAK,iBAAkB,CACzB,MAAMS,EAAcT,EAAQD,EAC5B,KAAK,iBAAiB,eAAeU,EAAa,CAAC,CACrD,CAGIT,EAAQF,EACV,WAAWG,EAAW,IAAOF,CAAG,GAE5B,KAAK,kBACP,KAAK,iBAAiB,UAAU,gBAAgB,EAElD,QAAQ,IAAI,SAAS,EAEzB,EAEAE,EAAS,CACX,CACF,CC3VA,MAAMS,EAAmB,IAAIjD,GAGtB,SAASkD,GAAmB/C,EAAMC,EAAU,CACjD,OAAO6C,EAAiB,mBAAmB9C,EAAMC,CAAQ,CAC3D,CAEO,SAAS+C,IAAwB,CACtC,OAAOF,EAAiB,sBAAqB,CAC/C,CAEO,SAASG,IAAsB,CACpC,OAAOH,EAAiB,oBAAmB,CAC7C,CAEO,SAASI,IAAqB,CACnC,OAAOJ,EAAiB,mBAAkB,CAC5C,CAEO,SAASK,IAA2B,CACzC,OAAOL,EAAiB,yBAAwB,CAClD,CAEO,eAAeM,GAA4BpD,EAAMC,EAAU,CAChE,OAAO6C,EAAiB,4BAA4B9C,EAAMC,CAAQ,CACpE,CAEO,eAAeoD,IAAqB,CACzC,OAAOP,EAAiB,mBAAkB,CAC5C,CAKA,MAAMQ,EAAmB,IAAI/H,GACvBgI,EAAgB,IAAI7H,GACpB8E,EAAqB,IAAIlD,GAE/B,IAAIkG,EAAU,GACVC,GAAyB,GAGzB9H,EAAS4E,EAAUmD,EAAYtI,EAAW0C,GAAWC,EAAeC,GACpE2F,EAAOC,EAASC,EAGhBC,EAAc,GAGdC,EAAY9H,GAAM,CAAC,EACnB+H,GAAWC,GAAU,CAAC,EAKtBC,GAAmB,EACnBC,EAAc,KACdC,EAAe,CAAE,EAAG,EAAG,EAAG,CAAC,EAC3BC,EAAuB,KAG3B,MAAMC,EAAkB,SAAS,cAAc,QAAQ,EACjDC,GAAeD,EAAgB,WAAW,IAAI,EACpDA,EAAgB,MAAM,QAAU,OAEhC,MAAME,EAAkB,SAAS,cAAc,QAAQ,EACjDC,EAAeD,EAAgB,WAAW,IAAI,EACpDA,EAAgB,MAAM,QAAU,OAGhC,MAAME,EAAiB,SAAS,cAAc,QAAQ,EAChDC,GAAcD,EAAe,WAAW,IAAI,EAC5CE,EAAoB,SAAS,cAAc,QAAQ,EACnDC,EAAiBD,EAAkB,WAAW,IAAI,EAClDE,EAAiB,SAAS,cAAc,QAAQ,EAChDC,EAAcD,EAAe,WAAW,IAAI,EAIlD,IAAIE,GAAgB,GAab,SAASC,GAASC,EAAKC,EAAY,GAAI,CAC5CxJ,EAAUuJ,EAAI,QACd3E,EAAW2E,EAAI,SACfxB,EAAawB,EAAI,WACjB9J,EAAY8J,EAAI,UAChBpH,GAAYoH,EAAI,WAAa,KAC7BnH,EAAgBmH,EAAI,eAAiB,KACrClH,GAAiBkH,EAAI,gBAAkB,KACvCpB,EAAcoB,EAAI,aAAe,GAEjC,QAAQ,IAAI,4BAA6B,CACvC,YAAApB,EACA,gBAAiB,CAAC,CAAC9F,GACnB,mBAAoB,CAAC,CAACD,CAC1B,CAAG,EAED4F,EAAQpD,EAAS,WAAW,IAAI,EAChCqD,EAAUF,EAAW,WAAW,IAAI,EACpCG,EAASzI,EAAU,WAAW,IAAI,EAE9B,OAAO+J,EAAU,UAAa,aAAYpB,EAAWoB,EAAU,UAC/D,OAAOA,EAAU,SAAY,aAAYnB,GAAUmB,EAAU,SAGjE5B,EAAc,gBAAgB5H,CAAO,EACrC6E,EAAmB,aAAasD,CAAW,EAC3ChB,EAAiB,oBAAoBqC,EAAU,UAAU,EAGzDC,GAAc,EAGd,OAAO,iBAAiB,SAAUC,EAAQ,CAC5C,CAQO,eAAeC,IAAe,CACnC,MAAM/B,EAAc,aAAY,EAChC6B,GAAc,CAChB,CAKO,SAASA,IAAiB,CL3JjC,IAAAjL,EK4JE,MAAMoL,EAAUnK,EAAU,QAAQ,QAAQ,GAAKA,EAAU,cAGnDoK,EAAkB,IAAM,CAC5B,MAAMC,EAAK,OAAO,eAClB,MAAO,CACL,EAAG,KAAK,OAAMA,GAAA,YAAAA,EAAI,QAAU,OAAO,YAAe,SAAS,gBAAgB,aAAgB,GAAG,EAC9F,EAAG,KAAK,OAAMA,GAAA,YAAAA,EAAI,SAAU,OAAO,aAAe,SAAS,gBAAgB,cAAgB,GAAG,CACpG,CACE,EAGA,IAAIC,EAAMC,EACV,IAAIxL,EAAAL,EAAO,UAAP,MAAAK,EAAgB,UAAW,CAC7B,KAAM,CAAE,EAAAyD,EAAG,EAAAC,CAAC,EAAK2H,EAAe,EAChCE,EAAO9H,EACP+H,EAAO9H,EAGH0H,GAAWA,EAAQ,QACrBA,EAAQ,MAAM,SAAW,QACzBA,EAAQ,MAAM,IAAM,IACpBA,EAAQ,MAAM,KAAO,IACrBA,EAAQ,MAAM,MAAQ,IACtBA,EAAQ,MAAM,OAAS,IACvBA,EAAQ,MAAM,MAAQ,SACtBA,EAAQ,MAAM,OAAS,SACvBA,EAAQ,MAAM,OAAS,IACvBA,EAAQ,MAAM,QAAU,IACxBA,EAAQ,MAAM,SAAW,SAE7B,KAAO,CACL,MAAMlK,EAAOkK,EAAQ,sBAAqB,EAC1CG,EAAO,KAAK,IAAI,IAAK,KAAK,MAAMrK,EAAK,KAAK,CAAC,EAC3CsK,EAAO,KAAK,IAAI,IAAK,KAAK,MAAMtK,EAAK,MAAM,CAAC,CAC9C,CAMA,MAAMgB,EAAM,KAAK,IAAI,EAAG,KAAK,IAAI,OAAO,kBAAoB,EAAG,CAAC,CAAC,EAC3DuJ,EAAU,OAAO,WAAa,IAAO,KAAO,KAC5CC,EAAU,OAAO,YAAc,KAAQ,KAAO,KAG9CC,EAAS,KAAK,IAAIzJ,EAAKuJ,EAASF,EAAMG,EAASF,CAAI,EAEnDI,EAAS,KAAK,MAAML,EAAOI,CAAM,EACjCE,EAAS,KAAK,MAAML,EAAOG,CAAM,EAEjCG,EAAWzL,GAAM,EACjBA,EAAE,QAAUuL,GAAUvL,EAAE,SAAWwL,KACrCxL,EAAE,MAASuL,EACXvL,EAAE,OAASwL,GAEbxL,EAAE,MAAM,MAAS,GAAGkL,CAAI,KACxBlL,EAAE,MAAM,OAAS,GAAGmL,CAAI,IAC1B,EAEA,CAACpF,EAAUmD,EAAYtI,EAAWkJ,EAAiBE,CAAe,EAAE,QAAQyB,CAAO,EAEnF7B,EAAe,CAAE,EAAGhJ,EAAU,MAAO,EAAGA,EAAU,MAAM,CAC1D,CAqNA,SAAS8K,GAAiBtI,EAAGC,EAAG,CAC9B2C,EAAmB,aAAasD,CAAW,EAC3CtD,EAAmB,mBAAmBmD,EAAO/F,EAAGC,EAAGC,GAAWC,EAAeC,EAAc,CAC7F,CAKA,SAASmI,GAAUC,EAAQxI,EAAGC,EAAG,CAC/B,MAAMwI,EAAIzI,EAAIC,EACd,GAAI,CAACsG,GAAeC,EAAa,IAAMxG,GAAKwG,EAAa,IAAMvG,EAC7D,OAAAsG,EAAc,IAAI,aAAakC,CAAC,EAChClC,EAAY,IAAIiC,CAAM,EACtBhC,EAAe,CAAE,EAAAxG,EAAG,EAAAC,CAAC,EACdsG,EAET,MAAMmC,EAAIxM,EAAO,UAAU,eAC3B,QAASsE,EAAI,EAAGA,EAAIiI,EAAGjI,IACrB+F,EAAY/F,CAAC,EAAIkI,EAAInC,EAAY/F,CAAC,GAAK,EAAIkI,GAAKF,EAAOhI,CAAC,EAE1D,OAAO+F,CACT,CAEA,SAASoC,GAAgBC,EAAS5I,EAAGC,EAAG,CACtC,MAAM4I,EAAI3M,EAAO,UAAU,UACrBuM,EAAIzI,EAAIC,EACRL,EAAM,IAAI,UAAUI,EAAGC,CAAC,EAC9B,QAASO,EAAI,EAAGgC,EAAI,EAAGhC,EAAIiI,EAAGjI,IAAKgC,GAAK,EAAG,CACzC,MAAMsG,EAAIF,EAAQpI,CAAC,EACbkI,EAAII,GAAKD,EAAI,KAAK,IAAI,IAAK,KAAK,MAAMC,EAAI,GAAG,CAAC,EAAI,EACxDlJ,EAAI,KAAK4C,CAAC,EAAI,EACd5C,EAAI,KAAK4C,EAAI,CAAC,EAAI,EAClB5C,EAAI,KAAK4C,EAAI,CAAC,EAAI,EAClB5C,EAAI,KAAK4C,EAAI,CAAC,EAAIkG,CACpB,CACA5B,EAAe,MAAQ9G,EACvB8G,EAAe,OAAS7G,EACxB8G,GAAY,aAAanH,EAAK,EAAG,CAAC,EAElC,MAAMmJ,EAAKvL,EAAU,MACnBwL,EAAKxL,EAAU,OACjBwJ,EAAkB,MAAQ+B,EAC1B/B,EAAkB,OAASgC,EAC3B/B,EAAe,UAAU,EAAG,EAAG8B,EAAIC,CAAE,EACrC/B,EAAe,sBAAwB,GACvCA,EAAe,sBAAwB,OACvCA,EAAe,UAAUH,EAAgB,EAAG,EAAGiC,EAAIC,CAAE,EAErD,MAAMC,EAAS/M,EAAO,UAAU,gBAChC,OAAAgL,EAAe,MAAQ6B,EACvB7B,EAAe,OAAS8B,EACxB7B,EAAY,UAAU,EAAG,EAAG4B,EAAIC,CAAE,EAClC7B,EAAY,OAAS8B,EAAS,EAAI,QAAQA,CAAM,MAAQ,OACxD9B,EAAY,UAAUH,EAAmB,EAAG,CAAC,EAC7CG,EAAY,OAAS,OACdD,CACT,CAUA,SAASgC,GAAcC,EAAY,CAC5B,MAACpG,EAAIvF,EAAU,MACdA,EAAU,OAChByI,EAAO,KAAI,EACXA,EAAO,UAAUlD,EAAG,CAAC,EACrBkD,EAAO,MAAM,GAAI,CAAC,EAIlB,MAAMmD,EAA2BD,EACjClD,EAAO,QAAO,EAGVkD,EAAW,OAAS,GACtB,QAAQ,IAAI,SAAUA,EAAW,OAAQ,aAAcC,EAAQ,MAAM,EAIvE,MAAMC,EAA4BD,EAAQ,QAAUlN,EAAO,wBAAwB,eAE/EmN,IAA8BxD,KAC5BwD,EAEE,OAAOlD,GAAa,YACtBA,EAAS,qBAAqB,EAI5B,OAAOA,GAAa,YACtBA,EAAS,kBAAkB,EAG/BN,GAAyBwD,GAI3BjD,GAAQ,CACN,UAAW+C,EAAW,OACtB,YAAaC,EAAQ,OACrB,WAAYA,EAAQ,QAAUlN,EAAO,wBAAwB,cACjE,CAAG,CACH,CAKA,eAAeoN,IAAa,CLhiB5B,IAAA/M,EAAAyB,EAAAC,EKiiBE,GAAI,CAAC2H,EAAS,OACd,MAAM2D,EAAM,YAAY,IAAG,EACrBxG,EAAIvF,EAAU,MAClBwF,EAAIxF,EAAU,OAGhByI,EAAO,UAAU,EAAG,EAAGlD,EAAGC,CAAC,EAC3BsF,GAAiBvF,EAAGC,CAAC,EAGrB2D,GAAa,UAAU,EAAG,EAAG5D,EAAGC,CAAC,EACjC,MAAMhC,EAAKjD,EAAQ,YAAc,EAC/BkD,EAAKlD,EAAQ,aAAe,EACxBmD,EAAQ,KAAK,IAAI6B,EAAI/B,EAAIgC,EAAI/B,CAAE,EAC/BE,EAAK,KAAK,MAAMH,EAAKE,CAAK,EAC9BE,EAAK,KAAK,MAAMH,EAAKC,CAAK,EACtBG,EAAK,KAAK,OAAO0B,EAAI5B,GAAM,CAAC,EAChCG,EAAK,KAAK,OAAO0B,EAAI5B,GAAM,CAAC,EAC9B,GAAI,CACFuF,GAAa,UAAU5I,EAAS,EAAG,EAAGiD,EAAIC,EAAII,EAAIC,EAAIH,EAAIC,CAAE,CAC9D,MAAQ,CAAC,CAGT,GAAIlF,EAAO,aAAa,SACtB,GAAI6B,EAAQ,cAAgBqJ,GAAe,CACzCA,GAAgBrJ,EAAQ,YACxB,MAAMmF,EAAS,MAAMwC,EAAiB,aAAagB,EAAiB6C,CAAG,EACvE,GAAIrG,EAAQ,CACV,IAAI0F,EAAU,KACZY,EAAK,EACLC,EAAK,EACP,GAAIvG,EAAO,iBAAmBA,EAAO,gBAAgB,OAAQ,CAC3D,MAAMwG,EACJpD,GAAmBpD,EAAO,gBAAgB,OACtCoD,GACA,EACAqD,EAAKzG,EAAO,gBAAgBwG,CAAG,EACrC,GAAIC,GAAA,MAAAA,EAAI,kBAAmB,CACzB,MAAMC,EAAMD,EAAG,kBAAiB,EAChCf,EAAU,IAAI,aAAagB,EAAI,MAAM,EACrChB,EAAQ,IAAIgB,CAAG,EACfJ,EAAKG,EAAG,MACRF,EAAKE,EAAG,MACV,CACA,UAAWE,KAAK3G,EAAO,gBACrB,GAAI,EACF3G,EAAAsN,GAAA,YAAAA,EAAG,QAAH,MAAAtN,EAAA,KAAAsN,EACF,MAAQ,CAAC,CAEb,UAAW7L,EAAAkF,EAAO,eAAP,MAAAlF,EAAqB,gBAAiB,CAC/C,MAAM8L,EAAM5G,EAAO,aACb6G,EAAKD,EAAI,gBAAe,EAC9BlB,EAAU,IAAI,aAAamB,EAAG,MAAM,EACpCP,EAAKM,EAAI,MACTL,EAAKK,EAAI,OACT,MAAME,EAAY1D,GAClB,QAAS9F,EAAI,EAAGA,EAAIuJ,EAAG,OAAQvJ,IAC7BoI,EAAQpI,CAAC,EAAIuJ,EAAGvJ,CAAC,IAAMwJ,EAAY,EAAI,EACzC,GAAI,EACF/L,EAAA6L,EAAI,QAAJ,MAAA7L,EAAA,KAAA6L,EACF,MAAQ,CAAC,CACX,CACA,GAAIlB,GAAWY,GAAMC,EAAI,CACvB,MAAMQ,EAAK1B,GAAUK,EAASY,EAAIC,CAAE,EACpChD,EAAuBkC,GAAgBsB,EAAIT,EAAIC,CAAE,CACnD,CACF,CACF,OAEAhD,EAAuB,KAIzBI,EAAa,UAAU,EAAG,EAAG9D,EAAGC,CAAC,EACjC6D,EAAa,KAAI,EACjBA,EAAa,UAAUH,EAAiB,EAAG,EAAG3D,EAAGC,CAAC,EAC9CyD,IACFI,EAAa,yBAA2B,iBACxCA,EAAa,UAAUJ,EAAsB,EAAG,EAAG1D,EAAGC,CAAC,EACvD6D,EAAa,yBAA2B,eAE1CA,EAAa,QAAO,EAGpBZ,EAAO,KAAI,EACXA,EAAO,UAAUlD,EAAG,CAAC,EACrBkD,EAAO,MAAM,GAAI,CAAC,EAClBA,EAAO,UAAUW,EAAiB,EAAG,EAAG7D,EAAGC,CAAC,EAC5CiD,EAAO,QAAO,EAGdD,EAAQ,UAAU,EAAG,EAAGjD,EAAGC,CAAC,EACxByD,GAAwByD,IAC1BlE,EAAQ,YAAc,GACtBA,EAAQ,UAAUS,EAAsB,EAAG,EAAG1D,EAAGC,CAAC,EAClDgD,EAAQ,YAAc,EACtBF,EAAW,MAAM,QAAU,SAE3BA,EAAW,MAAM,QAAU,OAI7B,MAAMqE,EAAMzE,EAAiB,YAAYgB,EAAiB6C,CAAG,EAE3DL,GADEiB,EACYA,EAAI,YAAc,GAGlB,CAAA,CAHoB,EAMpC,sBAAsBb,EAAU,CAClC,CAKO,eAAec,IAAQ,CAC5B,GAAIxE,EAAS,OAEb,GAAI,CADO/I,GAAgB,EAClB,CACPsJ,EAAS,aAAa,EACtB,MACF,CACAA,EAAS,QAAQ,EAGjBqB,GAAc,EAEd,MAAM9B,EAAiB,KAAKlI,CAAS,EACrC,MAAMmI,EAAc,YAAW,EAE/BC,EAAU,GACVO,EAAS,KAAK,EACd,sBAAsBmD,EAAU,CAClC,CAEO,SAASe,IAAO,CACrBzE,EAAU,GACVD,EAAc,WAAU,EACpBM,GAAUD,GAAWD,IACvBE,EAAO,UAAU,EAAG,EAAGzI,EAAU,MAAOA,EAAU,MAAM,EACxDwI,EAAQ,UAAU,EAAG,EAAGF,EAAW,MAAOA,EAAW,MAAM,EAC3DC,EAAM,UAAU,EAAG,EAAGpD,EAAS,MAAOA,EAAS,MAAM,GAEvDyD,GAAQ,CAAE,UAAW,EAAG,YAAa,EAAG,WAAY,GAAO,EAC3DD,EAAS,KAAK,CAChB,CAEO,SAASsB,IAAW,CACrB7B,GAAS4B,GAAc,CAC7B,CAGA,IAAI0C,GAAmB,GAChB,SAASI,GAAmBxB,EAAG,CACpCoB,GAAmB,CAAC,CAACpB,CACvB,CACO,SAASyB,GAAsBzB,EAAG,CACvC5M,EAAO,aAAa,QAAU,CAAC,CAAC4M,CAClC,CACO,SAAS0B,GAAkBnM,EAAG,CACnCnC,EAAO,WAAW,KAAOmC,CAC3B,CACO,SAASoM,GAAuBC,EAAK,CAC1CxO,EAAO,WAAW,UAAY,KAAK,IAAI,EAAG,KAAK,IAAI,EAAGwO,CAAG,CAAC,CAC5D,CACO,SAASC,GAAeC,EAAI,CACjC1O,EAAO,UAAU,gBAAkB,KAAK,IAAI,EAAG,OAAO0O,CAAE,GAAK,CAAC,CAChE,CACO,SAASC,GAAiBC,EAAK,CACpC5O,EAAO,UAAU,eAAiB,KAAK,IACrC,EACA,KAAK,IAAI,IAAM,OAAO4O,CAAG,GAAK,CAAC,CACnC,CACA,CACO,SAASC,GAAaD,EAAK,CAChC5O,EAAO,UAAU,UAAY,KAAK,IAAI,EAAG,KAAK,IAAI,EAAG,OAAO4O,CAAG,GAAK,CAAC,CAAC,CACxE,CAGO,SAASE,GAAgBC,EAAM,CAEpC/O,EAAO,WAAW,eAAiB+O,CACrC,CACO,SAASC,GAAqBC,EAAO,CAG5C,CAGO,SAASC,IAAY,CAC1B,OAAOxF,CACT,CAGO,SAASyF,GAA6BnJ,EAAU,CACrDgD,EAAiB,oBAAoBhD,CAAQ,CAC/C,CAEO,SAASoJ,GAAqBnJ,EAAQ,CAC3C+C,EAAiB,gBAAgB/C,CAAM,CACzC,CAKO,eAAeoJ,IAAe,CACnC,OAAOrG,EAAiB,aAAa1H,EAAWmF,EAAUzG,EAAQ0G,EAAoBzC,CAAa,CACrG,CAGO,eAAeqL,IAAuB,CAC3C,GAAI,CAACzN,GAAW,CAACA,EAAQ,YAAc,CAACA,EAAQ,YAC9C,eAAQ,MAAM,qCAAqC,EAC5C,KAIT,MAAM0N,EAAa,SAAS,cAAc,QAAQ,EAClD,OAAAA,EAAW,MAAQ1N,EAAQ,WAC3B0N,EAAW,OAAS1N,EAAQ,YACZ0N,EAAW,WAAW,IAAI,EAGlC,UAAU1N,EAAS,EAAG,CAAC,EAGxB0N,EAAW,UAAU,WAAW,CACzC,CAGO,eAAeC,GAA8BC,EAAeC,EAAmBC,EAAoB,CACxG,GAAI,CAACF,GAAiB,CAACC,EAAmB,CACxC,QAAQ,MAAM,0CAA0C,EACxD,MACF,CAEA,GAAI,CAEF,MAAME,EAAc,IAAI,MACxBA,EAAY,IAAMF,EAClB,MAAM,IAAI,QAAQ,CAAC9M,EAAS+E,IAAW,CACrCiI,EAAY,OAAShN,EACrBgN,EAAY,QAAUjI,CACxB,CAAC,EAGD,MAAMkI,EAAgB,IAAI,MAC1BA,EAAc,IAAMF,EACpB,MAAM,IAAI,QAAQ,CAAC/M,EAAS+E,IAAW,CACrCkI,EAAc,OAASjN,EACvBiN,EAAc,QAAUlI,CAC1B,CAAC,EAGD8H,EAAc,MAAQG,EAAY,MAClCH,EAAc,OAASG,EAAY,OACnC,MAAM/L,EAAM4L,EAAc,WAAW,IAAI,EAGzC,GAAI,CAACpF,GAAe,CAACb,EAAiB,cAAa,EAAI,CAErD3F,EAAI,UAAUgM,EAAe,EAAG,EAAGJ,EAAc,MAAOA,EAAc,MAAM,EAG5E5L,EAAI,YAAc,GAClBA,EAAI,UAAU+L,EAAa,EAAG,CAAC,EAC/B/L,EAAI,YAAc,EAClB,MACF,CAIAA,EAAI,UAAUgM,EAAe,EAAG,EAAGJ,EAAc,MAAOA,EAAc,MAAM,EAG5E,MAAM7F,EAAa,SAAS,cAAc,QAAQ,EAClDA,EAAW,MAAQ6F,EAAc,MACjC7F,EAAW,OAAS6F,EAAc,OAClC,MAAM3F,EAAUF,EAAW,WAAW,IAAI,EAG1C,GAAIS,GAAeC,EAAa,EAAI,GAAKA,EAAa,EAAI,EAAG,CAE3D,MAAMwF,EAAYhG,EAAQ,gBAAgBQ,EAAa,EAAGA,EAAa,CAAC,EACxE,QAAShG,EAAI,EAAGA,EAAI+F,EAAY,OAAQ/F,IAAK,CAC3C,MAAMyL,EAAY,KAAK,MAAM1F,EAAY/F,CAAC,EAAI,GAAG,EAC3C0L,EAAa1L,EAAI,EACvBwL,EAAU,KAAKE,CAAU,EAAID,EAC7BD,EAAU,KAAKE,EAAa,CAAC,EAAID,EACjCD,EAAU,KAAKE,EAAa,CAAC,EAAID,EACjCD,EAAU,KAAKE,EAAa,CAAC,EAAI,GACnC,CAGAlG,EAAQ,aAAagG,EAAW,EAAG,CAAC,EAGpCjM,EAAI,yBAA2B,iBAC/BA,EAAI,UAAU+F,EAAY,EAAG,EAAG6F,EAAc,MAAOA,EAAc,MAAM,EAGzE5L,EAAI,yBAA2B,cAC/BA,EAAI,UAAU+L,EAAa,EAAG,CAAC,EAG/B/L,EAAI,yBAA2B,aACjC,CAEF,OAASoD,EAAO,CACd,QAAQ,MAAM,6BAA8BA,CAAK,EAEjD,MAAMpD,EAAM4L,EAAc,WAAW,IAAI,EACnC/L,EAAM,IAAI,MAChBA,EAAI,IAAMgM,EACVhM,EAAI,OAAS,IAAM,CACjB+L,EAAc,MAAQ/L,EAAI,MAC1B+L,EAAc,OAAS/L,EAAI,OAC3BG,EAAI,UAAUH,EAAK,EAAG,CAAC,CACzB,CACF,CACF,CAGO,eAAeuM,GAAmBvO,EAAQkO,EAAa,CAC5D,GAAI,CAAClO,GAAU,CAACkO,EAAa,CAC3B,QAAQ,MAAM,6DAA6D,EAC3E,MACF,CAEA,GAAI,CACF,MAAM/L,EAAMnC,EAAO,WAAW,IAAI,EAGlC,GAAI,CAAC8H,EAAiB,cAAa,GAAM,CAACa,GAAe,CAACC,EAAa,GAAK,CAACA,EAAa,EAAG,CAC3F,QAAQ,KAAK,wEAAwE,EAGrFzG,EAAI,KAAI,EACRA,EAAI,MAAM,GAAI,CAAC,EACfA,EAAI,UAAU,CAACnC,EAAO,MAAO,CAAC,EAC9BmC,EAAI,UAAU+L,EAAa,EAAG,EAAGlO,EAAO,MAAOA,EAAO,MAAM,EAC5DmC,EAAI,QAAO,EACX,MACF,CAGA,MAAM0L,EAAa,SAAS,cAAc,QAAQ,EAClDA,EAAW,MAAQ7N,EAAO,MAC1B6N,EAAW,OAAS7N,EAAO,OAC3B,MAAMwO,EAAUX,EAAW,WAAW,IAAI,EAG1CW,EAAQ,KAAI,EACZA,EAAQ,MAAM,GAAI,CAAC,EACnBA,EAAQ,UAAU,CAACX,EAAW,MAAO,CAAC,EACtCW,EAAQ,UAAUN,EAAa,EAAG,EAAGL,EAAW,MAAOA,EAAW,MAAM,EACxEW,EAAQ,QAAO,EAGf,MAAMtG,EAAa,SAAS,cAAc,QAAQ,EAClDA,EAAW,MAAQU,EAAa,EAChCV,EAAW,OAASU,EAAa,EACjC,MAAMR,EAAUF,EAAW,WAAW,IAAI,EAGpCuG,EAAgBrG,EAAQ,gBAAgBQ,EAAa,EAAGA,EAAa,CAAC,EACtE8F,EAAYpQ,EAAO,UAAU,WAAa,GAEhD,QAASsE,EAAI,EAAGA,EAAI+F,EAAY,OAAQ/F,IAAK,CAC3C,MAAMyL,EAAY1F,EAAY/F,CAAC,EACzB+L,EAAQN,GAAaK,EAAY,KAAK,IAAI,IAAK,KAAK,MAAML,EAAY,GAAG,CAAC,EAAI,EAC9EC,EAAa1L,EAAI,EAEvB6L,EAAc,KAAKH,CAAU,EAAI,IACjCG,EAAc,KAAKH,EAAa,CAAC,EAAI,IACrCG,EAAc,KAAKH,EAAa,CAAC,EAAI,IACrCG,EAAc,KAAKH,EAAa,CAAC,EAAIK,CACvC,CAGAvG,EAAQ,aAAaqG,EAAe,EAAG,CAAC,EAGxC,MAAMG,EAAmB,SAAS,cAAc,QAAQ,EACxDA,EAAiB,MAAQ5O,EAAO,MAChC4O,EAAiB,OAAS5O,EAAO,OACX4O,EAAiB,WAAW,IAAI,EACxC,UAAU1G,EAAY,EAAG,EAAGlI,EAAO,MAAOA,EAAO,MAAM,EAGrEmC,EAAI,UAAU,EAAG,EAAGnC,EAAO,MAAOA,EAAO,MAAM,EAC/CmC,EAAI,UAAU0L,EAAY,EAAG,CAAC,EAG9B1L,EAAI,yBAA2B,iBAC/BA,EAAI,UAAUyM,EAAkB,EAAG,CAAC,EAGpCzM,EAAI,yBAA2B,aAEjC,OAASoD,EAAO,CACd,QAAQ,MAAM,iCAAkCA,CAAK,EAGrD,MAAMpD,EAAMnC,EAAO,WAAW,IAAI,EAClCmC,EAAI,UAAU,EAAG,EAAGnC,EAAO,MAAOA,EAAO,MAAM,EAC/CmC,EAAI,KAAI,EACRA,EAAI,MAAM,GAAI,CAAC,EACfA,EAAI,UAAU,CAACnC,EAAO,MAAO,CAAC,EAC9BmC,EAAI,UAAU+L,EAAa,EAAG,EAAGlO,EAAO,MAAOA,EAAO,MAAM,EAC5DmC,EAAI,QAAO,CACb,CACF,CAGA,IAAI0M,GAAc,GAKX,SAASC,GAAiBC,EAAcC,EAAe,CAC5DH,GAAc,GAKdlC,GAAsB,EAAI,EAG1BC,GAAkB,WAAW,EACzBoC,GACFhK,EAAmB,oBAAoBgK,CAAa,CAExD,CAGO,SAASC,IAAkB,CAChCJ,GAAc,GAKdlC,GAAsB,EAAK,EAC3BC,GAAkB,gBAAgB,CACpC,CAGO,SAASsC,GAAwBF,EAAe,CAChDH,IAGL7J,EAAmB,oBAAoBgK,CAAa,CACtD"}