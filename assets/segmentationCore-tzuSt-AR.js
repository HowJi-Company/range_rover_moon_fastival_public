const a={FACE_DETECTION:{MODEL:"short",MIN_DETECTION_CONFIDENCE:.5,MAX_FACES:10},SEGMENTATION:{ENABLED:!0,MODEL_SELECTION:1,SELFIE_MODE:!0,SEGMENTATION_THRESHOLD:.1},FACE_DETECTION_SETTINGS:{REQUIRED_FACES:1},CAMERA:{WIDTH:1280,HEIGHT:720,DEFAULT_WIDTH:1280,DEFAULT_HEIGHT:720,DEFAULT_FACING_MODE:"user",FRAME_RATE:30},UI:{STATUS_UPDATE_INTERVAL:100,SHOW_DEBUG_INFO:!0,SHOW_FPS:!1,LANGUAGE:"zh-TW"},EFFECTS:{MOON_EFFECT_DURATION:3e3,FADE_DURATION:800,ENABLE_SOUND:!1,MOON_SIZE_SCALE:1,STAR_COUNT:5,SPARKLE_COUNT:3},BACKGROUND_EFFECTS:{DEFAULT_BACKGROUND:"moon_video",WAVE_EFFECT:{AMPLITUDE:10,FREQUENCY:.02,SPEED:.05},FREQUENCY_EFFECT:{BANDS:32,HEIGHT_SCALE:.8,COLOR_SHIFT:.01},EFFECT_INTENSITY:.5,BLEND_MODE:"source-over"},PERFORMANCE:{ENABLE_MONITORING:!1,MAX_LATENCY:100,LOW_PERFORMANCE_MODE:!1,AUTO_ADJUST_PERFORMANCE:!0},DEBUG:{VERBOSE_LOGGING:!1,SHOW_FACE_LANDMARKS:!1,SAVE_DETECTION_RESULTS:!1},ADVANCED:{MEDIAPIPE_BASE_URL:"https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/",MEDIAPIPE_SEGMENTATION_URL:"https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/",USE_WEB_WORKERS:!1,MEMORY_LIMIT:512,ENABLE_ERROR_REPORTING:!0}};a.BACKGROUND=a.BACKGROUND||{TYPE:a.BACKGROUND_EFFECTS&&a.BACKGROUND_EFFECTS.DEFAULT_BACKGROUND||"original",INTENSITY:(a.BACKGROUND_EFFECTS&&a.BACKGROUND_EFFECTS.EFFECT_INTENSITY)??.5,GIF_BLEND_MODE:"overlay"};function Ae(){const n=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),e=(navigator.hardwareConcurrency||4)<=2;n&&(a.CAMERA.DEFAULT_WIDTH=480,a.CAMERA.DEFAULT_HEIGHT=360,a.FACE_DETECTION.MODEL="short",a.EFFECTS.STAR_COUNT=3,a.EFFECTS.SPARKLE_COUNT=2),e&&(a.PERFORMANCE.LOW_PERFORMANCE_MODE=!0,a.FACE_DETECTION.MIN_DETECTION_CONFIDENCE=.6,a.CAMERA.FRAME_RATE=20,a.EFFECTS.MOON_SIZE_SCALE=.8)}function Me(){var e;const n=[];return(a.FACE_DETECTION.MIN_DETECTION_CONFIDENCE<0||a.FACE_DETECTION.MIN_DETECTION_CONFIDENCE>1)&&n.push("MIN_DETECTION_CONFIDENCE 必須在 0~1 之間"),(e=navigator.mediaDevices)!=null&&e.getUserMedia||n.push("瀏覽器不支援相機功能"),n}function Ue(){try{localStorage.setItem("moonFestivalAR_config",JSON.stringify(a))}catch{}}function Pe(){try{localStorage.removeItem("moonFestivalAR_config")}catch{}location.reload()}function Oe(){try{const n=localStorage.getItem("moonFestivalAR_config");n&&Object.assign(a,JSON.parse(n))}catch{}}function Ce(){var e;Oe(),Ae(),a.CAMERA.WIDTH=a.CAMERA.DEFAULT_WIDTH||a.CAMERA.WIDTH||1280,a.CAMERA.HEIGHT=a.CAMERA.DEFAULT_HEIGHT||a.CAMERA.HEIGHT||720,a.CAMERA.FACING=a.CAMERA.DEFAULT_FACING_MODE||a.CAMERA.FACING||"user",a.SEGMENTER=a.SEGMENTER||{},a.SEGMENTER.USE_LANDSCAPE_MODEL=a.SEGMENTATION&&a.SEGMENTATION.MODEL_SELECTION===1?!0:a.SEGMENTER.USE_LANDSCAPE_MODEL??!0,a.SEGMENTER.USE_GPU=a.SEGMENTER.USE_GPU??!0,a.SMOOTHING=a.SMOOTHING||{},a.SMOOTHING.THRESHOLD=a.SMOOTHING.THRESHOLD??((e=a.SEGMENTATION)==null?void 0:e.SEGMENTATION_THRESHOLD)??.38,a.SMOOTHING.TEMPORAL_ALPHA=a.SMOOTHING.TEMPORAL_ALPHA??.6,a.SMOOTHING.EDGE_FEATHER_PX=a.SMOOTHING.EDGE_FEATHER_PX??3,a.SMOOTHING.HYS_ON=a.SMOOTHING.HYS_ON??a.SMOOTHING.THRESHOLD-.15,a.SMOOTHING.HYS_OFF=a.SMOOTHING.HYS_OFF??a.SMOOTHING.THRESHOLD+.15,a.SMOOTHING.MASK_GROW_PX=a.SMOOTHING.MASK_GROW_PX??1.5,a.MODELS||(a.MODELS={SELFIE_SEGMENTER_LANDSCAPE:"https://storage.googleapis.com/mediapipe-models/image_segmenter/selfie_segmenter_landscape/float16/latest/selfie_segmenter_landscape.tflite",SELFIE_SEGMENTER_SQUARE:"https://storage.googleapis.com/mediapipe-models/image_segmenter/selfie_segmenter/float16/latest/selfie_segmenter.tflite",FACE_DETECTOR:"https://storage.googleapis.com/mediapipe-models/face_detector/blaze_face_short_range/float16/latest/blaze_face_short_range.tflite"}),a.WASM_BASE=a.WASM_BASE||"https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.7/wasm";const n=Me();return n.length?(console.error("配置驗證失敗：",n),!1):!0}let ne=null,oe=null,G=null;async function we(){if(window.FilesetResolver&&window.ImageSegmenter)return!0;const n=["https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.7/vision_bundle.mjs","https://unpkg.com/@mediapipe/tasks-vision@0.10.7/vision_bundle.mjs"];for(const e of n)try{const t=await import(e);return t.FilesetResolver&&(window.FilesetResolver=t.FilesetResolver),t.ImageSegmenter&&(window.ImageSegmenter=t.ImageSegmenter),t.FaceDetector&&(window.FaceDetector=t.FaceDetector),!0}catch(t){console.warn("[WARN] failed to import tasks-vision from",e,t)}throw new Error("無法載入 @mediapipe/tasks-vision 模組")}async function Ie(n){G||(G=await FilesetResolver.forVisionTasks(a.WASM_BASE));try{const t=n.getBoundingClientRect();a.SEGMENTER.USE_LANDSCAPE_MODEL=(t.width||1)>=(t.height||1)}catch{}const e={modelAssetPath:a.SEGMENTER.USE_LANDSCAPE_MODEL?a.MODELS.SELFIE_SEGMENTER_LANDSCAPE:a.MODELS.SELFIE_SEGMENTER_SQUARE,delegate:a.SEGMENTER.USE_GPU?"GPU":"CPU"};try{ne=await ImageSegmenter.createFromOptions(G,{baseOptions:e,runningMode:"VIDEO",outputCategoryMask:!1,outputConfidenceMasks:!0})}catch(t){console.warn("[Segmenter] GPU 失敗，改用 CPU:",t),ne=await ImageSegmenter.createFromOptions(G,{baseOptions:{...e,delegate:"CPU"},runningMode:"VIDEO",outputCategoryMask:!1,outputConfidenceMasks:!0})}try{oe=await FaceDetector.createFromOptions(G,{baseOptions:{modelAssetPath:a.MODELS.FACE_DETECTOR,delegate:"GPU"},runningMode:"VIDEO",minDetectionConfidence:.6,minSuppressionThreshold:.3})}catch(t){console.warn("[FaceDetector] GPU 失敗，改用 CPU:",t),oe=await FaceDetector.createFromOptions(G,{baseOptions:{modelAssetPath:a.MODELS.FACE_DETECTOR,delegate:"CPU"},runningMode:"VIDEO",minDetectionConfidence:.6,minSuppressionThreshold:.3})}}class Re{constructor(){this.imageSegmenter=null,this.faceDetector=null,this.wasmFileset=null}async init(e){await we(),await Ie(e),this.imageSegmenter=ne,this.faceDetector=oe,this.wasmFileset=G}getImageSegmenter(){return this.imageSegmenter}getFaceDetector(){return this.faceDetector}isInitialized(){return this.imageSegmenter!==null&&this.faceDetector!==null}async segmentImage(e,t){if(!this.imageSegmenter)return null;try{return this.imageSegmenter.segmentForVideo?this.imageSegmenter.segmentForVideo(e,t):await this.imageSegmenter.segment(e)}catch(o){return console.warn("segmentForVideo error:",o),null}}detectFaces(e,t){if(!this.faceDetector)return console.warn("⚠️ faceDetector not initialized"),null;try{return this.faceDetector.detectForVideo?this.faceDetector.detectForVideo(e,t):this.faceDetector.detect(e)}catch(o){return console.warn("faceDetector error:",o),null}}}class _e{constructor(){this.stream=null,this.currentFacingMode=a.CAMERA.DEFAULT_FACING_MODE||"user",this.videoEl=null}setVideoElement(e){this.videoEl=e}async startCamera(){var l,m,u,h,E,f;if(this.stream)try{this.stream.getTracks().forEach(g=>g.stop())}catch{}const e=(l=this.videoEl)==null?void 0:l.closest(".stage"),t=(e==null?void 0:e.clientWidth)||window.innerWidth,o=(e==null?void 0:e.clientHeight)||window.innerHeight,i=Math.min(window.devicePixelRatio||1,3),s=Math.min(Math.round(t*i),1920),c=Math.min(Math.round(o*i),1080),r=s/Math.max(1,c),d={audio:!1,video:{facingMode:this.currentFacingMode,width:{ideal:s,min:640,max:2560},height:{ideal:c,min:480,max:1440},aspectRatio:{ideal:r},frameRate:{ideal:a.CAMERA.FRAME_RATE||30,max:60}}};this.stream=await navigator.mediaDevices.getUserMedia(d),this.videoEl.srcObject=this.stream,this.videoEl.setAttribute("playsinline",""),this.videoEl.muted=!0,this.videoEl.autoplay=!0,await new Promise(g=>{if(this.videoEl.readyState>=1&&this.videoEl.videoWidth&&this.videoEl.videoHeight)return g();this.videoEl.onloadedmetadata=()=>g(),setTimeout(g,1500)});try{const g=this.stream.getVideoTracks()[0],M=(m=g.getCapabilities)==null?void 0:m.call(g),_=(S,p,T)=>{if(p==null&&T==null)return S;const O=typeof p=="number"?p:S,W=typeof T=="number"?T:S;return Math.min(Math.max(S,O),W)};if(M){const S=_(s,(u=M.width)==null?void 0:u.min,(h=M.width)==null?void 0:h.max),p=_(c,(E=M.height)==null?void 0:E.min,(f=M.height)==null?void 0:f.max),T=s/Math.max(1,c);await g.applyConstraints({width:{ideal:S},height:{ideal:p},aspectRatio:{ideal:T},frameRate:{ideal:a.CAMERA.FRAME_RATE||30,max:60}})}}catch(g){console.warn("applyConstraints failed:",g)}try{await this.videoEl.play()}catch{}}stopCamera(){try{this.stream&&this.stream.getTracks().forEach(e=>e.stop())}catch{}this.stream=null}async switchCamera(){this.currentFacingMode=this.currentFacingMode==="user"?"environment":"user",await this.startCamera()}getCurrentFacingMode(){return this.currentFacingMode}getStream(){return this.stream}}class Ne{constructor(){this.animT=0,this.customBackgroundImage=null,this.isIOSDevice=!1,this.loadCustomBackground()}setIOSDevice(e){this.isIOSDevice=e}loadCustomBackground(){const e=new Image;e.onload=()=>{this.customBackgroundImage=e,console.log("✅ 自定義背景圖片載入完成")},e.onerror=o=>{console.warn("⚠️ 自定義背景圖片載入失敗:",o)};const t="/range_rover_moon_fastival_public/";e.src=t+"pexels-photo-623218.jpeg"}setCustomBackground(e){const t=new Image;t.onload=()=>{this.customBackgroundImage=t,console.log("✅ 背景圖片已更新:",e)},t.onerror=o=>{console.warn("⚠️ 背景圖片載入失敗:",o)},t.src=e}updateAnimation(){this.animT+=.016}renderBackgroundTo(e,t,o,i,s,c){const r=a.BACKGROUND&&a.BACKGROUND.TYPE||a.BACKGROUND_EFFECTS&&a.BACKGROUND_EFFECTS.DEFAULT_BACKGROUND||"original",d=a.BACKGROUND&&typeof a.BACKGROUND.INTENSITY=="number"?a.BACKGROUND.INTENSITY:(a.BACKGROUND_EFFECTS&&a.BACKGROUND_EFFECTS.EFFECT_INTENSITY)??.5;if(e.clearRect(0,0,t,o),this.updateAnimation(),r!=="original"){if(r==="waves"){this.renderWaveBackground(e,t,o,d);return}if(r==="frequency"){this.renderFrequencyBackground(e,t,o,d);return}if(r==="video"&&i){this.renderVideoBackground(e,t,o,i,d);return}if(r==="moon_video"&&s){this.renderMoonVideoBackground(e,t,o,s,d);return}if(r==="custom_moon_bg"&&this.customBackgroundImage){this.renderCustomMoonBackground(e,t,o,s,c,d);return}}}renderWaveBackground(e,t,o,i){const s=e.createLinearGradient(0,0,t,o);s.addColorStop(0,"#1a2332"),s.addColorStop(.5,"#2d3a50"),s.addColorStop(1,"#0f1419"),e.fillStyle=s,e.fillRect(0,0,t,o),e.strokeStyle=`rgba(100,200,255,${i*.6})`,e.lineWidth=2;for(let c=0;c<8;c++){e.beginPath();for(let r=0;r<t;r+=5){const d=c*50,l=o/2+Math.sin((r+d)*.012+this.animT*1.2)*20*i;r===0?e.moveTo(r,l):e.lineTo(r,l)}e.stroke()}}renderFrequencyBackground(e,t,o,i){e.fillStyle="#0a0a0a",e.fillRect(0,0,t,o);const s=48,c=t/s;for(let r=0;r<s;r++){const d=r*c,l=(Math.sin(this.animT*2+r*.2)*.5+.5)*o*.5*i,m=(this.animT*30+r*10)%360;e.fillStyle=`hsla(${m},70%,60%,0.8)`,e.fillRect(d,o-l,c-1,l)}}renderVideoBackground(e,t,o,i,s){const c=i.videoWidth||1,r=i.videoHeight||1;if(i.readyState>=2){const d=Math.max(t/c,o/r),l=Math.round(c*d),m=Math.round(r*d),u=Math.round((t-l)/2),h=Math.round((o-m)/2);try{i.paused&&i.play().catch(()=>{})}catch{}e.globalAlpha=Math.min(1,.3+s*.7),e.drawImage(i,0,0,c,r,u,h,l,m),e.globalAlpha=1}}renderMoonVideoBackground(e,t,o,i,s){try{if(i.readyState>=2&&!i.paused){const c=i.videoWidth||i.width||1,r=i.videoHeight||i.height||1;if(c>1&&r>1){const d=Math.max(t/c,o/r),l=Math.round(c*d),m=Math.round(r*d),u=Math.round((t-l)/2),h=Math.round((o-m)/2);e.globalAlpha=Math.min(1,.3+s*.7),e.drawImage(i,0,0,c,r,u,h,l,m),e.globalAlpha=1}}else i.paused&&i.play().catch(c=>console.warn("月相影片播放失敗:",c))}catch(c){console.warn("月相影片渲染錯誤:",c)}}renderCustomMoonBackground(e,t,o,i,s,c){try{if(this.isIOSDevice){if(this.customBackgroundImage){const r=this.customBackgroundImage.naturalWidth||this.customBackgroundImage.width,d=this.customBackgroundImage.naturalHeight||this.customBackgroundImage.height;if(r>0&&d>0){const l=Math.max(t/r,o/d),m=Math.round(r*l),u=Math.round(d*l),h=Math.round((t-m)/2),E=Math.round((o-u)/2);e.drawImage(this.customBackgroundImage,0,0,r,d,h,E,m,u)}}return}if(this.customBackgroundImage){const r=this.customBackgroundImage.naturalWidth||this.customBackgroundImage.width,d=this.customBackgroundImage.naturalHeight||this.customBackgroundImage.height;if(r>0&&d>0){const l=Math.max(t/r,o/d),m=Math.round(r*l),u=Math.round(d*l),h=Math.round((t-m)/2),E=Math.round((o-u)/2);e.drawImage(this.customBackgroundImage,0,0,r,d,h,E,m,u)}}i&&i.readyState>=2&&!i.paused?this.renderCircularMoon(e,t,o,i,c):i&&i.paused&&i.play().catch(r=>console.warn("月相影片播放失敗:",r))}catch(r){console.warn("自定義背景 + 圓形月亮渲染錯誤:",r)}}renderCircularMoon(e,t,o,i,s){const c=i.videoWidth||i.width||1,r=i.videoHeight||i.height||1;if(c>1&&r>1){e.save();const d=t/o;let l,m,u;d>.6?(l=t*.5,m=o*.35,u=Math.min(t,o)*.25):d>.5?(l=t*.51,m=o*.29,u=Math.min(t,o)*.29):(l=t*.51,m=o*.26,u=Math.min(t,o)*.3),e.beginPath(),e.arc(l,m,u,0,2*Math.PI),e.clip();const h=Math.max(t/c,o/r),E=Math.round(c*h),f=Math.round(r*h),g=Math.round((t-E)/2),M=Math.round((o-f)/2);e.globalAlpha=Math.min(1,.8+s*.2),e.drawImage(i,0,0,c,r,g,M,E,f),e.globalAlpha=1,e.restore()}}}let F=null,K=null,v=null;function se(){try{v&&(URL.revokeObjectURL(v),v=null)}catch(n){console.warn("revoke failed",n)}}class De{constructor(){this.progressCallback=null,this.outputFormat="mp4"}setProgressCallback(e){this.progressCallback=e}setOutputFormat(e){this.outputFormat=e}storeRecordingBlob(e,t){if(!e)return null;se(),F=e,K=t||`moonAR_${Date.now()}.webm`;try{v=URL.createObjectURL(e)}catch(o){console.warn("createObjectURL failed",o),v=null}return v}hasRecordingAvailable(){return!!F}getLastRecordingUrl(){return v||null}clearLastRecording(){se(),F=null,K=null}getLastRecordingFilename(){return K}async uploadBlobToServerAndGetUrl(e,t){const o=new FormData;o.append("file",e,t);const i=await fetch("/api/upload",{method:"POST",body:o});if(!i.ok)throw new Error("upload failed");const s=await i.json();if(!(s!=null&&s.url))throw new Error("upload response missing url");return s.url}async shareLastRecording(){if(!F)throw new Error("no recording available");const e=K||`moonAR_${Date.now()}.mp4`,t=new File([F],e,{type:F.type||"video/mp4"});try{if(navigator.canShare&&navigator.canShare({files:[t]}))return await navigator.share({files:[t],title:"月亮節 AR 影片",text:"分享給你"}),{ok:!0,method:"webshare"}}catch(o){console.warn("Web Share file error:",o)}try{const o=await this.uploadBlobToServerAndGetUrl(F,e);if(navigator.share)try{return await navigator.share({title:"月亮節 AR 影片",text:"看這個影片：",url:o}),{ok:!0,method:"url-share",url:o}}catch(i){console.warn("Web Share URL error:",i)}return{ok:!0,method:"uploaded",url:o}}catch(o){throw console.warn("upload failed:",o),o}}async capturePhoto(e,t,o,i,s){if(!e||!i)return console.warn("無法拍照：相機未啟動或畫布不存在"),null;try{const c=document.createElement("canvas"),r=c.getContext("2d"),d=e.width,l=e.height;c.width=d,c.height=l;const m=o.BACKGROUND&&o.BACKGROUND.TYPE;if(console.log("📸 拍照檢查背景類型:",{bgType:m,hasMoonVideo:!!s}),(m==="moon_video"||m==="custom_moon_bg")&&s){console.log("🌙 月相影片模式：生成 8 秒動態影片..."),r.drawImage(e,0,0,d,l);const u=c.toDataURL("image/png",1);try{const h=await this.generateVideoWithStaticPerson(u,d,l,o,i,s);return console.log("✅ 影片生成完成:",h),h}catch(h){return console.error("❌ 影片生成失敗:",h),this.savePNG(c)}}else r.drawImage(t,0,0,d,l),r.drawImage(e,0,0,d,l);return this.savePNG(c)}catch(c){return console.error("拍照失敗：",c),null}}savePNG(e){const t=e.toDataURL("image/png",1),o=new Date().toISOString().replace(/[:]/g,"-").split(".")[0],i=document.createElement("a"),s=`月亮節AR拍照_${o}.png`;return i.download=s,i.href=t,document.body.appendChild(i),i.click(),document.body.removeChild(i),console.log("📸 PNG 拍照成功！"),{png:t}}async generateVideoWithStaticPerson(e,t,o,i,s,c){if(console.log("🎬 開始錄製靜止人物 + 動態背景影片..."),!window.MediaRecorder)return console.warn("瀏覽器不支援 MediaRecorder"),{png:e,error:"瀏覽器不支援影片錄製"};const r=document.createElement("canvas"),d=r.getContext("2d"),l=640,m=t/o;t>o?(r.width=Math.min(l,t),r.height=Math.round(r.width/m)):(r.height=Math.min(l,o),r.width=Math.round(r.height*m));const u=new Image;return new Promise((h,E)=>{u.onload=async()=>{c&&c.paused&&await c.play().catch(O=>console.warn("影片播放失敗:",O));const _=r.captureStream(20),S=this.getRecorderOptions(),p=new MediaRecorder(_,S),T=[];p.ondataavailable=O=>{O.data.size>0&&T.push(O.data)},p.onstop=()=>{const O=this.outputFormat==="mp4"?"video/mp4":"video/webm",W=this.outputFormat==="mp4"?"mp4":"webm",pe=new Blob(T,{type:O}),Se=`月亮節AR_月相影片_${new Date().toISOString().replace(/[:]/g,"-").split(".")[0]}.${W}`,Te=this.storeRecordingBlob(pe,Se);h({png:e,video:Te,duration:8,format:W,saved:!0})},p.onerror=O=>{console.error("錄製錯誤:",O.error),E(O.error)},p.start(),this.recordFrames(d,r,u,160,20,i,s,c)},u.onerror=()=>E(new Error("靜止人物圖片載入失敗")),u.src=e})}getRecorderOptions(){return this.outputFormat==="mp4"?MediaRecorder.isTypeSupported("video/mp4; codecs=h264")?{mimeType:"video/mp4; codecs=h264",videoBitsPerSecond:3e6}:MediaRecorder.isTypeSupported("video/mp4")?{mimeType:"video/mp4",videoBitsPerSecond:3e6}:(console.warn("瀏覽器不支援 MP4，降級到 WebM"),this.outputFormat="webm",{mimeType:"video/webm; codecs=vp8",videoBitsPerSecond:3e6}):{mimeType:"video/webm; codecs=vp8",videoBitsPerSecond:3e6}}recordFrames(e,t,o,i,s,c,r,d){let l=0;const m=()=>{e.clearRect(0,0,t.width,t.height),r.renderBackgroundTo(e,t.width,t.height,null,d,null);const u=o.naturalWidth||o.width,h=o.naturalHeight||o.height;if(u>0&&h>0){const E=Math.max(t.width/u,t.height/h),f=Math.round(u*E),g=Math.round(h*E),M=Math.round((t.width-f)/2),_=Math.round((t.height-g)/2);e.drawImage(o,0,0,u,h,M,_,f,g)}if(l++,this.progressCallback){const E=l/s;this.progressCallback.updateProgress(E,8)}l<i?setTimeout(m,1e3/s):(this.progressCallback&&this.progressCallback.setStatus("錄製完成，正在生成檔案..."),console.log("所有幀錄製完成"))};m()}}const N=new De;function He(n,e){return N.storeRecordingBlob(n,e)}function Be(){return N.hasRecordingAvailable()}function be(){return N.getLastRecordingUrl()}function xe(){return N.clearLastRecording()}function We(){return N.getLastRecordingFilename()}async function Ke(n,e){return N.uploadBlobToServerAndGetUrl(n,e)}async function Ye(){return N.shareLastRecording()}const x=new Re,J=new _e,H=new Ne;let B=!1,ce=!1,I,b,k,A,ue,Q,ae,q,L,R,j=!1,D=n=>{},re=n=>{},te=0,C=null,w={w:0,h:0},U=null;const P=document.createElement("canvas"),le=P.getContext("2d");P.style.display="none";const Z=document.createElement("canvas"),y=Z.getContext("2d");Z.style.display="none";const V=document.createElement("canvas"),Fe=V.getContext("2d"),X=document.createElement("canvas"),Y=X.getContext("2d"),$=document.createElement("canvas"),z=$.getContext("2d");let de=-1;function ze(n,e={}){I=n.videoEl,b=n.bgCanvas,k=n.maskCanvas,A=n.outCanvas,ue=n.bgVideoEl||null,Q=n.bgMoonVideoEl||null,ae=n.iosMoonVideoEl||null,j=n.isIOSDevice||!1,console.log("📱 SegmentationCore 設備資訊:",{isIOSDevice:j,hasIOSMoonVideo:!!ae,hasNormalMoonVideo:!!Q}),q=b.getContext("2d"),L=k.getContext("2d"),R=A.getContext("2d"),typeof e.onStatus=="function"&&(D=e.onStatus),typeof e.onStats=="function"&&(re=e.onStats),J.setVideoElement(I),H.setIOSDevice(j),N.setProgressCallback(e.onProgress),ee(),window.addEventListener("resize",Le)}async function je(){await J.switchCamera(),ee()}function ee(){var u;const n=A.closest(".stage")||A.parentElement,e=()=>{const h=window.visualViewport;return{w:Math.round((h==null?void 0:h.width)||window.innerWidth||document.documentElement.clientWidth||360),h:Math.round((h==null?void 0:h.height)||window.innerHeight||document.documentElement.clientHeight||640)}};let t,o;if((u=a.DISPLAY)!=null&&u.FULLBLEED){const{w:h,h:E}=e();t=h,o=E,n&&n.style&&(n.style.position="fixed",n.style.top="0",n.style.left="0",n.style.right="0",n.style.bottom="0",n.style.width="100dvw",n.style.height="100dvh",n.style.margin="0",n.style.padding="0",n.style.overflow="hidden")}else{const h=n.getBoundingClientRect();t=Math.max(320,Math.round(h.width)),o=Math.max(240,Math.round(h.height))}const i=Math.max(1,Math.min(window.devicePixelRatio||1,3)),s=window.innerWidth>768?1920:1280,c=window.innerHeight>1024?1080:1280,r=Math.min(i,s/t,c/o),d=Math.round(t*r),l=Math.round(o*r),m=h=>{(h.width!==d||h.height!==l)&&(h.width=d,h.height=l),h.style.width=`${t}px`,h.style.height=`${o}px`};[b,k,A,P,Z].forEach(m),w={w:A.width,h:A.height}}function ye(n,e){H.setIOSDevice(j),H.renderBackgroundTo(q,n,e,ue,Q,ae)}function Ge(n,e,t){const o=e*t;if(!C||w.w!==e||w.h!==t)return C=new Float32Array(o),C.set(n),w={w:e,h:t},C;const i=a.SMOOTHING.TEMPORAL_ALPHA;for(let s=0;s<o;s++)C[s]=i*C[s]+(1-i)*n[s];return C}function ve(n,e,t){const o=a.SMOOTHING.THRESHOLD,i=e*t,s=new ImageData(e,t);for(let l=0,m=0;l<i;l++,m+=4){const u=n[l],h=u>=o?Math.min(255,Math.round(u*255)):0;s.data[m]=0,s.data[m+1]=0,s.data[m+2]=0,s.data[m+3]=h}V.width=e,V.height=t,Fe.putImageData(s,0,0);const c=A.width,r=A.height;X.width=c,X.height=r,Y.clearRect(0,0,c,r),Y.imageSmoothingEnabled=!0,Y.imageSmoothingQuality="high",Y.drawImage(V,0,0,c,r);const d=a.SMOOTHING.EDGE_FEATHER_PX;return $.width=c,$.height=r,z.clearRect(0,0,c,r),z.filter=d>0?`blur(${d}px)`:"none",z.drawImage(X,0,0),z.filter="none",$}function he(n){const e=A.width;A.height,R.save(),R.translate(e,0),R.scale(-1,1);const t=n;R.restore(),n.length>0&&console.log("🔍 偵測到",n.length,"個人臉，符合條件的:",t.length);const o=t.length>=a.FACE_DETECTION_SETTINGS.REQUIRED_FACES;o!==ce&&(o?typeof D=="function"&&D("TRIGGER_TEST_EFFECT"):typeof D=="function"&&D("STOP_TEST_EFFECT"),ce=o),re({faceCount:n.length,facesInArea:t.length,moonActive:t.length>=a.FACE_DETECTION_SETTINGS.REQUIRED_FACES})}async function me(){var u,h,E;if(!B)return;const n=performance.now(),e=A.width,t=A.height;R.clearRect(0,0,e,t),ye(e,t),le.clearRect(0,0,e,t);const o=I.videoWidth||1,i=I.videoHeight||1,s=Math.max(e/o,t/i),c=Math.round(o*s),r=Math.round(i*s),d=Math.round((e-c)/2),l=Math.round((t-r)/2);try{le.drawImage(I,0,0,o,i,d,l,c,r)}catch{}if(a.SEGMENTATION.ENABLED){if(I.currentTime!==de){de=I.currentTime;const f=await x.segmentImage(P,n);if(f){let g=null,M=0,_=0;if(f.confidenceMasks&&f.confidenceMasks.length){const S=te<f.confidenceMasks.length?te:0,p=f.confidenceMasks[S];if(p!=null&&p.getAsFloat32Array){const T=p.getAsFloat32Array();g=new Float32Array(T.length),g.set(T),M=p.width,_=p.height}for(const T of f.confidenceMasks)try{(u=T==null?void 0:T.close)==null||u.call(T)}catch{}}else if((h=f.categoryMask)!=null&&h.getAsUint8Array){const S=f.categoryMask,p=S.getAsUint8Array();g=new Float32Array(p.length),M=S.width,_=S.height;const T=te;for(let O=0;O<p.length;O++)g[O]=p[O]===T?1:0;try{(E=S.close)==null||E.call(S)}catch{}}if(g&&M&&_){const S=Ge(g,M,_);U=ve(S,M,_)}}}}else U=null;y.clearRect(0,0,e,t),y.save(),y.drawImage(P,0,0,e,t),U&&(y.globalCompositeOperation="destination-in",y.drawImage(U,0,0,e,t),y.globalCompositeOperation="source-over"),y.restore(),R.save(),R.translate(e,0),R.scale(-1,1),R.drawImage(Z,0,0,e,t),R.restore(),L.clearRect(0,0,e,t),U&&ge?(L.globalAlpha=.9,L.drawImage(U,0,0,e,t),L.globalAlpha=1,k.style.display="block"):k.style.display="none";const m=x.detectFaces(P,n);he(m?m.detections||[]:[]),requestAnimationFrame(me)}async function Ve(){if(B)return;if(!Ce()){D("配置錯誤，請檢查控制台");return}D("初始化..."),ee(),await x.init(A),await J.startCamera(),B=!0,D("檢測中"),requestAnimationFrame(me)}function Xe(){B=!1,J.stopCamera(),R&&L&&q&&(R.clearRect(0,0,A.width,A.height),L.clearRect(0,0,k.width,k.height),q.clearRect(0,0,b.width,b.height)),re({faceCount:0,facesInArea:0,moonActive:!1}),D("已停止")}function Le(){B&&ee()}let ge=!1;function $e(n){ge=!!n}function Ee(n){a.SEGMENTATION.ENABLED=!!n}function fe(n){a.BACKGROUND.TYPE=n}function Qe(n){a.BACKGROUND.INTENSITY=Math.max(0,Math.min(1,n))}function qe(n){a.SMOOTHING.EDGE_FEATHER_PX=Math.max(0,Number(n)||0)}function Je(n){a.SMOOTHING.TEMPORAL_ALPHA=Math.max(0,Math.min(.95,Number(n)||0))}function Ze(n){a.SMOOTHING.THRESHOLD=Math.max(0,Math.min(1,Number(n)||0))}function et(n){a.BACKGROUND.GIF_BLEND_MODE=n}function tt(n){}function nt(){return B}function ot(n){N.setProgressCallback(n)}function at(n){N.setOutputFormat(n)}async function rt(){return N.capturePhoto(A,b,a,H,Q)}async function it(){if(!I||!I.videoWidth||!I.videoHeight)return console.error("Video element not ready for capture"),null;const n=document.createElement("canvas");return n.width=I.videoWidth,n.height=I.videoHeight,n.getContext("2d").drawImage(I,0,0),n.toDataURL("image/png")}async function st(n,e,t){if(!n||!e){console.error("Missing canvas or image data for preview");return}try{const o=new Image;o.src=e,await new Promise((d,l)=>{o.onload=d,o.onerror=l});const i=new Image;i.src=t,await new Promise((d,l)=>{i.onload=d,i.onerror=l}),n.width=o.width,n.height=o.height;const s=n.getContext("2d");if(!C||!x.isInitialized()){s.drawImage(i,0,0,n.width,n.height),s.globalAlpha=.8,s.drawImage(o,0,0),s.globalAlpha=1;return}s.drawImage(i,0,0,n.width,n.height);const c=document.createElement("canvas");c.width=n.width,c.height=n.height;const r=c.getContext("2d");if(C&&w.w>0&&w.h>0){const d=r.createImageData(w.w,w.h);for(let l=0;l<C.length;l++){const m=Math.floor(C[l]*255),u=l*4;d.data[u]=m,d.data[u+1]=m,d.data[u+2]=m,d.data[u+3]=255}r.putImageData(d,0,0),s.globalCompositeOperation="destination-in",s.drawImage(c,0,0,n.width,n.height),s.globalCompositeOperation="source-over",s.drawImage(o,0,0),s.globalCompositeOperation="source-over"}}catch(o){console.error("Preview generation failed:",o);const i=n.getContext("2d"),s=new Image;s.src=e,s.onload=()=>{n.width=s.width,n.height=s.height,i.drawImage(s,0,0)}}}async function ct(n,e){if(!n||!e){console.error("Missing canvas or original image for person mask generation");return}try{const t=n.getContext("2d");if(!x.isInitialized()||!C||!w.w||!w.h){console.warn("MediaPipe not initialized or no mask available, showing original image"),t.save(),t.scale(-1,1),t.translate(-n.width,0),t.drawImage(e,0,0,n.width,n.height),t.restore();return}const o=document.createElement("canvas");o.width=n.width,o.height=n.height;const i=o.getContext("2d");i.save(),i.scale(-1,1),i.translate(-o.width,0),i.drawImage(e,0,0,o.width,o.height),i.restore();const s=document.createElement("canvas");s.width=w.w,s.height=w.h;const c=s.getContext("2d"),r=c.createImageData(w.w,w.h),d=a.SMOOTHING.THRESHOLD||.5;for(let u=0;u<C.length;u++){const h=C[u],E=h>=d?Math.min(255,Math.round(h*255)):0,f=u*4;r.data[f]=255,r.data[f+1]=255,r.data[f+2]=255,r.data[f+3]=E}c.putImageData(r,0,0);const l=document.createElement("canvas");l.width=n.width,l.height=n.height,l.getContext("2d").drawImage(s,0,0,n.width,n.height),t.clearRect(0,0,n.width,n.height),t.drawImage(o,0,0),t.globalCompositeOperation="destination-in",t.drawImage(l,0,0),t.globalCompositeOperation="source-over"}catch(t){console.error("Person mask generation failed:",t);const o=n.getContext("2d");o.clearRect(0,0,n.width,n.height),o.save(),o.scale(-1,1),o.translate(-n.width,0),o.drawImage(e,0,0,n.width,n.height),o.restore()}}let ie=!1;function lt(n,e){ie=!0,Ee(!0),fe("custom_bg"),e&&H.setCustomBackground(e)}function dt(){ie=!1,Ee(!1),fe("custom_moon_bg")}function ht(n){ie&&H.setCustomBackground(n)}export{a as CONFIG,it as captureOriginalFrame,rt as capturePhoto,xe as clearLastRecording,lt as enterPreviewMode,dt as exitPreviewMode,ct as generatePersonMask,st as generatePreviewWithBackground,We as getLastRecordingFilename,be as getLastRecordingUrl,Be as hasRecordingAvailable,ze as initCore,Ce as initializeConfig,nt as isRunning,Le as onResize,Pe as resetConfig,Ue as saveConfig,Qe as setBackgroundIntensity,fe as setBackgroundType,qe as setEdgeFeather,Ee as setEnableSegmentation,et as setGifBlendMode,ot as setRecordingProgressCallback,tt as setShouldGenerateGif,$e as setShowMaskPreview,Je as setTemporalAlpha,Ze as setThreshold,at as setVideoOutputFormat,Ye as shareLastRecording,Ve as start,Xe as stop,He as storeRecordingBlob,je as switchCamera,ht as switchPreviewBackground,ee as syncCanvasSize,Ke as uploadBlobToServerAndGetUrl};
//# sourceMappingURL=segmentationCore-tzuSt-AR.js.map
