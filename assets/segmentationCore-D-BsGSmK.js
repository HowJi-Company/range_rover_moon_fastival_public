const t={FACE_DETECTION:{MODEL:"short",MIN_DETECTION_CONFIDENCE:.5,MAX_FACES:10},SEGMENTATION:{ENABLED:!0,MODEL_SELECTION:1,SELFIE_MODE:!0,SEGMENTATION_THRESHOLD:.1},FACE_DETECTION_SETTINGS:{REQUIRED_FACES:1},CAMERA:{DEFAULT_WIDTH:640,DEFAULT_HEIGHT:480,DEFAULT_FACING_MODE:"user",FRAME_RATE:30},UI:{STATUS_UPDATE_INTERVAL:100,SHOW_DEBUG_INFO:!0,SHOW_FPS:!1,LANGUAGE:"zh-TW"},EFFECTS:{MOON_EFFECT_DURATION:3e3,FADE_DURATION:800,ENABLE_SOUND:!1,MOON_SIZE_SCALE:1,STAR_COUNT:5,SPARKLE_COUNT:3},BACKGROUND_EFFECTS:{DEFAULT_BACKGROUND:"moon_video",WAVE_EFFECT:{AMPLITUDE:10,FREQUENCY:.02,SPEED:.05},FREQUENCY_EFFECT:{BANDS:32,HEIGHT_SCALE:.8,COLOR_SHIFT:.01},EFFECT_INTENSITY:.5,BLEND_MODE:"source-over"},PERFORMANCE:{ENABLE_MONITORING:!1,MAX_LATENCY:100,LOW_PERFORMANCE_MODE:!1,AUTO_ADJUST_PERFORMANCE:!0},DEBUG:{VERBOSE_LOGGING:!1,SHOW_FACE_LANDMARKS:!1,SAVE_DETECTION_RESULTS:!1},ADVANCED:{MEDIAPIPE_BASE_URL:"https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/",MEDIAPIPE_SEGMENTATION_URL:"https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/",USE_WEB_WORKERS:!1,MEMORY_LIMIT:512,ENABLE_ERROR_REPORTING:!0}};t.BACKGROUND=t.BACKGROUND||{TYPE:t.BACKGROUND_EFFECTS&&t.BACKGROUND_EFFECTS.DEFAULT_BACKGROUND||"original",INTENSITY:(t.BACKGROUND_EFFECTS&&t.BACKGROUND_EFFECTS.EFFECT_INTENSITY)??.5,GIF_BLEND_MODE:"overlay"};let B=null,Ee=null,K=null;function Me(){try{K&&(URL.revokeObjectURL(K),K=null)}catch(e){console.warn("revoke failed",e)}}function Re(e,o){if(!e)return null;Me(),B=e,Ee=o||`moonAR_${Date.now()}.webm`;try{K=URL.createObjectURL(e)}catch(n){console.warn("createObjectURL failed",n),K=null}return K}function Ke(){return!!B}function xe(){return K||null}function Ve(){Me(),B=null,Ee=null}function Ye(){return Ee}async function Ie(e,o){const n=new FormData;n.append("file",e,o);const a=await fetch("/api/upload",{method:"POST",body:n});if(!a.ok)throw new Error("upload failed");const s=await a.json();if(!(s!=null&&s.url))throw new Error("upload response missing url");return s.url}async function $e(){if(!B)throw new Error("no recording available");const e=Ee||`moonAR_${Date.now()}.mp4`,o=new File([B],e,{type:B.type||"video/mp4"});try{if(navigator.canShare&&navigator.canShare({files:[o]}))return await navigator.share({files:[o],title:"月亮節 AR 影片",text:"分享給你"}),{ok:!0,method:"webshare"}}catch(n){console.warn("Web Share file error:",n)}try{const n=await Ie(B,e);if(navigator.share)try{return await navigator.share({title:"月亮節 AR 影片",text:"看這個影片：",url:n}),{ok:!0,method:"url-share",url:n}}catch(a){console.warn("Web Share URL error:",a)}return{ok:!0,method:"uploaded",url:n}}catch(n){throw console.warn("upload failed:",n),n}}let X=null,Z=null,$=null,x=!1,z=null,le=t.CAMERA.DEFAULT_FACING_MODE||"user",fe=!1,S,Q,V,f,L,c,de,k,I,p=null,F=e=>{},ee=e=>{},ue=0,b=null,re={w:0,h:0},j=null;const W=document.createElement("canvas"),Ae=W.getContext("2d");W.style.display="none";const he=document.createElement("canvas"),P=he.getContext("2d");he.style.display="none";const ie=document.createElement("canvas"),we=ie.getContext("2d"),se=document.createElement("canvas"),oe=se.getContext("2d"),ce=document.createElement("canvas"),ne=ce.getContext("2d");let ae=0,Te=-1;function De(){const e=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),o=(navigator.hardwareConcurrency||4)<=2;e&&(t.CAMERA.DEFAULT_WIDTH=480,t.CAMERA.DEFAULT_HEIGHT=360,t.FACE_DETECTION.MODEL="short",t.EFFECTS.STAR_COUNT=3,t.EFFECTS.SPARKLE_COUNT=2),o&&(t.PERFORMANCE.LOW_PERFORMANCE_MODE=!0,t.FACE_DETECTION.MIN_DETECTION_CONFIDENCE=.6,t.CAMERA.FRAME_RATE=20,t.EFFECTS.MOON_SIZE_SCALE=.8)}function Fe(){var o;const e=[];return(t.FACE_DETECTION.MIN_DETECTION_CONFIDENCE<0||t.FACE_DETECTION.MIN_DETECTION_CONFIDENCE>1)&&e.push("MIN_DETECTION_CONFIDENCE 必須在 0~1 之間"),(o=navigator.mediaDevices)!=null&&o.getUserMedia||e.push("瀏覽器不支援相機功能"),e}function je(){try{localStorage.setItem("moonFestivalAR_config",JSON.stringify(t))}catch{}}function Xe(){try{localStorage.removeItem("moonFestivalAR_config")}catch{}location.reload()}function ve(){try{const e=localStorage.getItem("moonFestivalAR_config");e&&Object.assign(t,JSON.parse(e))}catch{}}function ye(){var o;ve(),De(),t.CAMERA.WIDTH=t.CAMERA.DEFAULT_WIDTH||t.CAMERA.WIDTH||1280,t.CAMERA.HEIGHT=t.CAMERA.DEFAULT_HEIGHT||t.CAMERA.HEIGHT||720,t.CAMERA.FACING=t.CAMERA.DEFAULT_FACING_MODE||t.CAMERA.FACING||"user",t.SEGMENTER=t.SEGMENTER||{},t.SEGMENTER.USE_LANDSCAPE_MODEL=t.SEGMENTATION&&t.SEGMENTATION.MODEL_SELECTION===1?!0:t.SEGMENTER.USE_LANDSCAPE_MODEL??!0,t.SEGMENTER.USE_GPU=t.SEGMENTER.USE_GPU??!0,t.SMOOTHING=t.SMOOTHING||{},t.SMOOTHING.THRESHOLD=t.SMOOTHING.THRESHOLD??((o=t.SEGMENTATION)==null?void 0:o.SEGMENTATION_THRESHOLD)??.38,t.SMOOTHING.TEMPORAL_ALPHA=t.SMOOTHING.TEMPORAL_ALPHA??.6,t.SMOOTHING.EDGE_FEATHER_PX=t.SMOOTHING.EDGE_FEATHER_PX??3,t.SMOOTHING.HYS_ON=t.SMOOTHING.HYS_ON??t.SMOOTHING.THRESHOLD-.15,t.SMOOTHING.HYS_OFF=t.SMOOTHING.HYS_OFF??t.SMOOTHING.THRESHOLD+.15,t.SMOOTHING.MASK_GROW_PX=t.SMOOTHING.MASK_GROW_PX??1.5,t.MODELS||(t.MODELS={SELFIE_SEGMENTER_LANDSCAPE:"https://storage.googleapis.com/mediapipe-models/image_segmenter/selfie_segmenter_landscape/float16/latest/selfie_segmenter_landscape.tflite",SELFIE_SEGMENTER_SQUARE:"https://storage.googleapis.com/mediapipe-models/image_segmenter/selfie_segmenter/float16/latest/selfie_segmenter.tflite",FACE_DETECTOR:"https://storage.googleapis.com/mediapipe-models/face_detector/blaze_face_short_range/float16/latest/blaze_face_short_range.tflite"}),t.WASM_BASE=t.WASM_BASE||"https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.7/wasm";const e=Fe();return e.length?(console.error("配置驗證失敗：",e),!1):!0}function ze(e,o={}){S=e.videoEl,Q=e.bgCanvas,V=e.maskCanvas,f=e.outCanvas,L=e.bgVideoEl||null,e.bgGifEl,c=e.bgMoonVideoEl||null,de=Q.getContext("2d"),k=V.getContext("2d"),I=f.getContext("2d"),typeof o.onStatus=="function"&&(F=o.onStatus),typeof o.onStats=="function"&&(ee=o.onStats),le=t.CAMERA.FACING||"user",Ge()}function Ge(){const e=new Image;e.onload=()=>{p=e,console.log("✅ 自定義背景圖片載入完成")},e.onerror=n=>{console.warn("⚠️ 自定義背景圖片載入失敗:",n)};const o="/range_rover_moon_fastival_public/";e.src=o+"pexels-photo-623218.jpeg"}async function Ue(){if(window.FilesetResolver&&window.ImageSegmenter)return!0;const e=["https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.7/vision_bundle.mjs","https://unpkg.com/@mediapipe/tasks-vision@0.10.7/vision_bundle.mjs"];for(const o of e)try{const n=await import(o);return n.FilesetResolver&&(window.FilesetResolver=n.FilesetResolver),n.ImageSegmenter&&(window.ImageSegmenter=n.ImageSegmenter),n.FaceDetector&&(window.FaceDetector=n.FaceDetector),!0}catch(n){console.warn("[WARN] failed to import tasks-vision from",o,n)}throw new Error("無法載入 @mediapipe/tasks-vision 模組")}async function Le(){$||($=await FilesetResolver.forVisionTasks(t.WASM_BASE));try{const o=f.getBoundingClientRect();t.SEGMENTER.USE_LANDSCAPE_MODEL=(o.width||1)>=(o.height||1)}catch{}const e={modelAssetPath:t.SEGMENTER.USE_LANDSCAPE_MODEL?t.MODELS.SELFIE_SEGMENTER_LANDSCAPE:t.MODELS.SELFIE_SEGMENTER_SQUARE,delegate:t.SEGMENTER.USE_GPU?"GPU":"CPU"};try{X=await ImageSegmenter.createFromOptions($,{baseOptions:e,runningMode:"VIDEO",outputCategoryMask:!1,outputConfidenceMasks:!0})}catch(o){console.warn("[Segmenter] GPU 失敗，改用 CPU:",o),X=await ImageSegmenter.createFromOptions($,{baseOptions:{...e,delegate:"CPU"},runningMode:"VIDEO",outputCategoryMask:!1,outputConfidenceMasks:!0})}try{Z=await FaceDetector.createFromOptions($,{baseOptions:{modelAssetPath:t.MODELS.FACE_DETECTOR,delegate:"GPU"},runningMode:"VIDEO",minDetectionConfidence:.6,minSuppressionThreshold:.3})}catch(o){console.warn("[FaceDetector] GPU 失敗，改用 CPU:",o),Z=await FaceDetector.createFromOptions($,{baseOptions:{modelAssetPath:t.MODELS.FACE_DETECTOR,delegate:"CPU"},runningMode:"VIDEO",minDetectionConfidence:.6,minSuppressionThreshold:.3})}}async function Se(){if(z)try{z.getTracks().forEach(o=>o.stop())}catch{}const e={audio:!1,video:{facingMode:le,width:{ideal:t.CAMERA.WIDTH},height:{ideal:t.CAMERA.HEIGHT},frameRate:{ideal:t.CAMERA.FRAME_RATE}}};z=await navigator.mediaDevices.getUserMedia(e),S.srcObject=z,S.setAttribute("playsinline",""),S.muted=!0,S.autoplay=!0,await new Promise(o=>{if(S.readyState>=1&&S.videoWidth&&S.videoHeight)return o();S.onloadedmetadata=()=>o(),setTimeout(o,1500)});try{await S.play()}catch{}pe()}async function Qe(){le=le==="user"?"environment":"user",await Se()}function pe(){const o=(f.closest(".stage")||f.parentElement).getBoundingClientRect(),n=Math.max(1,Math.round(o.width)),a=Math.max(1,Math.round(o.height));[Q,V,f,W,he].forEach(s=>{(s.width!==n||s.height!==a)&&(s.width=n,s.height=a),s.style.width=`${n}px`,s.style.height=`${a}px`}),re={w:f.width,h:f.height}}function He(e,o,n){const a=t.BACKGROUND&&t.BACKGROUND.TYPE||t.BACKGROUND_EFFECTS&&t.BACKGROUND_EFFECTS.DEFAULT_BACKGROUND||"original",s=t.BACKGROUND&&typeof t.BACKGROUND.INTENSITY=="number"?t.BACKGROUND.INTENSITY:(t.BACKGROUND_EFFECTS&&t.BACKGROUND_EFFECTS.EFFECT_INTENSITY)??.5;if(e.clearRect(0,0,o,n),ae+=.016,a!=="original"){if(a==="waves"){const r=e.createLinearGradient(0,0,o,n);r.addColorStop(0,"#1a2332"),r.addColorStop(.5,"#2d3a50"),r.addColorStop(1,"#0f1419"),e.fillStyle=r,e.fillRect(0,0,o,n),e.strokeStyle=`rgba(100,200,255,${s*.6})`,e.lineWidth=2;for(let l=0;l<8;l++){e.beginPath();for(let i=0;i<o;i+=5){const h=l*50,E=n/2+Math.sin((i+h)*.012+ae*1.2)*20*s;i===0?e.moveTo(i,E):e.lineTo(i,E)}e.stroke()}return}if(a==="frequency"){e.fillStyle="#0a0a0a",e.fillRect(0,0,o,n);const r=48,l=o/r;for(let i=0;i<r;i++){const h=i*l,E=(Math.sin(ae*2+i*.2)*.5+.5)*n*.5*s,d=(ae*30+i*10)%360;e.fillStyle=`hsla(${d},70%,60%,0.8)`,e.fillRect(h,n-E,l-1,E)}return}if(a==="video"&&L){const r=L.videoWidth||1,l=L.videoHeight||1;if(L.readyState>=2){const i=Math.max(o/r,n/l),h=Math.round(r*i),E=Math.round(l*i),d=Math.round((o-h)/2),g=Math.round((n-E)/2);try{L.paused&&L.play().catch(()=>{})}catch{}e.globalAlpha=Math.min(1,.3+s*.7),e.drawImage(L,0,0,r,l,d,g,h,E),e.globalAlpha=1}return}if(a==="moon_video"&&c){try{if(c.readyState>=2&&!c.paused){const r=c.videoWidth||c.width||1,l=c.videoHeight||c.height||1;if(r>1&&l>1){const i=Math.max(o/r,n/l),h=Math.round(r*i),E=Math.round(l*i),d=Math.round((o-h)/2),g=Math.round((n-E)/2);e.globalAlpha=Math.min(1,.3+s*.7),e.drawImage(c,0,0,r,l,d,g,h,E),e.globalAlpha=1}else console.warn("🌙 Moon video dimensions too small:",{vw:r,vh:l})}else c.paused?c.play().catch(r=>console.warn("月相影片播放失敗:",r)):console.warn("🌙 Moon video not ready:",{readyState:c.readyState,paused:c.paused})}catch(r){console.warn("月相影片渲染錯誤:",r)}return}if(a==="custom_moon_bg"&&p&&c){try{if(p){const r=p.naturalWidth||p.width,l=p.naturalHeight||p.height;if(r>0&&l>0){const i=Math.max(o/r,n/l),h=Math.round(r*i),E=Math.round(l*i),d=Math.round((o-h)/2),g=Math.round((n-E)/2);e.drawImage(p,0,0,r,l,d,g,h,E)}}if(c.readyState>=2&&!c.paused){const r=c.videoWidth||c.width||1,l=c.videoHeight||c.height||1;if(r>1&&l>1){e.save();const i=o/n;let h,E,d;i>.6?(h=o*.5,E=n*.35,d=Math.min(o,n)*.25):i>.5?(h=o*.51,E=n*.29,d=Math.min(o,n)*.29):(h=o*.51,E=n*.26,d=Math.min(o,n)*.3),e.beginPath(),e.arc(h,E,d,0,2*Math.PI),e.clip();const g=Math.max(o/r,n/l),w=Math.round(r*g),u=Math.round(l*g),T=Math.round((o-w)/2),C=Math.round((n-u)/2);e.globalAlpha=Math.min(1,.8+s*.2),e.drawImage(c,0,0,r,l,T,C,w,u),e.globalAlpha=1,e.restore()}}else c.paused&&c.play().catch(r=>console.warn("月相影片播放失敗:",r))}catch(r){console.warn("自定義背景 + 圓形月亮渲染錯誤:",r)}return}}}function be(e,o){He(de,e,o)}function Pe(e,o,n){const a=o*n;if(!b||re.w!==o||re.h!==n)return b=new Float32Array(a),b.set(e),re={w:o,h:n},b;const s=t.SMOOTHING.TEMPORAL_ALPHA;for(let r=0;r<a;r++)b[r]=s*b[r]+(1-s)*e[r];return b}function Be(e,o,n){const a=t.SMOOTHING.THRESHOLD,s=o*n,r=new ImageData(o,n);for(let E=0,d=0;E<s;E++,d+=4){const g=e[E],w=g>=a?Math.min(255,Math.round(g*255)):0;r.data[d]=0,r.data[d+1]=0,r.data[d+2]=0,r.data[d+3]=w}ie.width=o,ie.height=n,we.putImageData(r,0,0);const l=f.width,i=f.height;se.width=l,se.height=i,oe.clearRect(0,0,l,i),oe.imageSmoothingEnabled=!0,oe.imageSmoothingQuality="high",oe.drawImage(ie,0,0,l,i);const h=t.SMOOTHING.EDGE_FEATHER_PX;return ce.width=l,ce.height=i,ne.clearRect(0,0,l,i),ne.filter=h>0?`blur(${h}px)`:"none",ne.drawImage(se,0,0),ne.filter="none",ce}function ke(e){const o=f.width;f.height,I.save(),I.translate(o,0),I.scale(-1,1);const n=e;I.restore();const a=n.length>=t.FACE_DETECTION_SETTINGS.REQUIRED_FACES;a!==fe&&(a?typeof F=="function"&&F("TRIGGER_TEST_EFFECT"):typeof F=="function"&&F("STOP_TEST_EFFECT"),fe=a),ee({faceCount:e.length,facesInArea:n.length,moonActive:n.length>=t.FACE_DETECTION_SETTINGS.REQUIRED_FACES})}async function Oe(){var d,g,w;if(!x)return;const e=performance.now(),o=f.width,n=f.height;I.clearRect(0,0,o,n),be(o,n),Ae.clearRect(0,0,o,n);const a=S.videoWidth||1,s=S.videoHeight||1,r=Math.min(o/a,n/s),l=Math.round(a*r),i=Math.round(s*r),h=Math.round((o-l)/2),E=Math.round((n-i)/2);try{Ae.drawImage(S,0,0,a,s,h,E,l,i)}catch{}if(X&&t.SEGMENTATION.ENABLED){if(S.currentTime!==Te){Te=S.currentTime;try{const u=X.segmentForVideo?X.segmentForVideo(W,e):await X.segment(W);if(u){let T=null,C=0,G=0;if(u.confidenceMasks&&u.confidenceMasks.length){const O=ue<u.confidenceMasks.length?ue:0,_=u.confidenceMasks[O];if(_!=null&&_.getAsFloat32Array){const m=_.getAsFloat32Array();T=new Float32Array(m.length),T.set(m),C=_.width,G=_.height}for(const m of u.confidenceMasks)try{(d=m==null?void 0:m.close)==null||d.call(m)}catch{}}else if((g=u.categoryMask)!=null&&g.getAsUint8Array){const O=u.categoryMask,_=O.getAsUint8Array();T=new Float32Array(_.length),C=O.width,G=O.height;const m=ue;for(let v=0;v<_.length;v++)T[v]=_[v]===m?1:0;try{(w=O.close)==null||w.call(O)}catch{}}if(T&&C&&G){const O=Pe(T,C,G);j=Be(O,C,G)}}}catch(u){console.warn("segmentForVideo error:",u)}}}else j=null;if(P.clearRect(0,0,o,n),P.save(),P.drawImage(W,0,0,o,n),j&&(P.globalCompositeOperation="destination-in",P.drawImage(j,0,0,o,n),P.globalCompositeOperation="source-over"),P.restore(),I.save(),I.translate(o,0),I.scale(-1,1),I.drawImage(he,0,0,o,n),I.restore(),k.clearRect(0,0,o,n),j&&Ce?(k.globalAlpha=.9,k.drawImage(j,0,0,o,n),k.globalAlpha=1,V.style.display="block"):V.style.display="none",Z)try{const u=Z.detectForVideo?Z.detectForVideo(W,e):null;u&&ke(u.detections||[])}catch(u){console.warn("faceDetector error:",u)}requestAnimationFrame(Oe)}async function qe(){if(x)return;if(!ye()){F("配置錯誤，請檢查控制台");return}F("初始化..."),await Ue(),await Le(),await Se(),x=!0,F("檢測中"),requestAnimationFrame(Oe)}function Je(){x=!1;try{z&&z.getTracks().forEach(e=>e.stop())}catch{}I&&k&&de&&(I.clearRect(0,0,f.width,f.height),k.clearRect(0,0,V.width,V.height),de.clearRect(0,0,Q.width,Q.height)),ee({faceCount:0,facesInArea:0,moonActive:!1}),F("已停止")}function Ze(){x&&pe()}let Ce=!1;function et(e){Ce=!!e}function tt(e){t.SEGMENTATION.ENABLED=!!e}function ot(e){t.BACKGROUND.TYPE=e}function nt(e){t.BACKGROUND.INTENSITY=Math.max(0,Math.min(1,e))}function at(e){t.SMOOTHING.EDGE_FEATHER_PX=Math.max(0,Number(e)||0)}function rt(e){t.SMOOTHING.TEMPORAL_ALPHA=Math.max(0,Math.min(.95,Number(e)||0))}function it(e){t.SMOOTHING.THRESHOLD=Math.max(0,Math.min(1,Number(e)||0))}function st(e){t.BACKGROUND.GIF_BLEND_MODE=e}function ct(e){}function lt(){return x}async function dt(){if(!f||!x)return console.warn("無法拍照：相機未啟動或畫布不存在"),null;try{const e=document.createElement("canvas"),o=e.getContext("2d"),n=f.width,a=f.height;e.width=n,e.height=a;const s=t.BACKGROUND&&t.BACKGROUND.TYPE;if(console.log("📸 拍照檢查背景類型:",{bgType:s,hasMoonVideo:!!c}),(s==="moon_video"||s==="custom_moon_bg")&&c){console.log("🌙 月相影片模式：生成 8 秒動態影片..."),o.drawImage(f,0,0,n,a);const E=e.toDataURL("image/png",1);try{const d=await We(E,n,a);return console.log("✅ 影片生成完成:",d),d}catch(d){console.error("❌ 影片生成失敗:",d);const g=e.toDataURL("image/png",1),w=new Date().toISOString().replace(/[:]/g,"-").split(".")[0],u=document.createElement("a"),T=`月亮節AR拍照_${w}.png`;return u.download=T,u.href=g,document.body.appendChild(u),u.click(),document.body.removeChild(u),{png:g,error:"影片生成失敗，已保存為圖片"}}}else o.drawImage(Q,0,0,n,a),o.drawImage(f,0,0,n,a);const r=e.toDataURL("image/png",1),l=new Date().toISOString().replace(/[:]/g,"-").split(".")[0],i=document.createElement("a"),h=`月亮節AR拍照_${l}.png`;return i.download=h,i.href=r,document.body.appendChild(i),i.click(),document.body.removeChild(i),console.log("📸 PNG 拍照成功！"),{png:r}}catch(e){return console.error("拍照失敗：",e),null}}let H=null,J="mp4";function Et(e){H=e}function ht(e){J=e}async function We(e,o,n){console.log("🎬 開始錄製靜止人物 + 動態背景影片...");try{if(!window.MediaRecorder)return console.warn("瀏覽器不支援 MediaRecorder"),{png:e,error:"瀏覽器不支援影片錄製"};const a=document.createElement("canvas"),s=a.getContext("2d"),r=640,l=o/n;o>n?(a.width=Math.min(r,o),a.height=Math.round(a.width/l)):(a.height=Math.min(r,n),a.width=Math.round(a.height*l)),console.log(`錄製 Canvas 尺寸: ${a.width}x${a.height} (原始: ${o}x${n}, 比例: ${l.toFixed(2)})`);const i=new Image;return new Promise((h,E)=>{i.onload=async()=>{console.log("靜止人物圖片載入完成，開始錄製...");const d=8,g=20,w=d*g;c&&c.paused&&await c.play().catch(m=>console.warn("影片播放失敗:",m));const u=a.captureStream(g);let T;J==="mp4"?MediaRecorder.isTypeSupported("video/mp4; codecs=h264")?T={mimeType:"video/mp4; codecs=h264",videoBitsPerSecond:3e6}:MediaRecorder.isTypeSupported("video/mp4")?T={mimeType:"video/mp4",videoBitsPerSecond:3e6}:(console.warn("瀏覽器不支援 MP4，降級到 WebM"),T={mimeType:"video/webm; codecs=vp8",videoBitsPerSecond:3e6},J="webm"):T={mimeType:"video/webm; codecs=vp8",videoBitsPerSecond:3e6};const C=new MediaRecorder(u,T);console.log(`📹 使用格式: ${T.mimeType}`);const G=[];C.ondataavailable=m=>{m.data.size>0&&G.push(m.data)},C.onstop=()=>{const m=J==="mp4"?"video/mp4":"video/webm",v=J==="mp4"?"mp4":"webm",Y=new Blob(G,{type:m}),te=`月亮節AR_月相影片_${new Date().toISOString().replace(/[:]/g,"-").split(".")[0]}.${v}`,A=Re(Y,te);typeof F=="function"&&F("影片已生成，可按 分享 或 下載"),typeof ee=="function"&&ee({lastVideoUrl:A,lastVideoFilename:te}),h({png:e,video:A,duration:d,format:v,saved:!0})},C.onerror=m=>{console.error("錄製錯誤:",m.error),E(m.error)},C.start(),console.log(`開始錄製 ${d} 秒影片...`),H&&(H.setStatus("開始錄製..."),H.updateProgress(0,d));let O=0;function _(){s.clearRect(0,0,a.width,a.height);const m=t.BACKGROUND&&t.BACKGROUND.TYPE,v=t.BACKGROUND.INTENSITY||.5;if(m==="custom_moon_bg"&&p&&c){if(p){const A=p.naturalWidth||p.width,M=p.naturalHeight||p.height;if(A>0&&M>0){const D=Math.max(a.width/A,a.height/M),N=Math.round(A*D),R=Math.round(M*D),y=Math.round((a.width-N)/2),U=Math.round((a.height-R)/2);s.drawImage(p,0,0,A,M,y,U,N,R)}}if(c.readyState>=2){const A=c.videoWidth||c.width||1,M=c.videoHeight||c.height||1;if(A>1&&M>1){s.save();const D=a.width/a.height;let N,R,y;D>.6?(N=a.width*.5,R=a.height*.35,y=Math.min(a.width,a.height)*.25):D>.5?(N=a.width*.51,R=a.height*.29,y=Math.min(a.width,a.height)*.29):(N=a.width*.51,R=a.height*.26,y=Math.min(a.width,a.height)*.3),s.beginPath(),s.arc(N,R,y,0,2*Math.PI),s.clip();const U=Math.max(a.width/A,a.height/M),ge=Math.round(A*U),me=Math.round(M*U),_e=Math.round((a.width-ge)/2),Ne=Math.round((a.height-me)/2);s.globalAlpha=Math.min(1,.8+v*.2),s.drawImage(c,0,0,A,M,_e,Ne,ge,me),s.globalAlpha=1,s.restore()}}}else if(c&&c.readyState>=2){const A=c.videoWidth||c.width||1,M=c.videoHeight||c.height||1;if(A>1&&M>1){const D=Math.max(a.width/A,a.height/M),N=Math.round(A*D),R=Math.round(M*D),y=Math.round((a.width-N)/2),U=Math.round((a.height-R)/2);s.globalAlpha=Math.min(1,.3+v*.7),s.drawImage(c,0,0,A,M,y,U,N,R),s.globalAlpha=1}}const Y=i.naturalWidth||i.width,q=i.naturalHeight||i.height;if(Y>0&&q>0){const A=a.width/Y,M=a.height/q,D=Math.max(A,M),N=Math.round(Y*D),R=Math.round(q*D),y=Math.round((a.width-N)/2),U=Math.round((a.height-R)/2);s.drawImage(i,0,0,Y,q,y,U,N,R)}else s.drawImage(i,0,0,a.width,a.height);O++;const te=O/g;H&&H.updateProgress(te,d),O<w?setTimeout(_,1e3/g):(H&&H.setStatus("錄製完成，正在生成檔案..."),C.stop(),console.log("所有幀錄製完成"))}_()},i.onerror=()=>{E(new Error("靜止人物圖片載入失敗"))},i.src=e})}catch(a){return console.error("影片生成錯誤:",a),{png:e,error:a.message}}}export{t as CONFIG,dt as capturePhoto,Ve as clearLastRecording,Ye as getLastRecordingFilename,xe as getLastRecordingUrl,Ke as hasRecordingAvailable,ze as initCore,ye as initializeConfig,lt as isRunning,Ze as onResize,Xe as resetConfig,je as saveConfig,nt as setBackgroundIntensity,ot as setBackgroundType,at as setEdgeFeather,tt as setEnableSegmentation,st as setGifBlendMode,Et as setRecordingProgressCallback,ct as setShouldGenerateGif,et as setShowMaskPreview,rt as setTemporalAlpha,it as setThreshold,ht as setVideoOutputFormat,$e as shareLastRecording,qe as start,Je as stop,Re as storeRecordingBlob,Qe as switchCamera,pe as syncCanvasSize,Ie as uploadBlobToServerAndGetUrl};
//# sourceMappingURL=segmentationCore-D-BsGSmK.js.map
