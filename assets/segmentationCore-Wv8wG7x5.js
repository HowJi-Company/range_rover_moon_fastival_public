const a={FACE_DETECTION:{MODEL:"short",MIN_DETECTION_CONFIDENCE:.5,MAX_FACES:10},SEGMENTATION:{ENABLED:!0,MODEL_SELECTION:1,SELFIE_MODE:!0,SEGMENTATION_THRESHOLD:.1},FACE_DETECTION_SETTINGS:{REQUIRED_FACES:1},CAMERA:{WIDTH:1280,HEIGHT:720,DEFAULT_WIDTH:1280,DEFAULT_HEIGHT:720,DEFAULT_FACING_MODE:"user",FRAME_RATE:30},UI:{STATUS_UPDATE_INTERVAL:100,SHOW_DEBUG_INFO:!0,SHOW_FPS:!1,LANGUAGE:"zh-TW"},EFFECTS:{MOON_EFFECT_DURATION:3e3,FADE_DURATION:800,ENABLE_SOUND:!1,MOON_SIZE_SCALE:1,STAR_COUNT:5,SPARKLE_COUNT:3},BACKGROUND_EFFECTS:{DEFAULT_BACKGROUND:"moon_video",WAVE_EFFECT:{AMPLITUDE:10,FREQUENCY:.02,SPEED:.05},FREQUENCY_EFFECT:{BANDS:32,HEIGHT_SCALE:.8,COLOR_SHIFT:.01},EFFECT_INTENSITY:.5,BLEND_MODE:"source-over"},PERFORMANCE:{ENABLE_MONITORING:!1,MAX_LATENCY:100,LOW_PERFORMANCE_MODE:!1,AUTO_ADJUST_PERFORMANCE:!0},DEBUG:{VERBOSE_LOGGING:!1,SHOW_FACE_LANDMARKS:!1,SAVE_DETECTION_RESULTS:!1},ADVANCED:{MEDIAPIPE_BASE_URL:"https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/",MEDIAPIPE_SEGMENTATION_URL:"https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/",USE_WEB_WORKERS:!1,MEMORY_LIMIT:512,ENABLE_ERROR_REPORTING:!0}};a.BACKGROUND=a.BACKGROUND||{TYPE:a.BACKGROUND_EFFECTS&&a.BACKGROUND_EFFECTS.DEFAULT_BACKGROUND||"original",INTENSITY:(a.BACKGROUND_EFFECTS&&a.BACKGROUND_EFFECTS.EFFECT_INTENSITY)??.5,GIF_BLEND_MODE:"overlay"};function Ae(){const o=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),e=(navigator.hardwareConcurrency||4)<=2;o&&(a.CAMERA.DEFAULT_WIDTH=480,a.CAMERA.DEFAULT_HEIGHT=360,a.FACE_DETECTION.MODEL="short",a.EFFECTS.STAR_COUNT=3,a.EFFECTS.SPARKLE_COUNT=2),e&&(a.PERFORMANCE.LOW_PERFORMANCE_MODE=!0,a.FACE_DETECTION.MIN_DETECTION_CONFIDENCE=.6,a.CAMERA.FRAME_RATE=20,a.EFFECTS.MOON_SIZE_SCALE=.8)}function Me(){var e;const o=[];return(a.FACE_DETECTION.MIN_DETECTION_CONFIDENCE<0||a.FACE_DETECTION.MIN_DETECTION_CONFIDENCE>1)&&o.push("MIN_DETECTION_CONFIDENCE 必須在 0~1 之間"),(e=navigator.mediaDevices)!=null&&e.getUserMedia||o.push("瀏覽器不支援相機功能"),o}function Ue(){try{localStorage.setItem("moonFestivalAR_config",JSON.stringify(a))}catch{}}function Be(){try{localStorage.removeItem("moonFestivalAR_config")}catch{}location.reload()}function Oe(){try{const o=localStorage.getItem("moonFestivalAR_config");o&&Object.assign(a,JSON.parse(o))}catch{}}function Ce(){var e;Oe(),Ae(),a.CAMERA.WIDTH=a.CAMERA.DEFAULT_WIDTH||a.CAMERA.WIDTH||1280,a.CAMERA.HEIGHT=a.CAMERA.DEFAULT_HEIGHT||a.CAMERA.HEIGHT||720,a.CAMERA.FACING=a.CAMERA.DEFAULT_FACING_MODE||a.CAMERA.FACING||"user",a.SEGMENTER=a.SEGMENTER||{},a.SEGMENTER.USE_LANDSCAPE_MODEL=a.SEGMENTATION&&a.SEGMENTATION.MODEL_SELECTION===1?!0:a.SEGMENTER.USE_LANDSCAPE_MODEL??!0,a.SEGMENTER.USE_GPU=a.SEGMENTER.USE_GPU??!0,a.SMOOTHING=a.SMOOTHING||{},a.SMOOTHING.THRESHOLD=a.SMOOTHING.THRESHOLD??((e=a.SEGMENTATION)==null?void 0:e.SEGMENTATION_THRESHOLD)??.38,a.SMOOTHING.TEMPORAL_ALPHA=a.SMOOTHING.TEMPORAL_ALPHA??.6,a.SMOOTHING.EDGE_FEATHER_PX=a.SMOOTHING.EDGE_FEATHER_PX??3,a.SMOOTHING.HYS_ON=a.SMOOTHING.HYS_ON??a.SMOOTHING.THRESHOLD-.15,a.SMOOTHING.HYS_OFF=a.SMOOTHING.HYS_OFF??a.SMOOTHING.THRESHOLD+.15,a.SMOOTHING.MASK_GROW_PX=a.SMOOTHING.MASK_GROW_PX??1.5,a.MODELS||(a.MODELS={SELFIE_SEGMENTER_LANDSCAPE:"https://storage.googleapis.com/mediapipe-models/image_segmenter/selfie_segmenter_landscape/float16/latest/selfie_segmenter_landscape.tflite",SELFIE_SEGMENTER_SQUARE:"https://storage.googleapis.com/mediapipe-models/image_segmenter/selfie_segmenter/float16/latest/selfie_segmenter.tflite",FACE_DETECTOR:"https://storage.googleapis.com/mediapipe-models/face_detector/blaze_face_short_range/float16/latest/blaze_face_short_range.tflite"}),a.WASM_BASE=a.WASM_BASE||"https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.7/wasm";const o=Me();return o.length?(console.error("配置驗證失敗：",o),!1):!0}let oe=null,ne=null,k=null;async function we(){if(window.FilesetResolver&&window.ImageSegmenter)return!0;const o=["https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.7/vision_bundle.mjs","https://unpkg.com/@mediapipe/tasks-vision@0.10.7/vision_bundle.mjs"];for(const e of o)try{const t=await import(e);return t.FilesetResolver&&(window.FilesetResolver=t.FilesetResolver),t.ImageSegmenter&&(window.ImageSegmenter=t.ImageSegmenter),t.FaceDetector&&(window.FaceDetector=t.FaceDetector),!0}catch(t){console.warn("[WARN] failed to import tasks-vision from",e,t)}throw new Error("無法載入 @mediapipe/tasks-vision 模組")}async function Ie(o){k||(k=await FilesetResolver.forVisionTasks(a.WASM_BASE));try{const t=o.getBoundingClientRect();a.SEGMENTER.USE_LANDSCAPE_MODEL=(t.width||1)>=(t.height||1)}catch{}const e={modelAssetPath:a.SEGMENTER.USE_LANDSCAPE_MODEL?a.MODELS.SELFIE_SEGMENTER_LANDSCAPE:a.MODELS.SELFIE_SEGMENTER_SQUARE,delegate:a.SEGMENTER.USE_GPU?"GPU":"CPU"};try{oe=await ImageSegmenter.createFromOptions(k,{baseOptions:e,runningMode:"VIDEO",outputCategoryMask:!1,outputConfidenceMasks:!0})}catch(t){console.warn("[Segmenter] GPU 失敗，改用 CPU:",t),oe=await ImageSegmenter.createFromOptions(k,{baseOptions:{...e,delegate:"CPU"},runningMode:"VIDEO",outputCategoryMask:!1,outputConfidenceMasks:!0})}try{ne=await FaceDetector.createFromOptions(k,{baseOptions:{modelAssetPath:a.MODELS.FACE_DETECTOR,delegate:"GPU"},runningMode:"VIDEO",minDetectionConfidence:.6,minSuppressionThreshold:.3})}catch(t){console.warn("[FaceDetector] GPU 失敗，改用 CPU:",t),ne=await FaceDetector.createFromOptions(k,{baseOptions:{modelAssetPath:a.MODELS.FACE_DETECTOR,delegate:"CPU"},runningMode:"VIDEO",minDetectionConfidence:.6,minSuppressionThreshold:.3})}}class Re{constructor(){this.imageSegmenter=null,this.faceDetector=null,this.wasmFileset=null}async init(e){await we(),await Ie(e),this.imageSegmenter=oe,this.faceDetector=ne,this.wasmFileset=k}getImageSegmenter(){return this.imageSegmenter}getFaceDetector(){return this.faceDetector}isInitialized(){return this.imageSegmenter!==null&&this.faceDetector!==null}async segmentImage(e,t){if(!this.imageSegmenter)return null;try{return this.imageSegmenter.segmentForVideo?this.imageSegmenter.segmentForVideo(e,t):await this.imageSegmenter.segment(e)}catch(n){return console.warn("segmentForVideo error:",n),null}}detectFaces(e,t){if(!this.faceDetector)return console.warn("⚠️ faceDetector not initialized"),null;try{return this.faceDetector.detectForVideo?this.faceDetector.detectForVideo(e,t):this.faceDetector.detect(e)}catch(n){return console.warn("faceDetector error:",n),null}}}class _e{constructor(){this.stream=null,this.currentFacingMode=a.CAMERA.DEFAULT_FACING_MODE||"user",this.videoEl=null}setVideoElement(e){this.videoEl=e}async startCamera(){var l,u,m,h,E,M;if(this.stream)try{this.stream.getTracks().forEach(g=>g.stop())}catch{}const e=(l=this.videoEl)==null?void 0:l.closest(".stage"),t=(e==null?void 0:e.clientWidth)||window.innerWidth,n=(e==null?void 0:e.clientHeight)||window.innerHeight,i=Math.min(window.devicePixelRatio||1,3),s=Math.min(Math.round(t*i),1920),c=Math.min(Math.round(n*i),1080),r=s/Math.max(1,c),d={audio:!1,video:{facingMode:this.currentFacingMode,width:{ideal:s,min:640,max:2560},height:{ideal:c,min:480,max:1440},aspectRatio:{ideal:r},frameRate:{ideal:a.CAMERA.FRAME_RATE||30,max:60}}};this.stream=await navigator.mediaDevices.getUserMedia(d),this.videoEl.srcObject=this.stream,this.videoEl.setAttribute("playsinline",""),this.videoEl.muted=!0,this.videoEl.autoplay=!0,await new Promise(g=>{if(this.videoEl.readyState>=1&&this.videoEl.videoWidth&&this.videoEl.videoHeight)return g();this.videoEl.onloadedmetadata=()=>g(),setTimeout(g,1500)});try{const g=this.stream.getVideoTracks()[0],O=(u=g.getCapabilities)==null?void 0:u.call(g),_=(C,S,T)=>{if(S==null&&T==null)return C;const p=typeof S=="number"?S:C,D=typeof T=="number"?T:C;return Math.min(Math.max(C,p),D)};if(O){const C=_(s,(m=O.width)==null?void 0:m.min,(h=O.width)==null?void 0:h.max),S=_(c,(E=O.height)==null?void 0:E.min,(M=O.height)==null?void 0:M.max),T=s/Math.max(1,c);await g.applyConstraints({width:{ideal:C},height:{ideal:S},aspectRatio:{ideal:T},frameRate:{ideal:a.CAMERA.FRAME_RATE||30,max:60}})}}catch(g){console.warn("applyConstraints failed:",g)}try{await this.videoEl.play()}catch{}}stopCamera(){try{this.stream&&this.stream.getTracks().forEach(e=>e.stop())}catch{}this.stream=null}async switchCamera(){this.currentFacingMode=this.currentFacingMode==="user"?"environment":"user",await this.startCamera()}getCurrentFacingMode(){return this.currentFacingMode}getStream(){return this.stream}}class Ne{constructor(){this.animT=0,this.customBackgroundImage=null,this.isIOSDevice=!1,this.loadCustomBackground()}setIOSDevice(e){this.isIOSDevice=e}setVideoElement(e){this.videoEl=e}loadCustomBackground(){const e=new Image;e.onload=()=>{this.customBackgroundImage=e,console.log("✅ 自定義背景圖片載入完成")},e.onerror=n=>{console.warn("⚠️ 自定義背景圖片載入失敗:",n)};const t="/range_rover_moon_fastival_public/";e.src=t+"pexels-photo-623218.jpeg"}setCustomBackground(e){const t=new Image;t.onload=()=>{this.customBackgroundImage=t,console.log("✅ 背景圖片已更新:",e)},t.onerror=n=>{console.warn("⚠️ 背景圖片載入失敗:",n)},t.src=e}updateAnimation(){this.animT+=.016}renderBackgroundTo(e,t,n,i,s,c){const r=a.BACKGROUND&&a.BACKGROUND.TYPE||a.BACKGROUND_EFFECTS&&a.BACKGROUND_EFFECTS.DEFAULT_BACKGROUND||"original",d=a.BACKGROUND&&typeof a.BACKGROUND.INTENSITY=="number"?a.BACKGROUND.INTENSITY:(a.BACKGROUND_EFFECTS&&a.BACKGROUND_EFFECTS.EFFECT_INTENSITY)??.5;if(e.clearRect(0,0,t,n),this.updateAnimation(),r!=="original"){if(r==="waves"){this.renderWaveBackground(e,t,n,d);return}if(r==="frequency"){this.renderFrequencyBackground(e,t,n,d);return}if(r==="video"&&i){this.renderVideoBackground(e,t,n,i,d);return}if(r==="moon_video"&&s){this.renderMoonVideoBackground(e,t,n,s,d);return}if(r==="person_overlay"){this.renderPersonOverlayBackground(e,t,n);return}if(r==="custom_moon_bg"&&this.customBackgroundImage){this.renderCustomMoonBackground(e,t,n,s,c,d);return}}}renderWaveBackground(e,t,n,i){const s=e.createLinearGradient(0,0,t,n);s.addColorStop(0,"#1a2332"),s.addColorStop(.5,"#2d3a50"),s.addColorStop(1,"#0f1419"),e.fillStyle=s,e.fillRect(0,0,t,n),e.strokeStyle=`rgba(100,200,255,${i*.6})`,e.lineWidth=2;for(let c=0;c<8;c++){e.beginPath();for(let r=0;r<t;r+=5){const d=c*50,l=n/2+Math.sin((r+d)*.012+this.animT*1.2)*20*i;r===0?e.moveTo(r,l):e.lineTo(r,l)}e.stroke()}}renderFrequencyBackground(e,t,n,i){e.fillStyle="#0a0a0a",e.fillRect(0,0,t,n);const s=48,c=t/s;for(let r=0;r<s;r++){const d=r*c,l=(Math.sin(this.animT*2+r*.2)*.5+.5)*n*.5*i,u=(this.animT*30+r*10)%360;e.fillStyle=`hsla(${u},70%,60%,0.8)`,e.fillRect(d,n-l,c-1,l)}}renderVideoBackground(e,t,n,i,s){const c=i.videoWidth||1,r=i.videoHeight||1;if(i.readyState>=2){const d=Math.max(t/c,n/r),l=Math.round(c*d),u=Math.round(r*d),m=Math.round((t-l)/2),h=Math.round((n-u)/2);try{i.paused&&i.play().catch(()=>{})}catch{}e.globalAlpha=Math.min(1,.3+s*.7),e.drawImage(i,0,0,c,r,m,h,l,u),e.globalAlpha=1}}renderMoonVideoBackground(e,t,n,i,s){try{if(i.readyState>=2&&!i.paused){const c=i.videoWidth||i.width||1,r=i.videoHeight||i.height||1;if(c>1&&r>1){const d=Math.max(t/c,n/r),l=Math.round(c*d),u=Math.round(r*d),m=Math.round((t-l)/2),h=Math.round((n-u)/2);e.globalAlpha=Math.min(1,.3+s*.7),e.drawImage(i,0,0,c,r,m,h,l,u),e.globalAlpha=1}}else i.paused&&i.play().catch(c=>console.warn("月相影片播放失敗:",c))}catch(c){console.warn("月相影片渲染錯誤:",c)}}renderCustomMoonBackground(e,t,n,i,s,c){try{if(this.isIOSDevice){if(this.customBackgroundImage){const r=this.customBackgroundImage.naturalWidth||this.customBackgroundImage.width,d=this.customBackgroundImage.naturalHeight||this.customBackgroundImage.height;if(r>0&&d>0){const l=Math.max(t/r,n/d),u=Math.round(r*l),m=Math.round(d*l),h=Math.round((t-u)/2),E=Math.round((n-m)/2);e.drawImage(this.customBackgroundImage,0,0,r,d,h,E,u,m)}}else console.log("🎬 iOS設備：沒有自定義背景圖片，保持背景透明");return}if(this.customBackgroundImage){const r=this.customBackgroundImage.naturalWidth||this.customBackgroundImage.width,d=this.customBackgroundImage.naturalHeight||this.customBackgroundImage.height;if(r>0&&d>0){const l=Math.max(t/r,n/d),u=Math.round(r*l),m=Math.round(d*l),h=Math.round((t-u)/2),E=Math.round((n-m)/2);e.drawImage(this.customBackgroundImage,0,0,r,d,h,E,u,m)}}i&&i.readyState>=2&&!i.paused?this.renderCircularMoon(e,t,n,i,c):i&&i.paused&&i.play().catch(r=>console.warn("月相影片播放失敗:",r))}catch(r){console.warn("自定義背景 + 圓形月亮渲染錯誤:",r)}}renderPersonOverlayBackground(e,t,n){var s;const i=((s=window.segmentationCore)==null?void 0:s.videoEl)||document.querySelector(".input_video");if(i&&i.videoWidth>0){const c=i.videoWidth||1,r=i.videoHeight||1,d=Math.max(t/c,n/r),l=Math.round(c*d),u=Math.round(r*d),m=Math.round((t-l)/2),h=Math.round((n-u)/2);try{e.save(),e.translate(t,0),e.scale(-1,1),e.drawImage(i,0,0,c,r,t-m-l,h,l,u),e.restore()}catch(E){console.warn("無法繪製相機畫面到背景層:",E),e.clearRect(0,0,t,n)}}else e.clearRect(0,0,t,n)}renderCircularMoon(e,t,n,i,s){const c=i.videoWidth||i.width||1,r=i.videoHeight||i.height||1;if(c>1&&r>1){e.save();const d=t/n;let l,u,m;d>.6?(l=t*.5,u=n*.35,m=Math.min(t,n)*.25):d>.5?(l=t*.51,u=n*.29,m=Math.min(t,n)*.29):(l=t*.51,u=n*.26,m=Math.min(t,n)*.3),e.beginPath(),e.arc(l,u,m,0,2*Math.PI),e.clip();const h=Math.max(t/c,n/r),E=Math.round(c*h),M=Math.round(r*h),g=Math.round((t-E)/2),O=Math.round((n-M)/2);e.globalAlpha=Math.min(1,.8+s*.2),e.drawImage(i,0,0,c,r,g,O,E,M),e.globalAlpha=1,e.restore()}}}let v=null,K=null,L=null;function se(){try{L&&(URL.revokeObjectURL(L),L=null)}catch(o){console.warn("revoke failed",o)}}class De{constructor(){this.progressCallback=null,this.outputFormat="mp4"}setProgressCallback(e){this.progressCallback=e}setOutputFormat(e){this.outputFormat=e}storeRecordingBlob(e,t){if(!e)return null;se(),v=e,K=t||`moonAR_${Date.now()}.webm`;try{L=URL.createObjectURL(e)}catch(n){console.warn("createObjectURL failed",n),L=null}return L}hasRecordingAvailable(){return!!v}getLastRecordingUrl(){return L||null}clearLastRecording(){se(),v=null,K=null}getLastRecordingFilename(){return K}async uploadBlobToServerAndGetUrl(e,t){const n=new FormData;n.append("file",e,t);const i=await fetch("/api/upload",{method:"POST",body:n});if(!i.ok)throw new Error("upload failed");const s=await i.json();if(!(s!=null&&s.url))throw new Error("upload response missing url");return s.url}async shareLastRecording(){if(!v)throw new Error("no recording available");const e=K||`moonAR_${Date.now()}.mp4`,t=new File([v],e,{type:v.type||"video/mp4"});try{if(navigator.canShare&&navigator.canShare({files:[t]}))return await navigator.share({files:[t],title:"月亮節 AR 影片",text:"分享給你"}),{ok:!0,method:"webshare"}}catch(n){console.warn("Web Share file error:",n)}try{const n=await this.uploadBlobToServerAndGetUrl(v,e);if(navigator.share)try{return await navigator.share({title:"月亮節 AR 影片",text:"看這個影片：",url:n}),{ok:!0,method:"url-share",url:n}}catch(i){console.warn("Web Share URL error:",i)}return{ok:!0,method:"uploaded",url:n}}catch(n){throw console.warn("upload failed:",n),n}}async capturePhoto(e,t,n,i,s){if(!e||!i)return console.warn("無法拍照：相機未啟動或畫布不存在"),null;try{const c=document.createElement("canvas"),r=c.getContext("2d"),d=e.width,l=e.height;c.width=d,c.height=l;const u=n.BACKGROUND&&n.BACKGROUND.TYPE;if(console.log("📸 拍照檢查背景類型:",{bgType:u,hasMoonVideo:!!s}),(u==="moon_video"||u==="custom_moon_bg")&&s){console.log("🌙 月相影片模式：生成 8 秒動態影片..."),r.drawImage(e,0,0,d,l);const m=c.toDataURL("image/png",1);try{const h=await this.generateVideoWithStaticPerson(m,d,l,n,i,s);return console.log("✅ 影片生成完成:",h),h}catch(h){return console.error("❌ 影片生成失敗:",h),this.savePNG(c)}}else r.drawImage(t,0,0,d,l),r.drawImage(e,0,0,d,l);return this.savePNG(c)}catch(c){return console.error("拍照失敗：",c),null}}savePNG(e){const t=e.toDataURL("image/png",1),n=new Date().toISOString().replace(/[:]/g,"-").split(".")[0],i=document.createElement("a"),s=`月亮節AR拍照_${n}.png`;return i.download=s,i.href=t,document.body.appendChild(i),i.click(),document.body.removeChild(i),console.log("📸 PNG 拍照成功！"),{png:t}}async generateVideoWithStaticPerson(e,t,n,i,s,c){if(console.log("🎬 開始錄製靜止人物 + 動態背景影片..."),!window.MediaRecorder)return console.warn("瀏覽器不支援 MediaRecorder"),{png:e,error:"瀏覽器不支援影片錄製"};const r=document.createElement("canvas"),d=r.getContext("2d"),l=640,u=t/n;t>n?(r.width=Math.min(l,t),r.height=Math.round(r.width/u)):(r.height=Math.min(l,n),r.width=Math.round(r.height*u));const m=new Image;return new Promise((h,E)=>{m.onload=async()=>{c&&c.paused&&await c.play().catch(p=>console.warn("影片播放失敗:",p));const _=r.captureStream(20),C=this.getRecorderOptions(),S=new MediaRecorder(_,C),T=[];S.ondataavailable=p=>{p.data.size>0&&T.push(p.data)},S.onstop=()=>{const p=this.outputFormat==="mp4"?"video/mp4":"video/webm",D=this.outputFormat==="mp4"?"mp4":"webm",pe=new Blob(T,{type:p}),Se=`月亮節AR_月相影片_${new Date().toISOString().replace(/[:]/g,"-").split(".")[0]}.${D}`,Te=this.storeRecordingBlob(pe,Se);h({png:e,video:Te,duration:8,format:D,saved:!0})},S.onerror=p=>{console.error("錄製錯誤:",p.error),E(p.error)},S.start(),this.recordFrames(d,r,m,160,20,i,s,c)},m.onerror=()=>E(new Error("靜止人物圖片載入失敗")),m.src=e})}getRecorderOptions(){return this.outputFormat==="mp4"?MediaRecorder.isTypeSupported("video/mp4; codecs=h264")?{mimeType:"video/mp4; codecs=h264",videoBitsPerSecond:3e6}:MediaRecorder.isTypeSupported("video/mp4")?{mimeType:"video/mp4",videoBitsPerSecond:3e6}:(console.warn("瀏覽器不支援 MP4，降級到 WebM"),this.outputFormat="webm",{mimeType:"video/webm; codecs=vp8",videoBitsPerSecond:3e6}):{mimeType:"video/webm; codecs=vp8",videoBitsPerSecond:3e6}}recordFrames(e,t,n,i,s,c,r,d){let l=0;const u=()=>{e.clearRect(0,0,t.width,t.height),r.renderBackgroundTo(e,t.width,t.height,null,d,null);const m=n.naturalWidth||n.width,h=n.naturalHeight||n.height;if(m>0&&h>0){const E=Math.max(t.width/m,t.height/h),M=Math.round(m*E),g=Math.round(h*E),O=Math.round((t.width-M)/2),_=Math.round((t.height-g)/2);e.drawImage(n,0,0,m,h,O,_,M,g)}if(l++,this.progressCallback){const E=l/s;this.progressCallback.updateProgress(E,8)}l<i?setTimeout(u,1e3/s):(this.progressCallback&&this.progressCallback.setStatus("錄製完成，正在生成檔案..."),console.log("所有幀錄製完成"))};u()}}const N=new De;function Pe(o,e){return N.storeRecordingBlob(o,e)}function He(){return N.hasRecordingAvailable()}function be(){return N.getLastRecordingUrl()}function xe(){return N.clearLastRecording()}function We(){return N.getLastRecordingFilename()}async function Ke(o,e){return N.uploadBlobToServerAndGetUrl(o,e)}async function Ye(){return N.shareLastRecording()}const W=new Re,J=new _e,P=new Ne;let b=!1,ce=!1,I,x,H,A,ue,Q,ae,q,U,f,j=!1,y=o=>{},re=o=>{},te=0,w=null,R={w:0,h:0},F=null;const B=document.createElement("canvas"),le=B.getContext("2d");B.style.display="none";const Z=document.createElement("canvas"),G=Z.getContext("2d");Z.style.display="none";const V=document.createElement("canvas"),Fe=V.getContext("2d"),$=document.createElement("canvas"),Y=$.getContext("2d"),X=document.createElement("canvas"),z=X.getContext("2d");let de=-1;function ze(o,e={}){I=o.videoEl,x=o.bgCanvas,H=o.maskCanvas,A=o.outCanvas,ue=o.bgVideoEl||null,Q=o.bgMoonVideoEl||null,ae=o.iosMoonVideoEl||null,j=o.isIOSDevice||!1,console.log("📱 SegmentationCore 設備資訊:",{isIOSDevice:j,hasIOSMoonVideo:!!ae,hasNormalMoonVideo:!!Q}),q=x.getContext("2d"),U=H.getContext("2d"),f=A.getContext("2d"),typeof e.onStatus=="function"&&(y=e.onStatus),typeof e.onStats=="function"&&(re=e.onStats),J.setVideoElement(I),P.setIOSDevice(j),N.setProgressCallback(e.onProgress),ee(),window.addEventListener("resize",ke)}async function je(){await J.switchCamera(),ee()}function ee(){var m;const o=A.closest(".stage")||A.parentElement,e=()=>{const h=window.visualViewport;return{w:Math.round((h==null?void 0:h.width)||window.innerWidth||document.documentElement.clientWidth||360),h:Math.round((h==null?void 0:h.height)||window.innerHeight||document.documentElement.clientHeight||640)}};let t,n;if((m=a.DISPLAY)!=null&&m.FULLBLEED){const{w:h,h:E}=e();t=h,n=E,o&&o.style&&(o.style.position="fixed",o.style.top="0",o.style.left="0",o.style.right="0",o.style.bottom="0",o.style.width="100dvw",o.style.height="100dvh",o.style.margin="0",o.style.padding="0",o.style.overflow="hidden")}else{const h=o.getBoundingClientRect();t=Math.max(320,Math.round(h.width)),n=Math.max(240,Math.round(h.height))}const i=Math.max(1,Math.min(window.devicePixelRatio||1,3)),s=window.innerWidth>768?1920:1280,c=window.innerHeight>1024?1080:1280,r=Math.min(i,s/t,c/n),d=Math.round(t*r),l=Math.round(n*r),u=h=>{(h.width!==d||h.height!==l)&&(h.width=d,h.height=l),h.style.width=`${t}px`,h.style.height=`${n}px`};[x,H,A,B,Z].forEach(u),R={w:A.width,h:A.height}}function ye(o,e){P.setIOSDevice(j),P.setVideoElement(I),P.renderBackgroundTo(q,o,e,ue,Q,ae)}function ve(o,e,t){const n=e*t;if(!w||R.w!==e||R.h!==t)return w=new Float32Array(n),w.set(o),R={w:e,h:t},w;const i=a.SMOOTHING.TEMPORAL_ALPHA;for(let s=0;s<n;s++)w[s]=i*w[s]+(1-i)*o[s];return w}function Ge(o,e,t){const n=a.SMOOTHING.THRESHOLD,i=e*t,s=new ImageData(e,t);for(let l=0,u=0;l<i;l++,u+=4){const m=o[l],h=m>=n?Math.min(255,Math.round(m*255)):0;s.data[u]=0,s.data[u+1]=0,s.data[u+2]=0,s.data[u+3]=h}V.width=e,V.height=t,Fe.putImageData(s,0,0);const c=A.width,r=A.height;$.width=c,$.height=r,Y.clearRect(0,0,c,r),Y.imageSmoothingEnabled=!0,Y.imageSmoothingQuality="high",Y.drawImage(V,0,0,c,r);const d=a.SMOOTHING.EDGE_FEATHER_PX;return X.width=c,X.height=r,z.clearRect(0,0,c,r),z.filter=d>0?`blur(${d}px)`:"none",z.drawImage($,0,0),z.filter="none",X}function he(o){const e=A.width;A.height,f.save(),f.translate(e,0),f.scale(-1,1);const t=o;f.restore(),o.length>0&&console.log("🔍 偵測到",o.length,"個人臉，符合條件的:",t.length);const n=t.length>=a.FACE_DETECTION_SETTINGS.REQUIRED_FACES;n!==ce&&(n?typeof y=="function"&&y("TRIGGER_TEST_EFFECT"):typeof y=="function"&&y("STOP_TEST_EFFECT"),ce=n),re({faceCount:o.length,facesInArea:t.length,moonActive:t.length>=a.FACE_DETECTION_SETTINGS.REQUIRED_FACES})}async function me(){var m,h,E,M;if(!b)return;const o=performance.now(),e=A.width,t=A.height;f.clearRect(0,0,e,t),ye(e,t),le.clearRect(0,0,e,t);const n=I.videoWidth||1,i=I.videoHeight||1,s=Math.max(e/n,t/i),c=Math.round(n*s),r=Math.round(i*s),d=Math.round((e-c)/2),l=Math.round((t-r)/2);try{le.drawImage(I,0,0,n,i,d,l,c,r)}catch{}if(a.SEGMENTATION.ENABLED){if(I.currentTime!==de){de=I.currentTime;const g=await W.segmentImage(B,o);if(g){let O=null,_=0,C=0;if(g.confidenceMasks&&g.confidenceMasks.length){const S=te<g.confidenceMasks.length?te:0,T=g.confidenceMasks[S];if(T!=null&&T.getAsFloat32Array){const p=T.getAsFloat32Array();O=new Float32Array(p.length),O.set(p),_=T.width,C=T.height}for(const p of g.confidenceMasks)try{(m=p==null?void 0:p.close)==null||m.call(p)}catch{}}else if((h=g.categoryMask)!=null&&h.getAsUint8Array){const S=g.categoryMask,T=S.getAsUint8Array();O=new Float32Array(T.length),_=S.width,C=S.height;const p=te;for(let D=0;D<T.length;D++)O[D]=T[D]===p?1:0;try{(E=S.close)==null||E.call(S)}catch{}}if(O&&_&&C){const S=ve(O,_,C);F=Ge(S,_,C)}}}}else F=null;G.clearRect(0,0,e,t),G.save(),G.drawImage(B,0,0,e,t),F&&(G.globalCompositeOperation="destination-in",G.drawImage(F,0,0,e,t),G.globalCompositeOperation="source-over"),G.restore(),console.log("🔧 檢查背景類型:",(M=a.BACKGROUND)==null?void 0:M.TYPE),a.BACKGROUND&&a.BACKGROUND.TYPE==="person_overlay"?(console.log("✅ 進入 person_overlay 模式"),f.clearRect(0,0,e,t),F&&a.SEGMENTATION.ENABLED&&(f.save(),f.translate(e,0),f.scale(-1,1),f.drawImage(B,0,0,e,t),f.globalCompositeOperation="destination-in",f.drawImage(F,0,0,e,t),f.globalCompositeOperation="source-over",f.restore(),console.log("🎭 person_overlay模式：已提取人像到頂層",{hasMask:!!F,segmentationEnabled:a.SEGMENTATION.ENABLED,canvasSize:`${e}x${t}`,outputCanvasOpacity:f.globalAlpha,outputCanvasZIndex:getComputedStyle(A).zIndex,outputCanvasDisplay:getComputedStyle(A).display}))):(f.save(),f.translate(e,0),f.scale(-1,1),f.drawImage(Z,0,0,e,t),f.restore()),U.clearRect(0,0,e,t),F&&ge?(U.globalAlpha=.9,U.drawImage(F,0,0,e,t),U.globalAlpha=1,H.style.display="block"):H.style.display="none";const u=W.detectFaces(B,o);he(u?u.detections||[]:[]),requestAnimationFrame(me)}async function Ve(){if(b)return;if(!Ce()){y("配置錯誤，請檢查控制台");return}y("初始化..."),ee(),await W.init(A),await J.startCamera(),b=!0,y("檢測中"),requestAnimationFrame(me)}function $e(){b=!1,J.stopCamera(),f&&U&&q&&(f.clearRect(0,0,A.width,A.height),U.clearRect(0,0,H.width,H.height),q.clearRect(0,0,x.width,x.height)),re({faceCount:0,facesInArea:0,moonActive:!1}),y("已停止")}function ke(){b&&ee()}let ge=!1;function Xe(o){ge=!!o}function Ee(o){a.SEGMENTATION.ENABLED=!!o}function fe(o){a.BACKGROUND.TYPE=o}function Qe(o){a.BACKGROUND.INTENSITY=Math.max(0,Math.min(1,o))}function qe(o){a.SMOOTHING.EDGE_FEATHER_PX=Math.max(0,Number(o)||0)}function Je(o){a.SMOOTHING.TEMPORAL_ALPHA=Math.max(0,Math.min(.95,Number(o)||0))}function Ze(o){a.SMOOTHING.THRESHOLD=Math.max(0,Math.min(1,Number(o)||0))}function et(o){a.BACKGROUND.GIF_BLEND_MODE=o}function tt(o){}function ot(){return b}function nt(o){N.setProgressCallback(o)}function at(o){N.setOutputFormat(o)}async function rt(){return N.capturePhoto(A,x,a,P,Q)}async function it(){if(!I||!I.videoWidth||!I.videoHeight)return console.error("Video element not ready for capture"),null;const o=document.createElement("canvas");return o.width=I.videoWidth,o.height=I.videoHeight,o.getContext("2d").drawImage(I,0,0),o.toDataURL("image/png")}async function st(o,e,t){if(!o||!e){console.error("Missing canvas or image data for preview");return}try{const n=new Image;n.src=e,await new Promise((d,l)=>{n.onload=d,n.onerror=l});const i=new Image;i.src=t,await new Promise((d,l)=>{i.onload=d,i.onerror=l}),o.width=n.width,o.height=n.height;const s=o.getContext("2d");if(!w||!W.isInitialized()){s.drawImage(i,0,0,o.width,o.height),s.globalAlpha=.8,s.drawImage(n,0,0),s.globalAlpha=1;return}s.drawImage(i,0,0,o.width,o.height);const c=document.createElement("canvas");c.width=o.width,c.height=o.height;const r=c.getContext("2d");if(w&&R.w>0&&R.h>0){const d=r.createImageData(R.w,R.h);for(let l=0;l<w.length;l++){const u=Math.floor(w[l]*255),m=l*4;d.data[m]=u,d.data[m+1]=u,d.data[m+2]=u,d.data[m+3]=255}r.putImageData(d,0,0),s.globalCompositeOperation="destination-in",s.drawImage(c,0,0,o.width,o.height),s.globalCompositeOperation="source-over",s.drawImage(n,0,0),s.globalCompositeOperation="source-over"}}catch(n){console.error("Preview generation failed:",n);const i=o.getContext("2d"),s=new Image;s.src=e,s.onload=()=>{o.width=s.width,o.height=s.height,i.drawImage(s,0,0)}}}async function ct(o,e){if(!o||!e){console.error("Missing canvas or original image for person mask generation");return}try{const t=o.getContext("2d");if(!W.isInitialized()||!w||!R.w||!R.h){console.warn("MediaPipe not initialized or no mask available, showing original image"),t.save(),t.scale(-1,1),t.translate(-o.width,0),t.drawImage(e,0,0,o.width,o.height),t.restore();return}const n=document.createElement("canvas");n.width=o.width,n.height=o.height;const i=n.getContext("2d");i.save(),i.scale(-1,1),i.translate(-n.width,0),i.drawImage(e,0,0,n.width,n.height),i.restore();const s=document.createElement("canvas");s.width=R.w,s.height=R.h;const c=s.getContext("2d"),r=c.createImageData(R.w,R.h),d=a.SMOOTHING.THRESHOLD||.5;for(let m=0;m<w.length;m++){const h=w[m],E=h>=d?Math.min(255,Math.round(h*255)):0,M=m*4;r.data[M]=255,r.data[M+1]=255,r.data[M+2]=255,r.data[M+3]=E}c.putImageData(r,0,0);const l=document.createElement("canvas");l.width=o.width,l.height=o.height,l.getContext("2d").drawImage(s,0,0,o.width,o.height),t.clearRect(0,0,o.width,o.height),t.drawImage(n,0,0),t.globalCompositeOperation="destination-in",t.drawImage(l,0,0),t.globalCompositeOperation="source-over"}catch(t){console.error("Person mask generation failed:",t);const n=o.getContext("2d");n.clearRect(0,0,o.width,o.height),n.save(),n.scale(-1,1),n.translate(-o.width,0),n.drawImage(e,0,0,o.width,o.height),n.restore()}}let ie=!1;function lt(o,e){ie=!0,Ee(!0),fe("custom_bg"),e&&P.setCustomBackground(e)}function dt(){ie=!1,Ee(!1),fe("custom_moon_bg")}function ht(o){ie&&P.setCustomBackground(o)}export{a as CONFIG,it as captureOriginalFrame,rt as capturePhoto,xe as clearLastRecording,lt as enterPreviewMode,dt as exitPreviewMode,ct as generatePersonMask,st as generatePreviewWithBackground,We as getLastRecordingFilename,be as getLastRecordingUrl,He as hasRecordingAvailable,ze as initCore,Ce as initializeConfig,ot as isRunning,ke as onResize,Be as resetConfig,Ue as saveConfig,Qe as setBackgroundIntensity,fe as setBackgroundType,qe as setEdgeFeather,Ee as setEnableSegmentation,et as setGifBlendMode,nt as setRecordingProgressCallback,tt as setShouldGenerateGif,Xe as setShowMaskPreview,Je as setTemporalAlpha,Ze as setThreshold,at as setVideoOutputFormat,Ye as shareLastRecording,Ve as start,$e as stop,Pe as storeRecordingBlob,je as switchCamera,ht as switchPreviewBackground,ee as syncCanvasSize,Ke as uploadBlobToServerAndGetUrl};
//# sourceMappingURL=segmentationCore-Wv8wG7x5.js.map
