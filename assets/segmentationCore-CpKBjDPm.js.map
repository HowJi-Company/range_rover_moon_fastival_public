{"version":3,"file":"segmentationCore-CpKBjDPm.js","sources":["../../src/segmentationCore.js"],"sourcesContent":["// segmentationCore.js\n// å½±åƒè™•ç† / å»èƒŒæ ¸å¿ƒæ¨¡çµ„ï¼ˆESMï¼‰\n// - å°è£ MediaPipe ImageSegmenter / FaceDetector åˆå§‹åŒ–ã€ç›¸æ©Ÿæ§åˆ¶ã€æ¸²æŸ“è¿´åœˆ\n// - å°å¤–æä¾›ï¼šinitCore(), start(), stop(), switchCamera(), onResize(), setters\n//   ä»¥åŠ CONFIG / saveConfig() / resetConfig() / initializeConfig()\n// - ç”±å¤–éƒ¨ UI æ¨¡çµ„ï¼ˆuiController.jsï¼‰è² è²¬ç¶å®šæŒ‰éˆ•ã€æ»‘æ¡¿ã€é¸å–®èˆ‡é¡¯ç¤ºæ•¸å€¼\n\n// -----------------------------------------------------------------------------\n// å…¬é–‹è¨­å®šï¼ˆæ²¿ç”¨ä½¿ç”¨è€…åŸæœ¬ CONFIGï¼Œåƒ…åšå°‘æ•¸å‘å¾Œç›¸å®¹è£œä½ï¼‰\n// -----------------------------------------------------------------------------\nexport const CONFIG = {\n  FACE_DETECTION: {\n    MODEL: \"short\",\n    MIN_DETECTION_CONFIDENCE: 0.5,\n    MAX_FACES: 10,\n  },\n  SEGMENTATION: {\n    ENABLED: true,\n    MODEL_SELECTION: 1, // 1 => landscape\n    SELFIE_MODE: true,\n    SEGMENTATION_THRESHOLD: 0.1,\n  },\n  FACE_DETECTION_SETTINGS: {\n    REQUIRED_FACES: 1,\n  },\n  CAMERA: {\n    DEFAULT_WIDTH: 640,\n    DEFAULT_HEIGHT: 480,\n    DEFAULT_FACING_MODE: \"user\",\n    FRAME_RATE: 30,\n  },\n  UI: {\n    STATUS_UPDATE_INTERVAL: 100,\n    SHOW_DEBUG_INFO: true,\n    SHOW_FPS: false,\n    LANGUAGE: \"zh-TW\",\n  },\n  EFFECTS: {\n    MOON_EFFECT_DURATION: 3000,\n    FADE_DURATION: 800,\n    ENABLE_SOUND: false,\n    MOON_SIZE_SCALE: 1.0,\n    STAR_COUNT: 5,\n    SPARKLE_COUNT: 3,\n  },\n  BACKGROUND_EFFECTS: {\n    DEFAULT_BACKGROUND: \"moon_video\",\n    WAVE_EFFECT: { AMPLITUDE: 10, FREQUENCY: 0.02, SPEED: 0.05 },\n    FREQUENCY_EFFECT: { BANDS: 32, HEIGHT_SCALE: 0.8, COLOR_SHIFT: 0.01 },\n    EFFECT_INTENSITY: 0.5,\n    BLEND_MODE: \"source-over\",\n  },\n  PERFORMANCE: {\n    ENABLE_MONITORING: false,\n    MAX_LATENCY: 100,\n    LOW_PERFORMANCE_MODE: false,\n    AUTO_ADJUST_PERFORMANCE: true,\n  },\n  DEBUG: {\n    VERBOSE_LOGGING: false,\n    SHOW_FACE_LANDMARKS: false,\n    SAVE_DETECTION_RESULTS: false,\n  },\n  ADVANCED: {\n    MEDIAPIPE_BASE_URL:\n      \"https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/\",\n    MEDIAPIPE_SEGMENTATION_URL:\n      \"https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/\",\n    USE_WEB_WORKERS: false,\n    MEMORY_LIMIT: 512,\n    ENABLE_ERROR_REPORTING: true,\n  },\n};\n\n// è®“èƒŒæ™¯è¨­å®šå­˜åœ¨ï¼ˆé¿å… undefinedï¼‰\nCONFIG.BACKGROUND = CONFIG.BACKGROUND || {\n  TYPE:\n    (CONFIG.BACKGROUND_EFFECTS &&\n      CONFIG.BACKGROUND_EFFECTS.DEFAULT_BACKGROUND) ||\n    \"original\",\n  INTENSITY:\n    (CONFIG.BACKGROUND_EFFECTS && CONFIG.BACKGROUND_EFFECTS.EFFECT_INTENSITY) ??\n    0.5,\n  GIF_BLEND_MODE: \"overlay\", // ä»ä¿ç•™æ¬„ä½ä»¥å‘å¾Œç›¸å®¹ï¼ˆä½†æœƒç„¡æ•ˆï¼‰\n};\n\n// ---- Recording storage & share helper (çµ±ä¸€ç®¡ç†) ----\n\n// å„²å­˜æœ€å¾Œä¸€æ¬¡éŒ„è£½çš„ Blob / filename / objectURLï¼ˆç”± core ç®¡ç†ï¼‰\nlet lastRecordedBlob = null;\nlet lastRecordedFilename = null;\nlet lastRecordedObjectUrl = null;\n\nfunction _revokeLastObjectUrl() {\n  try {\n    if (lastRecordedObjectUrl) {\n      URL.revokeObjectURL(lastRecordedObjectUrl);\n      lastRecordedObjectUrl = null;\n    }\n  } catch (e) {\n    console.warn(\"revoke failed\", e);\n  }\n}\n\n/**\n * å„²å­˜ Blob ä¸¦å»ºç«‹ objectURLï¼ˆç”± core å‘¼å«ï¼‰\n * å›å‚³å»ºç«‹çš„ objectURLï¼ˆæˆ– nullï¼‰\n */\nexport function storeRecordingBlob(blob, filename) {\n  if (!blob) return null;\n  // æ¸…ç†èˆŠçš„ objectURL\n  _revokeLastObjectUrl();\n  lastRecordedBlob = blob;\n  lastRecordedFilename = filename || `moonAR_${Date.now()}.webm`;\n  try {\n    lastRecordedObjectUrl = URL.createObjectURL(blob);\n  } catch (e) {\n    console.warn(\"createObjectURL failed\", e);\n    lastRecordedObjectUrl = null;\n  }\n  return lastRecordedObjectUrl;\n}\n\n/** UI ç”¨ï¼šæ˜¯å¦æœ‰éŒ„å½±æª”å¯ç”¨ */\nexport function hasRecordingAvailable() {\n  return !!lastRecordedBlob;\n}\n\n/** UI ç”¨ï¼šå–å¾— core ç®¡ç†çš„ objectURLï¼ˆä¸è¦åœ¨å¤–é¢å† createObjectURLï¼‰ */\nexport function getLastRecordingUrl() {\n  return lastRecordedObjectUrl || null;\n}\n\n/** UI ç”¨ï¼šæ¸…é™¤æœ€å¾Œä¸€æ¬¡éŒ„å½±çš„æš«å­˜ï¼ˆcore æœƒ revokeï¼‰ */\nexport function clearLastRecording() {\n  _revokeLastObjectUrl();\n  lastRecordedBlob = null;\n  lastRecordedFilename = null;\n}\n\n/** å–å¾—æœ€å¾ŒéŒ„å½±æª”å */\nexport function getLastRecordingFilename() {\n  return lastRecordedFilename;\n}\n\n// ä¸Šå‚³ stubï¼ˆè«‹æ›¿æ›æˆä½ è‡ªå·±çš„å¾Œç«¯æˆ–é›²ç«¯ä¸Šå‚³å¯¦ä½œï¼‰\n// å›å‚³å…¬é–‹å¯å­˜å–çš„ url å­—ä¸²\nexport async function uploadBlobToServerAndGetUrl(blob, filename) {\n  // ç¯„ä¾‹ï¼šå‘¼å« /api/upload (form-data: file)\n  const fd = new FormData();\n  fd.append(\"file\", blob, filename);\n  const res = await fetch(\"/api/upload\", { method: \"POST\", body: fd });\n  if (!res.ok) throw new Error(\"upload failed\");\n  const j = await res.json();\n  if (!j?.url) throw new Error(\"upload response missing url\");\n  return j.url;\n}\n\n// å¯¦éš›åˆ†äº«å‡½å¼ï¼šå¿…é ˆåœ¨ã€Œä½¿ç”¨è€…æ‰‹å‹¢ã€ä¸­å‘¼å«ï¼ˆä¾‹å¦‚æŒ‰éˆ• onclickï¼‰\n// é€™å€‹å‡½å¼æœƒå˜—è©¦ï¼š1) Web Share API åˆ†äº«æª”æ¡ˆï¼›2) ä¸Šå‚³ä¸¦åˆ†äº« URLï¼›3) æ‹‹éŒ¯ç”± UI è™•ç†\nexport async function shareLastRecording() {\n  if (!lastRecordedBlob) throw new Error(\"no recording available\");\n  const filename = lastRecordedFilename || `moonAR_${Date.now()}.mp4`;\n  const file = new File([lastRecordedBlob], filename, {\n    type: lastRecordedBlob.type || \"video/mp4\",\n  });\n\n  // å„ªå…ˆå˜—è©¦æª”æ¡ˆåˆ†äº«ï¼ˆLevel 2ï¼‰\n  try {\n    if (navigator.canShare && navigator.canShare({ files: [file] })) {\n      await navigator.share({\n        files: [file],\n        title: \"æœˆäº®ç¯€ AR å½±ç‰‡\",\n        text: \"åˆ†äº«çµ¦ä½ \",\n      });\n      return { ok: true, method: \"webshare\" };\n    }\n  } catch (err) {\n    console.warn(\"Web Share file error:\", err);\n    // ç¹¼çºŒå˜—è©¦ä¸Šå‚³åˆ†äº« URL\n  }\n\n  // è‹¥æª”æ¡ˆåˆ†äº«ä¸æ”¯æ´æˆ–å¤±æ•— -> å˜—è©¦ä¸Šå‚³ä¸¦åˆ†äº« URL\n  try {\n    const url = await uploadBlobToServerAndGetUrl(lastRecordedBlob, filename);\n    if (navigator.share) {\n      try {\n        await navigator.share({\n          title: \"æœˆäº®ç¯€ AR å½±ç‰‡\",\n          text: \"çœ‹é€™å€‹å½±ç‰‡ï¼š\",\n          url,\n        });\n        return { ok: true, method: \"url-share\", url };\n      } catch (err) {\n        console.warn(\"Web Share URL error:\", err);\n      }\n    }\n    // è‹¥ä¸èƒ½ç›´æ¥å‘¼å« navigator.shareï¼Œå›å‚³ url çµ¦ UI é¡¯ç¤ºè¤‡è£½\n    return { ok: true, method: \"uploaded\", url };\n  } catch (err) {\n    console.warn(\"upload failed:\", err);\n    throw err; // ç”±å‘¼å«ç«¯ï¼ˆUIï¼‰è™•ç† fallbackï¼ˆä¾‹å¦‚ä¸‹è¼‰ï¼‰\n  }\n}\n\n// -----------------------------------------------------------------------------\n// ç‹€æ…‹ã€DOM åƒç…§ã€å›å‘¼\n// -----------------------------------------------------------------------------\nlet imageSegmenter = null;\nlet faceDetector = null;\nlet wasmFileset = null;\nlet running = false;\nlet stream = null;\nlet currentFacingMode = CONFIG.CAMERA.DEFAULT_FACING_MODE || \"user\";\nlet lastFaceDetectionState = false;\n\n// DOM\nlet videoEl, bgCanvas, maskCanvas, outCanvas, bgVideoEl, bgGifEl, bgMoonVideoEl, iosMoonVideoEl;\nlet bgCtx, maskCtx, outCtx;\n\n// è‡ªå®šç¾©èƒŒæ™¯åœ–ç‰‡\nlet customBackgroundImage = null;\n\n// iOS è¨­å‚™æª¢æ¸¬\nlet isIOSDevice = false;\n\n// Callbacksï¼ˆç”± UI æ¨¡çµ„è¨»å†Šï¼‰\nlet onStatus = (t) => {};\nlet onStats = (stats) => {}; // { faceCount, facesInArea, moonActive }\n\n// -----------------------------------------------------------------------------\n// å…§éƒ¨æš«å­˜\n// -----------------------------------------------------------------------------\nlet personLabelIndex = 0;\nlet lastMaskF32 = null;\nlet lastMaskSize = { w: 0, h: 0 };\nlet gMaskCanvasProcessed = null;\n\n// offscreen\nconst videoDrawCanvas = document.createElement(\"canvas\");\nconst videoDrawCtx = videoDrawCanvas.getContext(\"2d\");\nvideoDrawCanvas.style.display = \"none\";\n\nconst compositeCanvas = document.createElement(\"canvas\");\nconst compositeCtx = compositeCanvas.getContext(\"2d\");\ncompositeCanvas.style.display = \"none\";\n\n// è’™ç‰ˆä¸­ç¹¼\nconst maskBaseCanvas = document.createElement(\"canvas\");\nconst maskBaseCtx = maskBaseCanvas.getContext(\"2d\");\nconst maskUpscaleCanvas = document.createElement(\"canvas\");\nconst maskUpscaleCtx = maskUpscaleCanvas.getContext(\"2d\");\nconst maskSoftCanvas = document.createElement(\"canvas\");\nconst maskSoftCtx = maskSoftCanvas.getContext(\"2d\");\n\n// å…¶ä»–\nlet animT = 0;\nlet lastVideoTime = -1;\n\n// -----------------------------------------------------------------------------\n// å·¥å…·ï¼šè£ç½®è‡ªå‹•èª¿æ•´ / é©—è­‰ / è¨­å®šæŒä¹…åŒ–\n// -----------------------------------------------------------------------------\nfunction autoAdjustConfig() {\n  const isMobile =\n    /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(\n      navigator.userAgent\n    );\n  const isLowEnd = (navigator.hardwareConcurrency || 4) <= 2;\n\n  if (isMobile) {\n    CONFIG.CAMERA.DEFAULT_WIDTH = 480;\n    CONFIG.CAMERA.DEFAULT_HEIGHT = 360;\n    CONFIG.FACE_DETECTION.MODEL = \"short\";\n    CONFIG.EFFECTS.STAR_COUNT = 3;\n    CONFIG.EFFECTS.SPARKLE_COUNT = 2;\n  }\n  if (isLowEnd) {\n    CONFIG.PERFORMANCE.LOW_PERFORMANCE_MODE = true;\n    CONFIG.FACE_DETECTION.MIN_DETECTION_CONFIDENCE = 0.6;\n    CONFIG.CAMERA.FRAME_RATE = 20;\n    CONFIG.EFFECTS.MOON_SIZE_SCALE = 0.8;\n  }\n}\n\nfunction validateConfig() {\n  const errors = [];\n  if (\n    CONFIG.FACE_DETECTION.MIN_DETECTION_CONFIDENCE < 0 ||\n    CONFIG.FACE_DETECTION.MIN_DETECTION_CONFIDENCE > 1\n  )\n    errors.push(\"MIN_DETECTION_CONFIDENCE å¿…é ˆåœ¨ 0~1 ä¹‹é–“\");\n\n  if (!navigator.mediaDevices?.getUserMedia) {\n    errors.push(\"ç€è¦½å™¨ä¸æ”¯æ´ç›¸æ©ŸåŠŸèƒ½\");\n  }\n  return errors;\n}\n\nexport function saveConfig() {\n  try {\n    localStorage.setItem(\"moonFestivalAR_config\", JSON.stringify(CONFIG));\n  } catch {}\n}\n\nexport function resetConfig() {\n  try {\n    localStorage.removeItem(\"moonFestivalAR_config\");\n  } catch {}\n  location.reload();\n}\n\nfunction loadCustomConfig() {\n  try {\n    const c = localStorage.getItem(\"moonFestivalAR_config\");\n    if (c) Object.assign(CONFIG, JSON.parse(c));\n  } catch {}\n}\n\n// åˆå§‹åŒ– / å‘å¾Œç›¸å®¹è£œä½\nexport function initializeConfig() {\n  loadCustomConfig();\n  autoAdjustConfig();\n\n  // å°æ‡‰èˆŠæ¬„ä½\n  CONFIG.CAMERA.WIDTH =\n    CONFIG.CAMERA.DEFAULT_WIDTH || CONFIG.CAMERA.WIDTH || 1280;\n  CONFIG.CAMERA.HEIGHT =\n    CONFIG.CAMERA.DEFAULT_HEIGHT || CONFIG.CAMERA.HEIGHT || 720;\n  CONFIG.CAMERA.FACING =\n    CONFIG.CAMERA.DEFAULT_FACING_MODE || CONFIG.CAMERA.FACING || \"user\";\n\n  CONFIG.SEGMENTER = CONFIG.SEGMENTER || {};\n  CONFIG.SEGMENTER.USE_LANDSCAPE_MODEL =\n    CONFIG.SEGMENTATION && CONFIG.SEGMENTATION.MODEL_SELECTION === 1\n      ? true\n      : CONFIG.SEGMENTER.USE_LANDSCAPE_MODEL ?? true;\n  CONFIG.SEGMENTER.USE_GPU = CONFIG.SEGMENTER.USE_GPU ?? true;\n\n  CONFIG.SMOOTHING = CONFIG.SMOOTHING || {};\n  CONFIG.SMOOTHING.THRESHOLD =\n    CONFIG.SMOOTHING.THRESHOLD ??\n    CONFIG.SEGMENTATION?.SEGMENTATION_THRESHOLD ??\n    0.38;\n  CONFIG.SMOOTHING.TEMPORAL_ALPHA = CONFIG.SMOOTHING.TEMPORAL_ALPHA ?? 0.6;\n  CONFIG.SMOOTHING.EDGE_FEATHER_PX = CONFIG.SMOOTHING.EDGE_FEATHER_PX ?? 3;\n  CONFIG.SMOOTHING.HYS_ON =\n    CONFIG.SMOOTHING.HYS_ON ?? CONFIG.SMOOTHING.THRESHOLD - 0.15;\n  CONFIG.SMOOTHING.HYS_OFF =\n    CONFIG.SMOOTHING.HYS_OFF ?? CONFIG.SMOOTHING.THRESHOLD + 0.15;\n  CONFIG.SMOOTHING.MASK_GROW_PX = CONFIG.SMOOTHING.MASK_GROW_PX ?? 1.5;\n\n  // æ¨¡å‹è·¯å¾‘èˆ‡ WASM base\n  if (!CONFIG.MODELS) {\n    CONFIG.MODELS = {\n      SELFIE_SEGMENTER_LANDSCAPE:\n        \"https://storage.googleapis.com/mediapipe-models/image_segmenter/selfie_segmenter_landscape/float16/latest/selfie_segmenter_landscape.tflite\",\n      SELFIE_SEGMENTER_SQUARE:\n        \"https://storage.googleapis.com/mediapipe-models/image_segmenter/selfie_segmenter/float16/latest/selfie_segmenter.tflite\",\n      FACE_DETECTOR:\n        \"https://storage.googleapis.com/mediapipe-models/face_detector/blaze_face_short_range/float16/latest/blaze_face_short_range.tflite\",\n    };\n  }\n  CONFIG.WASM_BASE =\n    CONFIG.WASM_BASE ||\n    \"https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.7/wasm\";\n\n  const errs = validateConfig();\n  if (errs.length) {\n    console.error(\"é…ç½®é©—è­‰å¤±æ•—ï¼š\", errs);\n    return false;\n  }\n  return true;\n}\n\n// -----------------------------------------------------------------------------\n// åˆå§‹åŒ–æ ¸å¿ƒï¼ˆç”± UI æ¨¡çµ„å‘¼å«ï¼ŒæŠŠå¿…è¦ DOM å‚³é€²ä¾† + è¨»å†Šå›å‘¼ï¼‰\n// -----------------------------------------------------------------------------\nexport function initCore(els, callbacks = {}) {\n  videoEl = els.videoEl;\n  bgCanvas = els.bgCanvas;\n  maskCanvas = els.maskCanvas;\n  outCanvas = els.outCanvas;\n  bgVideoEl = els.bgVideoEl || null;\n  bgGifEl = els.bgGifEl || null; // é›–ä¿ç•™è®Šæ•¸ï¼Œä½† GIF æµç¨‹å·²ç§»é™¤\n  bgMoonVideoEl = els.bgMoonVideoEl || null;\n  iosMoonVideoEl = els.iosMoonVideoEl || null;\n  isIOSDevice = els.isIOSDevice || false;\n  \n  console.log('ğŸ“± SegmentationCore è¨­å‚™è³‡è¨Š:', {\n    isIOSDevice,\n    hasIOSMoonVideo: !!iosMoonVideoEl,\n    hasNormalMoonVideo: !!bgMoonVideoEl\n  });\n\n  bgCtx = bgCanvas.getContext(\"2d\");\n  maskCtx = maskCanvas.getContext(\"2d\");\n  outCtx = outCanvas.getContext(\"2d\");\n\n  if (typeof callbacks.onStatus === \"function\") onStatus = callbacks.onStatus;\n  if (typeof callbacks.onStats === \"function\") onStats = callbacks.onStats;\n\n  currentFacingMode = CONFIG.CAMERA.FACING || \"user\";\n  \n  // è¼‰å…¥è‡ªå®šç¾©èƒŒæ™¯åœ–ç‰‡\n  loadCustomBackground();\n}\n\n// è¼‰å…¥è‡ªå®šç¾©èƒŒæ™¯åœ–ç‰‡\nfunction loadCustomBackground() {\n  const img = new Image();\n  img.onload = () => {\n    customBackgroundImage = img;\n    console.log('âœ… è‡ªå®šç¾©èƒŒæ™¯åœ–ç‰‡è¼‰å…¥å®Œæˆ');\n  };\n  img.onerror = (e) => {\n    console.warn('âš ï¸ è‡ªå®šç¾©èƒŒæ™¯åœ–ç‰‡è¼‰å…¥å¤±æ•—:', e);\n  };\n  // ä½¿ç”¨å‹•æ…‹è·¯å¾‘æ§‹é€ ï¼Œè®“ Vite æ­£ç¢ºè™•ç†\n  const base = import.meta.env.BASE_URL || '/';\n  img.src = base + 'pexels-photo-623218.jpeg';\n}\n\n// -----------------------------------------------------------------------------\n// MediaPipe æ¨¡çµ„è¼‰å…¥\n// -----------------------------------------------------------------------------\nasync function ensureTasksVisionLoaded() {\n  if (window.FilesetResolver && window.ImageSegmenter) return true;\n  const urls = [\n    \"https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.7/vision_bundle.mjs\",\n    \"https://unpkg.com/@mediapipe/tasks-vision@0.10.7/vision_bundle.mjs\",\n  ];\n  for (const url of urls) {\n    try {\n      const mod = await import(url);\n      if (mod.FilesetResolver) window.FilesetResolver = mod.FilesetResolver;\n      if (mod.ImageSegmenter) window.ImageSegmenter = mod.ImageSegmenter;\n      if (mod.FaceDetector) window.FaceDetector = mod.FaceDetector;\n      return true;\n    } catch (e) {\n      console.warn(\"[WARN] failed to import tasks-vision from\", url, e);\n    }\n  }\n  throw new Error(\"ç„¡æ³•è¼‰å…¥ @mediapipe/tasks-vision æ¨¡çµ„\");\n}\n\nasync function initTasks() {\n  if (!wasmFileset) {\n    wasmFileset = await FilesetResolver.forVisionTasks(CONFIG.WASM_BASE);\n  }\n  // ä¾ outCanvas æ¯”ä¾‹é¸æ“‡ä½¿ç”¨ landscape/square\n  try {\n    const rect = outCanvas.getBoundingClientRect();\n    CONFIG.SEGMENTER.USE_LANDSCAPE_MODEL =\n      (rect.width || 1) >= (rect.height || 1);\n  } catch {}\n\n  // ImageSegmenter\n  const baseOptions = {\n    modelAssetPath: CONFIG.SEGMENTER.USE_LANDSCAPE_MODEL\n      ? CONFIG.MODELS.SELFIE_SEGMENTER_LANDSCAPE\n      : CONFIG.MODELS.SELFIE_SEGMENTER_SQUARE,\n    delegate: CONFIG.SEGMENTER.USE_GPU ? \"GPU\" : \"CPU\",\n  };\n  try {\n    imageSegmenter = await ImageSegmenter.createFromOptions(wasmFileset, {\n      baseOptions,\n      runningMode: \"VIDEO\",\n      outputCategoryMask: false,\n      outputConfidenceMasks: true,\n    });\n  } catch (e) {\n    console.warn(\"[Segmenter] GPU å¤±æ•—ï¼Œæ”¹ç”¨ CPU:\", e);\n    imageSegmenter = await ImageSegmenter.createFromOptions(wasmFileset, {\n      baseOptions: { ...baseOptions, delegate: \"CPU\" },\n      runningMode: \"VIDEO\",\n      outputCategoryMask: false,\n      outputConfidenceMasks: true,\n    });\n  }\n\n  // FaceDetectorï¼ˆå¯é¸ï¼‰\n  try {\n    faceDetector = await FaceDetector.createFromOptions(wasmFileset, {\n      baseOptions: {\n        modelAssetPath: CONFIG.MODELS.FACE_DETECTOR,\n        delegate: \"GPU\",\n      },\n      runningMode: \"VIDEO\",\n      minDetectionConfidence: 0.6,\n      minSuppressionThreshold: 0.3,\n    });\n  } catch (e) {\n    console.warn(\"[FaceDetector] GPU å¤±æ•—ï¼Œæ”¹ç”¨ CPU:\", e);\n    faceDetector = await FaceDetector.createFromOptions(wasmFileset, {\n      baseOptions: {\n        modelAssetPath: CONFIG.MODELS.FACE_DETECTOR,\n        delegate: \"CPU\",\n      },\n      runningMode: \"VIDEO\",\n      minDetectionConfidence: 0.6,\n      minSuppressionThreshold: 0.3,\n    });\n  }\n}\n\n// -----------------------------------------------------------------------------\n// ç›¸æ©Ÿæ§åˆ¶\n// -----------------------------------------------------------------------------\nasync function startCamera() {\n  if (stream) {\n    try {\n      stream.getTracks().forEach((t) => t.stop());\n    } catch {}\n  }\n  const constraints = {\n    audio: false,\n    video: {\n      facingMode: currentFacingMode,\n      width: { ideal: CONFIG.CAMERA.WIDTH },\n      height: { ideal: CONFIG.CAMERA.HEIGHT },\n      frameRate: { ideal: CONFIG.CAMERA.FRAME_RATE },\n    },\n  };\n  stream = await navigator.mediaDevices.getUserMedia(constraints);\n  videoEl.srcObject = stream;\n  videoEl.setAttribute(\"playsinline\", \"\");\n  videoEl.muted = true;\n  videoEl.autoplay = true;\n\n  await new Promise((resolve) => {\n    if (videoEl.readyState >= 1 && videoEl.videoWidth && videoEl.videoHeight)\n      return resolve();\n    videoEl.onloadedmetadata = () => resolve();\n    setTimeout(resolve, 1500);\n  });\n  try {\n    await videoEl.play();\n  } catch {}\n\n  syncCanvasSize();\n}\n\nexport async function switchCamera() {\n  currentFacingMode = currentFacingMode === \"user\" ? \"environment\" : \"user\";\n  await startCamera();\n}\n\n// -----------------------------------------------------------------------------\n// ç•«å¸ƒå°ºå¯¸åŒæ­¥\n// -----------------------------------------------------------------------------\nexport function syncCanvasSize() {\n  const stageEl = outCanvas.closest(\".stage\") || outCanvas.parentElement;\n  const rect = stageEl.getBoundingClientRect();\n  const w = Math.max(1, Math.round(rect.width));\n  const h = Math.max(1, Math.round(rect.height));\n  [bgCanvas, maskCanvas, outCanvas, videoDrawCanvas, compositeCanvas].forEach(\n    (c) => {\n      if (c.width !== w || c.height !== h) {\n        c.width = w;\n        c.height = h;\n      }\n      c.style.width = `${w}px`;\n      c.style.height = `${h}px`;\n    }\n  );\n  lastMaskSize = { w: outCanvas.width, h: outCanvas.height };\n}\n\n// -----------------------------------------------------------------------------\n// èƒŒæ™¯ç¹ªè£½ï¼ˆå«ã€Œå½±ç‰‡ã€èƒŒæ™¯é¸é …ï¼‰\n// -----------------------------------------------------------------------------\nfunction renderBackgroundTo(ctx, w, h) {\n  const bgType =\n    (CONFIG.BACKGROUND && CONFIG.BACKGROUND.TYPE) ||\n    (CONFIG.BACKGROUND_EFFECTS &&\n      CONFIG.BACKGROUND_EFFECTS.DEFAULT_BACKGROUND) ||\n    \"original\";\n  const intensity =\n    CONFIG.BACKGROUND && typeof CONFIG.BACKGROUND.INTENSITY === \"number\"\n      ? CONFIG.BACKGROUND.INTENSITY\n      : (CONFIG.BACKGROUND_EFFECTS &&\n          CONFIG.BACKGROUND_EFFECTS.EFFECT_INTENSITY) ??\n        0.5;\n\n  ctx.clearRect(0, 0, w, h);\n  animT += 0.016;\n\n  if (bgType === \"original\") {\n    // é€æ˜\n    return;\n  }\n  if (bgType === \"waves\") {\n    const grad = ctx.createLinearGradient(0, 0, w, h);\n    grad.addColorStop(0, \"#1a2332\");\n    grad.addColorStop(0.5, \"#2d3a50\");\n    grad.addColorStop(1, \"#0f1419\");\n    ctx.fillStyle = grad;\n    ctx.fillRect(0, 0, w, h);\n    ctx.strokeStyle = `rgba(100,200,255,${intensity * 0.6})`;\n    ctx.lineWidth = 2;\n    for (let i = 0; i < 8; i++) {\n      ctx.beginPath();\n      for (let x = 0; x < w; x += 5) {\n        const off = i * 50;\n        const y =\n          h / 2 + Math.sin((x + off) * 0.012 + animT * 1.2) * 20 * intensity;\n        if (x === 0) ctx.moveTo(x, y);\n        else ctx.lineTo(x, y);\n      }\n      ctx.stroke();\n    }\n    return;\n  }\n  if (bgType === \"frequency\") {\n    ctx.fillStyle = \"#0a0a0a\";\n    ctx.fillRect(0, 0, w, h);\n    const bands = 48;\n    const bw = w / bands;\n    for (let i = 0; i < bands; i++) {\n      const x = i * bw;\n      const bh =\n        (Math.sin(animT * 2 + i * 0.2) * 0.5 + 0.5) * h * 0.5 * intensity;\n      const hue = (animT * 30 + i * 10) % 360;\n      ctx.fillStyle = `hsla(${hue},70%,60%,0.8)`;\n      ctx.fillRect(x, h - bh, bw - 1, bh);\n    }\n    return;\n  }\n  if (bgType === \"video\" && bgVideoEl) {\n    // ä»¥ cover æ–¹å¼é‹ªæ»¿\n    const vw = bgVideoEl.videoWidth || 1;\n    const vh = bgVideoEl.videoHeight || 1;\n    if (bgVideoEl.readyState >= 2) {\n      const scale = Math.max(w / vw, h / vh);\n      const dw = Math.round(vw * scale);\n      const dh = Math.round(vh * scale);\n      const ox = Math.round((w - dw) / 2);\n      const oy = Math.round((h - dh) / 2);\n      try {\n        if (bgVideoEl.paused) bgVideoEl.play().catch(() => {});\n      } catch {}\n      ctx.globalAlpha = Math.min(1, 0.3 + intensity * 0.7);\n      ctx.drawImage(bgVideoEl, 0, 0, vw, vh, ox, oy, dw, dh);\n      ctx.globalAlpha = 1;\n    }\n    return;\n  }\n  // æœˆç›¸å½±ç‰‡èƒŒæ™¯\n  if (bgType === \"moon_video\" && bgMoonVideoEl) {\n    try {\n      // Debug removed - moon video working properly\n      \n      if (bgMoonVideoEl.readyState >= 2 && !bgMoonVideoEl.paused) {\n        const vw = bgMoonVideoEl.videoWidth || bgMoonVideoEl.width || 1;\n        const vh = bgMoonVideoEl.videoHeight || bgMoonVideoEl.height || 1;\n        if (vw > 1 && vh > 1) {\n          const scale = Math.max(w / vw, h / vh);\n          const dw = Math.round(vw * scale);\n          const dh = Math.round(vh * scale);\n          const ox = Math.round((w - dw) / 2);\n          const oy = Math.round((h - dh) / 2);\n\n          ctx.globalAlpha = Math.min(1, 0.3 + intensity * 0.7);\n          ctx.drawImage(bgMoonVideoEl, 0, 0, vw, vh, ox, oy, dw, dh);\n          ctx.globalAlpha = 1;\n          // Moon video rendered successfully\n        } else {\n          console.warn(\"ğŸŒ™ Moon video dimensions too small:\", { vw, vh });\n        }\n      } else if (bgMoonVideoEl.paused) {\n        // Moon video is paused, attempting to play\n        bgMoonVideoEl.play().catch((e) => console.warn(\"æœˆç›¸å½±ç‰‡æ’­æ”¾å¤±æ•—:\", e));\n      } else {\n        console.warn(\"ğŸŒ™ Moon video not ready:\", { \n          readyState: bgMoonVideoEl.readyState, \n          paused: bgMoonVideoEl.paused \n        });\n      }\n    } catch (e) {\n      console.warn(\"æœˆç›¸å½±ç‰‡æ¸²æŸ“éŒ¯èª¤:\", e);\n    }\n    return;\n  }\n  \n  // è‡ªå®šç¾©èƒŒæ™¯ + åœ“å½¢æœˆäº®åˆæˆ\n  if (bgType === \"custom_moon_bg\" && customBackgroundImage) {\n    try {\n      // iOS è¨­å‚™ç‰¹æ®Šè™•ç†ï¼šä½¿ç”¨èƒŒæ™¯åœ–ç‰‡ + App.vue ä¸­çš„å…¨è¢å¹•é€æ˜ MOV\n      if (isIOSDevice) {\n        // iOS è¨­å‚™åªç¹ªè£½èƒŒæ™¯åœ–ç‰‡ï¼Œæœˆäº®ç”± App.vue çš„å…¨è¢å¹• MOV è™•ç†\n        if (customBackgroundImage) {\n          const imgW = customBackgroundImage.naturalWidth || customBackgroundImage.width;\n          const imgH = customBackgroundImage.naturalHeight || customBackgroundImage.height;\n          if (imgW > 0 && imgH > 0) {\n            const scale = Math.max(w / imgW, h / imgH);\n            const dw = Math.round(imgW * scale);\n            const dh = Math.round(imgH * scale);\n            const ox = Math.round((w - dw) / 2);\n            const oy = Math.round((h - dh) / 2);\n            ctx.drawImage(customBackgroundImage, 0, 0, imgW, imgH, ox, oy, dw, dh);\n          }\n        }\n        return; // iOS è¨­å‚™ä¸ç¹ªè£½åœ“å½¢æœˆäº®ï¼Œç”± MOV è™•ç†\n      }\n      \n      // é iOS è¨­å‚™ï¼šå‚³çµ±ä¸‰å±¤åˆæˆæ¨¡å¼\n      // ç¬¬ä¸€å±¤ï¼šè‡ªå®šç¾©èƒŒæ™¯åœ–ç‰‡\n      if (customBackgroundImage) {\n        const imgW = customBackgroundImage.naturalWidth || customBackgroundImage.width;\n        const imgH = customBackgroundImage.naturalHeight || customBackgroundImage.height;\n        if (imgW > 0 && imgH > 0) {\n          const scale = Math.max(w / imgW, h / imgH);\n          const dw = Math.round(imgW * scale);\n          const dh = Math.round(imgH * scale);\n          const ox = Math.round((w - dw) / 2);\n          const oy = Math.round((h - dh) / 2);\n          ctx.drawImage(customBackgroundImage, 0, 0, imgW, imgH, ox, oy, dw, dh);\n        }\n      }\n      \n      // ç¬¬äºŒå±¤ï¼šåœ“å½¢æœˆäº® MP4 (é iOS è¨­å‚™ç”¨)\n      if (bgMoonVideoEl && bgMoonVideoEl.readyState >= 2 && !bgMoonVideoEl.paused) {\n        const vw = bgMoonVideoEl.videoWidth || bgMoonVideoEl.width || 1;\n        const vh = bgMoonVideoEl.videoHeight || bgMoonVideoEl.height || 1;\n        \n        if (vw > 1 && vh > 1) {\n          ctx.save();\n          \n          // éŸ¿æ‡‰å¼åœ“å½¢è£å‰ªè·¯å¾‘è¨ˆç®—\n          // æ ¹æ“šè¢å¹•æ¯”ä¾‹èª¿æ•´æœˆäº®ä½ç½®ï¼Œç¢ºä¿åœ¨å„ç¨®æ‰‹æ©Ÿå°ºå¯¸ä¸‹éƒ½èƒ½æ­£ç¢ºé¡¯ç¤º\n          const aspectRatio = w / h;\n          let centerX, centerY, radius;\n          \n          if (aspectRatio > 0.6) {\n            // è¼ƒå¯¬çš„è¢å¹• (å¦‚å¹³æ¿æ©«å‘)\n            centerX = w * 0.5;\n            centerY = h * 0.35;\n            radius = Math.min(w, h) * 0.25;\n          } else if (aspectRatio > 0.5) {\n            // æ¨™æº–æ‰‹æ©Ÿè¢å¹• (9:16 åˆ° 9:18)\n            centerX = w * 0.51;\n            centerY = h * 0.29;\n            radius = Math.min(w, h) * 0.29;\n          } else {\n            // è¶…é•·è¢å¹• (å¦‚ 9:19.5, 9:20)\n            centerX = w * 0.51;\n            centerY = h * 0.26;\n            radius = Math.min(w, h) * 0.30;\n          }\n          \n          ctx.beginPath();\n          ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);\n          ctx.clip();\n          \n          // ç¹ªè£½æœˆäº®å½±ç‰‡ (ä»¥ cover æ–¹å¼)\n          const scale = Math.max(w / vw, h / vh);\n          const dw = Math.round(vw * scale);\n          const dh = Math.round(vh * scale);\n          const ox = Math.round((w - dw) / 2);\n          const oy = Math.round((h - dh) / 2);\n          \n          ctx.globalAlpha = Math.min(1, 0.8 + intensity * 0.2);\n          ctx.drawImage(bgMoonVideoEl, 0, 0, vw, vh, ox, oy, dw, dh);\n          ctx.globalAlpha = 1;\n          \n          ctx.restore();\n        }\n      } else if (bgMoonVideoEl && bgMoonVideoEl.paused) {\n        // è‡ªå‹•æ’­æ”¾æœˆç›¸å½±ç‰‡\n        bgMoonVideoEl.play().catch((e) => console.warn(\"æœˆç›¸å½±ç‰‡æ’­æ”¾å¤±æ•—:\", e));\n      }\n      \n    } catch (e) {\n      console.warn(\"è‡ªå®šç¾©èƒŒæ™¯ + åœ“å½¢æœˆäº®æ¸²æŸ“éŒ¯èª¤:\", e);\n    }\n    return;\n  }\n}\n\nfunction renderBackground(w, h) {\n  renderBackgroundTo(bgCtx, w, h);\n}\n\n// -----------------------------------------------------------------------------\n// è’™ç‰ˆè™•ç†ï¼ˆEMA å¹³æ»‘ + é‚Šç·£ç¾½åŒ–ï¼‰\n// -----------------------------------------------------------------------------\nfunction emaUpdate(srcF32, w, h) {\n  const N = w * h;\n  if (!lastMaskF32 || lastMaskSize.w !== w || lastMaskSize.h !== h) {\n    lastMaskF32 = new Float32Array(N);\n    lastMaskF32.set(srcF32);\n    lastMaskSize = { w, h };\n    return lastMaskF32;\n  }\n  const a = CONFIG.SMOOTHING.TEMPORAL_ALPHA;\n  for (let i = 0; i < N; i++) {\n    lastMaskF32[i] = a * lastMaskF32[i] + (1 - a) * srcF32[i];\n  }\n  return lastMaskF32;\n}\n\nfunction buildAlphaImage(maskF32, w, h) {\n  const T = CONFIG.SMOOTHING.THRESHOLD;\n  const N = w * h;\n  const img = new ImageData(w, h);\n  for (let i = 0, j = 0; i < N; i++, j += 4) {\n    const v = maskF32[i];\n    const a = v >= T ? Math.min(255, Math.round(v * 255)) : 0;\n    img.data[j] = 0;\n    img.data[j + 1] = 0;\n    img.data[j + 2] = 0;\n    img.data[j + 3] = a;\n  }\n  maskBaseCanvas.width = w;\n  maskBaseCanvas.height = h;\n  maskBaseCtx.putImageData(img, 0, 0);\n\n  const VW = outCanvas.width,\n    VH = outCanvas.height;\n  maskUpscaleCanvas.width = VW;\n  maskUpscaleCanvas.height = VH;\n  maskUpscaleCtx.clearRect(0, 0, VW, VH);\n  maskUpscaleCtx.imageSmoothingEnabled = true;\n  maskUpscaleCtx.imageSmoothingQuality = \"high\";\n  maskUpscaleCtx.drawImage(maskBaseCanvas, 0, 0, VW, VH);\n\n  const blurPx = CONFIG.SMOOTHING.EDGE_FEATHER_PX;\n  maskSoftCanvas.width = VW;\n  maskSoftCanvas.height = VH;\n  maskSoftCtx.clearRect(0, 0, VW, VH);\n  maskSoftCtx.filter = blurPx > 0 ? `blur(${blurPx}px)` : \"none\";\n  maskSoftCtx.drawImage(maskUpscaleCanvas, 0, 0);\n  maskSoftCtx.filter = \"none\";\n  return maskSoftCanvas;\n}\n\n// -----------------------------------------------------------------------------\n// è‡‰éƒ¨æª¢æ¸¬ / å€åŸŸèˆ‡ç–Šåœ–\n// -----------------------------------------------------------------------------\nfunction checkFacesInArea(detections) {\n  // ç¾åœ¨æ•´å€‹ç•«é¢éƒ½æ˜¯åµæ¸¬ç¯„åœï¼Œç›´æ¥è¿”å›æ‰€æœ‰åµæ¸¬åˆ°çš„äººè‡‰\n  return detections;\n}\n\nfunction renderOverlay(detections) {\n  const W = outCanvas.width,\n    H = outCanvas.height;\n  outCtx.save();\n  outCtx.translate(W, 0);\n  outCtx.scale(-1, 1);\n\n\n\n  const facesIn = checkFacesInArea(detections);\n  outCtx.restore();\n\n  // æ ¹æ“šäººåƒåµæ¸¬ç‹€æ…‹å‹•æ…‹åˆ‡æ›å»èƒŒåŠŸèƒ½å’ŒèƒŒæ™¯é¡å‹\n  const currentFaceDetectionState = facesIn.length >= CONFIG.FACE_DETECTION_SETTINGS.REQUIRED_FACES;\n  \n  if (currentFaceDetectionState !== lastFaceDetectionState) {\n    if (currentFaceDetectionState) {\n      // åµæ¸¬åˆ°äººåƒï¼šè§¸ç™¼æ¸¬è©¦æŒ‰éˆ•çš„æ•ˆæœ\n      if (typeof onStatus === 'function') {\n        onStatus('TRIGGER_TEST_EFFECT');\n      }\n    } else {\n      // æ²’æœ‰åµæ¸¬åˆ°äººåƒï¼šæ¢å¾©æ­£å¸¸ç‹€æ…‹\n      if (typeof onStatus === 'function') {\n        onStatus('STOP_TEST_EFFECT');\n      }\n    }\n    lastFaceDetectionState = currentFaceDetectionState;\n  }\n\n  // æ›´æ–°å›å‘¼\n  onStats({\n    faceCount: detections.length,\n    facesInArea: facesIn.length,\n    moonActive: facesIn.length >= CONFIG.FACE_DETECTION_SETTINGS.REQUIRED_FACES,\n  });\n}\n\n// -----------------------------------------------------------------------------\n// ä¸»æ¸²æŸ“è¿´åœˆ\n// -----------------------------------------------------------------------------\nasync function renderLoop() {\n  if (!running) return;\n  const now = performance.now();\n  const W = outCanvas.width,\n    H = outCanvas.height;\n\n  // èƒŒæ™¯\n  outCtx.clearRect(0, 0, W, H);\n  renderBackground(W, H);\n\n  // å°‡ video ä»¥ cover æ–¹å¼ç•«åˆ°æš«å­˜ï¼ˆæ»¿ç‰ˆé¡¯ç¤ºï¼‰\n  videoDrawCtx.clearRect(0, 0, W, H);\n  const vw = videoEl.videoWidth || 1,\n    vh = videoEl.videoHeight || 1;\n  const scale = Math.max(W / vw, H / vh);\n  const dw = Math.round(vw * scale),\n    dh = Math.round(vh * scale);\n  const ox = Math.round((W - dw) / 2),\n    oy = Math.round((H - dh) / 2);\n  try {\n    videoDrawCtx.drawImage(videoEl, 0, 0, vw, vh, ox, oy, dw, dh);\n  } catch {}\n\n  // Segmentationï¼ˆåƒ…åœ¨æ–°å¹€ï¼‰\n  if (imageSegmenter && CONFIG.SEGMENTATION.ENABLED) {\n    if (videoEl.currentTime !== lastVideoTime) {\n      lastVideoTime = videoEl.currentTime;\n      try {\n        const result = imageSegmenter.segmentForVideo\n          ? imageSegmenter.segmentForVideo(videoDrawCanvas, now)\n          : await imageSegmenter.segment(videoDrawCanvas);\n        if (result) {\n          let maskF32 = null,\n            mw = 0,\n            mh = 0;\n          if (result.confidenceMasks && result.confidenceMasks.length) {\n            const idx =\n              personLabelIndex < result.confidenceMasks.length\n                ? personLabelIndex\n                : 0;\n            const cm = result.confidenceMasks[idx];\n            if (cm?.getAsFloat32Array) {\n              const src = cm.getAsFloat32Array();\n              maskF32 = new Float32Array(src.length);\n              maskF32.set(src);\n              mw = cm.width;\n              mh = cm.height;\n            }\n            for (const m of result.confidenceMasks) {\n              try {\n                m?.close?.();\n              } catch {}\n            }\n          } else if (result.categoryMask?.getAsUint8Array) {\n            const cat = result.categoryMask;\n            const u8 = cat.getAsUint8Array();\n            maskF32 = new Float32Array(u8.length);\n            mw = cat.width;\n            mh = cat.height;\n            const personIdx = personLabelIndex;\n            for (let i = 0; i < u8.length; i++)\n              maskF32[i] = u8[i] === personIdx ? 1 : 0;\n            try {\n              cat.close?.();\n            } catch {}\n          }\n          if (maskF32 && mw && mh) {\n            const sm = emaUpdate(maskF32, mw, mh);\n            gMaskCanvasProcessed = buildAlphaImage(sm, mw, mh);\n          }\n        }\n      } catch (e) {\n        console.warn(\"segmentForVideo error:\", e);\n      }\n    }\n  } else {\n    gMaskCanvasProcessed = null;\n  }\n\n  // compositeï¼šå…ˆæŠŠäººç‰©åˆæˆåˆ°é›¢å±ï¼Œå†ç•«å› outCanvasï¼ˆé¿å…ç ´å£èƒŒæ™¯ï¼‰\n  compositeCtx.clearRect(0, 0, W, H);\n  compositeCtx.save();\n  compositeCtx.drawImage(videoDrawCanvas, 0, 0, W, H);\n  if (gMaskCanvasProcessed) {\n    compositeCtx.globalCompositeOperation = \"destination-in\";\n    compositeCtx.drawImage(gMaskCanvasProcessed, 0, 0, W, H);\n    compositeCtx.globalCompositeOperation = \"source-over\";\n  }\n  compositeCtx.restore();\n\n  // ä»¥é¡åƒæ–¹å¼ç¹ªå›ï¼ˆèˆ‡åŸæœ¬ä¸€è‡´ï¼‰\n  outCtx.save();\n  outCtx.translate(W, 0);\n  outCtx.scale(-1, 1);\n  outCtx.drawImage(compositeCanvas, 0, 0, W, H);\n  outCtx.restore();\n\n  // Mask é è¦½\n  maskCtx.clearRect(0, 0, W, H);\n  if (gMaskCanvasProcessed && _showMaskPreview) {\n    maskCtx.globalAlpha = 0.9;\n    maskCtx.drawImage(gMaskCanvasProcessed, 0, 0, W, H);\n    maskCtx.globalAlpha = 1.0;\n    maskCanvas.style.display = \"block\";\n  } else {\n    maskCanvas.style.display = \"none\";\n  }\n\n  // è‡‰éƒ¨æª¢æ¸¬\n  if (faceDetector) {\n    try {\n      const det = faceDetector.detectForVideo\n        ? faceDetector.detectForVideo(videoDrawCanvas, now)\n        : null;\n      if (det) renderOverlay(det.detections || []);\n    } catch (e) {\n      console.warn(\"faceDetector error:\", e);\n    }\n  }\n\n  requestAnimationFrame(renderLoop);\n}\n\n// -----------------------------------------------------------------------------\n// å…¬é–‹ APIï¼šstart/stop/onResize & åƒæ•¸ setters\n// -----------------------------------------------------------------------------\nexport async function start() {\n  if (running) return;\n  const ok = initializeConfig();\n  if (!ok) {\n    onStatus(\"é…ç½®éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°\");\n    return;\n  }\n  onStatus(\"åˆå§‹åŒ–...\");\n  await ensureTasksVisionLoaded();\n  await initTasks();\n  await startCamera();\n  running = true;\n  onStatus(\"æª¢æ¸¬ä¸­\");\n  requestAnimationFrame(renderLoop);\n}\n\nexport function stop() {\n  running = false;\n  try {\n    if (stream) stream.getTracks().forEach((t) => t.stop());\n  } catch {}\n  if (outCtx && maskCtx && bgCtx) {\n    outCtx.clearRect(0, 0, outCanvas.width, outCanvas.height);\n    maskCtx.clearRect(0, 0, maskCanvas.width, maskCanvas.height);\n    bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height);\n  }\n  onStats({ faceCount: 0, facesInArea: 0, moonActive: false });\n  onStatus(\"å·²åœæ­¢\");\n}\n\nexport function onResize() {\n  if (running) syncCanvasSize();\n}\n\n// setters\nlet _showMaskPreview = false;\nexport function setShowMaskPreview(v) {\n  _showMaskPreview = !!v;\n}\nexport function setEnableSegmentation(v) {\n  CONFIG.SEGMENTATION.ENABLED = !!v;\n}\nexport function setBackgroundType(t) {\n  CONFIG.BACKGROUND.TYPE = t;\n}\nexport function setBackgroundIntensity(p01) {\n  CONFIG.BACKGROUND.INTENSITY = Math.max(0, Math.min(1, p01));\n}\nexport function setEdgeFeather(px) {\n  CONFIG.SMOOTHING.EDGE_FEATHER_PX = Math.max(0, Number(px) || 0);\n}\nexport function setTemporalAlpha(v01) {\n  CONFIG.SMOOTHING.TEMPORAL_ALPHA = Math.max(\n    0,\n    Math.min(0.95, Number(v01) || 0)\n  );\n}\nexport function setThreshold(v01) {\n  CONFIG.SMOOTHING.THRESHOLD = Math.max(0, Math.min(1, Number(v01) || 0));\n}\n\n// ç‚ºäº†å‘å¾Œç›¸å®¹ï¼Œä¿ç•™ GIF ç›¸é—œ setterï¼ˆno-opï¼‰ï¼Œä½ ä¹‹å¾Œå¯ä»¥å®Œå…¨ç§»é™¤\nexport function setGifBlendMode(mode) {\n  // no-op: GIF åŠŸèƒ½å·²ç§»é™¤æ–¼ core\n  CONFIG.BACKGROUND.GIF_BLEND_MODE = mode;\n}\nexport function setShouldGenerateGif(value) {\n  // no-op\n  return;\n}\n\n// ä¾¿åˆ©ï¼šæä¾›ç›®å‰æ˜¯å¦åœ¨è·‘\nexport function isRunning() {\n  return running;\n}\n\n// -----------------------------------------------------------------------------\n// æ‹ç…§åŠŸèƒ½ï¼ˆä¸åŒ…å« GIF æµç¨‹ï¼‰\n// -----------------------------------------------------------------------------\nexport async function capturePhoto() {\n  if (!outCanvas || !running) {\n    console.warn(\"ç„¡æ³•æ‹ç…§ï¼šç›¸æ©Ÿæœªå•Ÿå‹•æˆ–ç•«å¸ƒä¸å­˜åœ¨\");\n    return null;\n  }\n\n  try {\n    // å‰µå»ºä¸€å€‹æ–°çš„ canvas ä¾†åˆæˆæœ€çµ‚åœ–åƒ\n    const captureCanvas = document.createElement(\"canvas\");\n    const captureCtx = captureCanvas.getContext(\"2d\");\n\n    // è¨­å®šæ‹ç…§å°ºå¯¸ï¼ˆä½¿ç”¨ç•¶å‰æ¸²æŸ“å°ºå¯¸ï¼‰\n    const W = outCanvas.width;\n    const H = outCanvas.height;\n    captureCanvas.width = W;\n    captureCanvas.height = H;\n\n    // æª¢æŸ¥èƒŒæ™¯é¡å‹\n    const bgType = CONFIG.BACKGROUND && CONFIG.BACKGROUND.TYPE;\n    console.log(\"ğŸ“¸ æ‹ç…§æª¢æŸ¥èƒŒæ™¯é¡å‹:\", { bgType, hasMoonVideo: !!bgMoonVideoEl });\n\n    if ((bgType === \"moon_video\" || bgType === \"custom_moon_bg\") && bgMoonVideoEl) {\n      // æœˆç›¸å½±ç‰‡æ¨¡å¼ï¼šéœæ­¢äººç‰© + å‹•æ…‹å½±ç‰‡èƒŒæ™¯ â†’ 8ç§’å½±ç‰‡\n      console.log(\"ğŸŒ™ æœˆç›¸å½±ç‰‡æ¨¡å¼ï¼šç”Ÿæˆ 8 ç§’å‹•æ…‹å½±ç‰‡...\");\n\n      // 1. å…ˆç¹ªè£½ç•¶å‰ç•«é¢ä½œç‚ºéœæ­¢äººç‰© (outCanvas å·²åŒ…å«å‰æ™¯èˆ‡èƒŒæ™¯)\n      captureCtx.drawImage(outCanvas, 0, 0, W, H);\n\n      // 2. ç”Ÿæˆéœæ­¢äººç‰©çš„ PNG ä½œç‚ºåŸºç¤\n      const staticPersonDataURL = captureCanvas.toDataURL(\"image/png\", 1.0);\n\n      // 3. é–‹å§‹éŒ„è£½ 8 ç§’å‹•æ…‹å½±ç‰‡\n      try {\n        const result = await generateVideoWithStaticPerson(staticPersonDataURL, W, H);\n        console.log(\"âœ… å½±ç‰‡ç”Ÿæˆå®Œæˆ:\", result);\n        return result;\n      } catch (error) {\n        console.error(\"âŒ å½±ç‰‡ç”Ÿæˆå¤±æ•—:\", error);\n        // å¦‚æœå½±ç‰‡ç”Ÿæˆå¤±æ•—ï¼Œå›é€€åˆ° PNG æ¨¡å¼\n        const dataURL = captureCanvas.toDataURL(\"image/png\", 1.0);\n        const timestamp = new Date()\n          .toISOString()\n          .replace(/[:]/g, \"-\")\n          .split(\".\")[0];\n        const pngLink = document.createElement(\"a\");\n        const pngFilename = `æœˆäº®ç¯€ARæ‹ç…§_${timestamp}.png`;\n        pngLink.download = pngFilename;\n        pngLink.href = dataURL;\n        document.body.appendChild(pngLink);\n        pngLink.click();\n        document.body.removeChild(pngLink);\n        return { png: dataURL, error: \"å½±ç‰‡ç”Ÿæˆå¤±æ•—ï¼Œå·²ä¿å­˜ç‚ºåœ–ç‰‡\" };\n      }\n    } else {\n      // ä¸€èˆ¬æ¨¡å¼ï¼šå…ˆèƒŒæ™¯å¾Œäººç‰©\n      captureCtx.drawImage(bgCanvas, 0, 0, W, H);\n      captureCtx.drawImage(outCanvas, 0, 0, W, H);\n    }\n\n    // è½‰æ›ç‚º DataURL\n    const dataURL = captureCanvas.toDataURL(\"image/png\", 1.0);\n    const timestamp = new Date()\n      .toISOString()\n      .replace(/[:]/g, \"-\")\n      .split(\".\")[0];\n\n    // ç¸½æ˜¯å…ˆä¸‹è¼‰ PNG ç‰ˆæœ¬\n    const pngLink = document.createElement(\"a\");\n    const pngFilename = `æœˆäº®ç¯€ARæ‹ç…§_${timestamp}.png`;\n    pngLink.download = pngFilename;\n    pngLink.href = dataURL;\n    document.body.appendChild(pngLink);\n    pngLink.click();\n    document.body.removeChild(pngLink);\n\n    console.log(`ğŸ“¸ PNG æ‹ç…§æˆåŠŸï¼`);\n\n    return { png: dataURL };\n  } catch (error) {\n    console.error(\"æ‹ç…§å¤±æ•—ï¼š\", error);\n    return null;\n  }\n}\n\n// å…¨åŸŸé€²åº¦å›èª¿å‡½æ•¸\nlet recordingProgressCallback = null;\nlet videoOutputFormat = \"mp4\"; // é è¨­ MP4\n\n// è¨­å®šéŒ„è£½é€²åº¦å›èª¿\nexport function setRecordingProgressCallback(callback) {\n  recordingProgressCallback = callback;\n}\n\n// è¨­å®šå½±ç‰‡è¼¸å‡ºæ ¼å¼\nexport function setVideoOutputFormat(format) {\n  videoOutputFormat = format;\n}\n\n// ç”Ÿæˆéœæ­¢äººç‰© + å‹•æ…‹å½±ç‰‡èƒŒæ™¯çš„ 8 ç§’å½±ç‰‡\nasync function generateVideoWithStaticPerson(\n  staticPersonDataURL,\n  width,\n  height\n) {\n  console.log(\"ğŸ¬ é–‹å§‹éŒ„è£½éœæ­¢äººç‰© + å‹•æ…‹èƒŒæ™¯å½±ç‰‡...\");\n\n  try {\n    // æª¢æŸ¥ç€è¦½å™¨æ”¯æ´\n    if (!window.MediaRecorder) {\n      console.warn(\"ç€è¦½å™¨ä¸æ”¯æ´ MediaRecorder\");\n      return { png: staticPersonDataURL, error: \"ç€è¦½å™¨ä¸æ”¯æ´å½±ç‰‡éŒ„è£½\" };\n    }\n\n    // å‰µå»ºéŒ„è£½ç”¨çš„ Canvas - ä¿æŒåŸå§‹æ¯”ä¾‹\n    const recordCanvas = document.createElement(\"canvas\");\n    const recordCtx = recordCanvas.getContext(\"2d\");\n\n    // è¨ˆç®—ä¿æŒæ¯”ä¾‹çš„å°ºå¯¸\n    const maxSize = 640; // æœ€å¤§é‚Šé•·é™åˆ¶\n    const aspectRatio = width / height;\n\n    if (width > height) {\n      // æ©«å‘å½±ç‰‡\n      recordCanvas.width = Math.min(maxSize, width);\n      recordCanvas.height = Math.round(recordCanvas.width / aspectRatio);\n    } else {\n      // ç›´å‘å½±ç‰‡\n      recordCanvas.height = Math.min(maxSize, height);\n      recordCanvas.width = Math.round(recordCanvas.height * aspectRatio);\n    }\n\n    console.log(\n      `éŒ„è£½ Canvas å°ºå¯¸: ${recordCanvas.width}x${\n        recordCanvas.height\n      } (åŸå§‹: ${width}x${height}, æ¯”ä¾‹: ${aspectRatio.toFixed(2)})`\n    );\n\n    // è¼‰å…¥éœæ­¢äººç‰©åœ–ç‰‡\n    const personImg = new Image();\n\n    return new Promise((resolve, reject) => {\n      personImg.onload = async () => {\n        console.log(\"éœæ­¢äººç‰©åœ–ç‰‡è¼‰å…¥å®Œæˆï¼Œé–‹å§‹éŒ„è£½...\");\n\n        // è¨­å®šéŒ„è£½åƒæ•¸ï¼š8 ç§’ï¼Œ20 FPS\n        const DURATION_SECONDS = 8;\n        const FPS = 20;\n        const totalFrames = DURATION_SECONDS * FPS;\n\n        // ç¢ºä¿æœˆç›¸å½±ç‰‡é–‹å§‹æ’­æ”¾\n        if (bgMoonVideoEl && bgMoonVideoEl.paused) {\n          await bgMoonVideoEl\n            .play()\n            .catch((e) => console.warn(\"å½±ç‰‡æ’­æ”¾å¤±æ•—:\", e));\n        }\n\n        // è¨­å®š MediaRecorder\n        const stream = recordCanvas.captureStream(FPS);\n\n        // æ ¹æ“šé¸æ“‡çš„æ ¼å¼è¨­å®š MediaRecorder\n        let recorderOptions;\n        if (videoOutputFormat === \"mp4\") {\n          // MP4 è¨­å®š (ç€è¦½å™¨æ”¯æ´æ€§æœ‰é™)\n          if (MediaRecorder.isTypeSupported(\"video/mp4; codecs=h264\")) {\n            recorderOptions = {\n              mimeType: \"video/mp4; codecs=h264\",\n              videoBitsPerSecond: 3000000, // 3 Mbps\n            };\n          } else if (MediaRecorder.isTypeSupported(\"video/mp4\")) {\n            recorderOptions = {\n              mimeType: \"video/mp4\",\n              videoBitsPerSecond: 3000000,\n            };\n          } else {\n            // é™ç´šåˆ° WebM\n            console.warn(\"ç€è¦½å™¨ä¸æ”¯æ´ MP4ï¼Œé™ç´šåˆ° WebM\");\n            recorderOptions = {\n              mimeType: \"video/webm; codecs=vp8\",\n              videoBitsPerSecond: 3000000,\n            };\n            videoOutputFormat = \"webm\"; // æ›´æ–°æ ¼å¼æ¨™è­˜\n          }\n        } else {\n          // WebM è¨­å®š\n          recorderOptions = {\n            mimeType: \"video/webm; codecs=vp8\",\n            videoBitsPerSecond: 3000000,\n          };\n        }\n\n        const recorder = new MediaRecorder(stream, recorderOptions);\n        console.log(`ğŸ“¹ ä½¿ç”¨æ ¼å¼: ${recorderOptions.mimeType}`);\n\n        const chunks = [];\n        recorder.ondataavailable = (event) => {\n          if (event.data.size > 0) {\n            chunks.push(event.data);\n          }\n        };\n\n        recorder.onstop = () => {\n          const mimeType =\n            videoOutputFormat === \"mp4\" ? \"video/mp4\" : \"video/webm\";\n          const extension = videoOutputFormat === \"mp4\" ? \"mp4\" : \"webm\";\n          const blob = new Blob(chunks, { type: mimeType });\n\n          const timestamp = new Date()\n            .toISOString()\n            .replace(/[:]/g, \"-\")\n            .split(\".\")[0];\n          const filename = `æœˆäº®ç¯€AR_æœˆç›¸å½±ç‰‡_${timestamp}.${extension}`;\n\n          // å„²å­˜ blob & filenameï¼ˆç”± core ç®¡ç† objectURLï¼‰\n          const storedUrl = storeRecordingBlob(blob, filename);\n\n          // è§¸ç™¼å›å‘¼é€šçŸ¥ UIï¼šå¯åœ¨ UI é¡¯ç¤ºã€Œåˆ†äº«ã€æŒ‰éˆ•èˆ‡ã€Œä¸‹è¼‰ã€æŒ‰éˆ•\n          if (typeof onStatus === \"function\") {\n            onStatus(\"å½±ç‰‡å·²ç”Ÿæˆï¼Œå¯æŒ‰ åˆ†äº« æˆ– ä¸‹è¼‰\");\n          }\n          if (typeof onStats === \"function\") {\n            // optional: å‚³å› video blob info çµ¦ UI\n            onStats({\n              lastVideoUrl: storedUrl,\n              lastVideoFilename: filename,\n            });\n          }\n\n          // resolve ä¸¦å›å‚³ç”± core ç®¡ç†çš„ URL\n          resolve({\n            png: staticPersonDataURL,\n            video: storedUrl,\n            duration: DURATION_SECONDS,\n            format: extension,\n            saved: true,\n          });\n        };\n\n        recorder.onerror = (event) => {\n          console.error(\"éŒ„è£½éŒ¯èª¤:\", event.error);\n          reject(event.error);\n        };\n\n        // é–‹å§‹éŒ„è£½\n        recorder.start();\n        console.log(`é–‹å§‹éŒ„è£½ ${DURATION_SECONDS} ç§’å½±ç‰‡...`);\n\n        // åˆå§‹åŒ–é€²åº¦ç‹€æ…‹\n        if (recordingProgressCallback) {\n          recordingProgressCallback.setStatus(\"é–‹å§‹éŒ„è£½...\");\n          recordingProgressCallback.updateProgress(0, DURATION_SECONDS);\n        }\n\n        let frame = 0;\n\n        // é€å¹€ç¹ªè£½å‡½æ•¸\n        function drawFrame() {\n          // æ¸…é™¤ç•«å¸ƒ\n          recordCtx.clearRect(0, 0, recordCanvas.width, recordCanvas.height);\n\n          // 1. ç¹ªè£½èƒŒæ™¯ï¼ˆæ ¹æ“šé¡å‹æ±ºå®šï¼‰\n          const bgType = CONFIG.BACKGROUND && CONFIG.BACKGROUND.TYPE;\n          const intensity = CONFIG.BACKGROUND.INTENSITY || 0.5;\n          \n          // æ ¹æ“šç•¶å‰èƒŒæ™¯é¡å‹ç¹ªè£½èƒŒæ™¯\n          if (bgType === \"custom_moon_bg\" && customBackgroundImage) {\n            // è‡ªå®šç¾©èƒŒæ™¯åœ–ç‰‡\n            const imgW = customBackgroundImage.naturalWidth || customBackgroundImage.width;\n            const imgH = customBackgroundImage.naturalHeight || customBackgroundImage.height;\n            if (imgW > 0 && imgH > 0) {\n              const scale = Math.max(recordCanvas.width / imgW, recordCanvas.height / imgH);\n              const dw = Math.round(imgW * scale);\n              const dh = Math.round(imgH * scale);\n              const ox = Math.round((recordCanvas.width - dw) / 2);\n              const oy = Math.round((recordCanvas.height - dh) / 2);\n              recordCtx.drawImage(customBackgroundImage, 0, 0, imgW, imgH, ox, oy, dw, dh);\n            }\n          } else if (bgType === \"video\" && bgVideoEl && bgVideoEl.readyState >= 2) {\n            // èƒŒæ™¯å½±ç‰‡\n            const vw = bgVideoEl.videoWidth || 1;\n            const vh = bgVideoEl.videoHeight || 1;\n            const scale = Math.max(recordCanvas.width / vw, recordCanvas.height / vh);\n            const dw = Math.round(vw * scale);\n            const dh = Math.round(vh * scale);\n            const ox = Math.round((recordCanvas.width - dw) / 2);\n            const oy = Math.round((recordCanvas.height - dh) / 2);\n            recordCtx.globalAlpha = Math.min(1, 0.3 + intensity * 0.7);\n            recordCtx.drawImage(bgVideoEl, 0, 0, vw, vh, ox, oy, dw, dh);\n            recordCtx.globalAlpha = 1;\n          }\n          \n          // ç¬¬äºŒå±¤ï¼šæœˆäº®å½±ç‰‡è™•ç†ï¼ˆæ ¹æ“šèƒŒæ™¯é¡å‹å’Œè¨­å‚™ï¼‰\n          const needsMoonLayer = (bgType === \"custom_moon_bg\" || bgType === \"moon_video\");\n          \n          if (needsMoonLayer) {\n            // iOS è¨­å‚™å„ªå…ˆä½¿ç”¨é€æ˜ MOVï¼Œå¦‚æœä¸å¯ç”¨å‰‡ä½¿ç”¨èƒŒæ™¯ MOV å…¨è¢å¹•\n            if (isIOSDevice) {\n              // iOS è¨­å‚™ï¼šå˜—è©¦ä½¿ç”¨é€æ˜ MOV\n              if (iosMoonVideoEl && iosMoonVideoEl.readyState >= 2 && iosMoonVideoEl.videoWidth > 0) {\n                // ä½¿ç”¨ iOS é€æ˜ MOV å…¨è¢å¹•\n                const vw = iosMoonVideoEl.videoWidth;\n                const vh = iosMoonVideoEl.videoHeight;\n                const scale = Math.max(recordCanvas.width / vw, recordCanvas.height / vh);\n                const dw = Math.round(vw * scale);\n                const dh = Math.round(vh * scale);\n                const ox = Math.round((recordCanvas.width - dw) / 2);\n                const oy = Math.round((recordCanvas.height - dh) / 2);\n                \n                recordCtx.globalAlpha = Math.min(1, 0.8 + intensity * 0.2);\n                recordCtx.drawImage(iosMoonVideoEl, 0, 0, vw, vh, ox, oy, dw, dh);\n                recordCtx.globalAlpha = 1;\n              } else if (bgMoonVideoEl && bgMoonVideoEl.readyState >= 2) {\n                // iOS fallbackï¼šä½¿ç”¨èƒŒæ™¯æœˆäº® MOV å…¨è¢å¹•ï¼ˆç„¡é®ç½©ï¼‰\n                const vw = bgMoonVideoEl.videoWidth || bgMoonVideoEl.width || 1;\n                const vh = bgMoonVideoEl.videoHeight || bgMoonVideoEl.height || 1;\n                const scale = Math.max(recordCanvas.width / vw, recordCanvas.height / vh);\n                const dw = Math.round(vw * scale);\n                const dh = Math.round(vh * scale);\n                const ox = Math.round((recordCanvas.width - dw) / 2);\n                const oy = Math.round((recordCanvas.height - dh) / 2);\n                \n                recordCtx.globalAlpha = Math.min(1, 0.8 + intensity * 0.2);\n                recordCtx.drawImage(bgMoonVideoEl, 0, 0, vw, vh, ox, oy, dw, dh);\n                recordCtx.globalAlpha = 1;\n              }\n            } else if (bgMoonVideoEl && bgMoonVideoEl.readyState >= 2) {\n              // é iOS: ä½¿ç”¨åœ“å½¢è£å‰ª MP4\n              const vw = bgMoonVideoEl.videoWidth || bgMoonVideoEl.width || 1;\n              const vh = bgMoonVideoEl.videoHeight || bgMoonVideoEl.height || 1;\n              \n              if (vw > 1 && vh > 1) {\n                recordCtx.save();\n                \n                // éŸ¿æ‡‰å¼åœ“å½¢è£å‰ªè·¯å¾‘è¨ˆç®—\n                const aspectRatio = recordCanvas.width / recordCanvas.height;\n                let centerX, centerY, radius;\n                \n                if (aspectRatio > 0.6) {\n                  centerX = recordCanvas.width * 0.5;\n                  centerY = recordCanvas.height * 0.35;\n                  radius = Math.min(recordCanvas.width, recordCanvas.height) * 0.25;\n                } else if (aspectRatio > 0.5) {\n                  centerX = recordCanvas.width * 0.51;\n                  centerY = recordCanvas.height * 0.29;\n                  radius = Math.min(recordCanvas.width, recordCanvas.height) * 0.29;\n                } else {\n                  centerX = recordCanvas.width * 0.51;\n                  centerY = recordCanvas.height * 0.26;\n                  radius = Math.min(recordCanvas.width, recordCanvas.height) * 0.30;\n                }\n                \n                recordCtx.beginPath();\n                recordCtx.arc(centerX, centerY, radius, 0, 2 * Math.PI);\n                recordCtx.clip();\n                \n                const scale = Math.max(recordCanvas.width / vw, recordCanvas.height / vh);\n                const dw = Math.round(vw * scale);\n                const dh = Math.round(vh * scale);\n                const ox = Math.round((recordCanvas.width - dw) / 2);\n                const oy = Math.round((recordCanvas.height - dh) / 2);\n                \n                recordCtx.globalAlpha = Math.min(1, 0.8 + intensity * 0.2);\n                recordCtx.drawImage(bgMoonVideoEl, 0, 0, vw, vh, ox, oy, dw, dh);\n                recordCtx.globalAlpha = 1;\n                \n                recordCtx.restore();\n              }\n            }\n          } else if (bgMoonVideoEl && bgMoonVideoEl.readyState >= 2) {\n            // åŸå§‹æœˆç›¸å½±ç‰‡èƒŒæ™¯æ¨¡å¼\n            const vw = bgMoonVideoEl.videoWidth || bgMoonVideoEl.width || 1;\n            const vh = bgMoonVideoEl.videoHeight || bgMoonVideoEl.height || 1;\n            if (vw > 1 && vh > 1) {\n              const scale = Math.max(recordCanvas.width / vw, recordCanvas.height / vh);\n              const dw = Math.round(vw * scale);\n              const dh = Math.round(vh * scale);\n              const ox = Math.round((recordCanvas.width - dw) / 2);\n              const oy = Math.round((recordCanvas.height - dh) / 2);\n\n              recordCtx.globalAlpha = Math.min(1, 0.3 + intensity * 0.7);\n              recordCtx.drawImage(bgMoonVideoEl, 0, 0, vw, vh, ox, oy, dw, dh);\n              recordCtx.globalAlpha = 1;\n            }\n          }\n\n          // 2. ç¹ªè£½éœæ­¢äººç‰©ï¼ˆå‰æ™¯ï¼‰- ä¿æŒåŸå§‹æ¯”ä¾‹\n          const personWidth = personImg.naturalWidth || personImg.width;\n          const personHeight = personImg.naturalHeight || personImg.height;\n\n          if (personWidth > 0 && personHeight > 0) {\n            // è¨ˆç®—äººç‰©åœ–ç‰‡çš„ç¸®æ”¾ï¼Œä¿æŒæ¯”ä¾‹ä¸¦å®Œå…¨è¦†è“‹ç•«é¢\n            const personScaleX = recordCanvas.width / personWidth;\n            const personScaleY = recordCanvas.height / personHeight;\n            const personScale = Math.max(personScaleX, personScaleY); // cover æ¨¡å¼\n\n            const personDrawWidth = Math.round(personWidth * personScale);\n            const personDrawHeight = Math.round(personHeight * personScale);\n            const personOffsetX = Math.round(\n              (recordCanvas.width - personDrawWidth) / 2\n            );\n            const personOffsetY = Math.round(\n              (recordCanvas.height - personDrawHeight) / 2\n            );\n\n            recordCtx.drawImage(\n              personImg,\n              0,\n              0,\n              personWidth,\n              personHeight,\n              personOffsetX,\n              personOffsetY,\n              personDrawWidth,\n              personDrawHeight\n            );\n          } else {\n            // å‚™ç”¨æ–¹æ¡ˆï¼šç›´æ¥æ‹‰ä¼¸\n            recordCtx.drawImage(\n              personImg,\n              0,\n              0,\n              recordCanvas.width,\n              recordCanvas.height\n            );\n          }\n\n          frame++;\n\n          // æ›´æ–°é€²åº¦åˆ° UI\n          const currentTime = frame / FPS;\n          if (recordingProgressCallback) {\n            recordingProgressCallback.updateProgress(\n              currentTime,\n              DURATION_SECONDS\n            );\n          }\n\n          // ç¹¼çºŒä¸‹ä¸€å¹€æˆ–çµæŸéŒ„è£½\n          if (frame < totalFrames) {\n            setTimeout(drawFrame, 1000 / FPS);\n          } else {\n            if (recordingProgressCallback) {\n              recordingProgressCallback.setStatus(\"éŒ„è£½å®Œæˆï¼Œæ­£åœ¨ç”Ÿæˆæª”æ¡ˆ...\");\n            }\n            recorder.stop();\n            console.log(\"æ‰€æœ‰å¹€éŒ„è£½å®Œæˆ\");\n          }\n        }\n\n        // é–‹å§‹ç¹ªè£½ç¬¬ä¸€å¹€\n        drawFrame();\n      };\n\n      personImg.onerror = () => {\n        reject(new Error(\"éœæ­¢äººç‰©åœ–ç‰‡è¼‰å…¥å¤±æ•—\"));\n      };\n\n      personImg.src = staticPersonDataURL;\n    });\n  } catch (error) {\n    console.error(\"å½±ç‰‡ç”ŸæˆéŒ¯èª¤:\", error);\n    return { png: staticPersonDataURL, error: error.message };\n  }\n}\n\n// å˜—è©¦ä½¿ç”¨ Web Share API åˆ†äº« Blobï¼ˆè‹¥æ”¯æ´æª”æ¡ˆåˆ†äº«ï¼‰\n// é€™æ˜¯å…§éƒ¨å·¥å…·å‡½å¼ï¼ˆUI æ‡‰ä½¿ç”¨ shareLastRecordingï¼‰\nasync function tryShareBlob(\n  blob,\n  filename,\n  title = \"æœˆäº®ç¯€ AR å½±ç‰‡\",\n  text = \"\"\n) {\n  try {\n    const file = new File([blob], filename, { type: blob.type || \"video/mp4\" });\n\n    if (navigator.share && navigator.canShare) {\n      if (navigator.canShare({ files: [file] })) {\n        await navigator.share({ files: [file], title, text });\n        return { ok: true, method: \"webshare\" };\n      }\n      return { ok: false, reason: \"canShare-false\" };\n    }\n\n    // è‹¥æ²’æœ‰ canShareï¼ˆæˆ–åªæ”¯æ´ url/textï¼‰ï¼Œè¦–ç‚ºä¸æ”¯æ´æª”æ¡ˆåˆ†äº«\n    return { ok: false, reason: \"no-file-share-support\" };\n  } catch (err) {\n    console.warn(\"tryShareBlob error\", err);\n    return { ok: false, reason: \"error\", error: err };\n  }\n}\n"],"names":["CONFIG","lastRecordedBlob","lastRecordedFilename","lastRecordedObjectUrl","_revokeLastObjectUrl","storeRecordingBlob","blob","filename","e","hasRecordingAvailable","getLastRecordingUrl","clearLastRecording","getLastRecordingFilename","uploadBlobToServerAndGetUrl","fd","res","j","shareLastRecording","file","err","url","imageSegmenter","faceDetector","wasmFileset","running","stream","currentFacingMode","lastFaceDetectionState","videoEl","bgCanvas","maskCanvas","outCanvas","bgVideoEl","bgMoonVideoEl","iosMoonVideoEl","bgCtx","maskCtx","outCtx","customBackgroundImage","isIOSDevice","onStatus","t","onStats","stats","personLabelIndex","lastMaskF32","lastMaskSize","gMaskCanvasProcessed","videoDrawCanvas","videoDrawCtx","compositeCanvas","compositeCtx","maskBaseCanvas","maskBaseCtx","maskUpscaleCanvas","maskUpscaleCtx","maskSoftCanvas","maskSoftCtx","animT","lastVideoTime","autoAdjustConfig","isMobile","isLowEnd","validateConfig","_a","errors","saveConfig","resetConfig","loadCustomConfig","c","initializeConfig","errs","initCore","els","callbacks","loadCustomBackground","img","base","ensureTasksVisionLoaded","urls","mod","initTasks","rect","baseOptions","startCamera","constraints","resolve","syncCanvasSize","switchCamera","w","h","renderBackgroundTo","ctx","bgType","intensity","grad","i","x","off","y","bands","bw","bh","hue","vw","vh","scale","dw","dh","ox","oy","imgW","imgH","aspectRatio","centerX","centerY","radius","renderBackground","emaUpdate","srcF32","N","a","buildAlphaImage","maskF32","T","v","VW","VH","blurPx","renderOverlay","detections","W","facesIn","currentFaceDetectionState","renderLoop","_b","_c","now","H","result","mw","mh","idx","cm","src","m","cat","u8","personIdx","sm","_showMaskPreview","det","start","stop","onResize","setShowMaskPreview","setEnableSegmentation","setBackgroundType","setBackgroundIntensity","p01","setEdgeFeather","px","setTemporalAlpha","v01","setThreshold","setGifBlendMode","mode","setShouldGenerateGif","value","isRunning","capturePhoto","captureCanvas","captureCtx","staticPersonDataURL","generateVideoWithStaticPerson","error","dataURL","timestamp","pngLink","pngFilename","recordingProgressCallback","videoOutputFormat","setRecordingProgressCallback","callback","setVideoOutputFormat","format","width","height","recordCanvas","recordCtx","maxSize","personImg","reject","DURATION_SECONDS","FPS","totalFrames","recorderOptions","recorder","chunks","event","mimeType","extension","storedUrl","frame","drawFrame","personWidth","personHeight","personScaleX","personScaleY","personScale","personDrawWidth","personDrawHeight","personOffsetX","personOffsetY","currentTime"],"mappings":"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"}