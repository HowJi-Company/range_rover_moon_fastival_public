{"version":3,"file":"segmentationCore-D-BsGSmK.js","sources":["../../src/segmentationCore.js"],"sourcesContent":["// segmentationCore.js\n// 影像處理 / 去背核心模組（ESM）\n// - 封裝 MediaPipe ImageSegmenter / FaceDetector 初始化、相機控制、渲染迴圈\n// - 對外提供：initCore(), start(), stop(), switchCamera(), onResize(), setters\n//   以及 CONFIG / saveConfig() / resetConfig() / initializeConfig()\n// - 由外部 UI 模組（uiController.js）負責綁定按鈕、滑桿、選單與顯示數值\n\n// -----------------------------------------------------------------------------\n// 公開設定（沿用使用者原本 CONFIG，僅做少數向後相容補位）\n// -----------------------------------------------------------------------------\nexport const CONFIG = {\n  FACE_DETECTION: {\n    MODEL: \"short\",\n    MIN_DETECTION_CONFIDENCE: 0.5,\n    MAX_FACES: 10,\n  },\n  SEGMENTATION: {\n    ENABLED: true,\n    MODEL_SELECTION: 1, // 1 => landscape\n    SELFIE_MODE: true,\n    SEGMENTATION_THRESHOLD: 0.1,\n  },\n  FACE_DETECTION_SETTINGS: {\n    REQUIRED_FACES: 1,\n  },\n  CAMERA: {\n    DEFAULT_WIDTH: 640,\n    DEFAULT_HEIGHT: 480,\n    DEFAULT_FACING_MODE: \"user\",\n    FRAME_RATE: 30,\n  },\n  UI: {\n    STATUS_UPDATE_INTERVAL: 100,\n    SHOW_DEBUG_INFO: true,\n    SHOW_FPS: false,\n    LANGUAGE: \"zh-TW\",\n  },\n  EFFECTS: {\n    MOON_EFFECT_DURATION: 3000,\n    FADE_DURATION: 800,\n    ENABLE_SOUND: false,\n    MOON_SIZE_SCALE: 1.0,\n    STAR_COUNT: 5,\n    SPARKLE_COUNT: 3,\n  },\n  BACKGROUND_EFFECTS: {\n    DEFAULT_BACKGROUND: \"moon_video\",\n    WAVE_EFFECT: { AMPLITUDE: 10, FREQUENCY: 0.02, SPEED: 0.05 },\n    FREQUENCY_EFFECT: { BANDS: 32, HEIGHT_SCALE: 0.8, COLOR_SHIFT: 0.01 },\n    EFFECT_INTENSITY: 0.5,\n    BLEND_MODE: \"source-over\",\n  },\n  PERFORMANCE: {\n    ENABLE_MONITORING: false,\n    MAX_LATENCY: 100,\n    LOW_PERFORMANCE_MODE: false,\n    AUTO_ADJUST_PERFORMANCE: true,\n  },\n  DEBUG: {\n    VERBOSE_LOGGING: false,\n    SHOW_FACE_LANDMARKS: false,\n    SAVE_DETECTION_RESULTS: false,\n  },\n  ADVANCED: {\n    MEDIAPIPE_BASE_URL:\n      \"https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/\",\n    MEDIAPIPE_SEGMENTATION_URL:\n      \"https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/\",\n    USE_WEB_WORKERS: false,\n    MEMORY_LIMIT: 512,\n    ENABLE_ERROR_REPORTING: true,\n  },\n};\n\n// 讓背景設定存在（避免 undefined）\nCONFIG.BACKGROUND = CONFIG.BACKGROUND || {\n  TYPE:\n    (CONFIG.BACKGROUND_EFFECTS &&\n      CONFIG.BACKGROUND_EFFECTS.DEFAULT_BACKGROUND) ||\n    \"original\",\n  INTENSITY:\n    (CONFIG.BACKGROUND_EFFECTS && CONFIG.BACKGROUND_EFFECTS.EFFECT_INTENSITY) ??\n    0.5,\n  GIF_BLEND_MODE: \"overlay\", // 仍保留欄位以向後相容（但會無效）\n};\n\n// ---- Recording storage & share helper (統一管理) ----\n\n// 儲存最後一次錄製的 Blob / filename / objectURL（由 core 管理）\nlet lastRecordedBlob = null;\nlet lastRecordedFilename = null;\nlet lastRecordedObjectUrl = null;\n\nfunction _revokeLastObjectUrl() {\n  try {\n    if (lastRecordedObjectUrl) {\n      URL.revokeObjectURL(lastRecordedObjectUrl);\n      lastRecordedObjectUrl = null;\n    }\n  } catch (e) {\n    console.warn(\"revoke failed\", e);\n  }\n}\n\n/**\n * 儲存 Blob 並建立 objectURL（由 core 呼叫）\n * 回傳建立的 objectURL（或 null）\n */\nexport function storeRecordingBlob(blob, filename) {\n  if (!blob) return null;\n  // 清理舊的 objectURL\n  _revokeLastObjectUrl();\n  lastRecordedBlob = blob;\n  lastRecordedFilename = filename || `moonAR_${Date.now()}.webm`;\n  try {\n    lastRecordedObjectUrl = URL.createObjectURL(blob);\n  } catch (e) {\n    console.warn(\"createObjectURL failed\", e);\n    lastRecordedObjectUrl = null;\n  }\n  return lastRecordedObjectUrl;\n}\n\n/** UI 用：是否有錄影檔可用 */\nexport function hasRecordingAvailable() {\n  return !!lastRecordedBlob;\n}\n\n/** UI 用：取得 core 管理的 objectURL（不要在外面再 createObjectURL） */\nexport function getLastRecordingUrl() {\n  return lastRecordedObjectUrl || null;\n}\n\n/** UI 用：清除最後一次錄影的暫存（core 會 revoke） */\nexport function clearLastRecording() {\n  _revokeLastObjectUrl();\n  lastRecordedBlob = null;\n  lastRecordedFilename = null;\n}\n\n/** 取得最後錄影檔名 */\nexport function getLastRecordingFilename() {\n  return lastRecordedFilename;\n}\n\n// 上傳 stub（請替換成你自己的後端或雲端上傳實作）\n// 回傳公開可存取的 url 字串\nexport async function uploadBlobToServerAndGetUrl(blob, filename) {\n  // 範例：呼叫 /api/upload (form-data: file)\n  const fd = new FormData();\n  fd.append(\"file\", blob, filename);\n  const res = await fetch(\"/api/upload\", { method: \"POST\", body: fd });\n  if (!res.ok) throw new Error(\"upload failed\");\n  const j = await res.json();\n  if (!j?.url) throw new Error(\"upload response missing url\");\n  return j.url;\n}\n\n// 實際分享函式：必須在「使用者手勢」中呼叫（例如按鈕 onclick）\n// 這個函式會嘗試：1) Web Share API 分享檔案；2) 上傳並分享 URL；3) 拋錯由 UI 處理\nexport async function shareLastRecording() {\n  if (!lastRecordedBlob) throw new Error(\"no recording available\");\n  const filename = lastRecordedFilename || `moonAR_${Date.now()}.mp4`;\n  const file = new File([lastRecordedBlob], filename, {\n    type: lastRecordedBlob.type || \"video/mp4\",\n  });\n\n  // 優先嘗試檔案分享（Level 2）\n  try {\n    if (navigator.canShare && navigator.canShare({ files: [file] })) {\n      await navigator.share({\n        files: [file],\n        title: \"月亮節 AR 影片\",\n        text: \"分享給你\",\n      });\n      return { ok: true, method: \"webshare\" };\n    }\n  } catch (err) {\n    console.warn(\"Web Share file error:\", err);\n    // 繼續嘗試上傳分享 URL\n  }\n\n  // 若檔案分享不支援或失敗 -> 嘗試上傳並分享 URL\n  try {\n    const url = await uploadBlobToServerAndGetUrl(lastRecordedBlob, filename);\n    if (navigator.share) {\n      try {\n        await navigator.share({\n          title: \"月亮節 AR 影片\",\n          text: \"看這個影片：\",\n          url,\n        });\n        return { ok: true, method: \"url-share\", url };\n      } catch (err) {\n        console.warn(\"Web Share URL error:\", err);\n      }\n    }\n    // 若不能直接呼叫 navigator.share，回傳 url 給 UI 顯示複製\n    return { ok: true, method: \"uploaded\", url };\n  } catch (err) {\n    console.warn(\"upload failed:\", err);\n    throw err; // 由呼叫端（UI）處理 fallback（例如下載）\n  }\n}\n\n// -----------------------------------------------------------------------------\n// 狀態、DOM 參照、回呼\n// -----------------------------------------------------------------------------\nlet imageSegmenter = null;\nlet faceDetector = null;\nlet wasmFileset = null;\nlet running = false;\nlet stream = null;\nlet currentFacingMode = CONFIG.CAMERA.DEFAULT_FACING_MODE || \"user\";\nlet lastFaceDetectionState = false;\n\n// DOM\nlet videoEl, bgCanvas, maskCanvas, outCanvas, bgVideoEl, bgGifEl, bgMoonVideoEl;\nlet bgCtx, maskCtx, outCtx;\n\n// 自定義背景圖片\nlet customBackgroundImage = null;\n\n// Callbacks（由 UI 模組註冊）\nlet onStatus = (t) => {};\nlet onStats = (stats) => {}; // { faceCount, facesInArea, moonActive }\n\n// -----------------------------------------------------------------------------\n// 內部暫存\n// -----------------------------------------------------------------------------\nlet personLabelIndex = 0;\nlet lastMaskF32 = null;\nlet lastMaskSize = { w: 0, h: 0 };\nlet gMaskCanvasProcessed = null;\n\n// offscreen\nconst videoDrawCanvas = document.createElement(\"canvas\");\nconst videoDrawCtx = videoDrawCanvas.getContext(\"2d\");\nvideoDrawCanvas.style.display = \"none\";\n\nconst compositeCanvas = document.createElement(\"canvas\");\nconst compositeCtx = compositeCanvas.getContext(\"2d\");\ncompositeCanvas.style.display = \"none\";\n\n// 蒙版中繼\nconst maskBaseCanvas = document.createElement(\"canvas\");\nconst maskBaseCtx = maskBaseCanvas.getContext(\"2d\");\nconst maskUpscaleCanvas = document.createElement(\"canvas\");\nconst maskUpscaleCtx = maskUpscaleCanvas.getContext(\"2d\");\nconst maskSoftCanvas = document.createElement(\"canvas\");\nconst maskSoftCtx = maskSoftCanvas.getContext(\"2d\");\n\n// 其他\nlet animT = 0;\nlet lastVideoTime = -1;\n\n// -----------------------------------------------------------------------------\n// 工具：裝置自動調整 / 驗證 / 設定持久化\n// -----------------------------------------------------------------------------\nfunction autoAdjustConfig() {\n  const isMobile =\n    /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(\n      navigator.userAgent\n    );\n  const isLowEnd = (navigator.hardwareConcurrency || 4) <= 2;\n\n  if (isMobile) {\n    CONFIG.CAMERA.DEFAULT_WIDTH = 480;\n    CONFIG.CAMERA.DEFAULT_HEIGHT = 360;\n    CONFIG.FACE_DETECTION.MODEL = \"short\";\n    CONFIG.EFFECTS.STAR_COUNT = 3;\n    CONFIG.EFFECTS.SPARKLE_COUNT = 2;\n  }\n  if (isLowEnd) {\n    CONFIG.PERFORMANCE.LOW_PERFORMANCE_MODE = true;\n    CONFIG.FACE_DETECTION.MIN_DETECTION_CONFIDENCE = 0.6;\n    CONFIG.CAMERA.FRAME_RATE = 20;\n    CONFIG.EFFECTS.MOON_SIZE_SCALE = 0.8;\n  }\n}\n\nfunction validateConfig() {\n  const errors = [];\n  if (\n    CONFIG.FACE_DETECTION.MIN_DETECTION_CONFIDENCE < 0 ||\n    CONFIG.FACE_DETECTION.MIN_DETECTION_CONFIDENCE > 1\n  )\n    errors.push(\"MIN_DETECTION_CONFIDENCE 必須在 0~1 之間\");\n\n  if (!navigator.mediaDevices?.getUserMedia) {\n    errors.push(\"瀏覽器不支援相機功能\");\n  }\n  return errors;\n}\n\nexport function saveConfig() {\n  try {\n    localStorage.setItem(\"moonFestivalAR_config\", JSON.stringify(CONFIG));\n  } catch {}\n}\n\nexport function resetConfig() {\n  try {\n    localStorage.removeItem(\"moonFestivalAR_config\");\n  } catch {}\n  location.reload();\n}\n\nfunction loadCustomConfig() {\n  try {\n    const c = localStorage.getItem(\"moonFestivalAR_config\");\n    if (c) Object.assign(CONFIG, JSON.parse(c));\n  } catch {}\n}\n\n// 初始化 / 向後相容補位\nexport function initializeConfig() {\n  loadCustomConfig();\n  autoAdjustConfig();\n\n  // 對應舊欄位\n  CONFIG.CAMERA.WIDTH =\n    CONFIG.CAMERA.DEFAULT_WIDTH || CONFIG.CAMERA.WIDTH || 1280;\n  CONFIG.CAMERA.HEIGHT =\n    CONFIG.CAMERA.DEFAULT_HEIGHT || CONFIG.CAMERA.HEIGHT || 720;\n  CONFIG.CAMERA.FACING =\n    CONFIG.CAMERA.DEFAULT_FACING_MODE || CONFIG.CAMERA.FACING || \"user\";\n\n  CONFIG.SEGMENTER = CONFIG.SEGMENTER || {};\n  CONFIG.SEGMENTER.USE_LANDSCAPE_MODEL =\n    CONFIG.SEGMENTATION && CONFIG.SEGMENTATION.MODEL_SELECTION === 1\n      ? true\n      : CONFIG.SEGMENTER.USE_LANDSCAPE_MODEL ?? true;\n  CONFIG.SEGMENTER.USE_GPU = CONFIG.SEGMENTER.USE_GPU ?? true;\n\n  CONFIG.SMOOTHING = CONFIG.SMOOTHING || {};\n  CONFIG.SMOOTHING.THRESHOLD =\n    CONFIG.SMOOTHING.THRESHOLD ??\n    CONFIG.SEGMENTATION?.SEGMENTATION_THRESHOLD ??\n    0.38;\n  CONFIG.SMOOTHING.TEMPORAL_ALPHA = CONFIG.SMOOTHING.TEMPORAL_ALPHA ?? 0.6;\n  CONFIG.SMOOTHING.EDGE_FEATHER_PX = CONFIG.SMOOTHING.EDGE_FEATHER_PX ?? 3;\n  CONFIG.SMOOTHING.HYS_ON =\n    CONFIG.SMOOTHING.HYS_ON ?? CONFIG.SMOOTHING.THRESHOLD - 0.15;\n  CONFIG.SMOOTHING.HYS_OFF =\n    CONFIG.SMOOTHING.HYS_OFF ?? CONFIG.SMOOTHING.THRESHOLD + 0.15;\n  CONFIG.SMOOTHING.MASK_GROW_PX = CONFIG.SMOOTHING.MASK_GROW_PX ?? 1.5;\n\n  // 模型路徑與 WASM base\n  if (!CONFIG.MODELS) {\n    CONFIG.MODELS = {\n      SELFIE_SEGMENTER_LANDSCAPE:\n        \"https://storage.googleapis.com/mediapipe-models/image_segmenter/selfie_segmenter_landscape/float16/latest/selfie_segmenter_landscape.tflite\",\n      SELFIE_SEGMENTER_SQUARE:\n        \"https://storage.googleapis.com/mediapipe-models/image_segmenter/selfie_segmenter/float16/latest/selfie_segmenter.tflite\",\n      FACE_DETECTOR:\n        \"https://storage.googleapis.com/mediapipe-models/face_detector/blaze_face_short_range/float16/latest/blaze_face_short_range.tflite\",\n    };\n  }\n  CONFIG.WASM_BASE =\n    CONFIG.WASM_BASE ||\n    \"https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.7/wasm\";\n\n  const errs = validateConfig();\n  if (errs.length) {\n    console.error(\"配置驗證失敗：\", errs);\n    return false;\n  }\n  return true;\n}\n\n// -----------------------------------------------------------------------------\n// 初始化核心（由 UI 模組呼叫，把必要 DOM 傳進來 + 註冊回呼）\n// -----------------------------------------------------------------------------\nexport function initCore(els, callbacks = {}) {\n  videoEl = els.videoEl;\n  bgCanvas = els.bgCanvas;\n  maskCanvas = els.maskCanvas;\n  outCanvas = els.outCanvas;\n  bgVideoEl = els.bgVideoEl || null;\n  bgGifEl = els.bgGifEl || null; // 雖保留變數，但 GIF 流程已移除\n  bgMoonVideoEl = els.bgMoonVideoEl || null;\n\n  bgCtx = bgCanvas.getContext(\"2d\");\n  maskCtx = maskCanvas.getContext(\"2d\");\n  outCtx = outCanvas.getContext(\"2d\");\n\n  if (typeof callbacks.onStatus === \"function\") onStatus = callbacks.onStatus;\n  if (typeof callbacks.onStats === \"function\") onStats = callbacks.onStats;\n\n  currentFacingMode = CONFIG.CAMERA.FACING || \"user\";\n  \n  // 載入自定義背景圖片\n  loadCustomBackground();\n}\n\n// 載入自定義背景圖片\nfunction loadCustomBackground() {\n  const img = new Image();\n  img.onload = () => {\n    customBackgroundImage = img;\n    console.log('✅ 自定義背景圖片載入完成');\n  };\n  img.onerror = (e) => {\n    console.warn('⚠️ 自定義背景圖片載入失敗:', e);\n  };\n  // 使用動態路徑構造，讓 Vite 正確處理\n  const base = import.meta.env.BASE_URL || '/';\n  img.src = base + 'pexels-photo-623218.jpeg';\n}\n\n// -----------------------------------------------------------------------------\n// MediaPipe 模組載入\n// -----------------------------------------------------------------------------\nasync function ensureTasksVisionLoaded() {\n  if (window.FilesetResolver && window.ImageSegmenter) return true;\n  const urls = [\n    \"https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.7/vision_bundle.mjs\",\n    \"https://unpkg.com/@mediapipe/tasks-vision@0.10.7/vision_bundle.mjs\",\n  ];\n  for (const url of urls) {\n    try {\n      const mod = await import(url);\n      if (mod.FilesetResolver) window.FilesetResolver = mod.FilesetResolver;\n      if (mod.ImageSegmenter) window.ImageSegmenter = mod.ImageSegmenter;\n      if (mod.FaceDetector) window.FaceDetector = mod.FaceDetector;\n      return true;\n    } catch (e) {\n      console.warn(\"[WARN] failed to import tasks-vision from\", url, e);\n    }\n  }\n  throw new Error(\"無法載入 @mediapipe/tasks-vision 模組\");\n}\n\nasync function initTasks() {\n  if (!wasmFileset) {\n    wasmFileset = await FilesetResolver.forVisionTasks(CONFIG.WASM_BASE);\n  }\n  // 依 outCanvas 比例選擇使用 landscape/square\n  try {\n    const rect = outCanvas.getBoundingClientRect();\n    CONFIG.SEGMENTER.USE_LANDSCAPE_MODEL =\n      (rect.width || 1) >= (rect.height || 1);\n  } catch {}\n\n  // ImageSegmenter\n  const baseOptions = {\n    modelAssetPath: CONFIG.SEGMENTER.USE_LANDSCAPE_MODEL\n      ? CONFIG.MODELS.SELFIE_SEGMENTER_LANDSCAPE\n      : CONFIG.MODELS.SELFIE_SEGMENTER_SQUARE,\n    delegate: CONFIG.SEGMENTER.USE_GPU ? \"GPU\" : \"CPU\",\n  };\n  try {\n    imageSegmenter = await ImageSegmenter.createFromOptions(wasmFileset, {\n      baseOptions,\n      runningMode: \"VIDEO\",\n      outputCategoryMask: false,\n      outputConfidenceMasks: true,\n    });\n  } catch (e) {\n    console.warn(\"[Segmenter] GPU 失敗，改用 CPU:\", e);\n    imageSegmenter = await ImageSegmenter.createFromOptions(wasmFileset, {\n      baseOptions: { ...baseOptions, delegate: \"CPU\" },\n      runningMode: \"VIDEO\",\n      outputCategoryMask: false,\n      outputConfidenceMasks: true,\n    });\n  }\n\n  // FaceDetector（可選）\n  try {\n    faceDetector = await FaceDetector.createFromOptions(wasmFileset, {\n      baseOptions: {\n        modelAssetPath: CONFIG.MODELS.FACE_DETECTOR,\n        delegate: \"GPU\",\n      },\n      runningMode: \"VIDEO\",\n      minDetectionConfidence: 0.6,\n      minSuppressionThreshold: 0.3,\n    });\n  } catch (e) {\n    console.warn(\"[FaceDetector] GPU 失敗，改用 CPU:\", e);\n    faceDetector = await FaceDetector.createFromOptions(wasmFileset, {\n      baseOptions: {\n        modelAssetPath: CONFIG.MODELS.FACE_DETECTOR,\n        delegate: \"CPU\",\n      },\n      runningMode: \"VIDEO\",\n      minDetectionConfidence: 0.6,\n      minSuppressionThreshold: 0.3,\n    });\n  }\n}\n\n// -----------------------------------------------------------------------------\n// 相機控制\n// -----------------------------------------------------------------------------\nasync function startCamera() {\n  if (stream) {\n    try {\n      stream.getTracks().forEach((t) => t.stop());\n    } catch {}\n  }\n  const constraints = {\n    audio: false,\n    video: {\n      facingMode: currentFacingMode,\n      width: { ideal: CONFIG.CAMERA.WIDTH },\n      height: { ideal: CONFIG.CAMERA.HEIGHT },\n      frameRate: { ideal: CONFIG.CAMERA.FRAME_RATE },\n    },\n  };\n  stream = await navigator.mediaDevices.getUserMedia(constraints);\n  videoEl.srcObject = stream;\n  videoEl.setAttribute(\"playsinline\", \"\");\n  videoEl.muted = true;\n  videoEl.autoplay = true;\n\n  await new Promise((resolve) => {\n    if (videoEl.readyState >= 1 && videoEl.videoWidth && videoEl.videoHeight)\n      return resolve();\n    videoEl.onloadedmetadata = () => resolve();\n    setTimeout(resolve, 1500);\n  });\n  try {\n    await videoEl.play();\n  } catch {}\n\n  syncCanvasSize();\n}\n\nexport async function switchCamera() {\n  currentFacingMode = currentFacingMode === \"user\" ? \"environment\" : \"user\";\n  await startCamera();\n}\n\n// -----------------------------------------------------------------------------\n// 畫布尺寸同步\n// -----------------------------------------------------------------------------\nexport function syncCanvasSize() {\n  const stageEl = outCanvas.closest(\".stage\") || outCanvas.parentElement;\n  const rect = stageEl.getBoundingClientRect();\n  const w = Math.max(1, Math.round(rect.width));\n  const h = Math.max(1, Math.round(rect.height));\n  [bgCanvas, maskCanvas, outCanvas, videoDrawCanvas, compositeCanvas].forEach(\n    (c) => {\n      if (c.width !== w || c.height !== h) {\n        c.width = w;\n        c.height = h;\n      }\n      c.style.width = `${w}px`;\n      c.style.height = `${h}px`;\n    }\n  );\n  lastMaskSize = { w: outCanvas.width, h: outCanvas.height };\n}\n\n// -----------------------------------------------------------------------------\n// 背景繪製（含「影片」背景選項）\n// -----------------------------------------------------------------------------\nfunction renderBackgroundTo(ctx, w, h) {\n  const bgType =\n    (CONFIG.BACKGROUND && CONFIG.BACKGROUND.TYPE) ||\n    (CONFIG.BACKGROUND_EFFECTS &&\n      CONFIG.BACKGROUND_EFFECTS.DEFAULT_BACKGROUND) ||\n    \"original\";\n  const intensity =\n    CONFIG.BACKGROUND && typeof CONFIG.BACKGROUND.INTENSITY === \"number\"\n      ? CONFIG.BACKGROUND.INTENSITY\n      : (CONFIG.BACKGROUND_EFFECTS &&\n          CONFIG.BACKGROUND_EFFECTS.EFFECT_INTENSITY) ??\n        0.5;\n\n  ctx.clearRect(0, 0, w, h);\n  animT += 0.016;\n\n  if (bgType === \"original\") {\n    // 透明\n    return;\n  }\n  if (bgType === \"waves\") {\n    const grad = ctx.createLinearGradient(0, 0, w, h);\n    grad.addColorStop(0, \"#1a2332\");\n    grad.addColorStop(0.5, \"#2d3a50\");\n    grad.addColorStop(1, \"#0f1419\");\n    ctx.fillStyle = grad;\n    ctx.fillRect(0, 0, w, h);\n    ctx.strokeStyle = `rgba(100,200,255,${intensity * 0.6})`;\n    ctx.lineWidth = 2;\n    for (let i = 0; i < 8; i++) {\n      ctx.beginPath();\n      for (let x = 0; x < w; x += 5) {\n        const off = i * 50;\n        const y =\n          h / 2 + Math.sin((x + off) * 0.012 + animT * 1.2) * 20 * intensity;\n        if (x === 0) ctx.moveTo(x, y);\n        else ctx.lineTo(x, y);\n      }\n      ctx.stroke();\n    }\n    return;\n  }\n  if (bgType === \"frequency\") {\n    ctx.fillStyle = \"#0a0a0a\";\n    ctx.fillRect(0, 0, w, h);\n    const bands = 48;\n    const bw = w / bands;\n    for (let i = 0; i < bands; i++) {\n      const x = i * bw;\n      const bh =\n        (Math.sin(animT * 2 + i * 0.2) * 0.5 + 0.5) * h * 0.5 * intensity;\n      const hue = (animT * 30 + i * 10) % 360;\n      ctx.fillStyle = `hsla(${hue},70%,60%,0.8)`;\n      ctx.fillRect(x, h - bh, bw - 1, bh);\n    }\n    return;\n  }\n  if (bgType === \"video\" && bgVideoEl) {\n    // 以 cover 方式鋪滿\n    const vw = bgVideoEl.videoWidth || 1;\n    const vh = bgVideoEl.videoHeight || 1;\n    if (bgVideoEl.readyState >= 2) {\n      const scale = Math.max(w / vw, h / vh);\n      const dw = Math.round(vw * scale);\n      const dh = Math.round(vh * scale);\n      const ox = Math.round((w - dw) / 2);\n      const oy = Math.round((h - dh) / 2);\n      try {\n        if (bgVideoEl.paused) bgVideoEl.play().catch(() => {});\n      } catch {}\n      ctx.globalAlpha = Math.min(1, 0.3 + intensity * 0.7);\n      ctx.drawImage(bgVideoEl, 0, 0, vw, vh, ox, oy, dw, dh);\n      ctx.globalAlpha = 1;\n    }\n    return;\n  }\n  // 月相影片背景\n  if (bgType === \"moon_video\" && bgMoonVideoEl) {\n    try {\n      // Debug removed - moon video working properly\n      \n      if (bgMoonVideoEl.readyState >= 2 && !bgMoonVideoEl.paused) {\n        const vw = bgMoonVideoEl.videoWidth || bgMoonVideoEl.width || 1;\n        const vh = bgMoonVideoEl.videoHeight || bgMoonVideoEl.height || 1;\n        if (vw > 1 && vh > 1) {\n          const scale = Math.max(w / vw, h / vh);\n          const dw = Math.round(vw * scale);\n          const dh = Math.round(vh * scale);\n          const ox = Math.round((w - dw) / 2);\n          const oy = Math.round((h - dh) / 2);\n\n          ctx.globalAlpha = Math.min(1, 0.3 + intensity * 0.7);\n          ctx.drawImage(bgMoonVideoEl, 0, 0, vw, vh, ox, oy, dw, dh);\n          ctx.globalAlpha = 1;\n          // Moon video rendered successfully\n        } else {\n          console.warn(\"🌙 Moon video dimensions too small:\", { vw, vh });\n        }\n      } else if (bgMoonVideoEl.paused) {\n        // Moon video is paused, attempting to play\n        bgMoonVideoEl.play().catch((e) => console.warn(\"月相影片播放失敗:\", e));\n      } else {\n        console.warn(\"🌙 Moon video not ready:\", { \n          readyState: bgMoonVideoEl.readyState, \n          paused: bgMoonVideoEl.paused \n        });\n      }\n    } catch (e) {\n      console.warn(\"月相影片渲染錯誤:\", e);\n    }\n    return;\n  }\n  \n  // 自定義背景 + 圓形月亮合成\n  if (bgType === \"custom_moon_bg\" && customBackgroundImage && bgMoonVideoEl) {\n    try {\n      // 第一層：自定義背景圖片\n      if (customBackgroundImage) {\n        const imgW = customBackgroundImage.naturalWidth || customBackgroundImage.width;\n        const imgH = customBackgroundImage.naturalHeight || customBackgroundImage.height;\n        if (imgW > 0 && imgH > 0) {\n          // 以 cover 方式鋪滿\n          const scale = Math.max(w / imgW, h / imgH);\n          const dw = Math.round(imgW * scale);\n          const dh = Math.round(imgH * scale);\n          const ox = Math.round((w - dw) / 2);\n          const oy = Math.round((h - dh) / 2);\n          ctx.drawImage(customBackgroundImage, 0, 0, imgW, imgH, ox, oy, dw, dh);\n        }\n      }\n      \n      // 第二層：圓形月亮 MP4 (響應式座標計算)\n      if (bgMoonVideoEl.readyState >= 2 && !bgMoonVideoEl.paused) {\n        const vw = bgMoonVideoEl.videoWidth || bgMoonVideoEl.width || 1;\n        const vh = bgMoonVideoEl.videoHeight || bgMoonVideoEl.height || 1;\n        \n        if (vw > 1 && vh > 1) {\n          ctx.save();\n          \n          // 響應式圓形裁剪路徑計算\n          // 根據螢幕比例調整月亮位置，確保在各種手機尺寸下都能正確顯示\n          const aspectRatio = w / h;\n          let centerX, centerY, radius;\n          \n          if (aspectRatio > 0.6) {\n            // 較寬的螢幕 (如平板橫向)\n            centerX = w * 0.5;\n            centerY = h * 0.35;\n            radius = Math.min(w, h) * 0.25;\n          } else if (aspectRatio > 0.5) {\n            // 標準手機螢幕 (9:16 到 9:18)\n            centerX = w * 0.51;\n            centerY = h * 0.29;\n            radius = Math.min(w, h) * 0.29;\n          } else {\n            // 超長螢幕 (如 9:19.5, 9:20)\n            centerX = w * 0.51;\n            centerY = h * 0.26;\n            radius = Math.min(w, h) * 0.30;\n          }\n          \n          ctx.beginPath();\n          ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);\n          ctx.clip();\n          \n          // 繪製月亮影片 (以 cover 方式)\n          const scale = Math.max(w / vw, h / vh);\n          const dw = Math.round(vw * scale);\n          const dh = Math.round(vh * scale);\n          const ox = Math.round((w - dw) / 2);\n          const oy = Math.round((h - dh) / 2);\n          \n          ctx.globalAlpha = Math.min(1, 0.8 + intensity * 0.2);\n          ctx.drawImage(bgMoonVideoEl, 0, 0, vw, vh, ox, oy, dw, dh);\n          ctx.globalAlpha = 1;\n          \n          ctx.restore();\n        }\n      } else if (bgMoonVideoEl.paused) {\n        // 自動播放月相影片\n        bgMoonVideoEl.play().catch((e) => console.warn(\"月相影片播放失敗:\", e));\n      }\n      \n    } catch (e) {\n      console.warn(\"自定義背景 + 圓形月亮渲染錯誤:\", e);\n    }\n    return;\n  }\n}\n\nfunction renderBackground(w, h) {\n  renderBackgroundTo(bgCtx, w, h);\n}\n\n// -----------------------------------------------------------------------------\n// 蒙版處理（EMA 平滑 + 邊緣羽化）\n// -----------------------------------------------------------------------------\nfunction emaUpdate(srcF32, w, h) {\n  const N = w * h;\n  if (!lastMaskF32 || lastMaskSize.w !== w || lastMaskSize.h !== h) {\n    lastMaskF32 = new Float32Array(N);\n    lastMaskF32.set(srcF32);\n    lastMaskSize = { w, h };\n    return lastMaskF32;\n  }\n  const a = CONFIG.SMOOTHING.TEMPORAL_ALPHA;\n  for (let i = 0; i < N; i++) {\n    lastMaskF32[i] = a * lastMaskF32[i] + (1 - a) * srcF32[i];\n  }\n  return lastMaskF32;\n}\n\nfunction buildAlphaImage(maskF32, w, h) {\n  const T = CONFIG.SMOOTHING.THRESHOLD;\n  const N = w * h;\n  const img = new ImageData(w, h);\n  for (let i = 0, j = 0; i < N; i++, j += 4) {\n    const v = maskF32[i];\n    const a = v >= T ? Math.min(255, Math.round(v * 255)) : 0;\n    img.data[j] = 0;\n    img.data[j + 1] = 0;\n    img.data[j + 2] = 0;\n    img.data[j + 3] = a;\n  }\n  maskBaseCanvas.width = w;\n  maskBaseCanvas.height = h;\n  maskBaseCtx.putImageData(img, 0, 0);\n\n  const VW = outCanvas.width,\n    VH = outCanvas.height;\n  maskUpscaleCanvas.width = VW;\n  maskUpscaleCanvas.height = VH;\n  maskUpscaleCtx.clearRect(0, 0, VW, VH);\n  maskUpscaleCtx.imageSmoothingEnabled = true;\n  maskUpscaleCtx.imageSmoothingQuality = \"high\";\n  maskUpscaleCtx.drawImage(maskBaseCanvas, 0, 0, VW, VH);\n\n  const blurPx = CONFIG.SMOOTHING.EDGE_FEATHER_PX;\n  maskSoftCanvas.width = VW;\n  maskSoftCanvas.height = VH;\n  maskSoftCtx.clearRect(0, 0, VW, VH);\n  maskSoftCtx.filter = blurPx > 0 ? `blur(${blurPx}px)` : \"none\";\n  maskSoftCtx.drawImage(maskUpscaleCanvas, 0, 0);\n  maskSoftCtx.filter = \"none\";\n  return maskSoftCanvas;\n}\n\n// -----------------------------------------------------------------------------\n// 臉部檢測 / 區域與疊圖\n// -----------------------------------------------------------------------------\nfunction checkFacesInArea(detections) {\n  // 現在整個畫面都是偵測範圍，直接返回所有偵測到的人臉\n  return detections;\n}\n\nfunction renderOverlay(detections) {\n  const W = outCanvas.width,\n    H = outCanvas.height;\n  outCtx.save();\n  outCtx.translate(W, 0);\n  outCtx.scale(-1, 1);\n\n\n\n  const facesIn = checkFacesInArea(detections);\n  outCtx.restore();\n\n  // 根據人像偵測狀態動態切換去背功能和背景類型\n  const currentFaceDetectionState = facesIn.length >= CONFIG.FACE_DETECTION_SETTINGS.REQUIRED_FACES;\n  \n  if (currentFaceDetectionState !== lastFaceDetectionState) {\n    if (currentFaceDetectionState) {\n      // 偵測到人像：觸發測試按鈕的效果\n      if (typeof onStatus === 'function') {\n        onStatus('TRIGGER_TEST_EFFECT');\n      }\n    } else {\n      // 沒有偵測到人像：恢復正常狀態\n      if (typeof onStatus === 'function') {\n        onStatus('STOP_TEST_EFFECT');\n      }\n    }\n    lastFaceDetectionState = currentFaceDetectionState;\n  }\n\n  // 更新回呼\n  onStats({\n    faceCount: detections.length,\n    facesInArea: facesIn.length,\n    moonActive: facesIn.length >= CONFIG.FACE_DETECTION_SETTINGS.REQUIRED_FACES,\n  });\n}\n\n// -----------------------------------------------------------------------------\n// 主渲染迴圈\n// -----------------------------------------------------------------------------\nasync function renderLoop() {\n  if (!running) return;\n  const now = performance.now();\n  const W = outCanvas.width,\n    H = outCanvas.height;\n\n  // 背景\n  outCtx.clearRect(0, 0, W, H);\n  renderBackground(W, H);\n\n  // 將 video 以 contain 方式畫到暫存\n  videoDrawCtx.clearRect(0, 0, W, H);\n  const vw = videoEl.videoWidth || 1,\n    vh = videoEl.videoHeight || 1;\n  const scale = Math.min(W / vw, H / vh);\n  const dw = Math.round(vw * scale),\n    dh = Math.round(vh * scale);\n  const ox = Math.round((W - dw) / 2),\n    oy = Math.round((H - dh) / 2);\n  try {\n    videoDrawCtx.drawImage(videoEl, 0, 0, vw, vh, ox, oy, dw, dh);\n  } catch {}\n\n  // Segmentation（僅在新幀）\n  if (imageSegmenter && CONFIG.SEGMENTATION.ENABLED) {\n    if (videoEl.currentTime !== lastVideoTime) {\n      lastVideoTime = videoEl.currentTime;\n      try {\n        const result = imageSegmenter.segmentForVideo\n          ? imageSegmenter.segmentForVideo(videoDrawCanvas, now)\n          : await imageSegmenter.segment(videoDrawCanvas);\n        if (result) {\n          let maskF32 = null,\n            mw = 0,\n            mh = 0;\n          if (result.confidenceMasks && result.confidenceMasks.length) {\n            const idx =\n              personLabelIndex < result.confidenceMasks.length\n                ? personLabelIndex\n                : 0;\n            const cm = result.confidenceMasks[idx];\n            if (cm?.getAsFloat32Array) {\n              const src = cm.getAsFloat32Array();\n              maskF32 = new Float32Array(src.length);\n              maskF32.set(src);\n              mw = cm.width;\n              mh = cm.height;\n            }\n            for (const m of result.confidenceMasks) {\n              try {\n                m?.close?.();\n              } catch {}\n            }\n          } else if (result.categoryMask?.getAsUint8Array) {\n            const cat = result.categoryMask;\n            const u8 = cat.getAsUint8Array();\n            maskF32 = new Float32Array(u8.length);\n            mw = cat.width;\n            mh = cat.height;\n            const personIdx = personLabelIndex;\n            for (let i = 0; i < u8.length; i++)\n              maskF32[i] = u8[i] === personIdx ? 1 : 0;\n            try {\n              cat.close?.();\n            } catch {}\n          }\n          if (maskF32 && mw && mh) {\n            const sm = emaUpdate(maskF32, mw, mh);\n            gMaskCanvasProcessed = buildAlphaImage(sm, mw, mh);\n          }\n        }\n      } catch (e) {\n        console.warn(\"segmentForVideo error:\", e);\n      }\n    }\n  } else {\n    gMaskCanvasProcessed = null;\n  }\n\n  // composite：先把人物合成到離屏，再畫回 outCanvas（避免破壞背景）\n  compositeCtx.clearRect(0, 0, W, H);\n  compositeCtx.save();\n  compositeCtx.drawImage(videoDrawCanvas, 0, 0, W, H);\n  if (gMaskCanvasProcessed) {\n    compositeCtx.globalCompositeOperation = \"destination-in\";\n    compositeCtx.drawImage(gMaskCanvasProcessed, 0, 0, W, H);\n    compositeCtx.globalCompositeOperation = \"source-over\";\n  }\n  compositeCtx.restore();\n\n  // 以鏡像方式繪回（與原本一致）\n  outCtx.save();\n  outCtx.translate(W, 0);\n  outCtx.scale(-1, 1);\n  outCtx.drawImage(compositeCanvas, 0, 0, W, H);\n  outCtx.restore();\n\n  // Mask 預覽\n  maskCtx.clearRect(0, 0, W, H);\n  if (gMaskCanvasProcessed && _showMaskPreview) {\n    maskCtx.globalAlpha = 0.9;\n    maskCtx.drawImage(gMaskCanvasProcessed, 0, 0, W, H);\n    maskCtx.globalAlpha = 1.0;\n    maskCanvas.style.display = \"block\";\n  } else {\n    maskCanvas.style.display = \"none\";\n  }\n\n  // 臉部檢測\n  if (faceDetector) {\n    try {\n      const det = faceDetector.detectForVideo\n        ? faceDetector.detectForVideo(videoDrawCanvas, now)\n        : null;\n      if (det) renderOverlay(det.detections || []);\n    } catch (e) {\n      console.warn(\"faceDetector error:\", e);\n    }\n  }\n\n  requestAnimationFrame(renderLoop);\n}\n\n// -----------------------------------------------------------------------------\n// 公開 API：start/stop/onResize & 參數 setters\n// -----------------------------------------------------------------------------\nexport async function start() {\n  if (running) return;\n  const ok = initializeConfig();\n  if (!ok) {\n    onStatus(\"配置錯誤，請檢查控制台\");\n    return;\n  }\n  onStatus(\"初始化...\");\n  await ensureTasksVisionLoaded();\n  await initTasks();\n  await startCamera();\n  running = true;\n  onStatus(\"檢測中\");\n  requestAnimationFrame(renderLoop);\n}\n\nexport function stop() {\n  running = false;\n  try {\n    if (stream) stream.getTracks().forEach((t) => t.stop());\n  } catch {}\n  if (outCtx && maskCtx && bgCtx) {\n    outCtx.clearRect(0, 0, outCanvas.width, outCanvas.height);\n    maskCtx.clearRect(0, 0, maskCanvas.width, maskCanvas.height);\n    bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height);\n  }\n  onStats({ faceCount: 0, facesInArea: 0, moonActive: false });\n  onStatus(\"已停止\");\n}\n\nexport function onResize() {\n  if (running) syncCanvasSize();\n}\n\n// setters\nlet _showMaskPreview = false;\nexport function setShowMaskPreview(v) {\n  _showMaskPreview = !!v;\n}\nexport function setEnableSegmentation(v) {\n  CONFIG.SEGMENTATION.ENABLED = !!v;\n}\nexport function setBackgroundType(t) {\n  CONFIG.BACKGROUND.TYPE = t;\n}\nexport function setBackgroundIntensity(p01) {\n  CONFIG.BACKGROUND.INTENSITY = Math.max(0, Math.min(1, p01));\n}\nexport function setEdgeFeather(px) {\n  CONFIG.SMOOTHING.EDGE_FEATHER_PX = Math.max(0, Number(px) || 0);\n}\nexport function setTemporalAlpha(v01) {\n  CONFIG.SMOOTHING.TEMPORAL_ALPHA = Math.max(\n    0,\n    Math.min(0.95, Number(v01) || 0)\n  );\n}\nexport function setThreshold(v01) {\n  CONFIG.SMOOTHING.THRESHOLD = Math.max(0, Math.min(1, Number(v01) || 0));\n}\n\n// 為了向後相容，保留 GIF 相關 setter（no-op），你之後可以完全移除\nexport function setGifBlendMode(mode) {\n  // no-op: GIF 功能已移除於 core\n  CONFIG.BACKGROUND.GIF_BLEND_MODE = mode;\n}\nexport function setShouldGenerateGif(value) {\n  // no-op\n  return;\n}\n\n// 便利：提供目前是否在跑\nexport function isRunning() {\n  return running;\n}\n\n// -----------------------------------------------------------------------------\n// 拍照功能（不包含 GIF 流程）\n// -----------------------------------------------------------------------------\nexport async function capturePhoto() {\n  if (!outCanvas || !running) {\n    console.warn(\"無法拍照：相機未啟動或畫布不存在\");\n    return null;\n  }\n\n  try {\n    // 創建一個新的 canvas 來合成最終圖像\n    const captureCanvas = document.createElement(\"canvas\");\n    const captureCtx = captureCanvas.getContext(\"2d\");\n\n    // 設定拍照尺寸（使用當前渲染尺寸）\n    const W = outCanvas.width;\n    const H = outCanvas.height;\n    captureCanvas.width = W;\n    captureCanvas.height = H;\n\n    // 檢查背景類型\n    const bgType = CONFIG.BACKGROUND && CONFIG.BACKGROUND.TYPE;\n    console.log(\"📸 拍照檢查背景類型:\", { bgType, hasMoonVideo: !!bgMoonVideoEl });\n\n    if ((bgType === \"moon_video\" || bgType === \"custom_moon_bg\") && bgMoonVideoEl) {\n      // 月相影片模式：靜止人物 + 動態影片背景 → 8秒影片\n      console.log(\"🌙 月相影片模式：生成 8 秒動態影片...\");\n\n      // 1. 先繪製當前畫面作為靜止人物 (outCanvas 已包含前景與背景)\n      captureCtx.drawImage(outCanvas, 0, 0, W, H);\n\n      // 2. 生成靜止人物的 PNG 作為基礎\n      const staticPersonDataURL = captureCanvas.toDataURL(\"image/png\", 1.0);\n\n      // 3. 開始錄製 8 秒動態影片\n      try {\n        const result = await generateVideoWithStaticPerson(staticPersonDataURL, W, H);\n        console.log(\"✅ 影片生成完成:\", result);\n        return result;\n      } catch (error) {\n        console.error(\"❌ 影片生成失敗:\", error);\n        // 如果影片生成失敗，回退到 PNG 模式\n        const dataURL = captureCanvas.toDataURL(\"image/png\", 1.0);\n        const timestamp = new Date()\n          .toISOString()\n          .replace(/[:]/g, \"-\")\n          .split(\".\")[0];\n        const pngLink = document.createElement(\"a\");\n        const pngFilename = `月亮節AR拍照_${timestamp}.png`;\n        pngLink.download = pngFilename;\n        pngLink.href = dataURL;\n        document.body.appendChild(pngLink);\n        pngLink.click();\n        document.body.removeChild(pngLink);\n        return { png: dataURL, error: \"影片生成失敗，已保存為圖片\" };\n      }\n    } else {\n      // 一般模式：先背景後人物\n      captureCtx.drawImage(bgCanvas, 0, 0, W, H);\n      captureCtx.drawImage(outCanvas, 0, 0, W, H);\n    }\n\n    // 轉換為 DataURL\n    const dataURL = captureCanvas.toDataURL(\"image/png\", 1.0);\n    const timestamp = new Date()\n      .toISOString()\n      .replace(/[:]/g, \"-\")\n      .split(\".\")[0];\n\n    // 總是先下載 PNG 版本\n    const pngLink = document.createElement(\"a\");\n    const pngFilename = `月亮節AR拍照_${timestamp}.png`;\n    pngLink.download = pngFilename;\n    pngLink.href = dataURL;\n    document.body.appendChild(pngLink);\n    pngLink.click();\n    document.body.removeChild(pngLink);\n\n    console.log(`📸 PNG 拍照成功！`);\n\n    return { png: dataURL };\n  } catch (error) {\n    console.error(\"拍照失敗：\", error);\n    return null;\n  }\n}\n\n// 全域進度回調函數\nlet recordingProgressCallback = null;\nlet videoOutputFormat = \"mp4\"; // 預設 MP4\n\n// 設定錄製進度回調\nexport function setRecordingProgressCallback(callback) {\n  recordingProgressCallback = callback;\n}\n\n// 設定影片輸出格式\nexport function setVideoOutputFormat(format) {\n  videoOutputFormat = format;\n}\n\n// 生成靜止人物 + 動態影片背景的 8 秒影片\nasync function generateVideoWithStaticPerson(\n  staticPersonDataURL,\n  width,\n  height\n) {\n  console.log(\"🎬 開始錄製靜止人物 + 動態背景影片...\");\n\n  try {\n    // 檢查瀏覽器支援\n    if (!window.MediaRecorder) {\n      console.warn(\"瀏覽器不支援 MediaRecorder\");\n      return { png: staticPersonDataURL, error: \"瀏覽器不支援影片錄製\" };\n    }\n\n    // 創建錄製用的 Canvas - 保持原始比例\n    const recordCanvas = document.createElement(\"canvas\");\n    const recordCtx = recordCanvas.getContext(\"2d\");\n\n    // 計算保持比例的尺寸\n    const maxSize = 640; // 最大邊長限制\n    const aspectRatio = width / height;\n\n    if (width > height) {\n      // 橫向影片\n      recordCanvas.width = Math.min(maxSize, width);\n      recordCanvas.height = Math.round(recordCanvas.width / aspectRatio);\n    } else {\n      // 直向影片\n      recordCanvas.height = Math.min(maxSize, height);\n      recordCanvas.width = Math.round(recordCanvas.height * aspectRatio);\n    }\n\n    console.log(\n      `錄製 Canvas 尺寸: ${recordCanvas.width}x${\n        recordCanvas.height\n      } (原始: ${width}x${height}, 比例: ${aspectRatio.toFixed(2)})`\n    );\n\n    // 載入靜止人物圖片\n    const personImg = new Image();\n\n    return new Promise((resolve, reject) => {\n      personImg.onload = async () => {\n        console.log(\"靜止人物圖片載入完成，開始錄製...\");\n\n        // 設定錄製參數：8 秒，20 FPS\n        const DURATION_SECONDS = 8;\n        const FPS = 20;\n        const totalFrames = DURATION_SECONDS * FPS;\n\n        // 確保月相影片開始播放\n        if (bgMoonVideoEl && bgMoonVideoEl.paused) {\n          await bgMoonVideoEl\n            .play()\n            .catch((e) => console.warn(\"影片播放失敗:\", e));\n        }\n\n        // 設定 MediaRecorder\n        const stream = recordCanvas.captureStream(FPS);\n\n        // 根據選擇的格式設定 MediaRecorder\n        let recorderOptions;\n        if (videoOutputFormat === \"mp4\") {\n          // MP4 設定 (瀏覽器支援性有限)\n          if (MediaRecorder.isTypeSupported(\"video/mp4; codecs=h264\")) {\n            recorderOptions = {\n              mimeType: \"video/mp4; codecs=h264\",\n              videoBitsPerSecond: 3000000, // 3 Mbps\n            };\n          } else if (MediaRecorder.isTypeSupported(\"video/mp4\")) {\n            recorderOptions = {\n              mimeType: \"video/mp4\",\n              videoBitsPerSecond: 3000000,\n            };\n          } else {\n            // 降級到 WebM\n            console.warn(\"瀏覽器不支援 MP4，降級到 WebM\");\n            recorderOptions = {\n              mimeType: \"video/webm; codecs=vp8\",\n              videoBitsPerSecond: 3000000,\n            };\n            videoOutputFormat = \"webm\"; // 更新格式標識\n          }\n        } else {\n          // WebM 設定\n          recorderOptions = {\n            mimeType: \"video/webm; codecs=vp8\",\n            videoBitsPerSecond: 3000000,\n          };\n        }\n\n        const recorder = new MediaRecorder(stream, recorderOptions);\n        console.log(`📹 使用格式: ${recorderOptions.mimeType}`);\n\n        const chunks = [];\n        recorder.ondataavailable = (event) => {\n          if (event.data.size > 0) {\n            chunks.push(event.data);\n          }\n        };\n\n        recorder.onstop = () => {\n          const mimeType =\n            videoOutputFormat === \"mp4\" ? \"video/mp4\" : \"video/webm\";\n          const extension = videoOutputFormat === \"mp4\" ? \"mp4\" : \"webm\";\n          const blob = new Blob(chunks, { type: mimeType });\n\n          const timestamp = new Date()\n            .toISOString()\n            .replace(/[:]/g, \"-\")\n            .split(\".\")[0];\n          const filename = `月亮節AR_月相影片_${timestamp}.${extension}`;\n\n          // 儲存 blob & filename（由 core 管理 objectURL）\n          const storedUrl = storeRecordingBlob(blob, filename);\n\n          // 觸發回呼通知 UI：可在 UI 顯示「分享」按鈕與「下載」按鈕\n          if (typeof onStatus === \"function\") {\n            onStatus(\"影片已生成，可按 分享 或 下載\");\n          }\n          if (typeof onStats === \"function\") {\n            // optional: 傳回 video blob info 給 UI\n            onStats({\n              lastVideoUrl: storedUrl,\n              lastVideoFilename: filename,\n            });\n          }\n\n          // resolve 並回傳由 core 管理的 URL\n          resolve({\n            png: staticPersonDataURL,\n            video: storedUrl,\n            duration: DURATION_SECONDS,\n            format: extension,\n            saved: true,\n          });\n        };\n\n        recorder.onerror = (event) => {\n          console.error(\"錄製錯誤:\", event.error);\n          reject(event.error);\n        };\n\n        // 開始錄製\n        recorder.start();\n        console.log(`開始錄製 ${DURATION_SECONDS} 秒影片...`);\n\n        // 初始化進度狀態\n        if (recordingProgressCallback) {\n          recordingProgressCallback.setStatus(\"開始錄製...\");\n          recordingProgressCallback.updateProgress(0, DURATION_SECONDS);\n        }\n\n        let frame = 0;\n\n        // 逐幀繪製函數\n        function drawFrame() {\n          // 清除畫布\n          recordCtx.clearRect(0, 0, recordCanvas.width, recordCanvas.height);\n\n          // 1. 繪製背景（根據類型決定）\n          const bgType = CONFIG.BACKGROUND && CONFIG.BACKGROUND.TYPE;\n          const intensity = CONFIG.BACKGROUND.INTENSITY || 0.5;\n          \n          if (bgType === \"custom_moon_bg\" && customBackgroundImage && bgMoonVideoEl) {\n            // 三層合成：自定義背景 + 圓形月亮\n            \n            // 第一層：自定義背景圖片\n            if (customBackgroundImage) {\n              const imgW = customBackgroundImage.naturalWidth || customBackgroundImage.width;\n              const imgH = customBackgroundImage.naturalHeight || customBackgroundImage.height;\n              if (imgW > 0 && imgH > 0) {\n                // 以 cover 方式鋪滿\n                const scale = Math.max(recordCanvas.width / imgW, recordCanvas.height / imgH);\n                const dw = Math.round(imgW * scale);\n                const dh = Math.round(imgH * scale);\n                const ox = Math.round((recordCanvas.width - dw) / 2);\n                const oy = Math.round((recordCanvas.height - dh) / 2);\n                recordCtx.drawImage(customBackgroundImage, 0, 0, imgW, imgH, ox, oy, dw, dh);\n              }\n            }\n            \n            // 第二層：圓形月亮 MP4\n            if (bgMoonVideoEl.readyState >= 2) {\n              const vw = bgMoonVideoEl.videoWidth || bgMoonVideoEl.width || 1;\n              const vh = bgMoonVideoEl.videoHeight || bgMoonVideoEl.height || 1;\n              \n              if (vw > 1 && vh > 1) {\n                recordCtx.save();\n                \n                // 響應式圓形裁剪路徑計算 (與即時渲染保持一致)\n                const aspectRatio = recordCanvas.width / recordCanvas.height;\n                let centerX, centerY, radius;\n                \n                if (aspectRatio > 0.6) {\n                  // 較寬的螢幕\n                  centerX = recordCanvas.width * 0.5;\n                  centerY = recordCanvas.height * 0.35;\n                  radius = Math.min(recordCanvas.width, recordCanvas.height) * 0.25;\n                } else if (aspectRatio > 0.5) {\n                  // 標準手機螢幕\n                  centerX = recordCanvas.width * 0.51;\n                  centerY = recordCanvas.height * 0.29;\n                  radius = Math.min(recordCanvas.width, recordCanvas.height) * 0.29;\n                } else {\n                  // 超長螢幕\n                  centerX = recordCanvas.width * 0.51;\n                  centerY = recordCanvas.height * 0.26;\n                  radius = Math.min(recordCanvas.width, recordCanvas.height) * 0.30;\n                }\n                \n                recordCtx.beginPath();\n                recordCtx.arc(centerX, centerY, radius, 0, 2 * Math.PI);\n                recordCtx.clip();\n                \n                // 繪製月亮影片 (以 cover 方式)\n                const scale = Math.max(recordCanvas.width / vw, recordCanvas.height / vh);\n                const dw = Math.round(vw * scale);\n                const dh = Math.round(vh * scale);\n                const ox = Math.round((recordCanvas.width - dw) / 2);\n                const oy = Math.round((recordCanvas.height - dh) / 2);\n                \n                recordCtx.globalAlpha = Math.min(1, 0.8 + intensity * 0.2);\n                recordCtx.drawImage(bgMoonVideoEl, 0, 0, vw, vh, ox, oy, dw, dh);\n                recordCtx.globalAlpha = 1;\n                \n                recordCtx.restore();\n              }\n            }\n          } else if (bgMoonVideoEl && bgMoonVideoEl.readyState >= 2) {\n            // 原始月相影片背景模式\n            const vw = bgMoonVideoEl.videoWidth || bgMoonVideoEl.width || 1;\n            const vh = bgMoonVideoEl.videoHeight || bgMoonVideoEl.height || 1;\n            if (vw > 1 && vh > 1) {\n              const scale = Math.max(recordCanvas.width / vw, recordCanvas.height / vh);\n              const dw = Math.round(vw * scale);\n              const dh = Math.round(vh * scale);\n              const ox = Math.round((recordCanvas.width - dw) / 2);\n              const oy = Math.round((recordCanvas.height - dh) / 2);\n\n              recordCtx.globalAlpha = Math.min(1, 0.3 + intensity * 0.7);\n              recordCtx.drawImage(bgMoonVideoEl, 0, 0, vw, vh, ox, oy, dw, dh);\n              recordCtx.globalAlpha = 1;\n            }\n          }\n\n          // 2. 繪製靜止人物（前景）- 保持原始比例\n          const personWidth = personImg.naturalWidth || personImg.width;\n          const personHeight = personImg.naturalHeight || personImg.height;\n\n          if (personWidth > 0 && personHeight > 0) {\n            // 計算人物圖片的縮放，保持比例並完全覆蓋畫面\n            const personScaleX = recordCanvas.width / personWidth;\n            const personScaleY = recordCanvas.height / personHeight;\n            const personScale = Math.max(personScaleX, personScaleY); // cover 模式\n\n            const personDrawWidth = Math.round(personWidth * personScale);\n            const personDrawHeight = Math.round(personHeight * personScale);\n            const personOffsetX = Math.round(\n              (recordCanvas.width - personDrawWidth) / 2\n            );\n            const personOffsetY = Math.round(\n              (recordCanvas.height - personDrawHeight) / 2\n            );\n\n            recordCtx.drawImage(\n              personImg,\n              0,\n              0,\n              personWidth,\n              personHeight,\n              personOffsetX,\n              personOffsetY,\n              personDrawWidth,\n              personDrawHeight\n            );\n          } else {\n            // 備用方案：直接拉伸\n            recordCtx.drawImage(\n              personImg,\n              0,\n              0,\n              recordCanvas.width,\n              recordCanvas.height\n            );\n          }\n\n          frame++;\n\n          // 更新進度到 UI\n          const currentTime = frame / FPS;\n          if (recordingProgressCallback) {\n            recordingProgressCallback.updateProgress(\n              currentTime,\n              DURATION_SECONDS\n            );\n          }\n\n          // 繼續下一幀或結束錄製\n          if (frame < totalFrames) {\n            setTimeout(drawFrame, 1000 / FPS);\n          } else {\n            if (recordingProgressCallback) {\n              recordingProgressCallback.setStatus(\"錄製完成，正在生成檔案...\");\n            }\n            recorder.stop();\n            console.log(\"所有幀錄製完成\");\n          }\n        }\n\n        // 開始繪製第一幀\n        drawFrame();\n      };\n\n      personImg.onerror = () => {\n        reject(new Error(\"靜止人物圖片載入失敗\"));\n      };\n\n      personImg.src = staticPersonDataURL;\n    });\n  } catch (error) {\n    console.error(\"影片生成錯誤:\", error);\n    return { png: staticPersonDataURL, error: error.message };\n  }\n}\n\n// 嘗試使用 Web Share API 分享 Blob（若支援檔案分享）\n// 這是內部工具函式（UI 應使用 shareLastRecording）\nasync function tryShareBlob(\n  blob,\n  filename,\n  title = \"月亮節 AR 影片\",\n  text = \"\"\n) {\n  try {\n    const file = new File([blob], filename, { type: blob.type || \"video/mp4\" });\n\n    if (navigator.share && navigator.canShare) {\n      if (navigator.canShare({ files: [file] })) {\n        await navigator.share({ files: [file], title, text });\n        return { ok: true, method: \"webshare\" };\n      }\n      return { ok: false, reason: \"canShare-false\" };\n    }\n\n    // 若沒有 canShare（或只支援 url/text），視為不支援檔案分享\n    return { ok: false, reason: \"no-file-share-support\" };\n  } catch (err) {\n    console.warn(\"tryShareBlob error\", err);\n    return { ok: false, reason: \"error\", error: err };\n  }\n}\n"],"names":["CONFIG","lastRecordedBlob","lastRecordedFilename","lastRecordedObjectUrl","_revokeLastObjectUrl","storeRecordingBlob","blob","filename","e","hasRecordingAvailable","getLastRecordingUrl","clearLastRecording","getLastRecordingFilename","uploadBlobToServerAndGetUrl","fd","res","j","shareLastRecording","file","err","url","imageSegmenter","faceDetector","wasmFileset","running","stream","currentFacingMode","lastFaceDetectionState","videoEl","bgCanvas","maskCanvas","outCanvas","bgVideoEl","bgMoonVideoEl","bgCtx","maskCtx","outCtx","customBackgroundImage","onStatus","t","onStats","stats","personLabelIndex","lastMaskF32","lastMaskSize","gMaskCanvasProcessed","videoDrawCanvas","videoDrawCtx","compositeCanvas","compositeCtx","maskBaseCanvas","maskBaseCtx","maskUpscaleCanvas","maskUpscaleCtx","maskSoftCanvas","maskSoftCtx","animT","lastVideoTime","autoAdjustConfig","isMobile","isLowEnd","validateConfig","_a","errors","saveConfig","resetConfig","loadCustomConfig","c","initializeConfig","errs","initCore","els","callbacks","loadCustomBackground","img","base","ensureTasksVisionLoaded","urls","mod","initTasks","rect","baseOptions","startCamera","constraints","resolve","syncCanvasSize","switchCamera","w","h","renderBackgroundTo","ctx","bgType","intensity","grad","i","x","off","y","bands","bw","bh","hue","vw","vh","scale","dw","dh","ox","oy","imgW","imgH","aspectRatio","centerX","centerY","radius","renderBackground","emaUpdate","srcF32","N","a","buildAlphaImage","maskF32","T","v","VW","VH","blurPx","renderOverlay","detections","W","facesIn","currentFaceDetectionState","renderLoop","_b","_c","now","H","result","mw","mh","idx","cm","src","cat","u8","personIdx","sm","_showMaskPreview","det","start","stop","onResize","setShowMaskPreview","setEnableSegmentation","setBackgroundType","setBackgroundIntensity","p01","setEdgeFeather","px","setTemporalAlpha","v01","setThreshold","setGifBlendMode","mode","setShouldGenerateGif","value","isRunning","capturePhoto","captureCanvas","captureCtx","staticPersonDataURL","generateVideoWithStaticPerson","error","dataURL","timestamp","pngLink","pngFilename","recordingProgressCallback","videoOutputFormat","setRecordingProgressCallback","callback","setVideoOutputFormat","format","width","height","recordCanvas","recordCtx","maxSize","personImg","reject","DURATION_SECONDS","FPS","totalFrames","recorderOptions","recorder","chunks","event","mimeType","extension","storedUrl","frame","drawFrame","personWidth","personHeight","personScaleX","personScaleY","personScale","personDrawWidth","personDrawHeight","personOffsetX","personOffsetY","currentTime"],"mappings":"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"}