const o={FACE_DETECTION:{MODEL:"short",MIN_DETECTION_CONFIDENCE:.5,MAX_FACES:10},SEGMENTATION:{ENABLED:!0,MODEL_SELECTION:1,SELFIE_MODE:!0,SEGMENTATION_THRESHOLD:.1},FACE_DETECTION_SETTINGS:{REQUIRED_FACES:1},CAMERA:{DEFAULT_WIDTH:640,DEFAULT_HEIGHT:480,DEFAULT_FACING_MODE:"user",FRAME_RATE:30},UI:{STATUS_UPDATE_INTERVAL:100,SHOW_DEBUG_INFO:!0,SHOW_FPS:!1,LANGUAGE:"zh-TW"},EFFECTS:{MOON_EFFECT_DURATION:3e3,FADE_DURATION:800,ENABLE_SOUND:!1,MOON_SIZE_SCALE:1,STAR_COUNT:5,SPARKLE_COUNT:3},BACKGROUND_EFFECTS:{DEFAULT_BACKGROUND:"moon_video",WAVE_EFFECT:{AMPLITUDE:10,FREQUENCY:.02,SPEED:.05},FREQUENCY_EFFECT:{BANDS:32,HEIGHT_SCALE:.8,COLOR_SHIFT:.01},EFFECT_INTENSITY:.5,BLEND_MODE:"source-over"},PERFORMANCE:{ENABLE_MONITORING:!1,MAX_LATENCY:100,LOW_PERFORMANCE_MODE:!1,AUTO_ADJUST_PERFORMANCE:!0},DEBUG:{VERBOSE_LOGGING:!1,SHOW_FACE_LANDMARKS:!1,SAVE_DETECTION_RESULTS:!1},ADVANCED:{MEDIAPIPE_BASE_URL:"https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/",MEDIAPIPE_SEGMENTATION_URL:"https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/",USE_WEB_WORKERS:!1,MEMORY_LIMIT:512,ENABLE_ERROR_REPORTING:!0}};o.BACKGROUND=o.BACKGROUND||{TYPE:o.BACKGROUND_EFFECTS&&o.BACKGROUND_EFFECTS.DEFAULT_BACKGROUND||"original",INTENSITY:(o.BACKGROUND_EFFECTS&&o.BACKGROUND_EFFECTS.EFFECT_INTENSITY)??.5,GIF_BLEND_MODE:"overlay"};let W=null,ue=null,V=null;function Oe(){try{V&&(URL.revokeObjectURL(V),V=null)}catch(e){console.warn("revoke failed",e)}}function De(e,t){if(!e)return null;Oe(),W=e,ue=t||`moonAR_${Date.now()}.webm`;try{V=URL.createObjectURL(e)}catch(a){console.warn("createObjectURL failed",a),V=null}return V}function Ye(){return!!W}function $e(){return V||null}function je(){Oe(),W=null,ue=null}function Xe(){return ue}async function Fe(e,t){const a=new FormData;a.append("file",e,t);const n=await fetch("/api/upload",{method:"POST",body:a});if(!n.ok)throw new Error("upload failed");const r=await n.json();if(!(r!=null&&r.url))throw new Error("upload response missing url");return r.url}async function ze(){if(!W)throw new Error("no recording available");const e=ue||`moonAR_${Date.now()}.mp4`,t=new File([W],e,{type:W.type||"video/mp4"});try{if(navigator.canShare&&navigator.canShare({files:[t]}))return await navigator.share({files:[t],title:"月亮節 AR 影片",text:"分享給你"}),{ok:!0,method:"webshare"}}catch(a){console.warn("Web Share file error:",a)}try{const a=await Fe(W,e);if(navigator.share)try{return await navigator.share({title:"月亮節 AR 影片",text:"看這個影片：",url:a}),{ok:!0,method:"url-share",url:a}}catch(n){console.warn("Web Share URL error:",n)}return{ok:!0,method:"uploaded",url:a}}catch(a){throw console.warn("upload failed:",a),a}}let z=null,ee=null,j=null,Y=!1,Q=null,de=o.CAMERA.DEFAULT_FACING_MODE||"user",Te=!1,N,q,$,S,v,c,b,he,x,y,O=null,Ee=!1,U=e=>{},te=e=>{},me=0,B=null,re={w:0,h:0},X=null;const K=document.createElement("canvas"),Se=K.getContext("2d");K.style.display="none";const ge=document.createElement("canvas"),k=ge.getContext("2d");ge.style.display="none";const se=document.createElement("canvas"),ve=se.getContext("2d"),ce=document.createElement("canvas"),ne=ce.getContext("2d"),le=document.createElement("canvas"),ae=le.getContext("2d");let ie=0,pe=-1;function ye(){const e=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),t=(navigator.hardwareConcurrency||4)<=2;e&&(o.CAMERA.DEFAULT_WIDTH=480,o.CAMERA.DEFAULT_HEIGHT=360,o.FACE_DETECTION.MODEL="short",o.EFFECTS.STAR_COUNT=3,o.EFFECTS.SPARKLE_COUNT=2),t&&(o.PERFORMANCE.LOW_PERFORMANCE_MODE=!0,o.FACE_DETECTION.MIN_DETECTION_CONFIDENCE=.6,o.CAMERA.FRAME_RATE=20,o.EFFECTS.MOON_SIZE_SCALE=.8)}function Ge(){var t;const e=[];return(o.FACE_DETECTION.MIN_DETECTION_CONFIDENCE<0||o.FACE_DETECTION.MIN_DETECTION_CONFIDENCE>1)&&e.push("MIN_DETECTION_CONFIDENCE 必須在 0~1 之間"),(t=navigator.mediaDevices)!=null&&t.getUserMedia||e.push("瀏覽器不支援相機功能"),e}function Qe(){try{localStorage.setItem("moonFestivalAR_config",JSON.stringify(o))}catch{}}function qe(){try{localStorage.removeItem("moonFestivalAR_config")}catch{}location.reload()}function Ue(){try{const e=localStorage.getItem("moonFestivalAR_config");e&&Object.assign(o,JSON.parse(e))}catch{}}function Le(){var t;Ue(),ye(),o.CAMERA.WIDTH=o.CAMERA.DEFAULT_WIDTH||o.CAMERA.WIDTH||1280,o.CAMERA.HEIGHT=o.CAMERA.DEFAULT_HEIGHT||o.CAMERA.HEIGHT||720,o.CAMERA.FACING=o.CAMERA.DEFAULT_FACING_MODE||o.CAMERA.FACING||"user",o.SEGMENTER=o.SEGMENTER||{},o.SEGMENTER.USE_LANDSCAPE_MODEL=o.SEGMENTATION&&o.SEGMENTATION.MODEL_SELECTION===1?!0:o.SEGMENTER.USE_LANDSCAPE_MODEL??!0,o.SEGMENTER.USE_GPU=o.SEGMENTER.USE_GPU??!0,o.SMOOTHING=o.SMOOTHING||{},o.SMOOTHING.THRESHOLD=o.SMOOTHING.THRESHOLD??((t=o.SEGMENTATION)==null?void 0:t.SEGMENTATION_THRESHOLD)??.38,o.SMOOTHING.TEMPORAL_ALPHA=o.SMOOTHING.TEMPORAL_ALPHA??.6,o.SMOOTHING.EDGE_FEATHER_PX=o.SMOOTHING.EDGE_FEATHER_PX??3,o.SMOOTHING.HYS_ON=o.SMOOTHING.HYS_ON??o.SMOOTHING.THRESHOLD-.15,o.SMOOTHING.HYS_OFF=o.SMOOTHING.HYS_OFF??o.SMOOTHING.THRESHOLD+.15,o.SMOOTHING.MASK_GROW_PX=o.SMOOTHING.MASK_GROW_PX??1.5,o.MODELS||(o.MODELS={SELFIE_SEGMENTER_LANDSCAPE:"https://storage.googleapis.com/mediapipe-models/image_segmenter/selfie_segmenter_landscape/float16/latest/selfie_segmenter_landscape.tflite",SELFIE_SEGMENTER_SQUARE:"https://storage.googleapis.com/mediapipe-models/image_segmenter/selfie_segmenter/float16/latest/selfie_segmenter.tflite",FACE_DETECTOR:"https://storage.googleapis.com/mediapipe-models/face_detector/blaze_face_short_range/float16/latest/blaze_face_short_range.tflite"}),o.WASM_BASE=o.WASM_BASE||"https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.7/wasm";const e=Ge();return e.length?(console.error("配置驗證失敗：",e),!1):!0}function Je(e,t={}){N=e.videoEl,q=e.bgCanvas,$=e.maskCanvas,S=e.outCanvas,v=e.bgVideoEl||null,e.bgGifEl,c=e.bgMoonVideoEl||null,b=e.iosMoonVideoEl||null,Ee=e.isIOSDevice||!1,console.log("📱 SegmentationCore 設備資訊:",{isIOSDevice:Ee,hasIOSMoonVideo:!!b,hasNormalMoonVideo:!!c}),he=q.getContext("2d"),x=$.getContext("2d"),y=S.getContext("2d"),typeof t.onStatus=="function"&&(U=t.onStatus),typeof t.onStats=="function"&&(te=t.onStats),de=o.CAMERA.FACING||"user",He()}function He(){const e=new Image;e.onload=()=>{O=e,console.log("✅ 自定義背景圖片載入完成")},e.onerror=a=>{console.warn("⚠️ 自定義背景圖片載入失敗:",a)};const t="/range_rover_moon_fastival_public/";e.src=t+"pexels-photo-623218.jpeg"}async function be(){if(window.FilesetResolver&&window.ImageSegmenter)return!0;const e=["https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.7/vision_bundle.mjs","https://unpkg.com/@mediapipe/tasks-vision@0.10.7/vision_bundle.mjs"];for(const t of e)try{const a=await import(t);return a.FilesetResolver&&(window.FilesetResolver=a.FilesetResolver),a.ImageSegmenter&&(window.ImageSegmenter=a.ImageSegmenter),a.FaceDetector&&(window.FaceDetector=a.FaceDetector),!0}catch(a){console.warn("[WARN] failed to import tasks-vision from",t,a)}throw new Error("無法載入 @mediapipe/tasks-vision 模組")}async function Pe(){j||(j=await FilesetResolver.forVisionTasks(o.WASM_BASE));try{const t=S.getBoundingClientRect();o.SEGMENTER.USE_LANDSCAPE_MODEL=(t.width||1)>=(t.height||1)}catch{}const e={modelAssetPath:o.SEGMENTER.USE_LANDSCAPE_MODEL?o.MODELS.SELFIE_SEGMENTER_LANDSCAPE:o.MODELS.SELFIE_SEGMENTER_SQUARE,delegate:o.SEGMENTER.USE_GPU?"GPU":"CPU"};try{z=await ImageSegmenter.createFromOptions(j,{baseOptions:e,runningMode:"VIDEO",outputCategoryMask:!1,outputConfidenceMasks:!0})}catch(t){console.warn("[Segmenter] GPU 失敗，改用 CPU:",t),z=await ImageSegmenter.createFromOptions(j,{baseOptions:{...e,delegate:"CPU"},runningMode:"VIDEO",outputCategoryMask:!1,outputConfidenceMasks:!0})}try{ee=await FaceDetector.createFromOptions(j,{baseOptions:{modelAssetPath:o.MODELS.FACE_DETECTOR,delegate:"GPU"},runningMode:"VIDEO",minDetectionConfidence:.6,minSuppressionThreshold:.3})}catch(t){console.warn("[FaceDetector] GPU 失敗，改用 CPU:",t),ee=await FaceDetector.createFromOptions(j,{baseOptions:{modelAssetPath:o.MODELS.FACE_DETECTOR,delegate:"CPU"},runningMode:"VIDEO",minDetectionConfidence:.6,minSuppressionThreshold:.3})}}async function Ce(){if(Q)try{Q.getTracks().forEach(t=>t.stop())}catch{}const e={audio:!1,video:{facingMode:de,width:{ideal:o.CAMERA.WIDTH},height:{ideal:o.CAMERA.HEIGHT},frameRate:{ideal:o.CAMERA.FRAME_RATE}}};Q=await navigator.mediaDevices.getUserMedia(e),N.srcObject=Q,N.setAttribute("playsinline",""),N.muted=!0,N.autoplay=!0,await new Promise(t=>{if(N.readyState>=1&&N.videoWidth&&N.videoHeight)return t();N.onloadedmetadata=()=>t(),setTimeout(t,1500)});try{await N.play()}catch{}_e()}async function Ze(){de=de==="user"?"environment":"user",await Ce()}function _e(){const t=(S.closest(".stage")||S.parentElement).getBoundingClientRect(),a=Math.max(1,Math.round(t.width)),n=Math.max(1,Math.round(t.height));[q,$,S,K,ge].forEach(r=>{(r.width!==a||r.height!==n)&&(r.width=a,r.height=n),r.style.width=`${a}px`,r.style.height=`${n}px`}),re={w:S.width,h:S.height}}function Be(e,t,a){const n=o.BACKGROUND&&o.BACKGROUND.TYPE||o.BACKGROUND_EFFECTS&&o.BACKGROUND_EFFECTS.DEFAULT_BACKGROUND||"original",r=o.BACKGROUND&&typeof o.BACKGROUND.INTENSITY=="number"?o.BACKGROUND.INTENSITY:(o.BACKGROUND_EFFECTS&&o.BACKGROUND_EFFECTS.EFFECT_INTENSITY)??.5;if(e.clearRect(0,0,t,a),ie+=.016,n!=="original"){if(n==="waves"){const i=e.createLinearGradient(0,0,t,a);i.addColorStop(0,"#1a2332"),i.addColorStop(.5,"#2d3a50"),i.addColorStop(1,"#0f1419"),e.fillStyle=i,e.fillRect(0,0,t,a),e.strokeStyle=`rgba(100,200,255,${r*.6})`,e.lineWidth=2;for(let l=0;l<8;l++){e.beginPath();for(let s=0;s<t;s+=5){const E=l*50,h=a/2+Math.sin((s+E)*.012+ie*1.2)*20*r;s===0?e.moveTo(s,h):e.lineTo(s,h)}e.stroke()}return}if(n==="frequency"){e.fillStyle="#0a0a0a",e.fillRect(0,0,t,a);const i=48,l=t/i;for(let s=0;s<i;s++){const E=s*l,h=(Math.sin(ie*2+s*.2)*.5+.5)*a*.5*r,d=(ie*30+s*10)%360;e.fillStyle=`hsla(${d},70%,60%,0.8)`,e.fillRect(E,a-h,l-1,h)}return}if(n==="video"&&v){const i=v.videoWidth||1,l=v.videoHeight||1;if(v.readyState>=2){const s=Math.max(t/i,a/l),E=Math.round(i*s),h=Math.round(l*s),d=Math.round((t-E)/2),M=Math.round((a-h)/2);try{v.paused&&v.play().catch(()=>{})}catch{}e.globalAlpha=Math.min(1,.3+r*.7),e.drawImage(v,0,0,i,l,d,M,E,h),e.globalAlpha=1}return}if(n==="moon_video"&&c){try{if(c.readyState>=2&&!c.paused){const i=c.videoWidth||c.width||1,l=c.videoHeight||c.height||1;if(i>1&&l>1){const s=Math.max(t/i,a/l),E=Math.round(i*s),h=Math.round(l*s),d=Math.round((t-E)/2),M=Math.round((a-h)/2);e.globalAlpha=Math.min(1,.3+r*.7),e.drawImage(c,0,0,i,l,d,M,E,h),e.globalAlpha=1}else console.warn("🌙 Moon video dimensions too small:",{vw:i,vh:l})}else c.paused?c.play().catch(i=>console.warn("月相影片播放失敗:",i)):console.warn("🌙 Moon video not ready:",{readyState:c.readyState,paused:c.paused})}catch(i){console.warn("月相影片渲染錯誤:",i)}return}if(n==="custom_moon_bg"&&O){try{if(Ee){if(O){const i=O.naturalWidth||O.width,l=O.naturalHeight||O.height;if(i>0&&l>0){const s=Math.max(t/i,a/l),E=Math.round(i*s),h=Math.round(l*s),d=Math.round((t-E)/2),M=Math.round((a-h)/2);e.drawImage(O,0,0,i,l,d,M,E,h)}}return}if(O){const i=O.naturalWidth||O.width,l=O.naturalHeight||O.height;if(i>0&&l>0){const s=Math.max(t/i,a/l),E=Math.round(i*s),h=Math.round(l*s),d=Math.round((t-E)/2),M=Math.round((a-h)/2);e.drawImage(O,0,0,i,l,d,M,E,h)}}if(c&&c.readyState>=2&&!c.paused){const i=c.videoWidth||c.width||1,l=c.videoHeight||c.height||1;if(i>1&&l>1){e.save();const s=t/a;let E,h,d;s>.6?(E=t*.5,h=a*.35,d=Math.min(t,a)*.25):s>.5?(E=t*.51,h=a*.29,d=Math.min(t,a)*.29):(E=t*.51,h=a*.26,d=Math.min(t,a)*.3),e.beginPath(),e.arc(E,h,d,0,2*Math.PI),e.clip();const M=Math.max(t/i,a/l),G=Math.round(i*M),m=Math.round(l*M),C=Math.round((t-G)/2),w=Math.round((a-m)/2);e.globalAlpha=Math.min(1,.8+r*.2),e.drawImage(c,0,0,i,l,C,w,G,m),e.globalAlpha=1,e.restore()}}else c&&c.paused&&c.play().catch(i=>console.warn("月相影片播放失敗:",i))}catch(i){console.warn("自定義背景 + 圓形月亮渲染錯誤:",i)}return}}}function ke(e,t){Be(he,e,t)}function We(e,t,a){const n=t*a;if(!B||re.w!==t||re.h!==a)return B=new Float32Array(n),B.set(e),re={w:t,h:a},B;const r=o.SMOOTHING.TEMPORAL_ALPHA;for(let i=0;i<n;i++)B[i]=r*B[i]+(1-r)*e[i];return B}function xe(e,t,a){const n=o.SMOOTHING.THRESHOLD,r=t*a,i=new ImageData(t,a);for(let h=0,d=0;h<r;h++,d+=4){const M=e[h],G=M>=n?Math.min(255,Math.round(M*255)):0;i.data[d]=0,i.data[d+1]=0,i.data[d+2]=0,i.data[d+3]=G}se.width=t,se.height=a,ve.putImageData(i,0,0);const l=S.width,s=S.height;ce.width=l,ce.height=s,ne.clearRect(0,0,l,s),ne.imageSmoothingEnabled=!0,ne.imageSmoothingQuality="high",ne.drawImage(se,0,0,l,s);const E=o.SMOOTHING.EDGE_FEATHER_PX;return le.width=l,le.height=s,ae.clearRect(0,0,l,s),ae.filter=E>0?`blur(${E}px)`:"none",ae.drawImage(ce,0,0),ae.filter="none",le}function Ke(e){const t=S.width;S.height,y.save(),y.translate(t,0),y.scale(-1,1);const a=e;y.restore();const n=a.length>=o.FACE_DETECTION_SETTINGS.REQUIRED_FACES;n!==Te&&(n?typeof U=="function"&&U("TRIGGER_TEST_EFFECT"):typeof U=="function"&&U("STOP_TEST_EFFECT"),Te=n),te({faceCount:e.length,facesInArea:a.length,moonActive:a.length>=o.FACE_DETECTION_SETTINGS.REQUIRED_FACES})}async function Ne(){var d,M,G;if(!Y)return;const e=performance.now(),t=S.width,a=S.height;y.clearRect(0,0,t,a),ke(t,a),Se.clearRect(0,0,t,a);const n=N.videoWidth||1,r=N.videoHeight||1,i=Math.max(t/n,a/r),l=Math.round(n*i),s=Math.round(r*i),E=Math.round((t-l)/2),h=Math.round((a-s)/2);try{Se.drawImage(N,0,0,n,r,E,h,l,s)}catch{}if(z&&o.SEGMENTATION.ENABLED){if(N.currentTime!==pe){pe=N.currentTime;try{const m=z.segmentForVideo?z.segmentForVideo(K,e):await z.segment(K);if(m){let C=null,w=0,L=0;if(m.confidenceMasks&&m.confidenceMasks.length){const R=me<m.confidenceMasks.length?me:0,D=m.confidenceMasks[R];if(D!=null&&D.getAsFloat32Array){const f=D.getAsFloat32Array();C=new Float32Array(f.length),C.set(f),w=D.width,L=D.height}for(const f of m.confidenceMasks)try{(d=f==null?void 0:f.close)==null||d.call(f)}catch{}}else if((M=m.categoryMask)!=null&&M.getAsUint8Array){const R=m.categoryMask,D=R.getAsUint8Array();C=new Float32Array(D.length),w=R.width,L=R.height;const f=me;for(let F=0;F<D.length;F++)C[F]=D[F]===f?1:0;try{(G=R.close)==null||G.call(R)}catch{}}if(C&&w&&L){const R=We(C,w,L);X=xe(R,w,L)}}}catch(m){console.warn("segmentForVideo error:",m)}}}else X=null;if(k.clearRect(0,0,t,a),k.save(),k.drawImage(K,0,0,t,a),X&&(k.globalCompositeOperation="destination-in",k.drawImage(X,0,0,t,a),k.globalCompositeOperation="source-over"),k.restore(),y.save(),y.translate(t,0),y.scale(-1,1),y.drawImage(ge,0,0,t,a),y.restore(),x.clearRect(0,0,t,a),X&&Re?(x.globalAlpha=.9,x.drawImage(X,0,0,t,a),x.globalAlpha=1,$.style.display="block"):$.style.display="none",ee)try{const m=ee.detectForVideo?ee.detectForVideo(K,e):null;m&&Ke(m.detections||[])}catch(m){console.warn("faceDetector error:",m)}requestAnimationFrame(Ne)}async function et(){if(Y)return;if(!Le()){U("配置錯誤，請檢查控制台");return}U("初始化..."),await be(),await Pe(),await Ce(),Y=!0,U("檢測中"),requestAnimationFrame(Ne)}function tt(){Y=!1;try{Q&&Q.getTracks().forEach(e=>e.stop())}catch{}y&&x&&he&&(y.clearRect(0,0,S.width,S.height),x.clearRect(0,0,$.width,$.height),he.clearRect(0,0,q.width,q.height)),te({faceCount:0,facesInArea:0,moonActive:!1}),U("已停止")}function ot(){Y&&_e()}let Re=!1;function nt(e){Re=!!e}function at(e){o.SEGMENTATION.ENABLED=!!e}function it(e){o.BACKGROUND.TYPE=e}function rt(e){o.BACKGROUND.INTENSITY=Math.max(0,Math.min(1,e))}function st(e){o.SMOOTHING.EDGE_FEATHER_PX=Math.max(0,Number(e)||0)}function ct(e){o.SMOOTHING.TEMPORAL_ALPHA=Math.max(0,Math.min(.95,Number(e)||0))}function lt(e){o.SMOOTHING.THRESHOLD=Math.max(0,Math.min(1,Number(e)||0))}function dt(e){o.BACKGROUND.GIF_BLEND_MODE=e}function ht(e){}function Et(){return Y}async function ut(){if(!S||!Y)return console.warn("無法拍照：相機未啟動或畫布不存在"),null;try{const e=document.createElement("canvas"),t=e.getContext("2d"),a=S.width,n=S.height;e.width=a,e.height=n;const r=o.BACKGROUND&&o.BACKGROUND.TYPE;if(console.log("📸 拍照檢查背景類型:",{bgType:r,hasMoonVideo:!!c}),(r==="moon_video"||r==="custom_moon_bg")&&c){console.log("🌙 月相影片模式：生成 8 秒動態影片..."),t.drawImage(S,0,0,a,n);const h=e.toDataURL("image/png",1);try{const d=await Ve(h,a,n);return console.log("✅ 影片生成完成:",d),d}catch(d){console.error("❌ 影片生成失敗:",d);const M=e.toDataURL("image/png",1),G=new Date().toISOString().replace(/[:]/g,"-").split(".")[0],m=document.createElement("a"),C=`月亮節AR拍照_${G}.png`;return m.download=C,m.href=M,document.body.appendChild(m),m.click(),document.body.removeChild(m),{png:M,error:"影片生成失敗，已保存為圖片"}}}else t.drawImage(q,0,0,a,n),t.drawImage(S,0,0,a,n);const i=e.toDataURL("image/png",1),l=new Date().toISOString().replace(/[:]/g,"-").split(".")[0],s=document.createElement("a"),E=`月亮節AR拍照_${l}.png`;return s.download=E,s.href=i,document.body.appendChild(s),s.click(),document.body.removeChild(s),console.log("📸 PNG 拍照成功！"),{png:i}}catch(e){return console.error("拍照失敗：",e),null}}let H=null,Z="mp4";function gt(e){H=e}function mt(e){Z=e}async function Ve(e,t,a){console.log("🎬 開始錄製靜止人物 + 動態背景影片...");try{if(!window.MediaRecorder)return console.warn("瀏覽器不支援 MediaRecorder"),{png:e,error:"瀏覽器不支援影片錄製"};const n=document.createElement("canvas"),r=n.getContext("2d"),i=640,l=t/a;t>a?(n.width=Math.min(i,t),n.height=Math.round(n.width/l)):(n.height=Math.min(i,a),n.width=Math.round(n.height*l)),console.log(`錄製 Canvas 尺寸: ${n.width}x${n.height} (原始: ${t}x${a}, 比例: ${l.toFixed(2)})`);const s=new Image;return new Promise((E,h)=>{s.onload=async()=>{console.log("靜止人物圖片載入完成，開始錄製...");const d=8,M=20,G=d*M;c&&c.paused&&await c.play().catch(f=>console.warn("影片播放失敗:",f));const m=n.captureStream(M);let C;Z==="mp4"?MediaRecorder.isTypeSupported("video/mp4; codecs=h264")?C={mimeType:"video/mp4; codecs=h264",videoBitsPerSecond:3e6}:MediaRecorder.isTypeSupported("video/mp4")?C={mimeType:"video/mp4",videoBitsPerSecond:3e6}:(console.warn("瀏覽器不支援 MP4，降級到 WebM"),C={mimeType:"video/webm; codecs=vp8",videoBitsPerSecond:3e6},Z="webm"):C={mimeType:"video/webm; codecs=vp8",videoBitsPerSecond:3e6};const w=new MediaRecorder(m,C);console.log(`📹 使用格式: ${C.mimeType}`);const L=[];w.ondataavailable=f=>{f.data.size>0&&L.push(f.data)},w.onstop=()=>{const f=Z==="mp4"?"video/mp4":"video/webm",F=Z==="mp4"?"mp4":"webm",fe=new Blob(L,{type:f}),P=`月亮節AR_月相影片_${new Date().toISOString().replace(/[:]/g,"-").split(".")[0]}.${F}`,oe=De(fe,P);typeof U=="function"&&U("影片已生成，可按 分享 或 下載"),typeof te=="function"&&te({lastVideoUrl:oe,lastVideoFilename:P}),E({png:e,video:oe,duration:d,format:F,saved:!0})},w.onerror=f=>{console.error("錄製錯誤:",f.error),h(f.error)},w.start(),console.log(`開始錄製 ${d} 秒影片...`),H&&(H.setStatus("開始錄製..."),H.updateProgress(0,d));let R=0;function D(){r.clearRect(0,0,n.width,n.height);const f=o.BACKGROUND&&o.BACKGROUND.TYPE,F=o.BACKGROUND.INTENSITY||.5;if(f==="custom_moon_bg"&&O){const u=O.naturalWidth||O.width,g=O.naturalHeight||O.height;if(u>0&&g>0){const p=Math.max(n.width/u,n.height/g),A=Math.round(u*p),T=Math.round(g*p),_=Math.round((n.width-A)/2),I=Math.round((n.height-T)/2);r.drawImage(O,0,0,u,g,_,I,A,T)}}else if(f==="video"&&v&&v.readyState>=2){const u=v.videoWidth||1,g=v.videoHeight||1,p=Math.max(n.width/u,n.height/g),A=Math.round(u*p),T=Math.round(g*p),_=Math.round((n.width-A)/2),I=Math.round((n.height-T)/2);r.globalAlpha=Math.min(1,.3+F*.7),r.drawImage(v,0,0,u,g,_,I,A,T),r.globalAlpha=1}if(f==="custom_moon_bg"||f==="moon_video"){if(Ee){if(b&&b.readyState>=2&&b.videoWidth>0){const u=b.videoWidth,g=b.videoHeight,p=Math.max(n.width/u,n.height/g),A=Math.round(u*p),T=Math.round(g*p),_=Math.round((n.width-A)/2),I=Math.round((n.height-T)/2);r.globalAlpha=Math.min(1,.8+F*.2),r.drawImage(b,0,0,u,g,_,I,A,T),r.globalAlpha=1}else if(c&&c.readyState>=2){const u=c.videoWidth||c.width||1,g=c.videoHeight||c.height||1,p=Math.max(n.width/u,n.height/g),A=Math.round(u*p),T=Math.round(g*p),_=Math.round((n.width-A)/2),I=Math.round((n.height-T)/2);r.globalAlpha=Math.min(1,.8+F*.2),r.drawImage(c,0,0,u,g,_,I,A,T),r.globalAlpha=1}}else if(c&&c.readyState>=2){const u=c.videoWidth||c.width||1,g=c.videoHeight||c.height||1;if(u>1&&g>1){r.save();const p=n.width/n.height;let A,T,_;p>.6?(A=n.width*.5,T=n.height*.35,_=Math.min(n.width,n.height)*.25):p>.5?(A=n.width*.51,T=n.height*.29,_=Math.min(n.width,n.height)*.29):(A=n.width*.51,T=n.height*.26,_=Math.min(n.width,n.height)*.3),r.beginPath(),r.arc(A,T,_,0,2*Math.PI),r.clip();const I=Math.max(n.width/u,n.height/g),Me=Math.round(u*I),Ae=Math.round(g*I),Ie=Math.round((n.width-Me)/2),we=Math.round((n.height-Ae)/2);r.globalAlpha=Math.min(1,.8+F*.2),r.drawImage(c,0,0,u,g,Ie,we,Me,Ae),r.globalAlpha=1,r.restore()}}}else if(c&&c.readyState>=2){const u=c.videoWidth||c.width||1,g=c.videoHeight||c.height||1;if(u>1&&g>1){const p=Math.max(n.width/u,n.height/g),A=Math.round(u*p),T=Math.round(g*p),_=Math.round((n.width-A)/2),I=Math.round((n.height-T)/2);r.globalAlpha=Math.min(1,.3+F*.7),r.drawImage(c,0,0,u,g,_,I,A,T),r.globalAlpha=1}}const J=s.naturalWidth||s.width,P=s.naturalHeight||s.height;if(J>0&&P>0){const u=n.width/J,g=n.height/P,p=Math.max(u,g),A=Math.round(J*p),T=Math.round(P*p),_=Math.round((n.width-A)/2),I=Math.round((n.height-T)/2);r.drawImage(s,0,0,J,P,_,I,A,T)}else r.drawImage(s,0,0,n.width,n.height);R++;const oe=R/M;H&&H.updateProgress(oe,d),R<G?setTimeout(D,1e3/M):(H&&H.setStatus("錄製完成，正在生成檔案..."),w.stop(),console.log("所有幀錄製完成"))}D()},s.onerror=()=>{h(new Error("靜止人物圖片載入失敗"))},s.src=e})}catch(n){return console.error("影片生成錯誤:",n),{png:e,error:n.message}}}export{o as CONFIG,ut as capturePhoto,je as clearLastRecording,Xe as getLastRecordingFilename,$e as getLastRecordingUrl,Ye as hasRecordingAvailable,Je as initCore,Le as initializeConfig,Et as isRunning,ot as onResize,qe as resetConfig,Qe as saveConfig,rt as setBackgroundIntensity,it as setBackgroundType,st as setEdgeFeather,at as setEnableSegmentation,dt as setGifBlendMode,gt as setRecordingProgressCallback,ht as setShouldGenerateGif,nt as setShowMaskPreview,ct as setTemporalAlpha,lt as setThreshold,mt as setVideoOutputFormat,ze as shareLastRecording,et as start,tt as stop,De as storeRecordingBlob,Ze as switchCamera,_e as syncCanvasSize,Fe as uploadBlobToServerAndGetUrl};
//# sourceMappingURL=segmentationCore-CpKBjDPm.js.map
